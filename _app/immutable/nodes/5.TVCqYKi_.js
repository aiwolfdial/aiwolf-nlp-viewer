import{t as Qe,a as Pe,c as vi,d as pl}from"../chunks/BopGTE8o.js";import{p as on,ai as wt,i as wa,t as nt,a as ln,aI as Tr,c as te,s as ne,r as Z,aL as ci,l as B,aK as sc,f as Er,$ as oc}from"../chunks/Ct7ANt6e.js";import{d as un,s as st,e as ba}from"../chunks/BnqBNAe_.js";import{i as At}from"../chunks/DNpI7BUG.js";import{e as _a,i as Da}from"../chunks/NQz2JwdD.js";import{h as lc}from"../chunks/B2ogVApr.js";import{a as Ra,s as Mt,r as Nt,b as yl,c as ir}from"../chunks/DZuwPtZB.js";import{s as kr,c as El}from"../chunks/CZyT7R6R.js";import{s as ka}from"../chunks/BnwBSpKm.js";import{b as uc}from"../chunks/C_Wyfoio.js";import{b as hr}from"../chunks/CMY0gm4c.js";import{p as fc,s as di,a as dc,b as hc}from"../chunks/DVr5ivKr.js";import{p as cc}from"../chunks/CQNWAaMO.js";import{w as _r,d as vc}from"../chunks/I4hA5oXT.js";import{I as gc}from"../chunks/Dz1Iufi4.js";import{e as mc,g as pc}from"../chunks/C12fYlIf.js";import{a as fn,o as Al}from"../chunks/CvhId5fI.js";/* empty css                */import{b as yc}from"../chunks/iCjsSuhP.js";import{b as Ec}from"../chunks/Bx59benV.js";class Ca{static fromJson(C){return Ac(JSON.parse(C),Dr("RealtimeSettings"))}static toJson(C){return JSON.stringify(xc(C,Dr("RealtimeSettings")),null,2)}}function dr(O,C,G,Y=""){const fe=Pa(O),ke=Y?` on ${Y}`:"",he=G?` for key "${G}"`:"";throw Error(`Invalid value${he}${ke}. Expected ${fe} but got ${JSON.stringify(C)}`)}function Pa(O){return Array.isArray(O)?O.length===2&&O[0]===void 0?`an optional ${Pa(O[1])}`:`one of [${O.map(C=>Pa(C)).join(", ")}]`:typeof O=="object"&&O.literal!==void 0?O.literal:typeof O}function Tc(O){if(O.jsonToJS===void 0){const C={};O.props.forEach(G=>C[G.json]={key:G.js,typ:G.typ}),O.jsonToJS=C}return O.jsonToJS}function Sc(O){if(O.jsToJSON===void 0){const C={};O.props.forEach(G=>C[G.js]={key:G.json,typ:G.typ}),O.jsToJSON=C}return O.jsToJSON}function Xr(O,C,G,Y="",fe=""){function ke(J,be){return typeof J==typeof be?be:dr(J,be,Y,fe)}function he(J,be){const Re=J.length;for(let Oe=0;Oe<Re;Oe++){const Q=J[Oe];try{return Xr(be,Q,G)}catch{}}return dr(J,be,Y,fe)}function z(J,be){return J.indexOf(be)!==-1?be:dr(J.map(Re=>an(Re)),be,Y,fe)}function Ue(J,be){return Array.isArray(be)?be.map(Re=>Xr(Re,J,G)):dr(an("array"),be,Y,fe)}function Ve(J){if(J===null)return null;const be=new Date(J);return isNaN(be.valueOf())?dr(an("Date"),J,Y,fe):be}function ae(J,be,Re){if(Re===null||typeof Re!="object"||Array.isArray(Re))return dr(an($e||"object"),Re,Y,fe);const Oe={};return Object.getOwnPropertyNames(J).forEach(Q=>{const qe=J[Q],ot=Object.prototype.hasOwnProperty.call(Re,Q)?Re[Q]:void 0;Oe[qe.key]=Xr(ot,qe.typ,G,Q,$e)}),Object.getOwnPropertyNames(Re).forEach(Q=>{Object.prototype.hasOwnProperty.call(J,Q)||(Oe[Q]=Xr(Re[Q],be,G,Q,$e))}),Oe}if(C==="any")return O;if(C===null)return O===null?O:dr(C,O,Y,fe);if(C===!1)return dr(C,O,Y,fe);let $e;for(;typeof C=="object"&&C.ref!==void 0;)$e=C.ref,C=Lc[C.ref];return Array.isArray(C)?z(C,O):typeof C=="object"?C.hasOwnProperty("unionMembers")?he(C.unionMembers,O):C.hasOwnProperty("arrayItems")?Ue(C.arrayItems,O):C.hasOwnProperty("props")?ae(G(C),C.additional,O):dr(C,O,Y,fe):C===Date&&typeof O!="number"?Ve(O):ke(C,O)}function Ac(O,C){return Xr(O,C,Tc)}function xc(O,C){return Xr(O,C,Sc)}function an(O){return{literal:O}}function sn(O,C){return{props:O,additional:C}}function Dr(O){return{ref:O}}const Lc={RealtimeSettings:sn([{json:"connection",js:"connection",typ:Dr("Connection")},{json:"display",js:"display",typ:Dr("Display")}],!1),Connection:sn([{json:"url",js:"url",typ:""},{json:"token",js:"token",typ:""}],!1),Display:sn([{json:"canvas",js:"canvas",typ:Dr("Agent")},{json:"bubble",js:"bubble",typ:Dr("Agent")},{json:"text",js:"text",typ:Dr("Agent")},{json:"largeScale",js:"largeScale",typ:!0}],!1),Agent:sn([{json:"name",js:"name",typ:!0},{json:"team",js:"team",typ:!0},{json:"role",js:"role",typ:!0}],!1)},Tl={connection:{url:"ws://localhost:8080/realtime",token:""},display:{canvas:{name:!0,team:!1,role:!0},bubble:{name:!0,team:!1,role:!1},text:{name:!0,team:!1,role:!1},largeScale:!1}};function bc(){const O=localStorage.getItem("realtime-settings");if(O)try{return Ca.fromJson(O)}catch(C){console.error(C)}return localStorage.setItem("realtime-settings",Ca.toJson(Tl)),Tl}const Cr=_r(bc());Cr.subscribe(O=>{localStorage.setItem("realtime-settings",Ca.toJson(O))});function Rc(O){return Array.from({length:O},(C,G)=>({idx:G+1,team:"Undefined",name:gc(G+1),profile:void 0,avatar:void 0,role:"Undefined",is_alive:!0}))}function St(O,C,G){var fe,ke,he;if(G===void 0)return"該当なし";let Y=[];return O!=null&&O.name&&Y.push((fe=C.agents.find(z=>z.idx===G))==null?void 0:fe.name),O!=null&&O.team&&Y.push((ke=C.agents.find(z=>z.idx===G))==null?void 0:ke.team),O!=null&&O.role&&Y.push((he=C.agents.find(z=>z.idx===G))==null?void 0:he.role),Y.join(" ")}function Ic(O){return O?mc[pc[O]]:""}function hi(O,C){return(O||C)&&!(O&&C)}function _c(){const{subscribe:O,update:C}=_r({status:"disconnected",entries:{}});let G=null,Y=null;Cr.subscribe(he=>{Y=he});function fe(){if(!Y)return;C(z=>({...z,status:"connecting"}));const he=new URL(Y.connection.url);Y.connection.token&&he.searchParams.set("token",Y.connection.token),G=new WebSocket(he),G.onopen=()=>{C(z=>({...z,status:"connected"}))},G.onclose=()=>{C(z=>({...z,status:"disconnected"})),G=null},G.onerror=()=>{C(z=>({...z,status:"disconnected"})),G=null},G.onmessage=z=>{try{const Ue=JSON.parse(z.data);console.log("Received packet:",Ue),C(Ve=>{const ae={...Ve.entries};return ae[Ue.id]||(ae[Ue.id]=[]),ae[Ue.id].push(Ue),{...Ve,entries:ae}})}catch(Ue){console.error("Failed to parse message:",Ue)}}}function ke(){G&&(C(he=>({...he,status:"disconnected"})),G.close(),G=null)}return{subscribe:O,connect:fe,disconnect:ke,entries:{subscribe:he=>O(z=>he(z.entries))}}}const zr=_c();var Dc=(O,C,G)=>{C()===B(G).idx?C(void 0):C(B(G).idx)},kc=Qe('<pre class="base-content text-2xl select-none"> </pre>'),Cc=Qe('<pre class="base-content select-none"> </pre>'),Pc=Qe('<pre class="base-content text-2xl select-none"> </pre>'),wc=Qe('<pre class="base-content select-none"> </pre>'),Mc=Qe('<pre class="base-content text-2xl select-none"> </pre>'),Oc=Qe('<pre class="base-content select-none"> </pre>'),Fc=Qe('<div><div class="avatar rounded-full bg-base-300"><div><button class="cursor-pointer"><img class="w-full h-full"></button></div></div> <div class="mt-2"><!> <!> <!></div></div>'),Nc=Qe(`<div class="h-full flex flex-col"><div class="bg-secondary"></div> <div class="w-full flex-1 mt-8"><div class="h-full flex items-center justify-center relative rounded-1/2 box-border"><pre class="base-content w-2/5 text-5xl font-bold opacity-70 absolute top-0 left-0 -mt-4 ml-8 select-none"> <br> <br> </pre> <canvas class="w-full h-full absolute top-0 left-0 pointer-events-none"></canvas> <canvas class="w-full h-full absolute top-0 left-0 z-10 pointer-events-none"></canvas> <div class="w-1/2 h-fit max-h-1/3 card bg-base-100 card-md shadow-md overflow-auto z-20"><div class="card-body"><p> </p></div></div> <!></div></div> <footer class="footer footer-center text-base-content p-2"><aside><span class="text-xs">イラスト:石黒正数氏, VOICEVOX:四国めたん,ずんだもん,春日部つむぎ,
        波音リツ,玄野武宏,白上虎太郎,青山龍星,冥鳴ひまり,九州そら,もち子(cv
        明日葉よもぎ),剣崎雌雄,WhiteCUL,後鬼,No.7,ちび式じい,
        櫻歌ミコ,小夜/SAYO,ナースロボ＿タイプＴ,†聖騎士 紅桜†,雀松朱司,
        麒ヶ島宗麟,春歌ナナ,猫使アル,猫使ビィ,中国うさぎ,栗田まろん,
        あいえるたん,満別花丸,琴詠ニア,Voidoll(CV:丹下桜),ぞん子,中部つるぎ</span></aside></footer></div>`);function Uc(O,C){on(C,!0);let G=fc(C,"focusIdx",15),Y=Tr(void 0);const fe=Cr.subscribe(ce=>{wt(Y,ce,!0)});fn(fe);let ke=sc(()=>{var ce,me,at,we,Ze,N,Te,Be,V,_,p,j,K,ve;switch(C.packet.event){case"未接続":return"未接続";case"トーク":return C.packet.message;case"囁き":return hi(G()===void 0,((ce=C.packet.agents.find($=>$.idx===G()))==null?void 0:ce.role)==="WEREWOLF")?C.packet.message:"囁きました";case"襲撃投票":return hi(G()===void 0,C.packet.from_idx===G())?`${St((me=B(Y))==null?void 0:me.display.bubble,C.packet,C.packet.from_idx)} が ${St((at=B(Y))==null?void 0:at.display.bubble,C.packet,C.packet.to_idx)} に襲撃投票しました`:"襲撃投票しました";case"投票":return hi(G()===void 0,C.packet.from_idx===G())?`${St((we=B(Y))==null?void 0:we.display.bubble,C.packet,C.packet.from_idx)} が ${St((Ze=B(Y))==null?void 0:Ze.display.bubble,C.packet,C.packet.to_idx)} に投票しました`:`${St((N=B(Y))==null?void 0:N.display.bubble,C.packet,C.packet.from_idx)} が投票しました`;case"追放":return C.packet.to_idx===void 0?"誰も追放されませんでした":`${St((Te=B(Y))==null?void 0:Te.display.bubble,C.packet,C.packet.to_idx)} を追放しました`;case"襲撃":return C.packet.to_idx===void 0?"誰も襲撃されませんでした":C.packet.from_idx===-1?`${St((Be=B(Y))==null?void 0:Be.display.bubble,C.packet,C.packet.to_idx)} が襲撃されましたが、護衛されました`:`${St((V=B(Y))==null?void 0:V.display.bubble,C.packet,C.packet.to_idx)} が襲撃されました`;case"占い":return hi(G()===void 0,C.packet.from_idx===G())?`${St((_=B(Y))==null?void 0:_.display.bubble,C.packet,C.packet.from_idx)} が ${St((p=B(Y))==null?void 0:p.display.bubble,C.packet,C.packet.to_idx)} を占った結果、${Ic((j=C.packet.agents.find($=>$.idx===C.packet.to_idx))==null?void 0:j.role)} でした`:"占いました";case"護衛":return hi(G()===void 0,C.packet.from_idx===G())?`${St((K=B(Y))==null?void 0:K.display.bubble,C.packet,C.packet.from_idx)} が ${St((ve=B(Y))==null?void 0:ve.display.bubble,C.packet,C.packet.to_idx)} を護衛対象にしました`:"護衛しました";case"終了":return C.packet.message+" が勝利しました";default:return C.packet.message??"不明なイベント"}}),he,z,Ue,Ve,ae;Al(()=>(window.addEventListener("resize",$e),()=>{window.removeEventListener("resize",$e)})),wa(()=>{$e()});function $e(){var Ze;if(!z||!Ue||!he)return;const ce=he.getBoundingClientRect();if([z,Ue].forEach(N=>{N.width=ce.width,N.height=ce.height;const Te=N.getContext("2d");Te&&(Te.clearRect(0,0,N.width,N.height),Te.globalAlpha=1,Te.lineWidth=2)}),G()!==void 0&&(C.packet.event==="囁き"&&((Ze=C.packet.agents.find(N=>N.idx===G()))==null?void 0:Ze.role)!=="WEREWOLF"||C.packet.event==="占い"&&C.packet.from_idx!==G()||C.packet.event==="投票"&&C.packet.from_idx!==G()||C.packet.event==="襲撃投票"&&C.packet.from_idx!==G()))return;const me=z.getContext("2d"),at=Ue.getContext("2d");if(!me||!at)return;const we=Ue.getBoundingClientRect();if(C.packet.from_idx!==void 0&&C.packet.to_idx!==void 0){const N=document.getElementById(`agent-${C.packet.from_idx}`);if(!(N instanceof HTMLElement))return;const Te=N.getBoundingClientRect(),Be=Te.left+Te.width/2-we.left,V=Te.top+Te.height/2-we.top,_=document.getElementById(`agent-${C.packet.to_idx}`);if(!(_ instanceof HTMLElement))return;const p=_.getBoundingClientRect();J(at,Be,V,p.left+p.width/2-we.left,p.top+p.height/2-we.top,!1,getComputedStyle(ae).getPropertyValue("background-color"))}if(C.packet.bubble_idx!==void 0){const N=document.getElementById(`agent-${C.packet.bubble_idx}`);if(!(N instanceof HTMLElement))return;const Te=N.getBoundingClientRect(),Be=Te.left+Te.width/2-we.left,V=Te.top+Te.height/2-we.top;J(me,we.width/2,we.height/2,Be,V,!0,getComputedStyle(Ve).getPropertyValue("background-color"))}}function J(ce,me,at,we,Ze,N,Te){const Be=N?[0,0,0,0,0,30]:[0,5,-20,5,-20,15];ce.strokeStyle=ce.fillStyle=Te,ce.beginPath();let V=we-me,_=Ze-at,p=Math.sqrt(V*V+_*_),j=_/p,K=V/p,ve=[];ve.push(0,0);for(let $=0;$<Be.length;$+=2){let ie=Be[$],Ee=Be[$+1];ve.push(ie<0?p+ie:ie,Ee)}ve.push(p,0);for(let $=Be.length;$>0;$-=2){let ie=Be[$-2],Ee=Be[$-1];ve.push(ie<0?p+ie:ie,-Ee)}ve.push(0,0);for(let $=0;$<ve.length;$+=2){let ie=ve[$]*K-ve[$+1]*j+me,Ee=ve[$]*j+ve[$+1]*K+at;$===0?ce.moveTo(ie,Ee):ce.lineTo(ie,Ee)}ce.fill()}var be=Nc(),Re=te(be);hr(Re,ce=>ae=ce,()=>ae);var Oe=ne(Re,2),Q=te(Oe),qe=te(Q),ot=te(qe),vt=ne(ot,2,!0),lt=ne(vt,2,!0);Z(qe);var dt=ne(qe,2);hr(dt,ce=>z=ce,()=>z);var Wt=ne(dt,2);hr(Wt,ce=>Ue=ce,()=>Ue);var Je=ne(Wt,2),Ot=te(Je),Ut=te(Ot),Yt=te(Ut,!0);Z(Ut),Z(Ot),Z(Je),hr(Je,ce=>Ve=ce,()=>Ve);var Bt=ne(Je,2);_a(Bt,17,()=>C.packet.agents,Da,(ce,me,at)=>{var we=Fc();let Ze;var N=te(we),Te=te(N);let Be,V;var _=te(Te);_.__click=[Dc,G,me];var p=te(_);Z(_),Z(Te),Z(N);var j=ne(N,2),K=te(j);{var ve=Fe=>{var Ce=vi(),xt=Er(Ce);{var gt=X=>{var re=kc(),pe=te(re,!0);Z(re),nt(()=>st(pe,B(me).name)),Pe(X,re)},_t=X=>{var re=Cc(),pe=te(re,!0);Z(re),nt(()=>st(pe,B(me).name)),Pe(X,re)};At(xt,X=>{var re;(re=B(Y))!=null&&re.display.largeScale?X(gt):X(_t,!1)})}Pe(Fe,Ce)};At(K,Fe=>{var Ce;(Ce=B(Y))!=null&&Ce.display.canvas.name&&Fe(ve)})}var $=ne(K,2);{var ie=Fe=>{var Ce=vi(),xt=Er(Ce);{var gt=X=>{var re=Pc(),pe=te(re,!0);Z(re),nt(()=>st(pe,B(me).team)),Pe(X,re)},_t=X=>{var re=wc(),pe=te(re,!0);Z(re),nt(()=>st(pe,B(me).team)),Pe(X,re)};At(xt,X=>{var re;(re=B(Y))!=null&&re.display.largeScale?X(gt):X(_t,!1)})}Pe(Fe,Ce)};At($,Fe=>{var Ce;(Ce=B(Y))!=null&&Ce.display.canvas.team&&Fe(ie)})}var Ee=ne($,2);{var qt=Fe=>{var Ce=vi(),xt=Er(Ce);{var gt=X=>{var re=Mc(),pe=te(re,!0);Z(re),nt(()=>st(pe,B(me).role)),Pe(X,re)},_t=X=>{var re=Oc(),pe=te(re,!0);Z(re),nt(()=>st(pe,B(me).role)),Pe(X,re)};At(xt,X=>{var re;(re=B(Y))!=null&&re.display.largeScale?X(gt):X(_t,!1)})}Pe(Fe,Ce)};At(Ee,Fe=>{var Ce;(Ce=B(Y))!=null&&Ce.display.canvas.role&&(B(me).idx===G()||G()===void 0)&&Fe(qt)})}Z(j),Z(we),nt((Fe,Ce,xt)=>{var gt;Ze=kr(we,1,"absolute origin-center text-center flex flex-col items-center transform-angle rounded-xl p-2 svelte-1xlm15x",null,Ze,Fe),ka(we,`--angle: ${at*(360/C.packet.agents.length)}`),Ra(we,"id",`agent-${B(me).idx??""}`),Be=kr(Te,1,El((gt=B(Y))!=null&&gt.display.largeScale?"relative w-48 rounded-full ring-offset-base-100 ring ring-offset-2":"relative w-24 rounded-full ring-offset-base-100 ring ring-offset-2"),"svelte-1xlm15x",Be,Ce),V=ka(Te,"",V,{opacity:B(me).is_alive?1:.25}),Ra(p,"src",xt),Ra(p,"alt",B(me).name)},[()=>({"bg-focus":B(me).idx===G()}),()=>({"ring-info":B(me).is_alive,"ring-error":!B(me).is_alive}),()=>B(me).avatar===void 0?`${yc}/images/male/${B(me).idx.toString().padStart(2,"0")}.png`:B(me).avatar]),Pe(ce,we)}),Z(Q),hr(Q,ce=>he=ce,()=>he),Z(Oe),ci(2),Z(be),nt(()=>{var ce;st(ot,`${C.packet.day??""}日目`),st(vt,C.packet.is_day?"昼":"夜"),st(lt,C.packet.event),Je.hidden=!B(ke),kr(Ut,1,El((ce=B(Y))!=null&&ce.display.largeScale?"base-content text-3xl font-bold text-pretty break-all text-center":"base-content text-lg text-pretty break-all text-center")),st(Yt,B(ke))}),Pe(O,be),ln()}un(["click"]);function Bc(O){return O&&O.__esModule&&Object.prototype.hasOwnProperty.call(O,"default")?O.default:O}var Ia={exports:{}},Sl;function Gc(){return Sl||(Sl=1,function(O,C){(function G(Y){(function(fe,ke){O.exports=ke()})(this,function(){function fe(a,o){(o==null||o>a.length)&&(o=a.length);for(var n=0,r=Array(o);n<o;n++)r[n]=a[n];return r}function ke(a,o,n){if(Re())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,o);var e=new(a.bind.apply(a,r));return n&&qe(e,n.prototype),e}function he(a,o){for(var n=0;n<o.length;n++){var r=o[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(a,vt(r.key),r)}}function z(a,o,n){return o&&he(a.prototype,o),n&&he(a,n),Object.defineProperty(a,"prototype",{writable:!1}),a}function Ue(a,o){var n=typeof Symbol<"u"&&a[Symbol.iterator]||a["@@iterator"];if(n)return(n=n.call(a)).next.bind(n);if(Array.isArray(a)||(n=lt(a))||o){n&&(a=n);var r=0;return function(){return r>=a.length?{done:!0}:{done:!1,value:a[r++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function Ve(a,o,n){return(o=vt(o))in a?Object.defineProperty(a,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):a[o]=n,a}function ae(){return ae=Object.assign?Object.assign.bind():function(a){for(var o=1;o<arguments.length;o++){var n=arguments[o];for(var r in n)({}).hasOwnProperty.call(n,r)&&(a[r]=n[r])}return a},ae.apply(null,arguments)}function $e(a){return $e=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(o){return o.__proto__||Object.getPrototypeOf(o)},$e(a)}function J(a,o){a.prototype=Object.create(o.prototype),a.prototype.constructor=a,qe(a,o)}function be(a){try{return Function.toString.call(a).indexOf("[native code]")!==-1}catch{return typeof a=="function"}}function Re(){try{var a=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(Re=function(){return!!a})()}function Oe(a,o){var n=Object.keys(a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(a);o&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable})),n.push.apply(n,r)}return n}function Q(a){for(var o=1;o<arguments.length;o++){var n=arguments[o]!=null?arguments[o]:{};o%2?Oe(Object(n),!0).forEach(function(r){Ve(a,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(n)):Oe(Object(n)).forEach(function(r){Object.defineProperty(a,r,Object.getOwnPropertyDescriptor(n,r))})}return a}function qe(a,o){return qe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,r){return n.__proto__=r,n},qe(a,o)}function ot(a,o){if(typeof a!="object"||!a)return a;var n=a[Symbol.toPrimitive];if(n!==void 0){var r=n.call(a,o);if(typeof r!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(o==="string"?String:Number)(a)}function vt(a){var o=ot(a,"string");return typeof o=="symbol"?o:o+""}function lt(a,o){if(a){if(typeof a=="string")return fe(a,o);var n={}.toString.call(a).slice(8,-1);return n==="Object"&&a.constructor&&(n=a.constructor.name),n==="Map"||n==="Set"?Array.from(a):n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?fe(a,o):void 0}}function dt(a){var o=typeof Map=="function"?new Map:void 0;return dt=function(n){if(n===null||!be(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(o!==void 0){if(o.has(n))return o.get(n);o.set(n,r)}function r(){return ke(n,arguments,$e(this).constructor)}return r.prototype=Object.create(n.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),qe(r,n)},dt(a)}function Wt(){try{return crypto.randomUUID()}catch{try{var a=URL.createObjectURL(new Blob),o=a.toString();return URL.revokeObjectURL(a),o.slice(o.lastIndexOf("/")+1)}catch{var n=new Date().getTime(),r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){var s=(n+Math.random()*16)%16|0;return n=Math.floor(n/16),(i=="x"?s:s&3|8).toString(16)});return r}}}function Je(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var Ot={exports:{}},Ut;function Yt(){return Ut||(Ut=1,function(a){var o=Object.prototype.hasOwnProperty,n="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(n=!1));function e(l,u,f){this.fn=l,this.context=u,this.once=f||!1}function t(l,u,f,d,h){if(typeof f!="function")throw new TypeError("The listener must be a function");var c=new e(f,d||l,h),v=n?n+u:u;return l._events[v]?l._events[v].fn?l._events[v]=[l._events[v],c]:l._events[v].push(c):(l._events[v]=c,l._eventsCount++),l}function i(l,u){--l._eventsCount===0?l._events=new r:delete l._events[u]}function s(){this._events=new r,this._eventsCount=0}s.prototype.eventNames=function(){var u=[],f,d;if(this._eventsCount===0)return u;for(d in f=this._events)o.call(f,d)&&u.push(n?d.slice(1):d);return Object.getOwnPropertySymbols?u.concat(Object.getOwnPropertySymbols(f)):u},s.prototype.listeners=function(u){var f=n?n+u:u,d=this._events[f];if(!d)return[];if(d.fn)return[d.fn];for(var h=0,c=d.length,v=new Array(c);h<c;h++)v[h]=d[h].fn;return v},s.prototype.listenerCount=function(u){var f=n?n+u:u,d=this._events[f];return d?d.fn?1:d.length:0},s.prototype.emit=function(u,f,d,h,c,v){var g=n?n+u:u;if(!this._events[g])return!1;var m=this._events[g],y=arguments.length,E,T;if(m.fn){switch(m.once&&this.removeListener(u,m.fn,void 0,!0),y){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,f),!0;case 3:return m.fn.call(m.context,f,d),!0;case 4:return m.fn.call(m.context,f,d,h),!0;case 5:return m.fn.call(m.context,f,d,h,c),!0;case 6:return m.fn.call(m.context,f,d,h,c,v),!0}for(T=1,E=new Array(y-1);T<y;T++)E[T-1]=arguments[T];m.fn.apply(m.context,E)}else{var S=m.length,A;for(T=0;T<S;T++)switch(m[T].once&&this.removeListener(u,m[T].fn,void 0,!0),y){case 1:m[T].fn.call(m[T].context);break;case 2:m[T].fn.call(m[T].context,f);break;case 3:m[T].fn.call(m[T].context,f,d);break;case 4:m[T].fn.call(m[T].context,f,d,h);break;default:if(!E)for(A=1,E=new Array(y-1);A<y;A++)E[A-1]=arguments[A];m[T].fn.apply(m[T].context,E)}}return!0},s.prototype.on=function(u,f,d){return t(this,u,f,d,!1)},s.prototype.once=function(u,f,d){return t(this,u,f,d,!0)},s.prototype.removeListener=function(u,f,d,h){var c=n?n+u:u;if(!this._events[c])return this;if(!f)return i(this,c),this;var v=this._events[c];if(v.fn)v.fn===f&&(!h||v.once)&&(!d||v.context===d)&&i(this,c);else{for(var g=0,m=[],y=v.length;g<y;g++)(v[g].fn!==f||h&&!v[g].once||d&&v[g].context!==d)&&m.push(v[g]);m.length?this._events[c]=m.length===1?m[0]:m:i(this,c)}return this},s.prototype.removeAllListeners=function(u){var f;return u?(f=n?n+u:u,this._events[f]&&i(this,f)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,a.exports=s}(Ot)),Ot.exports}var Bt=Yt(),ce=Je(Bt),me={exports:{}},at;function we(){return at||(at=1,function(a,o){(function(n){var r=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,e=/^(?=([^\/?#]*))\1([^]*)$/,t=/(?:\/|^)\.(?=\/)/g,i=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,s={buildAbsoluteURL:function(l,u,f){if(f=f||{},l=l.trim(),u=u.trim(),!u){if(!f.alwaysNormalize)return l;var d=s.parseURL(l);if(!d)throw new Error("Error trying to parse base URL.");return d.path=s.normalizePath(d.path),s.buildURLFromParts(d)}var h=s.parseURL(u);if(!h)throw new Error("Error trying to parse relative URL.");if(h.scheme)return f.alwaysNormalize?(h.path=s.normalizePath(h.path),s.buildURLFromParts(h)):u;var c=s.parseURL(l);if(!c)throw new Error("Error trying to parse base URL.");if(!c.netLoc&&c.path&&c.path[0]!=="/"){var v=e.exec(c.path);c.netLoc=v[1],c.path=v[2]}c.netLoc&&!c.path&&(c.path="/");var g={scheme:c.scheme,netLoc:h.netLoc,path:null,params:h.params,query:h.query,fragment:h.fragment};if(!h.netLoc&&(g.netLoc=c.netLoc,h.path[0]!=="/"))if(!h.path)g.path=c.path,h.params||(g.params=c.params,h.query||(g.query=c.query));else{var m=c.path,y=m.substring(0,m.lastIndexOf("/")+1)+h.path;g.path=s.normalizePath(y)}return g.path===null&&(g.path=f.alwaysNormalize?s.normalizePath(h.path):h.path),s.buildURLFromParts(g)},parseURL:function(l){var u=r.exec(l);return u?{scheme:u[1]||"",netLoc:u[2]||"",path:u[3]||"",params:u[4]||"",query:u[5]||"",fragment:u[6]||""}:null},normalizePath:function(l){for(l=l.split("").reverse().join("").replace(t,"");l.length!==(l=l.replace(i,"")).length;);return l.split("").reverse().join("")},buildURLFromParts:function(l){return l.scheme+l.netLoc+l.path+l.params+l.query+l.fragment}};a.exports=s})()}(me)),me.exports}var Ze=we(),N=Number.isFinite||function(a){return typeof a=="number"&&isFinite(a)},Te=Number.isSafeInteger||function(a){return typeof a=="number"&&Math.abs(a)<=Be},Be=Number.MAX_SAFE_INTEGER||9007199254740991,V=function(a){return a.NETWORK_ERROR="networkError",a.MEDIA_ERROR="mediaError",a.KEY_SYSTEM_ERROR="keySystemError",a.MUX_ERROR="muxError",a.OTHER_ERROR="otherError",a}({}),_=function(a){return a.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",a.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",a.KEY_SYSTEM_NO_SESSION="keySystemNoSession",a.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",a.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",a.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",a.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",a.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",a.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",a.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",a.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",a.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",a.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",a.MANIFEST_LOAD_ERROR="manifestLoadError",a.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",a.MANIFEST_PARSING_ERROR="manifestParsingError",a.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",a.LEVEL_EMPTY_ERROR="levelEmptyError",a.LEVEL_LOAD_ERROR="levelLoadError",a.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",a.LEVEL_PARSING_ERROR="levelParsingError",a.LEVEL_SWITCH_ERROR="levelSwitchError",a.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",a.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",a.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",a.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",a.FRAG_LOAD_ERROR="fragLoadError",a.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",a.FRAG_DECRYPT_ERROR="fragDecryptError",a.FRAG_PARSING_ERROR="fragParsingError",a.FRAG_GAP="fragGap",a.REMUX_ALLOC_ERROR="remuxAllocError",a.KEY_LOAD_ERROR="keyLoadError",a.KEY_LOAD_TIMEOUT="keyLoadTimeOut",a.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",a.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",a.BUFFER_APPEND_ERROR="bufferAppendError",a.BUFFER_APPENDING_ERROR="bufferAppendingError",a.BUFFER_STALLED_ERROR="bufferStalledError",a.BUFFER_FULL_ERROR="bufferFullError",a.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",a.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",a.ASSET_LIST_LOAD_ERROR="assetListLoadError",a.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",a.ASSET_LIST_PARSING_ERROR="assetListParsingError",a.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",a.INTERNAL_EXCEPTION="internalException",a.INTERNAL_ABORTED="aborted",a.ATTACH_MEDIA_ERROR="attachMediaError",a.UNKNOWN="unknown",a}({}),p=function(a){return a.MEDIA_ATTACHING="hlsMediaAttaching",a.MEDIA_ATTACHED="hlsMediaAttached",a.MEDIA_DETACHING="hlsMediaDetaching",a.MEDIA_DETACHED="hlsMediaDetached",a.MEDIA_ENDED="hlsMediaEnded",a.STALL_RESOLVED="hlsStallResolved",a.BUFFER_RESET="hlsBufferReset",a.BUFFER_CODECS="hlsBufferCodecs",a.BUFFER_CREATED="hlsBufferCreated",a.BUFFER_APPENDING="hlsBufferAppending",a.BUFFER_APPENDED="hlsBufferAppended",a.BUFFER_EOS="hlsBufferEos",a.BUFFERED_TO_END="hlsBufferedToEnd",a.BUFFER_FLUSHING="hlsBufferFlushing",a.BUFFER_FLUSHED="hlsBufferFlushed",a.MANIFEST_LOADING="hlsManifestLoading",a.MANIFEST_LOADED="hlsManifestLoaded",a.MANIFEST_PARSED="hlsManifestParsed",a.LEVEL_SWITCHING="hlsLevelSwitching",a.LEVEL_SWITCHED="hlsLevelSwitched",a.LEVEL_LOADING="hlsLevelLoading",a.LEVEL_LOADED="hlsLevelLoaded",a.LEVEL_UPDATED="hlsLevelUpdated",a.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",a.LEVELS_UPDATED="hlsLevelsUpdated",a.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",a.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",a.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",a.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",a.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",a.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",a.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",a.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",a.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",a.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",a.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",a.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",a.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",a.CUES_PARSED="hlsCuesParsed",a.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",a.INIT_PTS_FOUND="hlsInitPtsFound",a.FRAG_LOADING="hlsFragLoading",a.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",a.FRAG_LOADED="hlsFragLoaded",a.FRAG_DECRYPTED="hlsFragDecrypted",a.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",a.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",a.FRAG_PARSING_METADATA="hlsFragParsingMetadata",a.FRAG_PARSED="hlsFragParsed",a.FRAG_BUFFERED="hlsFragBuffered",a.FRAG_CHANGED="hlsFragChanged",a.FPS_DROP="hlsFpsDrop",a.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",a.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",a.ERROR="hlsError",a.DESTROYING="hlsDestroying",a.KEY_LOADING="hlsKeyLoading",a.KEY_LOADED="hlsKeyLoaded",a.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",a.BACK_BUFFER_REACHED="hlsBackBufferReached",a.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",a.ASSET_LIST_LOADING="hlsAssetListLoading",a.ASSET_LIST_LOADED="hlsAssetListLoaded",a.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",a.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",a.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",a.INTERSTITIAL_STARTED="hlsInterstitialStarted",a.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",a.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",a.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",a.INTERSTITIAL_ENDED="hlsInterstitialEnded",a.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",a.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",a.EVENT_CUE_ENTER="hlsEventCueEnter",a}({}),j={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},K={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"},ve=function(){function a(n,r,e){r===void 0&&(r=0),e===void 0&&(e=0),this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=n,this.alpha_=n?Math.exp(Math.log(.5)/n):0,this.estimate_=r,this.totalWeight_=e}var o=a.prototype;return o.sample=function(r,e){var t=Math.pow(this.alpha_,r);this.estimate_=e*(1-t)+t*this.estimate_,this.totalWeight_+=r},o.getTotalWeight=function(){return this.totalWeight_},o.getEstimate=function(){if(this.alpha_){var r=1-Math.pow(this.alpha_,this.totalWeight_);if(r)return this.estimate_/r}return this.estimate_},a}(),$=function(){function a(n,r,e,t){t===void 0&&(t=100),this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=e,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new ve(n),this.fast_=new ve(r),this.defaultTTFB_=t,this.ttfb_=new ve(n)}var o=a.prototype;return o.update=function(r,e){var t=this.slow_,i=this.fast_,s=this.ttfb_;t.halfLife!==r&&(this.slow_=new ve(r,t.getEstimate(),t.getTotalWeight())),i.halfLife!==e&&(this.fast_=new ve(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==r&&(this.ttfb_=new ve(r,s.getEstimate(),s.getTotalWeight()))},o.sample=function(r,e){r=Math.max(r,this.minDelayMs_);var t=8*e,i=r/1e3,s=t/i;this.fast_.sample(i,s),this.slow_.sample(i,s)},o.sampleTTFB=function(r){var e=r/1e3,t=Math.sqrt(2)*Math.exp(-Math.pow(e,2)/2);this.ttfb_.sample(t,Math.max(r,5))},o.canEstimate=function(){return this.fast_.getTotalWeight()>=this.minWeight_},o.getEstimate=function(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_},o.getEstimateTTFB=function(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_},o.destroy=function(){},z(a,[{key:"defaultEstimate",get:function(){return this.defaultEstimate_}}])}(),ie=function(o,n){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;var r="["+o+"]:";this.trace=Ee,this.debug=n.debug.bind(null,r),this.log=n.log.bind(null,r),this.warn=n.warn.bind(null,r),this.info=n.info.bind(null,r),this.error=n.error.bind(null,r)},Ee=function(){},qt={trace:Ee,debug:Ee,log:Ee,warn:Ee,info:Ee,error:Ee};function Fe(){return ae({},qt)}function Ce(a,o){var n=self.console[a];return n?n.bind(self.console,(o?"["+o+"] ":"")+"["+a+"] >"):Ee}function xt(a,o,n){return o[a]?o[a].bind(o):Ce(a,n)}var gt=Fe();function _t(a,o,n){var r=Fe();if(typeof console=="object"&&a===!0||typeof a=="object"){var e=["debug","log","info","warn","error"];e.forEach(function(t){r[t]=xt(t,a,n)});try{r.log('Debug logs enabled for "'+o+'" in hls.js version 1.6.2')}catch{return Fe()}e.forEach(function(t){gt[t]=xt(t,a)})}else ae(gt,r);return r}var X=gt;function re(a){if(a===void 0&&(a=!0),!(typeof self>"u")){var o=(a||!self.MediaSource)&&self.ManagedMediaSource;return o||self.MediaSource||self.WebKitMediaSource}}function pe(a){return typeof self<"u"&&a===self.ManagedMediaSource}function Rt(a,o){var n=Object.keys(a),r=Object.keys(o),e=n.length,t=r.length;return!e||!t||e===t&&!n.some(function(i){return r.indexOf(i)===-1})}function Ge(a,o){if(o===void 0&&(o=!1),typeof TextDecoder<"u"){var n=new TextDecoder("utf-8"),r=n.decode(a);if(o){var e=r.indexOf("\0");return e!==-1?r.substring(0,e):r}return r.replace(/\0/g,"")}for(var t=a.length,i,s,l,u="",f=0;f<t;){if(i=a[f++],i===0&&o)return u;if(i===0||i===3)continue;switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:u+=String.fromCharCode(i);break;case 12:case 13:s=a[f++],u+=String.fromCharCode((i&31)<<6|s&63);break;case 14:s=a[f++],l=a[f++],u+=String.fromCharCode((i&15)<<12|(s&63)<<6|(l&63)<<0);break}}return u}var Ne={hexDump:function(o){for(var n="",r=0;r<o.length;r++){var e=o[r].toString(16);e.length<2&&(e="0"+e),n+=e}return n}},_e=function(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}},oe={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"},mt=function(){function a(n){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,typeof n=="string"&&(n={url:n}),this.base=n,kt(this,"stats")}var o=a.prototype;return o.setByteRange=function(r,e){var t=r.split("@",2),i;t.length===1?i=(e==null?void 0:e.byteRangeEndOffset)||0:i=parseInt(t[1]),this._byteRange=[i,parseInt(t[0])+i]},o.clearElementaryStreamInfo=function(){var r=this.elementaryStreams;r[oe.AUDIO]=null,r[oe.VIDEO]=null,r[oe.AUDIOVIDEO]=null},z(a,[{key:"baseurl",get:function(){return this.base.url}},{key:"byteRange",get:function(){return this._byteRange===null?[]:this._byteRange}},{key:"byteRangeStartOffset",get:function(){return this.byteRange[0]}},{key:"byteRangeEndOffset",get:function(){return this.byteRange[1]}},{key:"elementaryStreams",get:function(){if(this._streams===null){var r;this._streams=(r={},r[oe.AUDIO]=null,r[oe.VIDEO]=null,r[oe.AUDIOVIDEO]=null,r)}return this._streams},set:function(r){this._streams=r}},{key:"hasStats",get:function(){return this._stats!==null}},{key:"hasStreams",get:function(){return this._streams!==null}},{key:"stats",get:function(){return this._stats===null&&(this._stats=new _e),this._stats},set:function(r){this._stats=r}},{key:"url",get:function(){return!this._url&&this.baseurl&&this.relurl&&(this._url=Ze.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""},set:function(r){this._url=r}}])}();function Ie(a){return a.sn!=="initSegment"}var Dt=function(a){function o(r,e){var t;return t=a.call(this,e)||this,t._decryptdata=null,t._programDateTime=null,t._ref=null,t._bitrate=void 0,t.rawProgramDateTime=null,t.tagList=[],t.duration=0,t.sn=0,t.levelkeys=void 0,t.type=void 0,t.loader=null,t.keyLoader=null,t.level=-1,t.cc=0,t.startPTS=void 0,t.endPTS=void 0,t.startDTS=void 0,t.endDTS=void 0,t.start=0,t.playlistOffset=0,t.deltaPTS=void 0,t.maxStartPTS=void 0,t.minEndPTS=void 0,t.data=void 0,t.bitrateTest=!1,t.title=null,t.initSegment=null,t.endList=void 0,t.gap=void 0,t.urlId=0,t.type=r,t}J(o,a);var n=o.prototype;return n.addStart=function(e){this.setStart(this.start+e)},n.setStart=function(e){this.start=e,this._ref&&(this._ref.start=e)},n.setDuration=function(e){this.duration=e,this._ref&&(this._ref.duration=e)},n.setKeyFormat=function(e){if(this.levelkeys){var t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}},n.abortRequests=function(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()},n.setElementaryStreamInfo=function(e,t,i,s,l,u){u===void 0&&(u=!1);var f=this.elementaryStreams,d=f[e];if(!d){f[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:l,partial:u};return}d.startPTS=Math.min(d.startPTS,t),d.endPTS=Math.max(d.endPTS,i),d.startDTS=Math.min(d.startDTS,s),d.endDTS=Math.max(d.endDTS,l)},z(o,[{key:"byteLength",get:function(){if(this.hasStats){var e=this.stats.total;if(e)return e}if(this.byteRange){var t=this.byteRange[0],i=this.byteRange[1];if(N(t)&&N(i))return i-t}return null}},{key:"bitrate",get:function(){return this.byteLength?this.byteLength*8/this.duration:this._bitrate?this._bitrate:null},set:function(e){this._bitrate=e}},{key:"decryptdata",get:function(){var e=this.levelkeys;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){var t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{var i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}},{key:"end",get:function(){return this.start+this.duration}},{key:"endProgramDateTime",get:function(){if(this.programDateTime===null)return null;var e=N(this.duration)?this.duration:0;return this.programDateTime+e*1e3}},{key:"encrypted",get:function(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){var t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}},{key:"programDateTime",get:function(){return this._programDateTime===null&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime},set:function(e){if(!N(e)){this._programDateTime=this.rawProgramDateTime=null;return}this._programDateTime=e}},{key:"ref",get:function(){return Ie(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}}])}(mt),It=function(a){function o(n,r,e,t,i){var s;s=a.call(this,e)||this,s.fragOffset=0,s.duration=0,s.gap=!1,s.independent=!1,s.relurl=void 0,s.fragment=void 0,s.index=void 0,s.duration=n.decimalFloatingPoint("DURATION"),s.gap=n.bool("GAP"),s.independent=n.bool("INDEPENDENT"),s.relurl=n.enumeratedString("URI"),s.fragment=r,s.index=t;var l=n.enumeratedString("BYTERANGE");return l&&s.setByteRange(l,i),i&&(s.fragOffset=i.fragOffset+i.duration),s}return J(o,a),z(o,[{key:"start",get:function(){return this.fragment.start+this.fragOffset}},{key:"end",get:function(){return this.start+this.duration}},{key:"loaded",get:function(){var r=this.elementaryStreams;return!!(r.audio||r.video||r.audiovideo)}}])}(mt);function nr(a,o){var n=Object.getPrototypeOf(a);if(n){var r=Object.getOwnPropertyDescriptor(n,o);return r||nr(n,o)}}function kt(a,o){var n=nr(a,o);n&&(n.enumerable=!0,Object.defineProperty(a,o,n))}var Lt=Math.pow(2,32)-1,Sr=[].push,ar={video:1,audio:2,id3:3,text:4};function je(a){return String.fromCharCode.apply(null,a)}function Ar(a,o){var n=a[o]<<8|a[o+1];return n<0?65536+n:n}function se(a,o){var n=Oa(a,o);return n<0?4294967296+n:n}function Ma(a,o){var n=se(a,o);return n*=Math.pow(2,32),n+=se(a,o+4),n}function Oa(a,o){return a[o]<<24|a[o+1]<<16|a[o+2]<<8|a[o+3]}function dn(a,o,n){a[o]=n>>24,a[o+1]=n>>16&255,a[o+2]=n>>8&255,a[o+3]=n&255}function xl(a){for(var o=a.byteLength,n=0;n<o;){var r=se(a,n);if(r>8&&a[n+4]===109&&a[n+5]===111&&a[n+6]===111&&a[n+7]===102)return!0;n=r>1?n+r:o}return!1}function ue(a,o){var n=[];if(!o.length)return n;for(var r=a.byteLength,e=0;e<r;){var t=se(a,e),i=je(a.subarray(e+4,e+8)),s=t>1?e+t:r;if(i===o[0])if(o.length===1)n.push(a.subarray(e+8,s));else{var l=ue(a.subarray(e+8,s),o.slice(1));l.length&&Sr.apply(n,l)}e=s}return n}function Ll(a){var o=[],n=a[0],r=8,e=se(a,r);r+=4;var t=0,i=0;n===0?(t=se(a,r),i=se(a,r+4),r+=8):(t=Ma(a,r),i=Ma(a,r+8),r+=16),r+=2;var s=a.length+i,l=Ar(a,r);r+=2;for(var u=0;u<l;u++){var f=r,d=se(a,f);f+=4;var h=d&2147483647,c=(d&2147483648)>>>31;if(c===1)return X.warn("SIDX has hierarchical references (not supported)"),null;var v=se(a,f);f+=4,o.push({referenceSize:h,subsegmentDuration:v,info:{duration:v/e,start:s,end:s+h-1}}),s+=h,f+=4,r=f}return{earliestPresentationTime:t,timescale:e,version:n,referencesCount:l,references:o}}function Fa(a){for(var o=[],n=ue(a,["moov","trak"]),r=0;r<n.length;r++){var e=n[r],t=ue(e,["tkhd"])[0];if(t){var i=t[0],s=se(t,i===0?12:20),l=ue(e,["mdia","mdhd"])[0];if(l){i=l[0];var u=se(l,i===0?12:20),f=ue(e,["mdia","hdlr"])[0];if(f){var d=je(f.subarray(8,12)),h={soun:oe.AUDIO,vide:oe.VIDEO}[d],c=ue(e,["mdia","minf","stbl","stsd"])[0],v=bl(c);h?(o[s]={timescale:u,type:h,stsd:v},o[h]=Q({timescale:u,id:s},v)):o[s]={timescale:u,type:d,stsd:v}}}}}var g=ue(a,["moov","mvex","trex"]);return g.forEach(function(m){var y=se(m,4),E=o[y];E&&(E.default={duration:se(m,12),flags:se(m,20)})}),o}function bl(a){var o=a.subarray(8),n=o.subarray(86),r=je(o.subarray(4,8)),e=r,t,i=r==="enca"||r==="encv";if(i){var s=ue(o,[r])[0],l=s.subarray(r==="enca"?28:78),u=ue(l,["sinf"]);u.forEach(function(yt){var ct=ue(yt,["schm"])[0];if(ct){var ft=je(ct.subarray(4,8));if(ft==="cbcs"||ft==="cenc"){var ze=ue(yt,["frma"])[0];ze&&(e=je(ze))}}})}var f=e;switch(e){case"avc1":case"avc2":case"avc3":case"avc4":{var d=ue(n,["avcC"])[0];d&&d.length>3&&(e+="."+mi(d[1])+mi(d[2])+mi(d[3]),t=gi(f==="avc1"?"dva1":"dvav",n));break}case"mp4a":{var h=ue(o,[r])[0],c=ue(h.subarray(28),["esds"])[0];if(c&&c.length>7){var v=4;if(c[v++]!==3)break;v=hn(c,v),v+=2;var g=c[v++];if(g&128&&(v+=2),g&64&&(v+=c[v++]),c[v++]!==4)break;v=hn(c,v);var m=c[v++];if(m===64)e+="."+mi(m);else break;if(v+=12,c[v++]!==5)break;v=hn(c,v);var y=c[v++],E=(y&248)>>3;E===31&&(E+=1+((y&7)<<3)+((c[v]&224)>>5)),e+="."+E}break}case"hvc1":case"hev1":{var T=ue(n,["hvcC"])[0];if(T&&T.length>12){var S=T[1],A=["","A","B","C"][S>>6],x=S&31,L=se(T,2),I=(S&32)>>5?"H":"L",k=T[12],R=T.subarray(6,12);e+="."+A+x,e+="."+L.toString(16).toUpperCase(),e+="."+I+k;for(var b="",D=R.length;D--;){var P=R[D];if(P||b){var U=P.toString(16).toUpperCase();b="."+U+b}}e+=b}t=gi(f=="hev1"?"dvhe":"dvh1",n);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":{e=gi(e,n)||e;break}case"vp09":{var F=ue(n,["vpcC"])[0];if(F&&F.length>6){var M=F[4],H=F[5],q=F[6]>>4&15;e+="."+Qt(M)+"."+Qt(H)+"."+Qt(q)}break}case"av01":{var W=ue(n,["av1C"])[0];if(W&&W.length>2){var ee=W[1]>>>5,ye=W[1]&31,le=W[2]>>>7?"H":"M",Ae=(W[2]&64)>>6,de=(W[2]&32)>>5,xe=ee===2&&Ae?de?12:10:Ae?10:8,Le=(W[2]&16)>>4,Me=(W[2]&8)>>3,tt=(W[2]&4)>>2,Xe=W[2]&3,Ke=1,rt=1,We=1,ge=0;e+="."+ee+"."+Qt(ye)+le+"."+Qt(xe)+"."+Le+"."+Me+tt+Xe+"."+Qt(Ke)+"."+Qt(rt)+"."+Qt(We)+"."+ge,t=gi("dav1",n)}break}}return{codec:e,encrypted:i,supplemental:t}}function gi(a,o){var n=ue(o,["dvvC"]),r=n.length?n[0]:ue(o,["dvcC"])[0];if(r){var e=r[2]>>1&127,t=r[2]<<5&32|r[3]>>3&31;return a+"."+Qt(e)+"."+Qt(t)}}function hn(a,o){for(var n=o+5;a[o++]&128&&o<n;);return o}function mi(a){return("0"+a.toString(16).toUpperCase()).slice(-2)}function Qt(a){return(a<10?"0":"")+a}function Rl(a,o){if(!a||!o)return a;var n=o.keyId;if(n&&o.isCommonEncryption){var r=ue(a,["moov","trak"]);r.forEach(function(e){var t=ue(e,["mdia","minf","stbl","stsd"])[0],i=t.subarray(8),s=ue(i,["enca"]),l=s.length>0;l||(s=ue(i,["encv"])),s.forEach(function(u){var f=l?u.subarray(28):u.subarray(78),d=ue(f,["sinf"]);d.forEach(function(h){var c=Na(h);if(c){var v=c.subarray(8,24);v.some(function(g){return g!==0})||(X.log("[eme] Patching keyId in 'enc"+(l?"a":"v")+">sinf>>tenc' box: "+Ne.hexDump(v)+" -> "+Ne.hexDump(n)),c.set(n,8))}})})})}return a}function Na(a){var o=ue(a,["schm"])[0];if(o){var n=je(o.subarray(4,8));if(n==="cbcs"||n==="cenc")return ue(a,["schi","tenc"])[0]}return null}function Il(a,o){return ue(o,["moof","traf"]).reduce(function(n,r){var e=ue(r,["tfdt"])[0],t=e[0],i=ue(r,["tfhd"]).reduce(function(s,l){var u=se(l,4),f=a[u];if(f){var d=se(e,4);if(t===1){if(d===Lt)return X.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),s;d*=Lt+1,d+=se(e,8)}var h=f.timescale||9e4,c=d/h;if(N(c)&&(s===null||c<s))return c}return s},null);return i!==null&&N(i)&&(n===null||i<n)?i:n},null)}function _l(a,o){for(var n=0,r=0,e=0,t=ue(a,["moof","traf"]),i=0;i<t.length;i++){var s=t[i],l=ue(s,["tfhd"])[0],u=se(l,4),f=o[u];if(f){var d=f.default,h=se(l,0)|(d==null?void 0:d.flags),c=d==null?void 0:d.duration;h&8&&(h&2?c=se(l,12):c=se(l,8));for(var v=f.timescale||9e4,g=ue(s,["trun"]),m=0;m<g.length;m++){if(n=Dl(g[m]),!n&&c){var y=se(g[m],4);n=c*y}f.type===oe.VIDEO?r+=n/v:f.type===oe.AUDIO&&(e+=n/v)}}}if(r===0&&e===0){for(var E=1/0,T=0,S=0,A=ue(a,["sidx"]),x=0;x<A.length;x++){var L=Ll(A[x]);if(L!=null&&L.references){E=Math.min(E,L.earliestPresentationTime/L.timescale);var I=L.references.reduce(function(k,R){return k+R.info.duration||0},0);T=Math.max(T,I+L.earliestPresentationTime/L.timescale),S=T-E}}if(S&&N(S))return S}return r||e}function Dl(a){var o=se(a,0),n=8;o&1&&(n+=4),o&4&&(n+=4);for(var r=0,e=se(a,4),t=0;t<e;t++){if(o&256){var i=se(a,n);r+=i,n+=4}o&512&&(n+=4),o&1024&&(n+=4),o&2048&&(n+=4)}return r}function kl(a,o,n){ue(o,["moof","traf"]).forEach(function(r){ue(r,["tfhd"]).forEach(function(e){var t=se(e,4),i=a[t];if(i){var s=i.timescale||9e4;ue(r,["tfdt"]).forEach(function(l){var u=l[0],f=n*s;if(f){var d=se(l,4);if(u===0)d-=f,d=Math.max(d,0),dn(l,4,d);else{d*=Math.pow(2,32),d+=se(l,8),d-=f,d=Math.max(d,0);var h=Math.floor(d/(Lt+1)),c=Math.floor(d%(Lt+1));dn(l,4,h),dn(l,8,c)}}})}})})}function Cl(a){var o={valid:null,remainder:null},n=ue(a,["moof"]);if(n.length<2)return o.remainder=a,o;var r=n[n.length-1];return o.valid=a.slice(0,r.byteOffset-8),o.remainder=a.slice(r.byteOffset-8),o}function Gt(a,o){var n=new Uint8Array(a.length+o.length);return n.set(a),n.set(o,a.length),n}function Ua(a,o){var n=[],r=o.samples,e=o.timescale,t=o.id,i=!1,s=ue(r,["moof"]);return s.map(function(l){var u=l.byteOffset-8,f=ue(l,["traf"]);f.map(function(d){var h=ue(d,["tfdt"]).map(function(c){var v=c[0],g=se(c,4);return v===1&&(g*=Math.pow(2,32),g+=se(c,8)),g/e})[0];return h!==void 0&&(a=h),ue(d,["tfhd"]).map(function(c){var v=se(c,4),g=se(c,0)&16777215,m=(g&1)!==0,y=(g&2)!==0,E=(g&8)!==0,T=0,S=(g&16)!==0,A=0,x=(g&32)!==0,L=8;v===t&&(m&&(L+=8),y&&(L+=4),E&&(T=se(c,L),L+=4),S&&(A=se(c,L),L+=4),x&&(L+=4),o.type==="video"&&(i=pi(o.codec)),ue(d,["trun"]).map(function(I){var k=I[0],R=se(I,0)&16777215,b=(R&1)!==0,D=0,P=(R&4)!==0,U=(R&256)!==0,F=0,M=(R&512)!==0,H=0,q=(R&1024)!==0,W=(R&2048)!==0,ee=0,ye=se(I,4),le=8;b&&(D=se(I,le),le+=4),P&&(le+=4);for(var Ae=D+u,de=0;de<ye;de++){if(U?(F=se(I,le),le+=4):F=T,M?(H=se(I,le),le+=4):H=A,q&&(le+=4),W&&(k===0?ee=se(I,le):ee=Oa(I,le),le+=4),o.type===oe.VIDEO)for(var xe=0;xe<H;){var Le=se(r,Ae);if(Ae+=4,Pl(i,r[Ae])){var Me=r.subarray(Ae,Ae+Le);cn(Me,i?2:1,a+ee/e,n)}Ae+=Le,xe+=Le+4}a+=F/e}}))})})}),n}function pi(a){if(!a)return!1;var o=a.substring(0,4);return o==="hvc1"||o==="hev1"||o==="dvh1"||o==="dvhe"}function Pl(a,o){if(a){var n=o>>1&63;return n===39||n===40}else{var r=o&31;return r===6}}function cn(a,o,n,r){var e=Ba(a),t=0;t+=o;for(var i=0,s=0,l=0;t<e.length;){i=0;do{if(t>=e.length)break;l=e[t++],i+=l}while(l===255);s=0;do{if(t>=e.length)break;l=e[t++],s+=l}while(l===255);var u=e.length-t,f=t;if(s<u)t+=s;else if(s>u){X.error("Malformed SEI payload. "+s+" is too small, only "+u+" bytes left to parse.");break}if(i===4){var d=e[f++];if(d===181){var h=Ar(e,f);if(f+=2,h===49){var c=se(e,f);if(f+=4,c===1195456820){var v=e[f++];if(v===3){var g=e[f++],m=31&g,y=64&g,E=y?2+m*3:0,T=new Uint8Array(E);if(y){T[0]=g;for(var S=1;S<E;S++)T[S]=e[f++]}r.push({type:v,payloadType:i,pts:n,bytes:T})}}}}}else if(i===5&&s>16){for(var A=[],x=0;x<16;x++){var L=e[f++].toString(16);A.push(L.length==1?"0"+L:L),(x===3||x===5||x===7||x===9)&&A.push("-")}for(var I=s-16,k=new Uint8Array(I),R=0;R<I;R++)k[R]=e[f++];r.push({payloadType:i,pts:n,uuid:A.join(""),userData:Ge(k),userDataBytes:k})}}}function Ba(a){for(var o=a.byteLength,n=[],r=1;r<o-2;)a[r]===0&&a[r+1]===0&&a[r+2]===3?(n.push(r+2),r+=2):r++;if(n.length===0)return a;var e=o-n.length,t=new Uint8Array(e),i=0;for(r=0;r<e;i++,r++)i===n[0]&&(i++,n.shift()),t[r]=a[i];return t}function wl(a){var o=a[0],n="",r="",e=0,t=0,i=0,s=0,l=0,u=0;if(o===0){for(;je(a.subarray(u,u+1))!=="\0";)n+=je(a.subarray(u,u+1)),u+=1;for(n+=je(a.subarray(u,u+1)),u+=1;je(a.subarray(u,u+1))!=="\0";)r+=je(a.subarray(u,u+1)),u+=1;r+=je(a.subarray(u,u+1)),u+=1,e=se(a,12),t=se(a,16),s=se(a,20),l=se(a,24),u=28}else if(o===1){u+=4,e=se(a,u),u+=4;var f=se(a,u);u+=4;var d=se(a,u);for(u+=4,i=Math.pow(2,32)*f+d,Te(i)||(i=Number.MAX_SAFE_INTEGER,X.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),s=se(a,u),u+=4,l=se(a,u),u+=4;je(a.subarray(u,u+1))!=="\0";)n+=je(a.subarray(u,u+1)),u+=1;for(n+=je(a.subarray(u,u+1)),u+=1;je(a.subarray(u,u+1))!=="\0";)r+=je(a.subarray(u,u+1)),u+=1;r+=je(a.subarray(u,u+1)),u+=1}var h=a.subarray(u,a.byteLength);return{schemeIdUri:n,value:r,timeScale:e,presentationTime:i,presentationTimeDelta:t,eventDuration:s,id:l,payload:h}}function Ml(a){for(var o=arguments.length,n=new Array(o>1?o-1:0),r=1;r<o;r++)n[r-1]=arguments[r];for(var e=n.length,t=8,i=e;i--;)t+=n[i].byteLength;var s=new Uint8Array(t);for(s[0]=t>>24&255,s[1]=t>>16&255,s[2]=t>>8&255,s[3]=t&255,s.set(a,4),i=0,t=8;i<e;i++)s.set(n[i],t),t+=n[i].byteLength;return s}function Ol(a,o,n){if(a.byteLength!==16)throw new RangeError("Invalid system id");var r,e;r=0,e=new Uint8Array;var t;r>0?(t=new Uint8Array(4),o.length>0&&new DataView(t.buffer).setUint32(0,o.length,!1)):t=new Uint8Array;var i=new Uint8Array(4);return n&&n.byteLength>0&&new DataView(i.buffer).setUint32(0,n.byteLength,!1),Ml([112,115,115,104],new Uint8Array([r,0,0,0]),a,t,e,i,n||new Uint8Array)}function Fl(a){var o=[];if(a instanceof ArrayBuffer)for(var n=a.byteLength,r=0;r+32<n;){var e=new DataView(a,r),t=Nl(e);o.push(t),r+=t.size}return o}function Nl(a){var o=a.getUint32(0),n=a.byteOffset,r=a.byteLength;if(r<o)return{offset:n,size:r};var e=a.getUint32(4);if(e!==1886614376)return{offset:n,size:o};var t=a.getUint32(8)>>>24;if(t!==0&&t!==1)return{offset:n,size:o};var i=a.buffer,s=Ne.hexDump(new Uint8Array(i,n+12,16)),l=a.getUint32(28),u=null,f=null;if(t===0){if(o-32<l||l<22)return{offset:n,size:o};f=new Uint8Array(i,n+32,l)}else if(t===1){if(!l||r<n+32+l*16+16)return{offset:n,size:o};u=[];for(var d=0;d<l;d++)u.push(new Uint8Array(i,n+32+d*16,16))}return{version:t,systemId:s,kids:u,data:f,offset:n,size:o}}var Ga=function(){return/\(Windows.+Firefox\//i.test(navigator.userAgent)},Pr={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Ka(a,o){var n=Pr[o];return!!n&&!!n[a.slice(0,4)]}function vn(a,o,n){return n===void 0&&(n=!0),!a.split(",").some(function(r){return!Ha(r,o,n)})}function Ha(a,o,n){var r;n===void 0&&(n=!0);var e=re(n);return(r=e==null?void 0:e.isTypeSupported(Qr(a,o)))!=null?r:!1}function Qr(a,o){return o+"/mp4;codecs="+a}function Va(a){if(a){var o=a.substring(0,4);return Pr.video[o]}return 2}function yi(a){var o=Ga();return a.split(",").reduce(function(n,r){var e=o&&pi(r),t=e?9:Pr.video[r];return t?(t*2+n)/(n?3:2):(Pr.audio[r]+n)/(n?2:1)},0)}var gn={};function Ul(a,o){if(o===void 0&&(o=!0),gn[a])return gn[a];for(var n={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[a],r=0;r<n.length;r++){var e;if(Ha(n[r],"audio",o))return gn[a]=n[r],n[r];if(n[r]==="mp3"&&(e=re(o))!=null&&e.isTypeSupported("audio/mpeg"))return""}return a}var Bl=/flac|opus|mp4a\.40\.34/i;function Ei(a,o){return o===void 0&&(o=!0),a.replace(Bl,function(n){return Ul(n.toLowerCase(),o)})}function Gl(a,o){var n=[];if(a)for(var r=a.split(","),e=0;e<r.length;e++)Ka(r[e],"video")||n.push(r[e]);return o&&n.push(o),n.join(",")}function Ti(a,o){if(a&&(a.length>4||["ac-3","ec-3","alac","fLaC","Opus"].indexOf(a)!==-1))return a;if(o){var n=o.split(",");if(n.length>1){if(a){for(var r=n.length;r--;)if(n[r].substring(0,4)===a.substring(0,4))return n[r]}return n[0]}}return o||a}function Kl(a){for(var o=a.split(","),n=0;n<o.length;n++){var r=o[n].split(".");if(r.length>2){var e=r.shift()+".";e+=parseInt(r.shift()).toString(16),e+=("000"+parseInt(r.shift()).toString(16)).slice(-4),o[n]=e}}return o.join(",")}function Hl(a){if(a.startsWith("av01.")){for(var o=a.split("."),n=["0","111","01","01","01","0"],r=o.length;r>4&&r<10;r++)o[r]=n[r-4];return o.join(".")}return a}function Wa(a){var o=re(a)||{isTypeSupported:function(){return!1}};return{mpeg:o.isTypeSupported("audio/mpeg"),mp3:o.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:o.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Ya(a){return a.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}var qa={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function ja(a,o){return{supported:!1,configurations:o,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:a}}var Xa={};function Vl(a,o,n,r,e,t){var i=a.audioCodec?a.audioGroups:null,s=t==null?void 0:t.audioCodec,l=t==null?void 0:t.channels,u=l?parseInt(l):s?1/0:2,f=null;if(i!=null&&i.length)try{i.length===1&&i[0]?f=o.groups[i[0]].channels:f=i.reduce(function(d,h){if(h){var c=o.groups[h];if(!c)throw new Error("Audio track group "+h+" not found");Object.keys(c.channels).forEach(function(v){d[v]=(d[v]||0)+c.channels[v]})}return d},{2:0})}catch{return!0}return a.videoCodec!==void 0&&(a.width>1920&&a.height>1088||a.height>1920&&a.width>1088||a.frameRate>Math.max(r,30)||a.videoRange!=="SDR"&&a.videoRange!==n||a.bitrate>Math.max(e,8e6))||!!f&&N(u)&&Object.keys(f).some(function(d){return parseInt(d)>u})}function za(a,o,n){var r=a.videoCodec,e=a.audioCodec;if(!r&&!e||!n)return Promise.resolve(qa);var t=[];if(r){var i={width:a.width,height:a.height,bitrate:Math.ceil(Math.max(a.bitrate*.9,a.averageBitrate)),framerate:a.frameRate||30},s=a.videoRange;s!=="SDR"&&(i.transferFunction=s.toLowerCase());var l=r.split(","),u=navigator.userAgent;if(l.some(function(f){return pi(f)})&&Ga())return Promise.resolve(ja(new Error("Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent sting: ("+u+")"),t));t.push.apply(t,l.map(function(f){return{type:"media-source",video:Q(Q({},i),{},{contentType:Qr(Hl(f),"video")})}}))}return e&&a.audioGroups&&a.audioGroups.forEach(function(f){var d;f&&((d=o.groups[f])==null||d.tracks.forEach(function(h){if(h.groupId===f){var c=h.channels||"",v=parseFloat(c);N(v)&&v>2&&t.push.apply(t,e.split(",").map(function(g){return{type:"media-source",audio:{contentType:Qr(g,"audio"),channels:""+v}}}))}}))}),Promise.all(t.map(function(f){var d=Wl(f);return Xa[d]||(Xa[d]=n.decodingInfo(f))})).then(function(f){return{supported:!f.some(function(d){return!d.supported}),configurations:t,decodingInfoResults:f}}).catch(function(f){return{supported:!1,configurations:t,decodingInfoResults:[],error:f}})}function Wl(a){var o=a.audio,n=a.video,r=n||o;if(r){var e=Ya(r.contentType);if(n)return"r"+n.height+"x"+n.width+"f"+Math.ceil(n.framerate)+(n.transferFunction||"sd")+"_"+e+"_"+Math.ceil(n.bitrate/1e5);if(o)return"c"+o.channels+(o.spatialRendering?"s":"n")+"_"+e}return""}var mn=["NONE","TYPE-0","TYPE-1",null];function Yl(a){return mn.indexOf(a)>-1}var Si=["SDR","PQ","HLG"];function ql(a){return!!a&&Si.indexOf(a)>-1}var Ai={No:"",Yes:"YES",v2:"v2"};function Qa(a){var o=a.canSkipUntil,n=a.canSkipDateRanges,r=a.age,e=r<o/2;return o&&e?n?Ai.v2:Ai.Yes:Ai.No}var $a=function(){function a(n,r,e){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=n,this.part=r,this.skip=e}var o=a.prototype;return o.addDirectives=function(r){var e=new self.URL(r);return this.msn!==void 0&&e.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href},a}(),$r=function(){function a(n){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[n.url],this._attrs=[n.attrs],this.bitrate=n.bitrate,n.details&&(this.details=n.details),this.id=n.id||0,this.name=n.name,this.width=n.width||0,this.height=n.height||0,this.frameRate=n.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=n.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=n.audioCodec,this.videoCodec=n.videoCodec,this.codecSet=[n.videoCodec,n.audioCodec].filter(function(t){return!!t}).map(function(t){return t.substring(0,4)}).join(","),"supplemental"in n){var r;this.supplemental=n.supplemental;var e=(r=n.supplemental)==null?void 0:r.videoCodec;e&&e!==n.videoCodec&&(this.codecSet+=","+e.substring(0,4))}this.addGroupId("audio",n.attrs.AUDIO),this.addGroupId("text",n.attrs.SUBTITLES)}var o=a.prototype;return o.hasAudioGroup=function(r){return Ja(this._audioGroups,r)},o.hasSubtitleGroup=function(r){return Ja(this._subtitleGroups,r)},o.addGroupId=function(r,e){if(e){if(r==="audio"){var t=this._audioGroups;t||(t=this._audioGroups=[]),t.indexOf(e)===-1&&t.push(e)}else if(r==="text"){var i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(e)===-1&&i.push(e)}}},o.addFallback=function(){},z(a,[{key:"maxBitrate",get:function(){return Math.max(this.realBitrate,this.bitrate)}},{key:"averageBitrate",get:function(){return this._avgBitrate||this.realBitrate||this.bitrate}},{key:"attrs",get:function(){return this._attrs[0]}},{key:"codecs",get:function(){return this.attrs.CODECS||""}},{key:"pathwayId",get:function(){return this.attrs["PATHWAY-ID"]||"."}},{key:"videoRange",get:function(){return this.attrs["VIDEO-RANGE"]||"SDR"}},{key:"score",get:function(){return this.attrs.optionalFloat("SCORE",0)}},{key:"uri",get:function(){return this.url[0]||""}},{key:"audioGroups",get:function(){return this._audioGroups}},{key:"subtitleGroups",get:function(){return this._subtitleGroups}},{key:"urlId",get:function(){return 0},set:function(r){}},{key:"audioGroupIds",get:function(){return this.audioGroups?[this.audioGroupId]:void 0}},{key:"textGroupIds",get:function(){return this.subtitleGroups?[this.textGroupId]:void 0}},{key:"audioGroupId",get:function(){var r;return(r=this.audioGroups)==null?void 0:r[0]}},{key:"textGroupId",get:function(){var r;return(r=this.subtitleGroups)==null?void 0:r[0]}}])}();function Ja(a,o){return!o||!a?!1:a.indexOf(o)!==-1}function jl(){if(typeof matchMedia=="function"){var a=matchMedia("(dynamic-range: high)"),o=matchMedia("bad query");if(a.media!==o.media)return a.matches===!0}return!1}function Xl(a,o){var n=!1,r=[];if(a&&(n=a!=="SDR",r=[a]),o){r=o.allowedVideoRanges||Si.slice(0);var e=r.join("")!=="SDR"&&!o.videoCodec;n=o.preferHDR!==void 0?o.preferHDR:e&&jl(),n||(r=["SDR"])}return{preferHDR:n,allowedVideoRanges:r}}var zl=function(o){var n=new WeakSet;return function(r,e){if(o&&(e=o(r,e)),typeof e=="object"&&e!==null){if(n.has(e))return;n.add(e)}return e}},He=function(o,n){return JSON.stringify(o,zl(n))};function Ql(a,o,n,r,e){for(var t=Object.keys(a),i=r==null?void 0:r.channels,s=r==null?void 0:r.audioCodec,l=e==null?void 0:e.videoCodec,u=i&&parseInt(i)===2,f=!1,d=!1,h=1/0,c=1/0,v=1/0,g=1/0,m=0,y=[],E=Xl(o,e),T=E.preferHDR,S=E.allowedVideoRanges,A=function(){var D=a[t[x]];f||(f=D.channels[2]>0),h=Math.min(h,D.minHeight),c=Math.min(c,D.minFramerate),v=Math.min(v,D.minBitrate);var P=S.filter(function(U){return D.videoRanges[U]>0});P.length>0&&(d=!0)},x=t.length;x--;)A();h=N(h)?h:0,c=N(c)?c:0;var L=Math.max(1080,h),I=Math.max(30,c);v=N(v)?v:n,n=Math.max(v,n),d||(o=void 0);var k=t.length>1,R=t.reduce(function(b,D){var P=a[D];if(D===b)return b;if(y=d?S.filter(function(U){return P.videoRanges[U]>0}):[],k){if(P.minBitrate>n)return $t(D,"min bitrate of "+P.minBitrate+" > current estimate of "+n),b;if(!P.hasDefaultAudio)return $t(D,"no renditions with default or auto-select sound found"),b;if(s&&D.indexOf(s.substring(0,4))%5!==0)return $t(D,'audio codec preference "'+s+'" not found'),b;if(i&&!u){if(!P.channels[i])return $t(D,"no renditions with "+i+" channel sound found (channels options: "+Object.keys(P.channels)+")"),b}else if((!s||u)&&f&&P.channels[2]===0)return $t(D,"no renditions with stereo sound found"),b;if(P.minHeight>L)return $t(D,"min resolution of "+P.minHeight+" > maximum of "+L),b;if(P.minFramerate>I)return $t(D,"min framerate of "+P.minFramerate+" > maximum of "+I),b;if(!y.some(function(U){return P.videoRanges[U]>0}))return $t(D,"no variants with VIDEO-RANGE of "+He(y)+" found"),b;if(l&&D.indexOf(l.substring(0,4))%5!==0)return $t(D,'video codec preference "'+l+'" not found'),b;if(P.maxScore<m)return $t(D,"max score of "+P.maxScore+" < selected max of "+m),b}return b&&(yi(D)>=yi(b)||P.fragmentError>a[b].fragmentError)?b:(g=P.minIndex,m=P.maxScore,D)},void 0);return{codecSet:R,videoRanges:y,preferHDR:T,minFramerate:c,minBitrate:v,minIndex:g}}function $t(a,o){X.log('[abr] start candidates with "'+a+'" ignored because '+o)}function Za(a){return a.reduce(function(o,n){var r=o.groups[n.groupId];r||(r=o.groups[n.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),r.tracks.push(n);var e=n.channels||"2";return r.channels[e]=(r.channels[e]||0)+1,r.hasDefault=r.hasDefault||n.default,r.hasAutoSelect=r.hasAutoSelect||n.autoselect,r.hasDefault&&(o.hasDefaultAudio=!0),r.hasAutoSelect&&(o.hasAutoSelectAudio=!0),o},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function $l(a,o,n,r){return a.slice(n,r+1).reduce(function(e,t,i){if(!t.codecSet)return e;var s=t.audioGroups,l=e[t.codecSet];l||(e[t.codecSet]=l={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:i,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!s,fragmentError:0}),l.minBitrate=Math.min(l.minBitrate,t.bitrate);var u=Math.min(t.height,t.width);return l.minHeight=Math.min(l.minHeight,u),l.minFramerate=Math.min(l.minFramerate,t.frameRate),l.minIndex=Math.min(l.minIndex,i),l.maxScore=Math.max(l.maxScore,t.score),l.fragmentError+=t.fragmentError,l.videoRanges[t.videoRange]=(l.videoRanges[t.videoRange]||0)+1,s&&s.forEach(function(f){if(f){var d=o.groups[f];d&&(l.hasDefaultAudio=l.hasDefaultAudio||o.hasDefaultAudio?d.hasDefault:d.hasAutoSelect||!o.hasDefaultAudio&&!o.hasAutoSelectAudio,Object.keys(d.channels).forEach(function(h){l.channels[h]=(l.channels[h]||0)+d.channels[h]}))}}),e},{})}function es(a){if(!a)return a;var o=a,n=o.lang,r=o.assocLang,e=o.characteristics,t=o.channels,i=o.audioCodec;return{lang:n,assocLang:r,characteristics:e,channels:t,audioCodec:i}}function Jt(a,o,n){if("attrs"in a){var r=o.indexOf(a);if(r!==-1)return r}for(var e=0;e<o.length;e++){var t=o[e];if(xr(a,t,n))return e}return-1}function xr(a,o,n){var r=a.groupId,e=a.name,t=a.lang,i=a.assocLang,s=a.default,l=a.forced;return(r===void 0||o.groupId===r)&&(e===void 0||o.name===e)&&(t===void 0||Jl(t,o.lang))&&(t===void 0||o.assocLang===i)&&(s===void 0||o.default===s)&&(l===void 0||o.forced===l)&&(!("characteristics"in a)||Zl(a.characteristics||"",o.characteristics))&&(n===void 0||n(a,o))}function Jl(a,o){return o===void 0&&(o="--"),a.length===o.length?a===o:a.startsWith(o)||o.startsWith(a)}function Zl(a,o){o===void 0&&(o="");var n=a.split(","),r=o.split(",");return n.length===r.length&&!n.some(function(e){return r.indexOf(e)===-1})}function Lr(a,o){var n=a.audioCodec,r=a.channels;return(n===void 0||(o.audioCodec||"").substring(0,4)===n.substring(0,4))&&(r===void 0||r===(o.channels||"2"))}function eu(a,o,n,r,e){var t=o[r],i=o.reduce(function(h,c,v){var g=c.uri,m=h[g]||(h[g]=[]);return m.push(v),h},{}),s=i[t.uri];s.length>1&&(r=Math.max.apply(Math,s));var l=t.videoRange,u=t.frameRate,f=t.codecSet.substring(0,4),d=ts(o,r,function(h){if(h.videoRange!==l||h.frameRate!==u||h.codecSet.substring(0,4)!==f)return!1;var c=h.audioGroups,v=n.filter(function(g){return!c||c.indexOf(g.groupId)!==-1});return Jt(a,v,e)>-1});return d>-1?d:ts(o,r,function(h){var c=h.audioGroups,v=n.filter(function(g){return!c||c.indexOf(g.groupId)!==-1});return Jt(a,v,e)>-1})}function ts(a,o,n){for(var r=o;r>-1;r--)if(n(a[r]))return r;for(var e=o+1;e<a.length;e++)if(n(a[e]))return e;return-1}function xi(a,o){var n;return!!a&&a!==((n=o.loadLevelObj)==null?void 0:n.uri)}var tu=function(a){function o(r){var e;return e=a.call(this,"abr",r.logger)||this,e.hls=void 0,e.lastLevelLoadSec=0,e.lastLoadedFragLevel=-1,e.firstSelection=-1,e._nextAutoLevel=-1,e.nextAutoLevelKey="",e.audioTracksByGroup=null,e.codecTiers=null,e.timer=-1,e.fragCurrent=null,e.partCurrent=null,e.bitrateTestDelay=0,e.rebufferNotice=-1,e.bwEstimator=void 0,e._abandonRulesCheck=function(t){var i,s=e,l=s.fragCurrent,u=s.partCurrent,f=s.hls,d=f.autoLevelEnabled,h=f.media;if(!(!l||!h)){var c=performance.now(),v=u?u.stats:l.stats,g=u?u.duration:l.duration,m=c-v.loading.start,y=f.minAutoLevel,E=l.level,T=e._nextAutoLevel;if(v.aborted||v.loaded&&v.loaded===v.total||E<=y){e.clearTimer(),e._nextAutoLevel=-1;return}if(d){var S=T>-1&&T!==E,A=!!t||S;if(!(!A&&(h.paused||!h.playbackRate||!h.readyState))){var x=f.mainForwardBufferInfo;if(!(!A&&x===null)){var L=e.bwEstimator.getEstimateTTFB(),I=Math.abs(h.playbackRate);if(!(m<=Math.max(L,1e3*(g/(I*2))))){var k=x?x.len/I:0,R=v.loading.first?v.loading.first-v.loading.start:-1,b=v.loaded&&R>-1,D=e.getBwEstimate(),P=f.levels,U=P[E],F=Math.max(v.loaded,Math.round(g*(l.bitrate||U.averageBitrate)/8)),M=b?m-R:m;M<1&&b&&(M=Math.min(m,v.loaded*8/D));var H=b?v.loaded*1e3/M:0,q=L/1e3,W=H?(F-v.loaded)/H:F*8/D+q;if(!(W<=k)){var ee=H?H*8:D,ye=((i=(t==null?void 0:t.details)||e.hls.latestLevelDetails)==null?void 0:i.live)===!0,le=e.hls.config.abrBandWidthUpFactor,Ae=Number.POSITIVE_INFINITY,de;for(de=E-1;de>y;de--){var xe=P[de].maxBitrate,Le=!P[de].details||ye;if(Ae=e.getTimeToLoadFrag(q,ee,g*xe,Le),Ae<Math.min(k,g+q))break}if(!(Ae>=W)&&!(Ae>g*10)){b?e.bwEstimator.sample(m-Math.min(L,R),v.loaded):e.bwEstimator.sampleTTFB(m);var Me=P[de].maxBitrate;e.getBwEstimate()*le>Me&&e.resetEstimator(Me);var tt=e.findBestLevel(Me,y,de,0,k,1,1);tt>-1&&(de=tt),e.warn("Fragment "+l.sn+(u?" part "+u.index:"")+" of level "+E+` is loading too slowly;
      Fragment duration: `+l.duration.toFixed(3)+`
      Time to underbuffer: `+k.toFixed(3)+` s
      Estimated load time for current fragment: `+W.toFixed(3)+` s
      Estimated load time for down switch fragment: `+Ae.toFixed(3)+` s
      TTFB estimate: `+(R|0)+` ms
      Current BW estimate: `+(N(D)?D|0:"Unknown")+` bps
      New BW estimate: `+(e.getBwEstimate()|0)+` bps
      Switching to level `+de+" @ "+(Me|0)+" bps"),f.nextLoadLevel=f.nextAutoLevel=de,e.clearTimer();var Xe=function(){if(e.clearTimer(),e.fragCurrent===l&&e.hls.loadLevel===de&&de>0){var rt=e.getStarvationDelay();if(e.warn("Aborting inflight request "+(de>0?"and switching down":"")+`
      Fragment duration: `+l.duration.toFixed(3)+` s
      Time to underbuffer: `+rt.toFixed(3)+" s"),l.abortRequests(),e.fragCurrent=e.partCurrent=null,de>y){var We=e.findBestLevel(e.hls.levels[y].bitrate,y,de,0,rt,1,1);We===-1&&(We=y),e.hls.nextLoadLevel=e.hls.nextAutoLevel=We,e.resetEstimator(e.hls.levels[We].bitrate)}}};S||W>Ae*2?Xe():e.timer=self.setInterval(Xe,Ae*1e3),f.trigger(p.FRAG_LOAD_EMERGENCY_ABORTED,{frag:l,part:u,stats:v})}}}}}}}},e.hls=r,e.bwEstimator=e.initEstimator(),e.registerListeners(),e}J(o,a);var n=o.prototype;return n.resetEstimator=function(e){e&&(this.log("setting initial bwe to "+e),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()},n.initEstimator=function(){var e=this.hls.config;return new $(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)},n.registerListeners=function(){var e=this.hls;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.FRAG_LOADING,this.onFragLoading,this),e.on(p.FRAG_LOADED,this.onFragLoaded,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(p.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e&&(e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.FRAG_LOADING,this.onFragLoading,this),e.off(p.FRAG_LOADED,this.onFragLoaded,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(p.ERROR,this.onError,this))},n.destroy=function(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null},n.onManifestLoading=function(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()},n.onLevelsUpdated=function(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null},n.onMaxAutoLevelUpdated=function(){this.firstSelection=-1,this.nextAutoLevelKey=""},n.onFragLoading=function(e,t){var i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=t.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}},n.onLevelSwitching=function(e,t){this.clearTimer()},n.onError=function(e,t){if(!t.fatal)switch(t.details){case _.BUFFER_ADD_CODEC_ERROR:case _.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case _.FRAG_LOAD_TIMEOUT:{var i=t.frag,s=this.fragCurrent,l=this.partCurrent;if(i&&s&&i.sn===s.sn&&i.level===s.level){var u=performance.now(),f=l?l.stats:i.stats,d=u-f.loading.start,h=f.loading.first?f.loading.first-f.loading.start:-1,c=f.loaded&&h>-1;if(c){var v=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(d-Math.min(v,h),f.loaded)}else this.bwEstimator.sampleTTFB(d)}break}}},n.getTimeToLoadFrag=function(e,t,i,s){var l=e+i/t,u=s?e+this.lastLevelLoadSec:0;return l+u},n.onLevelLoaded=function(e,t){var i=this.hls.config,s=t.stats.loading,l=s.end-s.first;N(l)&&(this.lastLevelLoadSec=l/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)},n.onFragLoaded=function(e,t){var i=t.frag,s=t.part,l=s?s.stats:i.stats;if(i.type===K.MAIN&&this.bwEstimator.sampleTTFB(l.loading.first-l.loading.start),!this.ignoreFragment(i)){if(this.clearTimer(),i.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){var u=s?s.duration:i.duration,f=this.hls.levels[i.level],d=(f.loaded?f.loaded.bytes:0)+l.loaded,h=(f.loaded?f.loaded.duration:0)+u;f.loaded={bytes:d,duration:h},f.realBitrate=Math.round(8*d/h)}if(i.bitrateTest){var c={stats:l,frag:i,part:s,id:i.type};this.onFragBuffered(p.FRAG_BUFFERED,c),i.bitrateTest=!1}else this.lastLoadedFragLevel=i.level}},n.onFragBuffered=function(e,t){var i=t.frag,s=t.part,l=s!=null&&s.stats.loaded?s.stats:i.stats;if(!l.aborted&&!this.ignoreFragment(i)){var u=l.parsing.end-l.loading.start-Math.min(l.loading.first-l.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(u,l.loaded),l.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=u/1e3:this.bitrateTestDelay=0}},n.ignoreFragment=function(e){return e.type!==K.MAIN||e.sn==="initSegment"},n.clearTimer=function(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)},n.getAutoLevelKey=function(){return this.getBwEstimate()+"_"+this.getStarvationDelay().toFixed(2)},n.getNextABRAutoLevel=function(){var e=this.fragCurrent,t=this.partCurrent,i=this.hls;if(i.levels.length<=1)return i.loadLevel;var s=i.maxAutoLevel,l=i.config,u=i.minAutoLevel,f=t?t.duration:e?e.duration:0,d=this.getBwEstimate(),h=this.getStarvationDelay(),c=l.abrBandWidthFactor,v=l.abrBandWidthUpFactor;if(h){var g=this.findBestLevel(d,u,s,h,0,c,v);if(g>=0)return this.rebufferNotice=-1,g}var m=f?Math.min(f,l.maxStarvationDelay):l.maxStarvationDelay;if(!h){var y=this.bitrateTestDelay;if(y){var E=f?Math.min(f,l.maxLoadingDelay):l.maxLoadingDelay;m=E-y,this.info("bitrate test took "+Math.round(1e3*y)+"ms, set first fragment max fetchDuration to "+Math.round(1e3*m)+" ms"),c=v=1}}var T=this.findBestLevel(d,u,s,h,m,c,v);if(this.rebufferNotice!==T&&(this.rebufferNotice=T,this.info((h?"rebuffering expected":"buffer is empty")+", optimal quality level "+T)),T>-1)return T;var S=i.levels[u],A=i.loadLevelObj;return A&&(S==null?void 0:S.bitrate)<A.bitrate?u:i.loadLevel},n.getStarvationDelay=function(){var e=this.hls,t=e.media;if(!t)return 1/0;var i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,s=e.mainForwardBufferInfo;return(s?s.len:0)/i},n.getBwEstimate=function(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate},n.findBestLevel=function(e,t,i,s,l,u,f){var d,h=this,c=s+l,v=this.lastLoadedFragLevel,g=v===-1?this.hls.firstLevel:v,m=this.fragCurrent,y=this.partCurrent,E=this.hls,T=E.levels,S=E.allAudioTracks,A=E.loadLevel,x=E.config;if(T.length===1)return 0;var L=T[g],I=!!((d=this.hls.latestLevelDetails)!=null&&d.live),k=A===-1||v===-1,R,b="SDR",D=(L==null?void 0:L.frameRate)||0,P=x.audioPreference,U=x.videoPreference,F=this.audioTracksByGroup||(this.audioTracksByGroup=Za(S)),M=-1;if(k){if(this.firstSelection!==-1)return this.firstSelection;var H=this.codecTiers||(this.codecTiers=$l(T,F,t,i)),q=Ql(H,b,e,P,U),W=q.codecSet,ee=q.videoRanges,ye=q.minFramerate,le=q.minBitrate,Ae=q.minIndex,de=q.preferHDR;M=Ae,R=W,b=de?ee[ee.length-1]:ee[0],D=ye,e=Math.max(e,le),this.log("picked start tier "+He(q))}else R=L==null?void 0:L.codecSet,b=L==null?void 0:L.videoRange;for(var xe=y?y.duration:m?m.duration:0,Le=this.bwEstimator.getEstimateTTFB()/1e3,Me=[],tt=function(){var We,ge=T[Ke],yt=Ke>g;if(!ge)return 0;if(x.useMediaCapabilities&&!ge.supportedResult&&!ge.supportedPromise){var ct=navigator.mediaCapabilities;typeof(ct==null?void 0:ct.decodingInfo)=="function"&&(Vl(ge,F,b,D,e,P)||pi(ge.videoCodec))?(ge.supportedPromise=za(ge,F,ct),ge.supportedPromise.then(function(Vt){if(h.hls){ge.supportedResult=Vt;var Hr=h.hls.levels,zt=Hr.indexOf(ge);Vt.error?h.warn('MediaCapabilities decodingInfo error: "'+Vt.error+'" for level '+zt+" "+He(Vt)):Vt.supported||(h.warn("Unsupported MediaCapabilities decodingInfo result for level "+zt+" "+He(Vt)),zt>-1&&Hr.length>1&&(h.log("Removing unsupported level "+zt),h.hls.removeLevel(zt),h.hls.loadLevel===-1&&(h.hls.nextLoadLevel=0)))}})):ge.supportedResult=qa}if((R&&ge.codecSet!==R||b&&ge.videoRange!==b||yt&&D>ge.frameRate||!yt&&D>0&&D<ge.frameRate||ge.supportedResult&&!((We=ge.supportedResult.decodingInfoResults)!=null&&We[0].smooth))&&(!k||Ke!==M))return Me.push(Ke),0;var ft=ge.details,ze=(y?ft==null?void 0:ft.partTarget:ft==null?void 0:ft.averagetargetduration)||xe,Et;yt?Et=f*e:Et=u*e;var Ye=xe&&s>=xe*2&&l===0?ge.averageBitrate:ge.maxBitrate,it=h.getTimeToLoadFrag(Le,Et,Ye*ze,ft===void 0),rr=Et>=Ye&&(Ke===v||ge.loadError===0&&ge.fragmentError===0)&&(it<=Le||!N(it)||I&&!h.bitrateTestDelay||it<c);if(rr){var mr=h.forcedAutoLevel;return Ke!==A&&(mr===-1||mr!==A)&&(Me.length&&h.trace("Skipped level(s) "+Me.join(",")+" of "+i+' max with CODECS and VIDEO-RANGE:"'+T[Me[0]].codecs+'" '+T[Me[0]].videoRange+'; not compatible with "'+R+'" '+b),h.info("switch candidate:"+g+"->"+Ke+" adjustedbw("+Math.round(Et)+")-bitrate="+Math.round(Et-Ye)+" ttfb:"+Le.toFixed(1)+" avgDuration:"+ze.toFixed(1)+" maxFetchDuration:"+c.toFixed(1)+" fetchDuration:"+it.toFixed(1)+" firstSelection:"+k+" codecSet:"+ge.codecSet+" videoRange:"+ge.videoRange+" hls.loadLevel:"+A)),k&&(h.firstSelection=Ke),{v:Ke}}},Xe,Ke=i;Ke>=t;Ke--)if(Xe=tt(),Xe!==0&&Xe)return Xe.v;return-1},n.deriveNextAutoLevel=function(e){var t=this.hls,i=t.maxAutoLevel,s=t.minAutoLevel;return Math.min(Math.max(e,s),i)},z(o,[{key:"firstAutoLevel",get:function(){var e=this.hls,t=e.maxAutoLevel,i=e.minAutoLevel,s=this.getBwEstimate(),l=this.hls.config.maxStarvationDelay,u=this.findBestLevel(s,i,t,0,l,1,1);if(u>-1)return u;var f=this.hls.firstLevel,d=Math.min(Math.max(f,i),t);return this.warn("Could not find best starting auto level. Defaulting to first in playlist "+f+" clamped to "+d),d}},{key:"forcedAutoLevel",get:function(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}},{key:"nextAutoLevel",get:function(){var e=this.forcedAutoLevel,t=this.bwEstimator,i=t.canEstimate(),s=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!s||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;var l=i&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){var u=this.hls.levels;if(u.length>Math.max(e,l)&&u[e].loadError<=u[l].loadError)return e}return this._nextAutoLevel=l,this.nextAutoLevelKey=this.getAutoLevelKey(),l},set:function(e){var t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}}])}(ie),pn={search:function(o,n){for(var r=0,e=o.length-1,t=null,i=null;r<=e;){t=(r+e)/2|0,i=o[t];var s=n(i);if(s>0)r=t+1;else if(s<0)e=t-1;else return i}return null}};function ru(a,o,n){if(o===null||!Array.isArray(a)||!a.length||!N(o))return null;var r=a[0].programDateTime;if(o<(r||0))return null;var e=a[a.length-1].endProgramDateTime;if(o>=(e||0))return null;n=n||0;for(var t=0;t<a.length;++t){var i=a[t];if(nu(o,n,i))return i}return null}function br(a,o,n,r,e){n===void 0&&(n=0),r===void 0&&(r=0),e===void 0&&(e=.005);var t=null;if(a){t=o[1+a.sn-o[0].sn]||null;var i=a.endDTS-n;i>0&&i<15e-7&&(n+=15e-7),t&&a.level!==t.level&&t.end<=a.end&&(t=o[2+a.sn-o[0].sn]||null)}else n===0&&o[0].start===0&&(t=o[0]);if(t&&((!a||a.level===t.level)&&rs(n,r,t)===0||iu(t,a,Math.min(e,r))))return t;var s=pn.search(o,rs.bind(null,n,r));return s&&(s!==a||!t)?s:t}function iu(a,o,n){if(o&&o.start===0&&o.level<a.level&&(o.endPTS||0)>0){var r=o.tagList.reduce(function(e,t){return t[0]==="INF"&&(e+=parseFloat(t[1])),e},n);return a.start<=r}return!1}function rs(a,o,n){if(a===void 0&&(a=0),o===void 0&&(o=0),n.start<=a&&n.start+n.duration>a)return 0;var r=Math.min(o,n.duration+(n.deltaPTS?n.deltaPTS:0));return n.start+n.duration-r<=a?1:n.start-r>a&&n.start?-1:0}function nu(a,o,n){var r=Math.min(o,n.duration+(n.deltaPTS?n.deltaPTS:0))*1e3,e=n.endProgramDateTime||0;return e-r>a}function is(a,o){return pn.search(a,function(n){return n.cc<o?1:n.cc>o?-1:0})}function au(a,o,n){if(a&&a.startCC<=o&&a.endCC>=o){var r=n.start,e=n.end,t=a.fragments;if(!n.relurl){var i=a.fragmentHint;i&&(t=t.concat(i))}return pn.search(t,function(s){return s.cc<o||s.end<=r?1:s.cc>o||s.start>=e?-1:0})}return null}function Li(a){switch(a.details){case _.FRAG_LOAD_TIMEOUT:case _.KEY_LOAD_TIMEOUT:case _.LEVEL_LOAD_TIMEOUT:case _.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function ns(a,o){var n=Li(o);return a.default[(n?"timeout":"error")+"Retry"]}function yn(a,o){var n=a.backoff==="linear"?1:Math.pow(2,o);return Math.min(n*a.retryDelayMs,a.maxRetryDelayMs)}function as(a){return Q(Q({},a),{errorRetry:null,timeoutRetry:null})}function bi(a,o,n,r){if(!a)return!1;var e=r==null?void 0:r.code,t=o<a.maxNumRetry&&(su(e)||!!n);return a.shouldRetry?a.shouldRetry(a,o,n,r,t):t}function su(a){return a===0&&navigator.onLine===!1||!!a&&(a<400||a>499)}var bt={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},jt={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2},ou=function(a){function o(r){var e;return e=a.call(this,"error-controller",r.logger)||this,e.hls=void 0,e.playlistError=0,e.penalizedRenditions={},e.hls=r,e.registerListeners(),e}J(o,a);var n=o.prototype;return n.registerListeners=function(){var e=this.hls;e.on(p.ERROR,this.onError,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this)},n.unregisterListeners=function(){var e=this.hls;e&&(e.off(p.ERROR,this.onError,this),e.off(p.ERROR,this.onErrorOut,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this))},n.destroy=function(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}},n.startLoad=function(e){},n.stopLoad=function(){this.playlistError=0},n.getVariantLevelIndex=function(e){return(e==null?void 0:e.type)===K.MAIN?e.level:this.hls.loadLevel},n.onManifestLoading=function(){this.playlistError=0,this.penalizedRenditions={}},n.onLevelUpdated=function(){this.playlistError=0},n.onError=function(e,t){var i;if(!t.fatal){var s=this.hls,l=t.context;switch(t.details){case _.FRAG_LOAD_ERROR:case _.FRAG_LOAD_TIMEOUT:case _.KEY_LOAD_ERROR:case _.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case _.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction=Jr();return}case _.FRAG_GAP:case _.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=bt.SendAlternateToPenaltyBox;return}case _.LEVEL_EMPTY_ERROR:case _.LEVEL_PARSING_ERROR:{var u,f,d=t.parent===K.MAIN?t.level:s.loadLevel;t.details===_.LEVEL_EMPTY_ERROR&&((u=t.context)!=null&&(f=u.levelDetails)!=null&&f.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,d):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,d))}return;case _.LEVEL_LOAD_ERROR:case _.LEVEL_LOAD_TIMEOUT:typeof(l==null?void 0:l.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,l.level));return;case _.AUDIO_TRACK_LOAD_ERROR:case _.AUDIO_TRACK_LOAD_TIMEOUT:case _.SUBTITLE_LOAD_ERROR:case _.SUBTITLE_TRACK_LOAD_TIMEOUT:if(l){var h=s.loadLevelObj;if(h&&(l.type===j.AUDIO_TRACK&&h.hasAudioGroup(l.groupId)||l.type===j.SUBTITLE_TRACK&&h.hasSubtitleGroup(l.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=bt.SendAlternateToPenaltyBox,t.errorAction.flags=jt.MoveAllAlternatesMatchingHost;return}}return;case _.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{var c=s.loadLevelObj,v=c==null?void 0:c.attrs["HDCP-LEVEL"];v?t.errorAction={action:bt.SendAlternateToPenaltyBox,flags:jt.MoveAllAlternatesMatchingHDCP,hdcpLevel:v}:this.keySystemError(t)}return;case _.BUFFER_ADD_CODEC_ERROR:case _.REMUX_ALLOC_ERROR:case _.BUFFER_APPEND_ERROR:if(!t.errorAction){var g;t.errorAction=this.getLevelSwitchAction(t,(g=t.level)!=null?g:s.loadLevel)}return;case _.INTERNAL_EXCEPTION:case _.BUFFER_APPENDING_ERROR:case _.BUFFER_FULL_ERROR:case _.LEVEL_SWITCH_ERROR:case _.BUFFER_STALLED_ERROR:case _.BUFFER_SEEK_OVER_HOLE:case _.BUFFER_NUDGE_ON_STALL:t.errorAction=Jr();return}t.type===V.KEY_SYSTEM_ERROR&&this.keySystemError(t)}},n.keySystemError=function(e){var t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)},n.getPlaylistRetryOrSwitchAction=function(e,t){var i=this.hls,s=ns(i.config.playlistLoadPolicy,e),l=this.playlistError++,u=bi(s,l,Li(e),e.response);if(u)return{action:bt.RetryRequest,flags:jt.None,retryConfig:s,retryCount:l};var f=this.getLevelSwitchAction(e,t);return s&&(f.retryConfig=s,f.retryCount=l),f},n.getFragRetryOrSwitchAction=function(e){var t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],l=t.config,u=l.fragLoadPolicy,f=l.keyLoadPolicy,d=ns(e.details.startsWith("key")?f:u,e),h=t.levels.reduce(function(g,m){return g+m.fragmentError},0);if(s){e.details!==_.FRAG_GAP&&s.fragmentError++;var c=bi(d,h,Li(e),e.response);if(c)return{action:bt.RetryRequest,flags:jt.None,retryConfig:d,retryCount:h}}var v=this.getLevelSwitchAction(e,i);return d&&(v.retryConfig=d,v.retryCount=h),v},n.getLevelSwitchAction=function(e,t){var i=this.hls;t==null&&(t=i.loadLevel);var s=this.hls.levels[t];if(s){var l,u,f=e.details;s.loadError++,f===_.BUFFER_APPEND_ERROR&&s.fragmentError++;var d=-1,h=i.levels,c=i.loadLevel,v=i.minAutoLevel,g=i.maxAutoLevel;i.autoLevelEnabled||(i.loadLevel=-1);for(var m=(l=e.frag)==null?void 0:l.type,y=m===K.AUDIO&&f===_.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(f===_.BUFFER_ADD_CODEC_ERROR||f===_.BUFFER_APPEND_ERROR),E=y&&h.some(function(b){var D=b.audioCodec;return s.audioCodec!==D}),T=e.sourceBufferName==="video"&&(f===_.BUFFER_ADD_CODEC_ERROR||f===_.BUFFER_APPEND_ERROR),S=T&&h.some(function(b){var D=b.codecSet,P=b.audioCodec;return s.codecSet!==D&&s.audioCodec===P}),A=(u=e.context)!=null?u:{},x=A.type,L=A.groupId,I=function(){var D=(R+c)%h.length;if(D!==c&&D>=v&&D<=g&&h[D].loadError===0){var P,U,F=h[D];if(f===_.FRAG_GAP&&m===K.MAIN&&e.frag){var M=h[D].details;if(M){var H=br(e.frag,M.fragments,e.frag.start);if(H!=null&&H.gap)return 0}}else{if(x===j.AUDIO_TRACK&&F.hasAudioGroup(L)||x===j.SUBTITLE_TRACK&&F.hasSubtitleGroup(L))return 0;if(m===K.AUDIO&&(P=s.audioGroups)!=null&&P.some(function(q){return F.hasAudioGroup(q)})||m===K.SUBTITLE&&(U=s.subtitleGroups)!=null&&U.some(function(q){return F.hasSubtitleGroup(q)})||E&&s.audioCodec===F.audioCodec||!E&&s.audioCodec!==F.audioCodec||S&&s.codecSet===F.codecSet)return 0}return d=D,1}},k,R=h.length;R--&&(k=I(),!(k!==0&&k===1)););if(d>-1&&i.loadLevel!==d)return e.levelRetry=!0,this.playlistError=0,{action:bt.SendAlternateToPenaltyBox,flags:jt.None,nextAutoLevel:d}}return{action:bt.SendAlternateToPenaltyBox,flags:jt.MoveAllAlternatesMatchingHost}},n.onErrorOut=function(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case bt.DoNothing:break;case bt.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==_.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn('MediaSource ended after "'+t.sourceBufferName+'" sourceBuffer append error. Attempting to recover from media error.'),this.hls.recoverMediaError());break}if(t.fatal){this.hls.stopLoad();return}},n.sendAlternateToPenaltyBox=function(e){var t=this.hls,i=e.errorAction;if(i){var s=i.flags,l=i.hdcpLevel,u=i.nextAutoLevel;switch(s){case jt.None:this.switchLevel(e,u);break;case jt.MoveAllAlternatesMatchingHDCP:l&&(t.maxHdcpLevel=mn[mn.indexOf(l)-1],i.resolved=!0),this.warn('Restricting playback to HDCP-LEVEL of "'+t.maxHdcpLevel+'" or lower');break}i.resolved||this.switchLevel(e,u)}},n.switchLevel=function(e,t){if(t!==void 0&&e.errorAction&&(this.warn("switching to level "+t+" after "+e.details),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===_.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&e.sourceBufferName!=="audiovideo"))for(var i=Ya(e.mimeType),s=this.hls.levels,l=s.length;l--;)s[l][e.sourceBufferName+"Codec"]===i&&this.hls.removeLevel(l)},o}(ie);function Jr(a){var o={action:bt.DoNothing,flags:jt.None};return a&&(o.resolved=!0),o}var ut={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"},lu=function(){function a(n){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=n,this._registerListeners()}var o=a.prototype;return o._registerListeners=function(){var r=this.hls;r.on(p.MANIFEST_LOADING,this.onManifestLoading,this),r.on(p.BUFFER_APPENDED,this.onBufferAppended,this),r.on(p.FRAG_BUFFERED,this.onFragBuffered,this),r.on(p.FRAG_LOADED,this.onFragLoaded,this)},o._unregisterListeners=function(){var r=this.hls;r.off(p.MANIFEST_LOADING,this.onManifestLoading,this),r.off(p.BUFFER_APPENDED,this.onBufferAppended,this),r.off(p.FRAG_BUFFERED,this.onFragBuffered,this),r.off(p.FRAG_LOADED,this.onFragLoaded,this)},o.destroy=function(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null},o.getAppendedFrag=function(r,e){var t=this.activePartLists[e];if(t)for(var i=t.length;i--;){var s=t[i];if(!s)break;var l=s.end;if(s.start<=r&&l!==null&&r<=l)return s}return this.getBufferedFrag(r,e)},o.getBufferedFrag=function(r,e){return this.getFragAtPos(r,e,!0)},o.getFragAtPos=function(r,e,t){for(var i=this.fragments,s=Object.keys(i),l=s.length;l--;){var u=i[s[l]];if((u==null?void 0:u.body.type)===e&&(!t||u.buffered)){var f=u.body;if(f.start<=r&&r<=f.end)return f}}return null},o.detectEvictedFragments=function(r,e,t,i,s){var l=this;this.timeRanges&&(this.timeRanges[r]=e);var u=(i==null?void 0:i.fragment.sn)||-1;Object.keys(this.fragments).forEach(function(f){var d=l.fragments[f];if(d&&!(u>=d.body.sn)){if(!d.buffered&&(!d.loaded||s)){d.body.type===t&&l.removeFragment(d.body);return}var h=d.range[r];if(h){if(h.time.length===0){l.removeFragment(d.body);return}h.time.some(function(c){var v=!l.isTimeBuffered(c.startPTS,c.endPTS,e);return v&&l.removeFragment(d.body),v})}}})},o.detectPartialFragments=function(r){var e=this,t=this.timeRanges;if(!(!t||r.frag.sn==="initSegment")){var i=r.frag,s=wr(i),l=this.fragments[s];if(!(!l||l.buffered&&i.gap)){var u=!i.relurl;if(Object.keys(t).forEach(function(d){var h=i.elementaryStreams[d];if(h){var c=t[d],v=u||h.partial===!0;l.range[d]=e.getBufferedTimes(i,r.part,v,c)}}),l.loaded=null,Object.keys(l.range).length){l.buffered=!0;var f=l.body.endList=i.endList||l.body.endList;f&&(this.endListFragments[l.body.type]=l),Ri(l)||this.removeParts(i.sn-1,i.type)}else this.removeFragment(l.body)}}},o.removeParts=function(r,e){var t=this.activePartLists[e];t&&(this.activePartLists[e]=ss(t,function(i){return i.fragment.sn>=r}))},o.fragBuffered=function(r,e){var t=wr(r),i=this.fragments[t];!i&&e&&(i=this.fragments[t]={body:r,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},r.gap&&(this.hasGaps=!0)),i&&(i.loaded=null,i.buffered=!0)},o.getBufferedTimes=function(r,e,t,i){for(var s={time:[],partial:t},l=r.start,u=r.end,f=r.minEndPTS||u,d=r.maxStartPTS||l,h=0;h<i.length;h++){var c=i.start(h)-this.bufferPadding,v=i.end(h)+this.bufferPadding;if(d>=c&&f<=v){s.time.push({startPTS:Math.max(l,i.start(h)),endPTS:Math.min(u,i.end(h))});break}else if(l<v&&u>c){var g=Math.max(l,i.start(h)),m=Math.min(u,i.end(h));m>g&&(s.partial=!0,s.time.push({startPTS:g,endPTS:m}))}else if(u<=c)break}return s},o.getPartialFragment=function(r){var e=null,t,i,s,l=0,u=this.bufferPadding,f=this.fragments;return Object.keys(f).forEach(function(d){var h=f[d];h&&Ri(h)&&(i=h.body.start-u,s=h.body.end+u,r>=i&&r<=s&&(t=Math.min(r-i,s-r),l<=t&&(e=h.body,l=t)))}),e},o.isEndListAppended=function(r){var e=this.endListFragments[r];return e!==void 0&&(e.buffered||Ri(e))},o.getState=function(r){var e=wr(r),t=this.fragments[e];return t?t.buffered?Ri(t)?ut.PARTIAL:ut.OK:ut.APPENDING:ut.NOT_LOADED},o.isTimeBuffered=function(r,e,t){for(var i,s,l=0;l<t.length;l++){if(i=t.start(l)-this.bufferPadding,s=t.end(l)+this.bufferPadding,r>=i&&e<=s)return!0;if(e<=i)return!1}return!1},o.onManifestLoading=function(){this.removeAllFragments()},o.onFragLoaded=function(r,e){if(!(e.frag.sn==="initSegment"||e.frag.bitrateTest)){var t=e.frag,i=e.part?null:e,s=wr(t);this.fragments[s]={body:t,appendedPTS:null,loaded:i,buffered:!1,range:Object.create(null)}}},o.onBufferAppended=function(r,e){var t=e.frag,i=e.part,s=e.timeRanges,l=e.type;if(t.sn!=="initSegment"){var u=t.type;if(i){var f=this.activePartLists[u];f||(this.activePartLists[u]=f=[]),f.push(i)}this.timeRanges=s;var d=s[l];this.detectEvictedFragments(l,d,u,i)}},o.onFragBuffered=function(r,e){this.detectPartialFragments(e)},o.hasFragment=function(r){var e=wr(r);return!!this.fragments[e]},o.hasFragments=function(r){var e=this.fragments,t=Object.keys(e);if(!r)return t.length>0;for(var i=t.length;i--;){var s=e[t[i]];if((s==null?void 0:s.body.type)===r)return!0}return!1},o.hasParts=function(r){var e;return!!((e=this.activePartLists[r])!=null&&e.length)},o.removeFragmentsInRange=function(r,e,t,i,s){var l=this;i&&!this.hasGaps||Object.keys(this.fragments).forEach(function(u){var f=l.fragments[u];if(f){var d=f.body;d.type!==t||i&&!d.gap||d.start<e&&d.end>r&&(f.buffered||s)&&l.removeFragment(d)}})},o.removeFragment=function(r){var e=wr(r);r.clearElementaryStreamInfo();var t=this.activePartLists[r.type];if(t){var i=r.sn;this.activePartLists[r.type]=ss(t,function(s){return s.fragment.sn!==i})}delete this.fragments[e],r.endList&&delete this.endListFragments[r.type]},o.removeAllFragments=function(){var r,e;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;var t=(r=this.hls)==null||(e=r.latestLevelDetails)==null?void 0:e.partList;t&&t.forEach(function(i){return i.clearElementaryStreamInfo()})},a}();function Ri(a){var o,n,r;return a.buffered&&(a.body.gap||((o=a.range.video)==null?void 0:o.partial)||((n=a.range.audio)==null?void 0:n.partial)||((r=a.range.audiovideo)==null?void 0:r.partial))}function wr(a){return a.type+"_"+a.level+"_"+a.sn}function ss(a,o){return a.filter(function(n){var r=o(n);return r||n.clearElementaryStreamInfo(),r})}var cr={cbc:0,ctr:1},uu=function(){function a(n,r,e){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=n,this.aesIV=r,this.aesMode=e}var o=a.prototype;return o.decrypt=function(r,e){switch(this.aesMode){case cr.cbc:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,r);case cr.ctr:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},e,r);default:throw new Error("[AESCrypto] invalid aes mode "+this.aesMode)}},a}();function fu(a){var o=a.byteLength,n=o&&new DataView(a.buffer).getUint8(o-1);return n?a.slice(0,o-n):a}var du=function(){function a(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}var o=a.prototype;return o.uint8ArrayToUint32Array_=function(r){for(var e=new DataView(r),t=new Uint32Array(4),i=0;i<4;i++)t[i]=e.getUint32(i*4);return t},o.initTable=function(){var r=this.sBox,e=this.invSBox,t=this.subMix,i=t[0],s=t[1],l=t[2],u=t[3],f=this.invSubMix,d=f[0],h=f[1],c=f[2],v=f[3],g=new Uint32Array(256),m=0,y=0,E=0;for(E=0;E<256;E++)E<128?g[E]=E<<1:g[E]=E<<1^283;for(E=0;E<256;E++){var T=y^y<<1^y<<2^y<<3^y<<4;T=T>>>8^T&255^99,r[m]=T,e[T]=m;var S=g[m],A=g[S],x=g[A],L=g[T]*257^T*16843008;i[m]=L<<24|L>>>8,s[m]=L<<16|L>>>16,l[m]=L<<8|L>>>24,u[m]=L,L=x*16843009^A*65537^S*257^m*16843008,d[T]=L<<24|L>>>8,h[T]=L<<16|L>>>16,c[T]=L<<8|L>>>24,v[T]=L,m?(m=S^g[g[g[x^S]]],y^=g[g[y]]):m=y=1}},o.expandKey=function(r){for(var e=this.uint8ArrayToUint32Array_(r),t=!0,i=0;i<e.length&&t;)t=e[i]===this.key[i],i++;if(!t){this.key=e;var s=this.keySize=e.length;if(s!==4&&s!==6&&s!==8)throw new Error("Invalid aes key size="+s);var l=this.ksRows=(s+6+1)*4,u,f,d=this.keySchedule=new Uint32Array(l),h=this.invKeySchedule=new Uint32Array(l),c=this.sBox,v=this.rcon,g=this.invSubMix,m=g[0],y=g[1],E=g[2],T=g[3],S,A;for(u=0;u<l;u++){if(u<s){S=d[u]=e[u];continue}A=S,u%s===0?(A=A<<8|A>>>24,A=c[A>>>24]<<24|c[A>>>16&255]<<16|c[A>>>8&255]<<8|c[A&255],A^=v[u/s|0]<<24):s>6&&u%s===4&&(A=c[A>>>24]<<24|c[A>>>16&255]<<16|c[A>>>8&255]<<8|c[A&255]),d[u]=S=(d[u-s]^A)>>>0}for(f=0;f<l;f++)u=l-f,f&3?A=d[u]:A=d[u-4],f<4||u<=4?h[f]=A:h[f]=m[c[A>>>24]]^y[c[A>>>16&255]]^E[c[A>>>8&255]]^T[c[A&255]],h[f]=h[f]>>>0}},o.networkToHostOrderSwap=function(r){return r<<24|(r&65280)<<8|(r&16711680)>>8|r>>>24},o.decrypt=function(r,e,t){for(var i=this.keySize+6,s=this.invKeySchedule,l=this.invSBox,u=this.invSubMix,f=u[0],d=u[1],h=u[2],c=u[3],v=this.uint8ArrayToUint32Array_(t),g=v[0],m=v[1],y=v[2],E=v[3],T=new Int32Array(r),S=new Int32Array(T.length),A,x,L,I,k,R,b,D,P,U,F,M,H,q,W=this.networkToHostOrderSwap;e<T.length;){for(P=W(T[e]),U=W(T[e+1]),F=W(T[e+2]),M=W(T[e+3]),k=P^s[0],R=M^s[1],b=F^s[2],D=U^s[3],H=4,q=1;q<i;q++)A=f[k>>>24]^d[R>>16&255]^h[b>>8&255]^c[D&255]^s[H],x=f[R>>>24]^d[b>>16&255]^h[D>>8&255]^c[k&255]^s[H+1],L=f[b>>>24]^d[D>>16&255]^h[k>>8&255]^c[R&255]^s[H+2],I=f[D>>>24]^d[k>>16&255]^h[R>>8&255]^c[b&255]^s[H+3],k=A,R=x,b=L,D=I,H=H+4;A=l[k>>>24]<<24^l[R>>16&255]<<16^l[b>>8&255]<<8^l[D&255]^s[H],x=l[R>>>24]<<24^l[b>>16&255]<<16^l[D>>8&255]<<8^l[k&255]^s[H+1],L=l[b>>>24]<<24^l[D>>16&255]<<16^l[k>>8&255]<<8^l[R&255]^s[H+2],I=l[D>>>24]<<24^l[k>>16&255]<<16^l[R>>8&255]<<8^l[b&255]^s[H+3],S[e]=W(A^g),S[e+1]=W(I^m),S[e+2]=W(L^y),S[e+3]=W(x^E),g=P,m=U,y=F,E=M,e=e+4}return S.buffer},a}(),hu=function(){function a(n,r,e){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=n,this.key=r,this.aesMode=e}var o=a.prototype;return o.expandKey=function(){var r=cu(this.aesMode);return this.subtle.importKey("raw",this.key,{name:r},!1,["encrypt","decrypt"])},a}();function cu(a){switch(a){case cr.cbc:return"AES-CBC";case cr.ctr:return"AES-CTR";default:throw new Error("[FastAESKey] invalid aes mode "+a)}}var vu=16,En=function(){function a(n,r){var e=r===void 0?{}:r,t=e.removePKCS7Padding,i=t===void 0?!0:t;if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=n.enableSoftwareAES,this.removePKCS7Padding=i,i)try{var s=self.crypto;s&&(this.subtle=s.subtle||s.webkitSubtle)}catch{}this.useSoftware=!this.subtle}var o=a.prototype;return o.destroy=function(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null},o.isSync=function(){return this.useSoftware},o.flush=function(){var r=this.currentResult,e=this.remainderData;if(!r||e)return this.reset(),null;var t=new Uint8Array(r);return this.reset(),this.removePKCS7Padding?fu(t):t},o.reset=function(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)},o.decrypt=function(r,e,t,i){var s=this;return this.useSoftware?new Promise(function(l,u){var f=ArrayBuffer.isView(r)?r:new Uint8Array(r);s.softwareDecrypt(f,e,t,i);var d=s.flush();d?l(d.buffer):u(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(r),e,t,i)},o.softwareDecrypt=function(r,e,t,i){var s=this.currentIV,l=this.currentResult,u=this.remainderData;if(i!==cr.cbc||e.byteLength!==16)return X.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),u&&(r=Gt(u,r),this.remainderData=null);var f=this.getValidChunk(r);if(!f.length)return null;s&&(t=s);var d=this.softwareDecrypter;d||(d=this.softwareDecrypter=new du),d.expandKey(e);var h=l;return this.currentResult=d.decrypt(f.buffer,0,t),this.currentIV=f.slice(-16).buffer,h||null},o.webCryptoDecrypt=function(r,e,t,i){var s=this;if(this.key!==e||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(r,e,t,i));this.key=e,this.fastAesKey=new hu(this.subtle,e,i)}return this.fastAesKey.expandKey().then(function(l){if(!s.subtle)return Promise.reject(new Error("web crypto not initialized"));s.logOnce("WebCrypto AES decrypt");var u=new uu(s.subtle,new Uint8Array(t),i);return u.decrypt(r.buffer,l)}).catch(function(l){return X.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, "+l.name+": "+l.message),s.onWebCryptoError(r,e,t,i)})},o.onWebCryptoError=function(r,e,t,i){var s=this.enableSoftwareAES;if(s){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(r,e,t,i);var l=this.flush();if(l)return l.buffer}throw new Error("WebCrypto"+(s?" and softwareDecrypt":"")+": failed to decrypt data")},o.getValidChunk=function(r){var e=r,t=r.length-r.length%vu;return t!==r.length&&(e=r.slice(0,t),this.remainderData=r.slice(t)),e},o.logOnce=function(r){this.logEnabled&&(X.log("[decrypter]: "+r),this.logEnabled=!1)},a}(),os=Math.pow(2,17),gu=function(){function a(n){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=n}var o=a.prototype;return o.destroy=function(){this.loader&&(this.loader.destroy(),this.loader=null)},o.abort=function(){this.loader&&this.loader.abort()},o.load=function(r,e){var t=this,i=r.url;if(!i)return Promise.reject(new sr({type:V.NETWORK_ERROR,details:_.FRAG_LOAD_ERROR,fatal:!1,frag:r,error:new Error("Fragment does not have a "+(i?"part list":"url")),networkDetails:null}));this.abort();var s=this.config,l=s.fLoader,u=s.loader;return new Promise(function(f,d){if(t.loader&&t.loader.destroy(),r.gap)if(r.tagList.some(function(y){return y[0]==="GAP"})){d(us(r));return}else r.gap=!1;var h=t.loader=l?new l(s):new u(s),c=ls(r);r.loader=h;var v=as(s.fragLoadPolicy.default),g={loadPolicy:v,timeout:v.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:r.sn==="initSegment"?1/0:os};r.stats=h.stats;var m={onSuccess:function(E,T,S,A){t.resetLoader(r,h);var x=E.data;S.resetIV&&r.decryptdata&&(r.decryptdata.iv=new Uint8Array(x.slice(0,16)),x=x.slice(16)),f({frag:r,part:null,payload:x,networkDetails:A})},onError:function(E,T,S,A){t.resetLoader(r,h),d(new sr({type:V.NETWORK_ERROR,details:_.FRAG_LOAD_ERROR,fatal:!1,frag:r,response:Q({url:i,data:void 0},E),error:new Error("HTTP Error "+E.code+" "+E.text),networkDetails:S,stats:A}))},onAbort:function(E,T,S){t.resetLoader(r,h),d(new sr({type:V.NETWORK_ERROR,details:_.INTERNAL_ABORTED,fatal:!1,frag:r,error:new Error("Aborted"),networkDetails:S,stats:E}))},onTimeout:function(E,T,S){t.resetLoader(r,h),d(new sr({type:V.NETWORK_ERROR,details:_.FRAG_LOAD_TIMEOUT,fatal:!1,frag:r,error:new Error("Timeout after "+g.timeout+"ms"),networkDetails:S,stats:E}))}};e&&(m.onProgress=function(y,E,T,S){return e({frag:r,part:null,payload:T,networkDetails:S})}),h.load(c,g,m)})},o.loadPart=function(r,e,t){var i=this;this.abort();var s=this.config,l=s.fLoader,u=s.loader;return new Promise(function(f,d){if(i.loader&&i.loader.destroy(),r.gap||e.gap){d(us(r,e));return}var h=i.loader=l?new l(s):new u(s),c=ls(r,e);r.loader=h;var v=as(s.fragLoadPolicy.default),g={loadPolicy:v,timeout:v.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:os};e.stats=h.stats,h.load(c,g,{onSuccess:function(y,E,T,S){i.resetLoader(r,h),i.updateStatsFromPart(r,e);var A={frag:r,part:e,payload:y.data,networkDetails:S};t(A),f(A)},onError:function(y,E,T,S){i.resetLoader(r,h),d(new sr({type:V.NETWORK_ERROR,details:_.FRAG_LOAD_ERROR,fatal:!1,frag:r,part:e,response:Q({url:c.url,data:void 0},y),error:new Error("HTTP Error "+y.code+" "+y.text),networkDetails:T,stats:S}))},onAbort:function(y,E,T){r.stats.aborted=e.stats.aborted,i.resetLoader(r,h),d(new sr({type:V.NETWORK_ERROR,details:_.INTERNAL_ABORTED,fatal:!1,frag:r,part:e,error:new Error("Aborted"),networkDetails:T,stats:y}))},onTimeout:function(y,E,T){i.resetLoader(r,h),d(new sr({type:V.NETWORK_ERROR,details:_.FRAG_LOAD_TIMEOUT,fatal:!1,frag:r,part:e,error:new Error("Timeout after "+g.timeout+"ms"),networkDetails:T,stats:y}))}})})},o.updateStatsFromPart=function(r,e){var t=r.stats,i=e.stats,s=i.total;if(t.loaded+=i.loaded,s){var l=Math.round(r.duration/e.duration),u=Math.min(Math.round(t.loaded/s),l),f=l-u,d=f*Math.round(t.loaded/u);t.total=t.loaded+d}else t.total=Math.max(t.loaded,t.total);var h=t.loading,c=i.loading;h.start?h.first+=c.first-c.start:(h.start=c.start,h.first=c.first),h.end=c.end},o.resetLoader=function(r,e){r.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()},a}();function ls(a,o){o===void 0&&(o=null);var n=o||a,r={frag:a,part:o,responseType:"arraybuffer",url:n.url,headers:{},rangeStart:0,rangeEnd:0},e=n.byteRangeStartOffset,t=n.byteRangeEndOffset;if(N(e)&&N(t)){var i,s=e,l=t;if(a.sn==="initSegment"&&mu((i=a.decryptdata)==null?void 0:i.method)){var u=t-e;u%16&&(l=t+(16-u%16)),e!==0&&(r.resetIV=!0,s=e-16)}r.rangeStart=s,r.rangeEnd=l}return r}function us(a,o){var n=new Error("GAP "+(a.gap?"tag":"attribute")+" found"),r={type:V.MEDIA_ERROR,details:_.FRAG_GAP,fatal:!1,frag:a,error:n,networkDetails:null};return o&&(r.part=o),(o||a).stats.aborted=!0,new sr(r)}function mu(a){return a==="AES-128"||a==="AES-256"}var sr=function(a){function o(n){var r;return r=a.call(this,n.error.message)||this,r.data=void 0,r.data=n,r}return J(o,a),o}(dt(Error)),fs=function(a){function o(r,e){var t;return t=a.call(this,r,e)||this,t._boundTick=void 0,t._tickTimer=null,t._tickInterval=null,t._tickCallCount=0,t._boundTick=t.tick.bind(t),t}J(o,a);var n=o.prototype;return n.destroy=function(){this.onHandlerDestroying(),this.onHandlerDestroyed()},n.onHandlerDestroying=function(){this.clearNextTick(),this.clearInterval()},n.onHandlerDestroyed=function(){},n.hasInterval=function(){return!!this._tickInterval},n.hasNextTick=function(){return!!this._tickTimer},n.setInterval=function(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)},n.clearInterval=function(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1},n.clearNextTick=function(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1},n.tick=function(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)},n.tickImmediate=function(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)},n.doTick=function(){},o}(ie),Tn=function(o,n,r,e,t,i){e===void 0&&(e=0),t===void 0&&(t=-1),i===void 0&&(i=!1),this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=Ii(),this.buffering={audio:Ii(),video:Ii(),audiovideo:Ii()},this.level=o,this.sn=n,this.id=r,this.size=e,this.part=t,this.partial=i};function Ii(){return{start:0,executeStart:0,executeEnd:0,end:0}}var ds={length:0,start:function(){return 0},end:function(){return 0}},Se=function(){function a(){}return a.isBuffered=function(n,r){if(n){for(var e=a.getBuffered(n),t=e.length;t--;)if(r>=e.start(t)&&r<=e.end(t))return!0}return!1},a.bufferedRanges=function(n){if(n){var r=a.getBuffered(n);return a.timeRangesToArray(r)}return[]},a.timeRangesToArray=function(n){for(var r=[],e=0;e<n.length;e++)r.push({start:n.start(e),end:n.end(e)});return r},a.bufferInfo=function(n,r,e){if(n){var t=a.bufferedRanges(n);if(t.length)return a.bufferedInfo(t,r,e)}return{len:0,start:r,end:r,bufferedIndex:-1}},a.bufferedInfo=function(n,r,e){r=Math.max(0,r),n.length>1&&n.sort(function(y,E){return y.start-E.start||E.end-y.end});var t=-1,i=[];if(e)for(var s=0;s<n.length;s++){r>=n[s].start&&r<=n[s].end&&(t=s);var l=i.length;if(l){var u=i[l-1].end;n[s].start-u<e?n[s].end>u&&(i[l-1].end=n[s].end):i.push(n[s])}else i.push(n[s])}else i=n;for(var f=0,d,h=r,c=r,v=0;v<i.length;v++){var g=i[v].start,m=i[v].end;if(t===-1&&r>=g&&r<=m&&(t=v),r+e>=g&&r<m)h=g,c=m,f=c-r;else if(r+e<g){d=g;break}}return{len:f,start:h||0,end:c||0,nextStart:d,buffered:n,bufferedIndex:t}},a.getBuffered=function(n){try{return n.buffered||ds}catch(r){return X.log("failed to get media.buffered",r),ds}},a}(),hs=/\{\$([a-zA-Z0-9-_]+)\}/g;function cs(a){return hs.test(a)}function Sn(a,o){if(a.variableList!==null||a.hasVariableRefs){var n=a.variableList;return o.replace(hs,function(r){var e=r.substring(2,r.length-1),t=n==null?void 0:n[e];return t===void 0?(a.playlistParsingError||(a.playlistParsingError=new Error('Missing preceding EXT-X-DEFINE tag for Variable Reference: "'+e+'"')),r):t})}return o}function vs(a,o,n){var r=a.variableList;r||(a.variableList=r={});var e,t;if("QUERYPARAM"in o){e=o.QUERYPARAM;try{var i=new self.URL(n).searchParams;if(i.has(e))t=i.get(e);else throw new Error('"'+e+'" does not match any query parameter in URI: "'+n+'"')}catch(s){a.playlistParsingError||(a.playlistParsingError=new Error("EXT-X-DEFINE QUERYPARAM: "+s.message))}}else e=o.NAME,t=o.VALUE;e in r?a.playlistParsingError||(a.playlistParsingError=new Error('EXT-X-DEFINE duplicate Variable Name declarations: "'+e+'"')):r[e]=t||""}function pu(a,o,n){var r=o.IMPORT;if(n&&r in n){var e=a.variableList;e||(a.variableList=e={}),e[r]=n[r]}else a.playlistParsingError||(a.playlistParsingError=new Error('EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "'+r+'"'))}var yu=/^(\d+)x(\d+)$/,gs=/(.+?)=(".*?"|.*?)(?:,|$)/g,et=function(){function a(n,r){typeof n=="string"&&(n=a.parseAttrList(n,r)),ae(this,n)}var o=a.prototype;return o.decimalInteger=function(r){var e=parseInt(this[r],10);return e>Number.MAX_SAFE_INTEGER?1/0:e},o.hexadecimalInteger=function(r){if(this[r]){var e=(this[r]||"0x").slice(2);e=(e.length&1?"0":"")+e;for(var t=new Uint8Array(e.length/2),i=0;i<e.length/2;i++)t[i]=parseInt(e.slice(i*2,i*2+2),16);return t}return null},o.hexadecimalIntegerAsNumber=function(r){var e=parseInt(this[r],16);return e>Number.MAX_SAFE_INTEGER?1/0:e},o.decimalFloatingPoint=function(r){return parseFloat(this[r])},o.optionalFloat=function(r,e){var t=this[r];return t?parseFloat(t):e},o.enumeratedString=function(r){return this[r]},o.enumeratedStringList=function(r,e){var t=this[r];return(t?t.split(/[ ,]+/):[]).reduce(function(i,s){return i[s.toLowerCase()]=!0,i},e)},o.bool=function(r){return this[r]==="YES"},o.decimalResolution=function(r){var e=yu.exec(this[r]);if(e!==null)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}},a.parseAttrList=function(r,e){var t,i={},s='"';for(gs.lastIndex=0;(t=gs.exec(r))!==null;){var l=t[1].trim(),u=t[2],f=u.indexOf(s)===0&&u.lastIndexOf(s)===u.length-1,d=!1;if(f)u=u.slice(1,-1);else switch(l){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":d=!0}if(e&&(f||d))u=Sn(e,u);else if(!d&&!f)switch(l){case"CLOSED-CAPTIONS":if(u==="NONE")break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":X.warn(r+": attribute "+l+" is missing quotes")}i[l]=u}return i},z(a,[{key:"clientAttrs",get:function(){return Object.keys(this).filter(function(r){return r.substring(0,2)==="X-"})}}])}(),Eu="com.apple.hls.interstitial";function Tu(a){return a!=="ID"&&a!=="CLASS"&&a!=="CUE"&&a!=="START-DATE"&&a!=="DURATION"&&a!=="END-DATE"&&a!=="END-ON-NEXT"}function Su(a){return a==="SCTE35-OUT"||a==="SCTE35-IN"||a==="SCTE35-CMD"}var ms=function(){function a(o,n,r){var e;if(r===void 0&&(r=0),this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(n==null?void 0:n.tagAnchor)||null,this.tagOrder=(e=n==null?void 0:n.tagOrder)!=null?e:r,n){var t=n.attr;for(var i in t)if(Object.prototype.hasOwnProperty.call(o,i)&&o[i]!==t[i]){X.warn('DATERANGE tag attribute: "'+i+'" does not match for tags with ID: "'+o.ID+'"'),this._badValueForSameId=i;break}o=ae(new et({}),t,o)}if(this.attr=o,n?(this._startDate=n._startDate,this._cue=n._cue,this._endDate=n._endDate,this._dateAtEnd=n._dateAtEnd):this._startDate=new Date(o["START-DATE"]),"END-DATE"in this.attr){var s=(n==null?void 0:n.endDate)||new Date(this.attr["END-DATE"]);N(s.getTime())&&(this._endDate=s)}}return z(a,[{key:"id",get:function(){return this.attr.ID}},{key:"class",get:function(){return this.attr.CLASS}},{key:"cue",get:function(){var n=this._cue;return n===void 0?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):n}},{key:"startTime",get:function(){var n=this.tagAnchor;return n===null||n.programDateTime===null?(X.warn('Expected tagAnchor Fragment with PDT set for DateRange "'+this.id+'": '+n),NaN):n.start+(this.startDate.getTime()-n.programDateTime)/1e3}},{key:"startDate",get:function(){return this._startDate}},{key:"endDate",get:function(){var n=this._endDate||this._dateAtEnd;if(n)return n;var r=this.duration;return r!==null?this._dateAtEnd=new Date(this._startDate.getTime()+r*1e3):null}},{key:"duration",get:function(){if("DURATION"in this.attr){var n=this.attr.decimalFloatingPoint("DURATION");if(N(n))return n}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}},{key:"plannedDuration",get:function(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}},{key:"endOnNext",get:function(){return this.attr.bool("END-ON-NEXT")}},{key:"isInterstitial",get:function(){return this.class===Eu}},{key:"isValid",get:function(){return!!this.id&&!this._badValueForSameId&&N(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}])}(),Au=10,xu=function(){function a(n){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=n}var o=a.prototype;return o.reloaded=function(r){if(!r){this.advanced=!0,this.updated=!0;return}var e=this.lastPartSn-r.lastPartSn,t=this.lastPartIndex-r.lastPartIndex;this.updated=this.endSN!==r.endSN||!!t||!!e||!this.live,this.advanced=this.endSN>r.endSN||e>0||e===0&&t>0,this.updated||this.advanced?this.misses=Math.floor(r.misses*.6):this.misses=r.misses+1},z(a,[{key:"hasProgramDateTime",get:function(){return this.fragments.length?N(this.fragments[this.fragments.length-1].programDateTime):!1}},{key:"levelTargetDuration",get:function(){return this.averagetargetduration||this.targetduration||Au}},{key:"drift",get:function(){var r=this.driftEndTime-this.driftStartTime;if(r>0){var e=this.driftEnd-this.driftStart;return e*1e3/r}return 1}},{key:"edge",get:function(){return this.partEnd||this.fragmentEnd}},{key:"partEnd",get:function(){var r;return(r=this.partList)!=null&&r.length?this.partList[this.partList.length-1].end:this.fragmentEnd}},{key:"fragmentEnd",get:function(){var r;return(r=this.fragments)!=null&&r.length?this.fragments[this.fragments.length-1].end:0}},{key:"fragmentStart",get:function(){var r;return(r=this.fragments)!=null&&r.length?this.fragments[0].start:0}},{key:"age",get:function(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}},{key:"lastPartIndex",get:function(){var r;return(r=this.partList)!=null&&r.length?this.partList[this.partList.length-1].index:-1}},{key:"maxPartIndex",get:function(){var r=this.partList;if(r){var e=this.lastPartIndex;if(e!==-1){for(var t=r.length;t--;)if(r[t].index>e)return r[t].index;return e}}return 0}},{key:"lastPartSn",get:function(){var r;return(r=this.partList)!=null&&r.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}},{key:"expired",get:function(){if(this.live&&this.age&&this.misses<3){var r=this.partEnd-this.fragmentStart;return this.age>Math.max(r,this.totalduration)+this.levelTargetDuration}return!1}}])}();function Mr(a){return a==="AES-128"||a==="AES-256"||a==="AES-256-CTR"}function An(a){switch(a){case"AES-128":case"AES-256":return cr.cbc;case"AES-256-CTR":return cr.ctr;default:throw new Error("invalid full segment method "+a)}}function xn(a){return Uint8Array.from(atob(a),function(o){return o.charCodeAt(0)})}function Ln(a){return Uint8Array.from(unescape(encodeURIComponent(a)),function(o){return o.charCodeAt(0)})}function Lu(a){var o=Ln(a).subarray(0,16),n=new Uint8Array(16);return n.set(o,16-o.length),n}function bu(a){var o=function(r,e,t){var i=r[e];r[e]=r[t],r[t]=i};o(a,0,3),o(a,1,2),o(a,4,5),o(a,6,7)}function Ru(a){var o=a.split(":"),n=null;if(o[0]==="data"&&o.length===2){var r=o[1].split(";"),e=r[r.length-1].split(",");if(e.length===2){var t=e[0]==="base64",i=e[1];t?(r.splice(-1,1),n=xn(i)):n=Lu(i)}}return n}var _i=typeof self<"u"?self:void 0,De={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},Ct={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function bn(a){switch(a){case Ct.FAIRPLAY:return De.FAIRPLAY;case Ct.PLAYREADY:return De.PLAYREADY;case Ct.WIDEVINE:return De.WIDEVINE;case Ct.CLEARKEY:return De.CLEARKEY}}var Di={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function Rn(a){if(a===Di.WIDEVINE)return De.WIDEVINE;if(a===Di.PLAYREADY)return De.PLAYREADY;if(a===Di.CENC||a===Di.CLEARKEY)return De.CLEARKEY}function In(a){switch(a){case De.FAIRPLAY:return Ct.FAIRPLAY;case De.PLAYREADY:return Ct.PLAYREADY;case De.WIDEVINE:return Ct.WIDEVINE;case De.CLEARKEY:return Ct.CLEARKEY}}function ki(a){var o=a.drmSystems,n=a.widevineLicenseUrl,r=o?[De.FAIRPLAY,De.WIDEVINE,De.PLAYREADY,De.CLEARKEY].filter(function(e){return!!o[e]}):[];return!r[De.WIDEVINE]&&n&&r.push(De.WIDEVINE),r}var ps=function(a){return _i!=null&&(a=_i.navigator)!=null&&a.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function Iu(a,o,n,r){var e;switch(a){case De.FAIRPLAY:e=["cenc","sinf"];break;case De.WIDEVINE:case De.PLAYREADY:e=["cenc"];break;case De.CLEARKEY:e=["cenc","keyids"];break;default:throw new Error("Unknown key-system: "+a)}return _u(e,o,n,r)}function _u(a,o,n,r){var e={initDataTypes:a,persistentState:r.persistentState||"optional",distinctiveIdentifier:r.distinctiveIdentifier||"optional",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:o.map(function(t){return{contentType:"audio/mp4; codecs="+t,robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null}}),videoCapabilities:n.map(function(t){return{contentType:"video/mp4; codecs="+t,robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null}})};return[e]}function Du(a){var o;return a.sessionType==="persistent-license"||!!((o=a.sessionTypes)!=null&&o.some(function(n){return n==="persistent-license"}))}function ys(a){var o=new Uint16Array(a.buffer,a.byteOffset,a.byteLength/2),n=String.fromCharCode.apply(null,Array.from(o)),r=n.substring(n.indexOf("<"),n.length),e=new DOMParser,t=e.parseFromString(r,"text/xml"),i=t.getElementsByTagName("KID")[0];if(i){var s=i.childNodes[0]?i.childNodes[0].nodeValue:i.getAttribute("VALUE");if(s){var l=xn(s).subarray(0,16);return bu(l),l}}return null}var Ci={},_n=function(){function a(n,r,e,t,i){t===void 0&&(t=[1]),i===void 0&&(i=null),this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=n,this.uri=r,this.keyFormat=e,this.keyFormatVersions=t,this.iv=i,this.encrypted=n?n!=="NONE":!1,this.isCommonEncryption=this.encrypted&&!Mr(n)}a.clearKeyUriToKeyIdMap=function(){Ci={}};var o=a.prototype;return o.isSupported=function(){if(this.method){if(Mr(this.method)||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case Ct.FAIRPLAY:case Ct.WIDEVINE:case Ct.PLAYREADY:case Ct.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1},o.getDecryptData=function(r){if(!this.encrypted||!this.uri)return null;if(Mr(this.method)&&this.uri&&!this.iv){typeof r!="number"&&(X.warn('missing IV for initialization segment with method="'+this.method+'" - compliance issue'),r=0);var e=ku(r),t=new a(this.method,this.uri,"identity",this.keyFormatVersions,e);return t}var i=Ru(this.uri);if(i)switch(this.keyFormat){case Ct.WIDEVINE:this.pssh=i,i.length>=22&&(this.keyId=i.subarray(i.length-22,i.length-6));break;case Ct.PLAYREADY:{var s=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=Ol(s,null,i),this.keyId=ys(i);break}default:{var l=i.subarray(0,16);if(l.length!==16){var u=new Uint8Array(16);u.set(l,16-l.length),l=u}this.keyId=l;break}}if(!this.keyId||this.keyId.byteLength!==16){var f=Ci[this.uri];if(!f){var d=Object.keys(Ci).length%Number.MAX_SAFE_INTEGER;f=new Uint8Array(16);var h=new DataView(f.buffer,12,4);h.setUint32(0,d),Ci[this.uri]=f}this.keyId=f}return this},a}();function ku(a){for(var o=new Uint8Array(16),n=12;n<16;n++)o[n]=a>>8*(15-n)&255;return o}var Es=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,Ts=/#EXT-X-MEDIA:(.*)/g,Cu=/^#EXT(?:INF|-X-TARGETDURATION):/m,Dn=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),Pu=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|")),Zr=function(){function a(){}return a.findGroup=function(n,r){for(var e=0;e<n.length;e++){var t=n[e];if(t.id===r)return t}},a.resolve=function(n,r){return Ze.buildAbsoluteURL(r,n,{alwaysNormalize:!0})},a.isMediaPlaylist=function(n){return Cu.test(n)},a.parseMasterPlaylist=function(n,r){var e=cs(n),t={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:e},i=[];Es.lastIndex=0;for(var s;(s=Es.exec(n))!=null;)if(s[1]){var l,u=new et(s[1],t),f=Sn(t,s[2]),d={attrs:u,bitrate:u.decimalInteger("BANDWIDTH")||u.decimalInteger("AVERAGE-BANDWIDTH"),name:u.NAME,url:a.resolve(f,r)},h=u.decimalResolution("RESOLUTION");h&&(d.width=h.width,d.height=h.height),Ls(u.CODECS,d);var c=u["SUPPLEMENTAL-CODECS"];c&&(d.supplemental={},Ls(c,d.supplemental)),(l=d.unknownCodecs)!=null&&l.length||i.push(d),t.levels.push(d)}else if(s[3]){var v=s[3],g=s[4];switch(v){case"SESSION-DATA":{var m=new et(g,t),y=m["DATA-ID"];y&&(t.sessionData===null&&(t.sessionData={}),t.sessionData[y]=m);break}case"SESSION-KEY":{var E=As(g,r,t);E.encrypted&&E.isSupported()?(t.sessionKeys===null&&(t.sessionKeys=[]),t.sessionKeys.push(E)):X.warn('[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "'+g+'"');break}case"DEFINE":{{var T=new et(g,t);vs(t,T,r)}break}case"CONTENT-STEERING":{var S=new et(g,t);t.contentSteering={uri:a.resolve(S["SERVER-URI"],r),pathwayId:S["PATHWAY-ID"]||"."};break}case"START":{t.startTimeOffset=xs(g);break}}}var A=i.length>0&&i.length<t.levels.length;return t.levels=A?i:t.levels,t.levels.length===0&&(t.playlistParsingError=new Error("no levels found in manifest")),t},a.parseMasterPlaylistMedia=function(n,r,e){var t,i={},s=e.levels,l={AUDIO:s.map(function(A){return{id:A.attrs.AUDIO,audioCodec:A.audioCodec}}),SUBTITLES:s.map(function(A){return{id:A.attrs.SUBTITLES,textCodec:A.textCodec}}),"CLOSED-CAPTIONS":[]},u=0;for(Ts.lastIndex=0;(t=Ts.exec(n))!==null;){var f=new et(t[1],e),d=f.TYPE;if(d){var h=l[d],c=i[d]||[];i[d]=c;var v=f.LANGUAGE,g=f["ASSOC-LANGUAGE"],m=f.CHANNELS,y=f.CHARACTERISTICS,E=f["INSTREAM-ID"],T={attrs:f,bitrate:0,id:u++,groupId:f["GROUP-ID"]||"",name:f.NAME||v||"",type:d,default:f.bool("DEFAULT"),autoselect:f.bool("AUTOSELECT"),forced:f.bool("FORCED"),lang:v,url:f.URI?a.resolve(f.URI,r):""};if(g&&(T.assocLang=g),m&&(T.channels=m),y&&(T.characteristics=y),E&&(T.instreamId=E),h!=null&&h.length){var S=a.findGroup(h,T.groupId)||h[0];bs(T,S,"audioCodec"),bs(T,S,"textCodec")}c.push(T)}}return i},a.parseLevelPlaylist=function(n,r,e,t,i,s){var l,u={url:r},f=new xu(r),d=f.fragments,h=[],c=null,v=0,g=0,m=0,y=0,E=0,T=null,S=new Dt(t,u),A,x,L,I=-1,k=!1,R=null,b;if(Dn.lastIndex=0,f.m3u8=n,f.hasVariableRefs=cs(n),((l=Dn.exec(n))==null?void 0:l[0])!=="#EXTM3U")return f.playlistParsingError=new Error("Missing format identifier #EXTM3U"),f;for(;(A=Dn.exec(n))!==null;){k&&(k=!1,S=new Dt(t,u),S.playlistOffset=m,S.start=m,S.sn=v,S.cc=y,E&&(S.bitrate=E),S.level=e,c&&(S.initSegment=c,c.rawProgramDateTime&&(S.rawProgramDateTime=c.rawProgramDateTime,c.rawProgramDateTime=null),R&&(S.setByteRange(R),R=null)));var D=A[1];if(D){S.duration=parseFloat(D);var P=(" "+A[2]).slice(1);S.title=P||null,S.tagList.push(P?["INF",D,P]:["INF",D])}else if(A[3]){if(N(S.duration)){S.playlistOffset=m,S.start=m,L&&Is(S,L,f),S.sn=v,S.level=e,S.cc=y,d.push(S);var U=(" "+A[3]).slice(1);S.relurl=Sn(f,U),kn(S,T,h),T=S,m+=S.duration,v++,g=0,k=!0}}else{if(A=A[0].match(Pu),!A){X.warn("No matches on slow regex match for level playlist!");continue}for(x=1;x<A.length&&A[x]===void 0;x++);var F=(" "+A[x]).slice(1),M=(" "+A[x+1]).slice(1),H=A[x+2]?(" "+A[x+2]).slice(1):null;switch(F){case"BYTERANGE":T?S.setByteRange(M,T):S.setByteRange(M);break;case"PROGRAM-DATE-TIME":S.rawProgramDateTime=M,S.tagList.push(["PROGRAM-DATE-TIME",M]),I===-1&&(I=d.length);break;case"PLAYLIST-TYPE":f.type&&or(f,F,A),f.type=M.toUpperCase();break;case"MEDIA-SEQUENCE":f.startSN!==0?or(f,F,A):d.length>0&&_s(f,F,A),v=f.startSN=parseInt(M);break;case"SKIP":{f.skippedSegments&&or(f,F,A);var q=new et(M,f),W=q.decimalInteger("SKIPPED-SEGMENTS");if(N(W)){f.skippedSegments+=W;for(var ee=W;ee--;)d.push(null);v+=W}var ye=q.enumeratedString("RECENTLY-REMOVED-DATERANGES");ye&&(f.recentlyRemovedDateranges=(f.recentlyRemovedDateranges||[]).concat(ye.split("	")));break}case"TARGETDURATION":f.targetduration!==0&&or(f,F,A),f.targetduration=Math.max(parseInt(M),1);break;case"VERSION":f.version!==null&&or(f,F,A),f.version=parseInt(M);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":f.live||or(f,F,A),f.live=!1;break;case"#":(M||H)&&S.tagList.push(H?[M,H]:[M]);break;case"DISCONTINUITY":y++,S.tagList.push(["DIS"]);break;case"GAP":S.gap=!0,S.tagList.push([F]);break;case"BITRATE":S.tagList.push([F,M]),E=parseInt(M)*1e3,N(E)?S.bitrate=E:E=0;break;case"DATERANGE":{var le=new et(M,f),Ae=new ms(le,f.dateRanges[le.ID],f.dateRangeTagCount);f.dateRangeTagCount++,Ae.isValid||f.skippedSegments?f.dateRanges[Ae.id]=Ae:X.warn('Ignoring invalid DATERANGE tag: "'+M+'"'),S.tagList.push(["EXT-X-DATERANGE",M]);break}case"DEFINE":{{var de=new et(M,f);"IMPORT"in de?pu(f,de,s):vs(f,de,r)}break}case"DISCONTINUITY-SEQUENCE":f.startCC!==0?or(f,F,A):d.length>0&&_s(f,F,A),f.startCC=y=parseInt(M);break;case"KEY":{var xe=As(M,r,f);if(xe.isSupported()){if(xe.method==="NONE"){L=void 0;break}L||(L={}),L[xe.keyFormat]&&(L=ae({},L)),L[xe.keyFormat]=xe}else X.warn('[Keys] Ignoring invalid EXT-X-KEY tag: "'+M+'"');break}case"START":f.startTimeOffset=xs(M);break;case"MAP":{var Le=new et(M,f);if(S.duration){var Me=new Dt(t,u);Rs(Me,Le,e,L),c=Me,S.initSegment=c,c.rawProgramDateTime&&!S.rawProgramDateTime&&(S.rawProgramDateTime=c.rawProgramDateTime)}else{var tt=S.byteRangeEndOffset;if(tt){var Xe=S.byteRangeStartOffset;R=tt-Xe+"@"+Xe}else R=null;Rs(S,Le,e,L),c=S,k=!0}c.cc=y;break}case"SERVER-CONTROL":{b&&or(f,F,A),b=new et(M),f.canBlockReload=b.bool("CAN-BLOCK-RELOAD"),f.canSkipUntil=b.optionalFloat("CAN-SKIP-UNTIL",0),f.canSkipDateRanges=f.canSkipUntil>0&&b.bool("CAN-SKIP-DATERANGES"),f.partHoldBack=b.optionalFloat("PART-HOLD-BACK",0),f.holdBack=b.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{f.partTarget&&or(f,F,A);var Ke=new et(M);f.partTarget=Ke.decimalFloatingPoint("PART-TARGET");break}case"PART":{var rt=f.partList;rt||(rt=f.partList=[]);var We=g>0?rt[rt.length-1]:void 0,ge=g++,yt=new et(M,f),ct=new It(yt,S,u,ge,We);rt.push(ct),S.duration+=ct.duration;break}case"PRELOAD-HINT":{var ft=new et(M,f);f.preloadHint=ft;break}case"RENDITION-REPORT":{var ze=new et(M,f);f.renditionReports=f.renditionReports||[],f.renditionReports.push(ze);break}default:X.warn("line parsed but not handled: "+A);break}}}T&&!T.relurl?(d.pop(),m-=T.duration,f.partList&&(f.fragmentHint=T)):f.partList&&(kn(S,T,h),S.cc=y,f.fragmentHint=S,L&&Is(S,L,f)),f.targetduration||(f.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));var Et=d.length,Ye=d[0],it=d[Et-1];if(m+=f.skippedSegments*f.targetduration,m>0&&Et&&it){f.averagetargetduration=m/Et;var rr=it.sn;f.endSN=rr!=="initSegment"?rr:0,f.live||(it.endList=!0),Ye&&f.startCC===void 0&&(f.startCC=Ye.cc),I>0&&(Mu(d,I),Ye&&h.unshift(Ye))}else f.endSN=0,f.startCC=0;return f.fragmentHint&&(m+=f.fragmentHint.duration),f.totalduration=m,h.length&&f.dateRangeTagCount&&Ye&&Ss(h,f),f.endCC=y,f},a}();function Ss(a,o){for(var n=a.length,r=a[n-1],e=o.live?1/0:o.totalduration,t=Object.keys(o.dateRanges),i=t.length;i--;){var s=o.dateRanges[t[i]],l=s.startDate.getTime();s.tagAnchor=r.ref;for(var u=n;u--;){var f=wu(o,l,a,u,e);if(f!==-1){s.tagAnchor=o.fragments[f].ref;break}}}}function wu(a,o,n,r,e){var t=n[r];if(t){var i=t.programDateTime;if(o>=i||r===0){var s,l=(((s=n[r+1])==null?void 0:s.start)||e)-t.start;if(o<=i+l*1e3){var u=n[r].sn-a.startSN,f=a.fragments;if(f.length>n.length)for(var d=n[r+1]||f[f.length-1],h=d.sn-a.startSN,c=h;c>u;c--){var v=f[c].programDateTime;if(o>=v&&o<v+f[c].duration*1e3)return c}return u}}}return-1}function As(a,o,n){var r,e,t=new et(a,n),i=(r=t.METHOD)!=null?r:"",s=t.URI,l=t.hexadecimalInteger("IV"),u=t.KEYFORMATVERSIONS,f=(e=t.KEYFORMAT)!=null?e:"identity";s&&t.IV&&!l&&X.error("Invalid IV: "+t.IV);var d=s?Zr.resolve(s,o):"",h=(u||"1").split("/").map(Number).filter(Number.isFinite);return new _n(i,d,f,h,l)}function xs(a){var o=new et(a),n=o.decimalFloatingPoint("TIME-OFFSET");return N(n)?n:null}function Ls(a,o){var n=(a||"").split(/[ ,]+/).filter(function(r){return r});["video","audio","text"].forEach(function(r){var e=n.filter(function(t){return Ka(t,r)});e.length&&(o[r+"Codec"]=e.map(function(t){return t.split("/")[0]}).join(","),n=n.filter(function(t){return e.indexOf(t)===-1}))}),o.unknownCodecs=n}function bs(a,o,n){var r=o[n];r&&(a[n]=r)}function Mu(a,o){for(var n=a[o],r=o;r--;){var e=a[r];if(!e)return;e.programDateTime=n.programDateTime-e.duration*1e3,n=e}}function kn(a,o,n){a.rawProgramDateTime?n.push(a):o!=null&&o.programDateTime&&(a.programDateTime=o.endProgramDateTime)}function Rs(a,o,n,r){a.relurl=o.URI,o.BYTERANGE&&a.setByteRange(o.BYTERANGE),a.level=n,a.sn="initSegment",r&&(a.levelkeys=r),a.initSegment=null}function Is(a,o,n){a.levelkeys=o;var r=n.encryptedFragments;(!r.length||r[r.length-1].levelkeys!==o)&&Object.keys(o).some(function(e){return o[e].isCommonEncryption})&&r.push(a)}function or(a,o,n){a.playlistParsingError=new Error("#EXT-X-"+o+" must not appear more than once ("+n[0]+")")}function _s(a,o,n){a.playlistParsingError=new Error("#EXT-X-"+o+" must appear before the first Media Segment ("+n[0]+")")}function Cn(a,o){var n=o.startPTS;if(N(n)){var r=0,e;o.sn>a.sn?(r=n-a.start,e=a):(r=a.start-n,e=o),e.duration!==r&&e.setDuration(r)}else if(o.sn>a.sn){var t=a.cc===o.cc;t&&a.minEndPTS?o.setStart(a.start+(a.minEndPTS-a.start)):o.setStart(a.start+a.duration)}else o.setStart(Math.max(a.start-o.duration,0))}function Ds(a,o,n,r,e,t){var i=r-n;i<=0&&(X.warn("Fragment should have a positive duration",o),r=n+o.duration,t=e+o.duration);var s=n,l=r,u=o.startPTS,f=o.endPTS;if(N(u)){var d=Math.abs(u-n);N(o.deltaPTS)?o.deltaPTS=Math.max(d,o.deltaPTS):o.deltaPTS=d,s=Math.max(n,u),n=Math.min(n,u),e=Math.min(e,o.startDTS),l=Math.min(r,f),r=Math.max(r,f),t=Math.max(t,o.endDTS)}var h=n-o.start;o.start!==0&&o.setStart(n),o.setDuration(r-o.start),o.startPTS=n,o.maxStartPTS=s,o.startDTS=e,o.endPTS=r,o.minEndPTS=l,o.endDTS=t;var c=o.sn;if(!a||c<a.startSN||c>a.endSN)return 0;var v,g=c-a.startSN,m=a.fragments;for(m[g]=o,v=g;v>0;v--)Cn(m[v],m[v-1]);for(v=g;v<m.length-1;v++)Cn(m[v],m[v+1]);return a.fragmentHint&&Cn(m[m.length-1],a.fragmentHint),a.PTSKnown=a.alignedSliding=!0,h}function Ou(a,o){if(a!==o){for(var n=null,r=a.fragments,e=r.length-1;e>=0;e--){var t=r[e].initSegment;if(t){n=t;break}}a.fragmentHint&&delete a.fragmentHint.endPTS;var i;Uu(a,o,function(v,g,m,y){if(!o.startCC&&g.cc!==v.cc){for(var E,T,S=v.cc-g.cc,A=m;A<y.length;A++)y[A].cc+=S;o.startCC=(E=(T=ws(a,o.startSN-1))==null?void 0:T.cc)!=null?E:y[0].cc,o.endCC=y[y.length-1].cc}N(v.startPTS)&&N(v.endPTS)&&(g.setStart(g.startPTS=v.startPTS),g.startDTS=v.startDTS,g.maxStartPTS=v.maxStartPTS,g.endPTS=v.endPTS,g.endDTS=v.endDTS,g.minEndPTS=v.minEndPTS,g.setDuration(v.endPTS-v.startPTS),g.duration&&(i=g),o.PTSKnown=o.alignedSliding=!0),v.hasStreams&&(g.elementaryStreams=v.elementaryStreams),g.loader=v.loader,v.hasStats&&(g.stats=v.stats),v.initSegment&&(g.initSegment=v.initSegment,n=v.initSegment)});var s=o.fragments,l=o.fragmentHint?s.concat(o.fragmentHint):s;if(n&&l.forEach(function(v){var g;v&&(!v.initSegment||v.initSegment.relurl===((g=n)==null?void 0:g.relurl))&&(v.initSegment=n)}),o.skippedSegments)if(o.deltaUpdateFailed=s.some(function(v){return!v}),o.deltaUpdateFailed){X.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(var u=o.skippedSegments;u--;)s.shift();o.startSN=s[0].sn}else{o.endCC=s[s.length-1].cc,o.canSkipDateRanges&&(o.dateRanges=Fu(a.dateRanges,o));var f=a.fragments.filter(function(v){return v.rawProgramDateTime});if(a.hasProgramDateTime&&!o.hasProgramDateTime)for(var d=1;d<l.length;d++)l[d].programDateTime===null&&kn(l[d],l[d-1],f);Ss(f,o)}Nu(a.partList,o.partList,function(v,g){g.elementaryStreams=v.elementaryStreams,g.stats=v.stats}),i?Ds(o,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS):Cs(a,o),s.length&&(o.totalduration=o.edge-s[0].start),o.driftStartTime=a.driftStartTime,o.driftStart=a.driftStart;var h=o.advancedDateTime;if(o.advanced&&h){var c=o.edge;o.driftStart||(o.driftStartTime=h,o.driftStart=c),o.driftEndTime=h,o.driftEnd=c}else o.driftEndTime=a.driftEndTime,o.driftEnd=a.driftEnd,o.advancedDateTime=a.advancedDateTime;o.requestScheduled===-1&&(o.requestScheduled=a.requestScheduled)}}function Fu(a,o){var n=o.dateRanges,r=o.recentlyRemovedDateranges,e=ae({},a);r&&r.forEach(function(s){delete e[s]});var t=Object.keys(e),i=t.length;return i&&Object.keys(n).forEach(function(s){var l=e[s],u=new ms(n[s].attr,l);u.isValid?(e[s]=u,l||(u.tagOrder+=i)):X.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'+He(n[s].attr)+'"')}),e}function Nu(a,o,n){if(a&&o)for(var r=0,e=0,t=a.length;e<=t;e++){var i=a[e],s=o[e+r];i&&s&&i.index===s.index&&i.fragment.sn===s.fragment.sn?n(i,s):r--}}function Uu(a,o,n){for(var r=o.skippedSegments,e=Math.max(a.startSN,o.startSN)-o.startSN,t=(a.fragmentHint?1:0)+(r?o.endSN:Math.min(a.endSN,o.endSN))-o.startSN,i=o.startSN-a.startSN,s=o.fragmentHint?o.fragments.concat(o.fragmentHint):o.fragments,l=a.fragmentHint?a.fragments.concat(a.fragmentHint):a.fragments,u=e;u<=t;u++){var f=l[i+u],d=s[u];if(r&&!d&&f&&(d=o.fragments[u]=f),f&&d){if(n(f,d,u,s),f.url&&f.url!==d.url){o.playlistParsingError=ks("media sequence mismatch "+d.sn+":",a,o,f,d);return}else if(f.cc!==d.cc){o.playlistParsingError=ks("discontinuity sequence mismatch ("+f.cc+"!="+d.cc+")",a,o,f,d);return}}}}function ks(a,o,n,r,e){return new Error(a+" "+e.url+`
Playlist starting @`+o.startSN+`
`+o.m3u8+`

Playlist starting @`+n.startSN+`
`+n.m3u8)}function Cs(a,o,n){n===void 0&&(n=!0);var r=o.startSN+o.skippedSegments-a.startSN,e=a.fragments,t=r>=0,i=0;if(t&&r<e.length)i=e[r].start;else if(t&&o.startSN===a.endSN+1)i=a.fragmentEnd;else if(t&&n)i=a.fragmentStart+r*o.levelTargetDuration;else if(!o.skippedSegments&&o.fragmentStart===0)i=a.fragmentStart;else return;Pn(o,i)}function Pn(a,o){if(o){for(var n=a.fragments,r=a.skippedSegments;r<n.length;r++)n[r].addStart(o);a.fragmentHint&&a.fragmentHint.addStart(o)}}function Ps(a,o){o===void 0&&(o=1/0);var n=1e3*a.targetduration;if(a.updated){var r=a.fragments,e=4;if(r.length&&n*e>o){var t=r[r.length-1].duration*1e3;t<n&&(n=t)}}else n/=2;return Math.round(n)}function ws(a,o,n){if(!a)return null;var r=a.fragments[o-a.startSN];return r||(r=a.fragmentHint,r&&r.sn===o)?r:o<a.startSN&&n&&n.sn===o?n:null}function Ms(a,o,n){return a?Os(a.partList,o,n):null}function Os(a,o,n){if(a)for(var r=a.length;r--;){var e=a[r];if(e.index===n&&e.fragment.sn===o)return e}return null}function Fs(a){a.forEach(function(o,n){var r;(r=o.details)==null||r.fragments.forEach(function(e){e.level=n,e.initSegment&&(e.initSegment.level=n)})})}function ei(a,o){for(var n=0,r=a.length;n<r;n++){var e;if(((e=a[n])==null?void 0:e.cc)===o)return a[n]}return null}function Bu(a,o){return!!(a&&o.startCC<a.endCC&&o.endCC>a.startCC)}function Ns(a,o){if(a){var n=a.start+o;a.start=a.startPTS=n,a.endPTS=n+a.duration}}function Us(a,o){for(var n=o.fragments,r=0,e=n.length;r<e;r++)Ns(n[r],a);o.fragmentHint&&Ns(o.fragmentHint,a),o.alignedSliding=!0}function Gu(a,o){a&&(Bs(o,a),!o.alignedSliding&&a&&Pi(o,a),!o.alignedSliding&&a&&!o.skippedSegments&&Cs(a,o,!1))}function Bs(a,o){if(Bu(o,a)){var n=Math.min(o.endCC,a.endCC),r=ei(o.fragments,n),e=ei(a.fragments,n);if(!(!r||!e)){X.log("Aligning playlist at start of dicontinuity sequence "+n);var t=r.start-e.start;Us(t,a)}}}function Pi(a,o){if(!(!a.hasProgramDateTime||!o.hasProgramDateTime)){var n=a.fragments,r=o.fragments;if(!(!n.length||!r.length)){var e,t,i=Math.min(o.endCC,a.endCC);o.startCC<i&&a.startCC<i&&(e=ei(r,i),t=ei(n,i)),(!e||!t)&&(e=r[Math.floor(r.length/2)],t=ei(n,e.cc)||n[Math.floor(n.length/2)]);var s=e.programDateTime,l=t.programDateTime;if(!(!s||!l)){var u=(l-s)/1e3-(t.start-e.start);Us(u,a)}}}}var Ku={toString:function(o){for(var n="",r=o.length,e=0;e<r;e++)n+="["+o.start(e).toFixed(3)+"-"+o.end(e).toFixed(3)+"]";return n}},w={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"},wn=function(a){function o(r,e,t,i,s){var l;return l=a.call(this,i,r.logger)||this,l.hls=void 0,l.fragPrevious=null,l.fragCurrent=null,l.fragmentTracker=void 0,l.transmuxer=null,l._state=w.STOPPED,l.playlistType=void 0,l.media=null,l.mediaBuffer=null,l.config=void 0,l.bitrateTest=!1,l.lastCurrentTime=0,l.nextLoadPosition=0,l.startPosition=0,l.startTimeOffset=null,l.retryDate=0,l.levels=null,l.fragmentLoader=void 0,l.keyLoader=void 0,l.levelLastLoaded=null,l.startFragRequested=!1,l.decrypter=void 0,l.initPTS=[],l.buffering=!0,l.loadingParts=!1,l.loopSn=void 0,l.onMediaSeeking=function(){var u=l,f=u.config,d=u.fragCurrent,h=u.media,c=u.mediaBuffer,v=u.state,g=h?h.currentTime:0,m=Se.bufferInfo(c||h,g,f.maxBufferHole);if(l.log("media seeking to "+(N(g)?g.toFixed(3):g)+", state: "+v),l.state===w.ENDED)l.resetLoadingState();else if(d){var y=f.maxFragLookUpTolerance,E=d.start-y,T=d.start+d.duration+y;if(!m.len||T<m.start||E>m.end){var S=g>T;(g<E||S)&&(S&&d.loader&&(l.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),d.abortRequests(),l.resetLoadingState()),l.fragPrevious=null)}}if(h){l.fragmentTracker.removeFragmentsInRange(g,1/0,l.playlistType,!0);var A=l.lastCurrentTime;if(g>A&&(l.lastCurrentTime=g),!l.loadingParts){var x=Math.max(m.end,g),L=l.shouldLoadParts(l.getLevelDetails(),x);L&&(l.log("LL-Part loading ON after seeking to "+g.toFixed(2)+" with buffer @"+x.toFixed(2)),l.loadingParts=L)}}!l.hls.hasEnoughToStart&&!m.len&&(l.log("setting startPosition to "+g+" because of seek before start"),l.nextLoadPosition=l.startPosition=g),l.tickImmediate()},l.onMediaEnded=function(){l.log("setting startPosition to 0 because media ended"),l.startPosition=l.lastCurrentTime=0},l.playlistType=s,l.hls=r,l.fragmentLoader=new gu(r.config),l.keyLoader=t,l.fragmentTracker=e,l.config=r.config,l.decrypter=new En(r.config),l}J(o,a);var n=o.prototype;return n.registerListeners=function(){var e=this.hls;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.ERROR,this.onError,this)},n.doTick=function(){this.onTickEnd()},n.onTickEnd=function(){},n.startLoad=function(e){},n.stopLoad=function(){if(this.state!==w.STOPPED){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);var e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=w.STOPPED}},n.pauseBuffering=function(){this.buffering=!1},n.resumeBuffering=function(){this.buffering=!0},n._streamEnded=function(e,t){if(t.live||!this.media)return!1;var i=e.end||0,s=this.config.timelineOffset||0;if(i<=s)return!1;var l=e.nextStart,u=l&&l>s&&l<t.edge;if(u||this.media.currentTime<e.start)return!1;var f=t.partList;if(f!=null&&f.length){var d=f[f.length-1],h=Se.isBuffered(this.media,d.start+d.duration/2);return h}var c=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(c)},n.getLevelDetails=function(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}},n.onMediaAttached=function(e,t){var i=this.media=this.mediaBuffer=t.media;i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),i.addEventListener("seeking",this.onMediaSeeking),i.addEventListener("ended",this.onMediaEnded);var s=this.config;this.levels&&s.autoStartLoad&&this.state===w.STOPPED&&this.startLoad(s.startPosition)},n.onMediaDetaching=function(e,t){var i=!!t.transferMedia,s=this.media;if(s!==null){if(s.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),s.removeEventListener("seeking",this.onMediaSeeking),s.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!i&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,i){this.resetLoadingState(),this.resetTransmuxer();return}this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}},n.onManifestLoading=function(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1},n.onError=function(e,t){},n.onManifestLoaded=function(e,t){this.startTimeOffset=t.startTimeOffset},n.onHandlerDestroying=function(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),a.prototype.onHandlerDestroying.call(this),this.hls=this.onMediaSeeking=this.onMediaEnded=null},n.onHandlerDestroyed=function(){this.state=w.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,a.prototype.onHandlerDestroyed.call(this)},n.loadFragment=function(e,t,i){this.startFragRequested=!0,this._loadFragForPlayback(e,t,i)},n._loadFragForPlayback=function(e,t,i){var s=this,l=function(f){var d=f.frag;if(s.fragContextChanged(d)){s.warn(d.type+" sn: "+d.sn+(f.part?" part: "+f.part.index:"")+" of "+s.fragInfo(d,!1,f.part)+") was dropped during download."),s.fragmentTracker.removeFragment(d);return}d.stats.chunkCount++,s._handleFragmentLoadProgress(f)};this._doFragLoad(e,t,i,l).then(function(u){if(u){var f=s.state,d=u.frag;if(s.fragContextChanged(d)){(f===w.FRAG_LOADING||!s.fragCurrent&&f===w.PARSING)&&(s.fragmentTracker.removeFragment(d),s.state=w.IDLE);return}"payload"in u&&(s.log("Loaded "+d.type+" sn: "+d.sn+" of "+s.playlistLabel()+" "+d.level),s.hls.trigger(p.FRAG_LOADED,u)),s._handleFragmentLoadComplete(u)}}).catch(function(u){s.state===w.STOPPED||s.state===w.ERROR||(s.warn("Frag error: "+((u==null?void 0:u.message)||u)),s.resetFragmentLoading(e))})},n.clearTrackerIfNeeded=function(e){var t,i=this.fragmentTracker,s=i.getState(e);if(s===ut.APPENDING){var l=e.type,u=this.getFwdBufferInfo(this.mediaBuffer,l),f=Math.max(e.duration,u?u.len:this.config.maxBufferLength),d=this.backtrackFragment,h=d?e.sn-d.sn:0;(h===1||this.reduceMaxBufferLength(f,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===ut.PARTIAL&&i.removeFragment(e))},n.checkLiveUpdate=function(e){if(e.updated&&!e.live){var t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)},n.waitForLive=function(e){var t=e.details;return(t==null?void 0:t.live)&&t.type!=="EVENT"&&(this.levelLastLoaded!==e||t.expired)},n.flushMainBuffer=function(e,t,i){if(i===void 0&&(i=null),!!(e-t)){var s={startOffset:e,endOffset:t,type:i};this.hls.trigger(p.BUFFER_FLUSHING,s)}},n._loadInitSegment=function(e,t){var i=this;this._doFragLoad(e,t).then(function(s){var l=s==null?void 0:s.frag;if(!l||i.fragContextChanged(l)||!i.levels)throw new Error("init load aborted");return s}).then(function(s){var l=i.hls,u=s.frag,f=s.payload,d=u.decryptdata;if(f&&f.byteLength>0&&d!=null&&d.key&&d.iv&&Mr(d.method)){var h=self.performance.now();return i.decrypter.decrypt(new Uint8Array(f),d.key.buffer,d.iv.buffer,An(d.method)).catch(function(c){throw l.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_DECRYPT_ERROR,fatal:!1,error:c,reason:c.message,frag:u}),c}).then(function(c){var v=self.performance.now();return l.trigger(p.FRAG_DECRYPTED,{frag:u,payload:c,stats:{tstart:h,tdecrypt:v}}),s.payload=c,i.completeInitSegmentLoad(s)})}return i.completeInitSegmentLoad(s)}).catch(function(s){i.state===w.STOPPED||i.state===w.ERROR||(i.warn(s),i.resetFragmentLoading(e))})},n.completeInitSegmentLoad=function(e){var t=this.levels;if(!t)throw new Error("init load aborted, missing levels");var i=e.frag.stats;this.state!==w.STOPPED&&(this.state=w.IDLE),e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()},n.fragContextChanged=function(e){var t=this.fragCurrent;return!e||!t||e.sn!==t.sn||e.level!==t.level},n.fragBufferedComplete=function(e,t){var i=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log("Buffered "+e.type+" sn: "+e.sn+(t?" part: "+t.index:"")+" of "+this.fragInfo(e,!1,t)+" > buffer:"+(i?Ku.toString(Se.getBuffered(i)):"(detached)")+")"),Ie(e)){var s;if(e.type!==K.SUBTITLE){var l=e.elementaryStreams;if(!Object.keys(l).some(function(f){return!!l[f]})){this.state=w.IDLE;return}}var u=(s=this.levels)==null?void 0:s[e.level];u!=null&&u.fragmentError&&(this.log("Resetting level fragment error count of "+u.fragmentError+" on frag buffered"),u.fragmentError=0)}this.state=w.IDLE},n._handleFragmentLoadComplete=function(e){var t=this.transmuxer;if(t){var i=e.frag,s=e.part,l=e.partsLoaded,u=!l||l.length===0||l.some(function(d){return!d}),f=new Tn(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!u);t.flush(f)}},n._handleFragmentLoadProgress=function(e){},n._doFragLoad=function(e,t,i,s){var l,u=this;i===void 0&&(i=null),this.fragCurrent=e;var f=t==null?void 0:t.details;if(!this.levels||!f)throw new Error("frag load aborted, missing level"+(f?"":" detail")+"s");var d=null;e.encrypted&&!((l=e.decryptdata)!=null&&l.key)?(this.log("Loading key for "+e.sn+" of ["+f.startSN+"-"+f.endSN+"], "+this.playlistLabel()+" "+e.level),this.state=w.KEY_LOADING,this.fragCurrent=e,d=this.keyLoader.load(e).then(function(S){if(!u.fragContextChanged(S.frag))return u.hls.trigger(p.KEY_LOADED,S),u.state===w.KEY_LOADING&&(u.state=w.IDLE),S}),this.hls.trigger(p.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(d=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&f.encryptedFragments.length&&this.keyLoader.loadClear(e,f.encryptedFragments);var h=this.fragPrevious;if(Ie(e)&&(!h||e.sn!==h.sn)){var c=this.shouldLoadParts(t.details,e.end);c!==this.loadingParts&&(this.log("LL-Part loading "+(c?"ON":"OFF")+" loading sn "+(h==null?void 0:h.sn)+"->"+e.sn),this.loadingParts=c)}if(i=Math.max(e.start,i||0),this.loadingParts&&Ie(e)){var v=f.partList;if(v&&s){i>e.end&&f.fragmentHint&&(e=f.fragmentHint);var g=this.getNextPart(v,e,i);if(g>-1){var m=v[g];e=this.fragCurrent=m.fragment,this.log("Loading "+e.type+" sn: "+e.sn+" part: "+m.index+" ("+g+"/"+(v.length-1)+") of "+this.fragInfo(e,!1,m)+") cc: "+e.cc+" ["+f.startSN+"-"+f.endSN+"], target: "+parseFloat(i.toFixed(3))),this.nextLoadPosition=m.start+m.duration,this.state=w.FRAG_LOADING;var y;return d?y=d.then(function(S){return!S||u.fragContextChanged(S.frag)?null:u.doFragPartsLoad(e,m,t,s)}).catch(function(S){return u.handleFragLoadError(S)}):y=this.doFragPartsLoad(e,m,t,s).catch(function(S){return u.handleFragLoadError(S)}),this.hls.trigger(p.FRAG_LOADING,{frag:e,part:m,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):y}else if(!e.url||this.loadedEndOfParts(v,i))return Promise.resolve(null)}}if(Ie(e)&&this.loadingParts)this.log("LL-Part loading OFF after next part miss @"+i.toFixed(2)),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log("Loading "+e.type+" sn: "+e.sn+" of "+this.fragInfo(e,!1)+") cc: "+e.cc+" "+(f?"["+f.startSN+"-"+f.endSN+"]":"")+", target: "+parseFloat(i.toFixed(3))),N(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=w.FRAG_LOADING;var E=this.config.progressive,T;return E&&d?T=d.then(function(S){return!S||u.fragContextChanged(S==null?void 0:S.frag)?null:u.fragmentLoader.load(e,s)}).catch(function(S){return u.handleFragLoadError(S)}):T=Promise.all([this.fragmentLoader.load(e,E?s:void 0),d]).then(function(S){var A=S[0];return!E&&A&&s&&s(A),A}).catch(function(S){return u.handleFragLoadError(S)}),this.hls.trigger(p.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):T},n.doFragPartsLoad=function(e,t,i,s){var l=this;return new Promise(function(u,f){var d,h=[],c=(d=i.details)==null?void 0:d.partList,v=function(m){l.fragmentLoader.loadPart(e,m,s).then(function(y){h[m.index]=y;var E=y.part;l.hls.trigger(p.FRAG_LOADED,y);var T=Ms(i.details,e.sn,m.index+1)||Os(c,e.sn,m.index+1);if(T)v(T);else return u({frag:e,part:E,partsLoaded:h})}).catch(f)};v(t)})},n.handleFragLoadError=function(e){if("data"in e){var t=e.data;e.data&&t.details===_.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(p.ERROR,t)}else this.hls.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null},n._handleTransmuxerFlush=function(e){var t=this.getCurrentContext(e);if(!t||this.state!==w.PARSING){!this.fragCurrent&&this.state!==w.STOPPED&&this.state!==w.ERROR&&(this.state=w.IDLE);return}var i=t.frag,s=t.part,l=t.level,u=self.performance.now();i.stats.parsing.end=u,s&&(s.stats.parsing.end=u);var f=this.getLevelDetails(),d=f&&i.sn>f.endSN,h=d||this.shouldLoadParts(f,i.end);h!==this.loadingParts&&(this.log("LL-Part loading "+(h?"ON":"OFF")+" after parsing segment ending @"+i.end.toFixed(2)),this.loadingParts=h),this.updateLevelTiming(i,s,l,e.partial)},n.shouldLoadParts=function(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(e!=null&&e.partList){var i,s=e.partList[0],l=s.end+(((i=e.fragmentHint)==null?void 0:i.duration)||0);if(t>=l){var u,f=this.hls.hasEnoughToStart?((u=this.media)==null?void 0:u.currentTime)||this.lastCurrentTime:this.getLoadPosition();if(f>s.start-s.fragment.duration)return!0}}}return!1},n.getCurrentContext=function(e){var t=this.levels,i=this.fragCurrent,s=e.level,l=e.sn,u=e.part;if(!(t!=null&&t[s]))return this.warn("Levels object was unset while buffering fragment "+l+" of "+this.playlistLabel()+" "+s+". The current chunk will not be buffered."),null;var f=t[s],d=f.details,h=u>-1?Ms(d,l,u):null,c=h?h.fragment:ws(d,l,i);return c?(i&&i!==c&&(c.stats=i.stats),{frag:c,part:h,level:f}):null},n.bufferFragmentData=function(e,t,i,s,l){var u;if(!(!e||this.state!==w.PARSING)){var f=e.data1,d=e.data2,h=f;if(f&&d&&(h=Gt(f,d)),!!((u=h)!=null&&u.length)){var c={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:h};if(this.hls.trigger(p.BUFFER_APPENDING,c),e.dropped&&e.independent&&!i){if(l)return;this.flushBufferGap(t)}}}},n.flushBufferGap=function(e){var t=this.media;if(t){if(!Se.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}var i=t.currentTime,s=Se.bufferInfo(t,i,0),l=e.duration,u=Math.min(this.config.maxFragLookUpTolerance*2,l*.25),f=Math.max(Math.min(e.start-u,s.end-u),i+u);e.start-f>u&&this.flushMainBuffer(f,e.start)}},n.getFwdBufferInfo=function(e,t){var i,s=this.getLoadPosition();if(!N(s))return null;var l=this.lastCurrentTime>s,u=l||(i=this.media)!=null&&i.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,s,t,u)},n.getFwdBufferInfoAtPos=function(e,t,i,s){var l=Se.bufferInfo(e,t,s);if(l.len===0&&l.nextStart!==void 0){var u=this.fragmentTracker.getBufferedFrag(t,i);if(u&&(l.nextStart<=u.end||u.gap)){var f=Math.max(Math.min(l.nextStart,u.end)-t,s);return Se.bufferInfo(e,t,f)}}return l},n.getMaxBufferLength=function(e){var t=this.config,i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)},n.reduceMaxBufferLength=function(e,t){var i=this.config,s=Math.max(Math.min(e-t,i.maxBufferLength),t),l=Math.max(e-t*3,i.maxMaxBufferLength/2,s);return l>=s?(i.maxMaxBufferLength=l,this.warn("Reduce max buffer length to "+l+"s"),!0):!1},n.getAppendedFrag=function(e,t){var i;t===void 0&&(t=K.MAIN);var s=(i=this.fragmentTracker)==null?void 0:i.getAppendedFrag(e,t);return s&&"fragment"in s?s.fragment:s},n.getNextFragment=function(e,t){var i=t.fragments,s=i.length;if(!s)return null;var l=this.config,u=i[0].start,f=l.lowLatencyMode&&!!t.partList,d=null;if(t.live){var h=l.initialLiveManifestSize;if(s<h)return this.warn("Not enough fragments to start playback (have: "+s+", need: "+h+")"),null;if(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<u){var c;f&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),d=this.getInitialLiveFragment(t,i);var v=this.hls.startPosition,g=this.hls.liveSyncPosition,m=d?(v!==-1&&v>=u?v:g)||d.start:e;this.log("Setting startPosition to "+m+" to match start frag at live edge. mainStart: "+v+" liveSyncPosition: "+g+" frag.start: "+((c=d)==null?void 0:c.start)),this.startPosition=this.nextLoadPosition=m}}else e<=u&&(d=i[0]);if(!d){var y=this.loadingParts?t.partEnd:t.fragmentEnd;d=this.getFragmentAtPosition(e,y,t)}var E=this.filterReplacedPrimary(d,t);if(!E&&d){var T=d.sn-t.startSN;E=this.filterReplacedPrimary(i[T+1]||null,t)}return this.mapToInitFragWhenRequired(E)},n.isLoopLoading=function(e,t){var i=this.fragmentTracker.getState(e);return(i===ut.OK||i===ut.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t},n.getNextFragmentLoopLoading=function(e,t,i,s,l){var u=null;if(e.gap&&(u=this.getNextFragment(this.nextLoadPosition,t),u&&!u.gap&&i.nextStart)){var f=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s,0);if(f!==null&&i.len+f.len>=l){var d=u.sn;return this.loopSn!==d&&(this.log('buffer full after gaps in "'+s+'" playlist starting at sn: '+d),this.loopSn=d),null}}return this.loopSn=void 0,u},n.filterReplacedPrimary=function(e,t){if(!e)return e;if(Gs(this.hls.config)&&e.type!==K.SUBTITLE){var i=this.hls.interstitialsManager,s=i==null?void 0:i.bufferingItem;if(s){var l=s.event;if(l){if(l.appendInPlace||Math.abs(e.start-s.start)>1||s.start===0)return null}else if(e.end<=s.start&&(t==null?void 0:t.live)===!1||e.start>s.end&&s.nextEvent&&(s.nextEvent.appendInPlace||e.start-s.end>1))return null}var u=i==null?void 0:i.playerQueue;if(u)for(var f=u.length;f--;){var d=u[f].interstitial;if(d.appendInPlace&&e.start>=d.startTime&&e.end<=d.resumeTime)return null}}return e},n.mapToInitFragWhenRequired=function(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e},n.getNextPart=function(e,t,i){for(var s=-1,l=!1,u=!0,f=0,d=e.length;f<d;f++){var h=e[f];if(u=u&&!h.independent,s>-1&&i<h.start)break;var c=h.loaded;c?s=-1:(l||h.independent||u)&&h.fragment===t&&(s=f),l=c}return s},n.loadedEndOfParts=function(e,t){var i=e[e.length-1];return i&&t>i.start&&i.loaded},n.getInitialLiveFragment=function(e,t){var i=this.fragPrevious,s=null;if(i){if(e.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: "+i.programDateTime),s=ru(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){var l=i.sn+1;if(l>=e.startSN&&l<=e.endSN){var u=t[l-e.startSN];i.cc===u.cc&&(s=u,this.log("Live playlist, switching playlist, load frag with next SN: "+s.sn))}s||(s=is(t,i.cc),s&&this.log("Live playlist, switching playlist, load frag with same CC: "+s.sn))}}else{var f=this.hls.liveSyncPosition;f!==null&&(s=this.getFragmentAtPosition(f,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s},n.getFragmentAtPosition=function(e,t,i){var s=this.config,l=this.fragPrevious,u=i.fragments,f=i.endSN,d=i.fragmentHint,h=s.maxFragLookUpTolerance,c=i.partList,v=!!(this.loadingParts&&c!=null&&c.length&&d);v&&d&&!this.bitrateTest&&c[c.length-1].fragment.sn===d.sn&&(u=u.concat(d),f=d.sn);var g;if(e<t){var m,y=e<this.lastCurrentTime,E=y||e>t-h||(m=this.media)!=null&&m.paused||!this.startFragRequested?0:h;g=br(l,u,e,E)}else g=u[u.length-1];if(g){var T=g.sn-i.startSN,S=this.fragmentTracker.getState(g);if((S===ut.OK||S===ut.PARTIAL&&g.gap)&&(l=g),l&&g.sn===l.sn&&(!v||c[0].fragment.sn>g.sn||!i.live&&!v)){var A=l&&g.level===l.level;if(A){var x=u[T+1];g.sn<f&&this.fragmentTracker.getState(x)!==ut.OK?g=x:g=null}}}return g},n.alignPlaylists=function(e,t,i){var s=e.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;var l=e.fragmentStart,u=!t,f=e.alignedSliding&&N(l);if(u||!f&&!l){Gu(i,e);var d=e.fragmentStart;return this.log("Live playlist sliding: "+d.toFixed(2)+" start-sn: "+(t?t.startSN:"na")+"->"+e.startSN+" fragments: "+s),d}return l},n.waitForCdnTuneIn=function(e){var t=3;return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*t)},n.setStartPosition=function(e,t){var i=this.startPosition;i<t&&(i=-1);var s=this.timelineOffset;if(i===-1){var l=this.startTimeOffset!==null,u=l?this.startTimeOffset:e.startTimeOffset;u!==null&&N(u)?(i=t+u,u<0&&(i+=e.edge),i=Math.min(Math.max(t,i),t+e.totalduration),this.log("Setting startPosition to "+i+" for start time offset "+u+" found in "+(l?"multivariant":"media")+" playlist"),this.startPosition=i):e.live?(i=this.hls.liveSyncPosition||t,this.log("Setting startPosition to -1 to start at live edge "+i),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=i=0),this.lastCurrentTime=i+s}this.nextLoadPosition=i+s},n.getLoadPosition=function(){var e,t=this.media,i=0;return(e=this.hls)!=null&&e.hasEnoughToStart&&t?i=t.currentTime:this.nextLoadPosition>=0&&(i=this.nextLoadPosition),i},n.handleFragLoadAborted=function(e,t){this.transmuxer&&e.type===this.playlistType&&Ie(e)&&e.stats.aborted&&(this.warn("Fragment "+e.sn+(t?" part "+t.index:"")+" of "+this.playlistLabel()+" "+e.level+" was aborted"),this.resetFragmentLoading(e))},n.resetFragmentLoading=function(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==w.FRAG_LOADING_WAITING_RETRY)&&(this.state=w.IDLE)},n.onFragmentOrKeyLoadError=function(e,t){if(t.chunkMeta&&!t.frag){var i=this.getCurrentContext(t.chunkMeta);i&&(t.frag=i.frag)}var s=t.frag;if(!(!s||s.type!==e||!this.levels)){if(this.fragContextChanged(s)){var l;this.warn("Frag load error must match current frag to retry "+s.url+" > "+((l=this.fragCurrent)==null?void 0:l.url));return}var u=t.details===_.FRAG_GAP;u&&this.fragmentTracker.fragBuffered(s,!0);var f=t.errorAction,d=f||{},h=d.action,c=d.flags,v=d.retryCount,g=v===void 0?0:v,m=d.retryConfig,y=!!f&&!!m,E=y&&h===bt.RetryRequest,T=y&&!f.resolved&&c===jt.MoveAllAlternatesMatchingHost;if(!E&&T&&Ie(s)&&!s.endList)this.resetFragmentErrors(e),this.treatAsGap(s),f.resolved=!0;else if((E||T)&&g<m.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);var S=yn(m,g);this.warn("Fragment "+s.sn+" of "+e+" "+s.level+" errored with "+t.details+", retrying loading "+(g+1)+"/"+m.maxNumRetry+" in "+S+"ms"),f.resolved=!0,this.retryDate=self.performance.now()+S,this.state=w.FRAG_LOADING_WAITING_RETRY}else if(m&&f)if(this.resetFragmentErrors(e),g<m.maxNumRetry)!u&&h!==bt.RemoveAlternatePermanently&&(f.resolved=!0);else{this.warn(t.details+" reached or exceeded max retry ("+g+")");return}else h===bt.SendAlternateToPenaltyBox?this.state=w.WAITING_LEVEL:this.state=w.ERROR;this.tickImmediate()}},n.reduceLengthAndFlushBuffer=function(e){if(this.state===w.PARSING||this.state===w.PARSED){var t=e.frag,i=e.parent,s=this.getFwdBufferInfo(this.mediaBuffer,i),l=s&&s.len>.5;l&&this.reduceMaxBufferLength(s.len,(t==null?void 0:t.duration)||10);var u=!l;return u&&this.warn("Buffer full error while media.currentTime is not buffered, flush "+i+" buffer"),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),u}return!1},n.resetFragmentErrors=function(e){e===K.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==w.STOPPED&&(this.state=w.IDLE)},n.afterBufferFlushed=function(e,t,i){if(e){var s=Se.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===w.ENDED&&this.resetLoadingState()}},n.resetLoadingState=function(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==w.STOPPED&&(this.state=w.IDLE)},n.resetStartWhenNotLoaded=function(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;var t=e?e.details:null;t!=null&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}},n.resetWhenMissingContext=function(e){this.warn("The loading context changed while buffering fragment "+e.sn+" of "+this.playlistLabel()+" "+e.level+". This chunk will not be buffered."),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()},n.removeUnbufferedFrags=function(e){e===void 0&&(e=0),this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)},n.updateLevelTiming=function(e,t,i,s){var l=this,u=i.details;if(!u){this.warn("level.details undefined");return}var f=Object.keys(e.elementaryStreams).reduce(function(c,v){var g=e.elementaryStreams[v];if(g){var m=g.endPTS-g.startPTS;if(m<=0)return l.warn("Could not parse fragment "+e.sn+" "+v+" duration reliably ("+m+")"),c||!1;var y=s?0:Ds(u,e,g.startPTS,g.endPTS,g.startDTS,g.endDTS);return l.hls.trigger(p.LEVEL_PTS_UPDATED,{details:u,level:i,drift:y,type:v,frag:e,start:g.startPTS,end:g.endPTS}),!0}return c},!1);if(!f){var d;if(i.fragmentError===0&&this.treatAsGap(e,i),((d=this.transmuxer)==null?void 0:d.error)===null){var h=new Error("Found no media in fragment "+e.sn+" of "+this.playlistLabel()+" "+e.level+" resetting transmuxer to fallback to playlist timing");if(this.warn(h.message),this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:!1,error:h,frag:e,reason:"Found no media in msn "+e.sn+" of "+this.playlistLabel()+' "'+i.url+'"'}),!this.hls)return;this.resetTransmuxer()}}this.state=w.PARSED,this.log("Parsed "+e.type+" sn: "+e.sn+(t?" part: "+t.index:"")+" of "+this.fragInfo(e,!1,t)+")"),this.hls.trigger(p.FRAG_PARSED,{frag:e,part:t})},n.playlistLabel=function(){return this.playlistType===K.MAIN?"level":"track"},n.fragInfo=function(e,t,i){var s,l;return t===void 0&&(t=!0),this.playlistLabel()+" "+e.level+" ("+(i?"part":"frag")+":["+((s=t&&!i?e.startPTS:(i||e).start)!=null?s:NaN).toFixed(3)+"-"+((l=t&&!i?e.endPTS:(i||e).end)!=null?l:NaN).toFixed(3)+"]"+(i&&e.type==="main"?"INDEPENDENT="+(i.independent?"YES":"NO"):"")},n.treatAsGap=function(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)},n.resetTransmuxer=function(){var e;(e=this.transmuxer)==null||e.reset()},n.recoverWorkerError=function(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())},z(o,[{key:"startPositionValue",get:function(){var e=this.nextLoadPosition,t=this.startPosition;return t===-1&&e?e:t}},{key:"bufferingEnabled",get:function(){return this.buffering}},{key:"inFlightFrag",get:function(){return{frag:this.fragCurrent,state:this.state}}},{key:"timelineOffset",get:function(){var e=this.config.timelineOffset;if(e){var t;return((t=this.getLevelDetails())==null?void 0:t.appliedTimelineOffset)||e}return 0}},{key:"primaryPrefetch",get:function(){if(Gs(this.hls.config)){var e,t,i=(e=this.hls.interstitialsManager)==null||(t=e.playingItem)==null?void 0:t.event;if(i)return!0}return!1}},{key:"state",get:function(){return this._state},set:function(e){var t=this._state;t!==e&&(this._state=e,this.log(t+"->"+e))}}])}(fs);function Gs(a){return!!a.interstitialsController&&a.enableInterstitialPlayback!==!1}var Ks=function(){function a(){this.chunks=[],this.dataLength=0}var o=a.prototype;return o.push=function(r){this.chunks.push(r),this.dataLength+=r.length},o.flush=function(){var r=this.chunks,e=this.dataLength,t;if(r.length)r.length===1?t=r[0]:t=Hu(r,e);else return new Uint8Array(0);return this.reset(),t},o.reset=function(){this.chunks.length=0,this.dataLength=0},a}();function Hu(a,o){for(var n=new Uint8Array(o),r=0,e=0;e<a.length;e++){var t=a[e];n.set(t,r),r+=t.length}return n}function Hs(a,o){return o+10<=a.length&&a[o]===51&&a[o+1]===68&&a[o+2]===73&&a[o+3]<255&&a[o+4]<255&&a[o+6]<128&&a[o+7]<128&&a[o+8]<128&&a[o+9]<128}function Mn(a,o){return o+10<=a.length&&a[o]===73&&a[o+1]===68&&a[o+2]===51&&a[o+3]<255&&a[o+4]<255&&a[o+6]<128&&a[o+7]<128&&a[o+8]<128&&a[o+9]<128}function wi(a,o){var n=0;return n=(a[o]&127)<<21,n|=(a[o+1]&127)<<14,n|=(a[o+2]&127)<<7,n|=a[o+3]&127,n}function ti(a,o){for(var n=o,r=0;Mn(a,o);){r+=10;var e=wi(a,o+6);r+=e,Hs(a,o+10)&&(r+=10),o+=r}if(r>0)return a.subarray(n,n+r)}function Vu(a,o,n,r){var e=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],t=o[n+2],i=t>>2&15;if(i>12){var s=new Error("invalid ADTS sampling index:"+i);a.emit(p.ERROR,p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:!0,error:s,reason:s.message});return}var l=(t>>6&3)+1,u=o[n+3]>>6&3|(t&1)<<2,f="mp4a.40."+l,d=e[i],h=i;(l===5||l===29)&&(h-=3);var c=[l<<3|(h&14)>>1,(h&1)<<7|u<<3];return X.log("manifest codec:"+r+", parsed codec:"+f+", channels:"+u+", rate:"+d+" (ADTS object type:"+l+" sampling index:"+i+")"),{config:c,samplerate:d,channelCount:u,codec:f,parsedCodec:f,manifestCodec:r}}function Vs(a,o){return a[o]===255&&(a[o+1]&246)===240}function Ws(a,o){return a[o+1]&1?7:9}function On(a,o){return(a[o+3]&3)<<11|a[o+4]<<3|(a[o+5]&224)>>>5}function Wu(a,o){return o+5<a.length}function Mi(a,o){return o+1<a.length&&Vs(a,o)}function Yu(a,o){return Wu(a,o)&&Vs(a,o)&&On(a,o)<=a.length-o}function qu(a,o){if(Mi(a,o)){var n=Ws(a,o);if(o+n>=a.length)return!1;var r=On(a,o);if(r<=n)return!1;var e=o+r;return e===a.length||Mi(a,e)}return!1}function Ys(a,o,n,r,e){if(!a.samplerate){var t=Vu(o,n,r,e);if(!t)return;ae(a,t)}}function qs(a){return 1024*9e4/a}function ju(a,o){var n=Ws(a,o);if(o+n<=a.length){var r=On(a,o)-n;if(r>0)return{headerLength:n,frameLength:r}}}function js(a,o,n,r,e){var t=qs(a.samplerate),i=r+e*t,s=ju(o,n),l;if(s){var u=s.frameLength,f=s.headerLength,d=f+u,h=Math.max(0,n+d-o.length);h?(l=new Uint8Array(d-f),l.set(o.subarray(n+f,o.length),0)):l=o.subarray(n+f,n+d);var c={unit:l,pts:i};return h||a.samples.push(c),{sample:c,length:d,missing:h}}var v=o.length-n;l=new Uint8Array(v),l.set(o.subarray(n,o.length),0);var g={unit:l,pts:i};return{sample:g,length:v,missing:-1}}function Xu(a,o){return Mn(a,o)&&wi(a,o+6)+10<=a.length-o}function zu(a){if(!(a.size<2)){var o=Ge(a.data,!0),n=new Uint8Array(a.data.subarray(o.length+1));return{key:a.type,info:o,data:n.buffer}}}function Qu(a){if(!(a.size<2)){if(a.type==="TXXX"){var o=1,n=Ge(a.data.subarray(o),!0);o+=n.length+1;var r=Ge(a.data.subarray(o));return{key:a.type,info:n,data:r}}var e=Ge(a.data.subarray(1));return{key:a.type,info:"",data:e}}}function $u(a){if(a.type==="WXXX"){if(a.size<2)return;var o=1,n=Ge(a.data.subarray(o),!0);o+=n.length+1;var r=Ge(a.data.subarray(o));return{key:a.type,info:n,data:r}}var e=Ge(a.data);return{key:a.type,info:"",data:e}}function Ju(a){return btoa(String.fromCharCode.apply(String,a))}function Xs(a,o){if(a<0)return-Xs(-a,o);var n=Math.pow(10,o),r=Math.abs(a*n%1-.5)<Number.EPSILON;if(r){var e=Math.floor(a*n);return(e%2===0?e:e+1)/n}else return Math.round(a*n)/n}function Zu(a,o){var n=new URL(a),r=new URL(o);if(n.origin!==r.origin)return a;for(var e=n.pathname.split("/").slice(1),t=r.pathname.split("/").slice(1,-1);e[0]===t[0];)e.shift(),t.shift();for(;t.length;)t.shift(),e.unshift("..");return e.join("/")}function ef(a){return a instanceof ArrayBuffer?a:a.byteOffset==0&&a.byteLength==a.buffer.byteLength?a.buffer:new Uint8Array(a).buffer}function Fn(a,o,n){return o===void 0&&(o=0),n===void 0&&(n=1/0),tf(a,o,n,Uint8Array)}function tf(a,o,n,r){var e=rf(a),t=1;"BYTES_PER_ELEMENT"in r&&(t=r.BYTES_PER_ELEMENT);var i=nf(a)?a.byteOffset:0,s=(i+a.byteLength)/t,l=(i+o)/t,u=Math.floor(Math.max(0,Math.min(l,s))),f=Math.floor(Math.min(u+Math.max(n,0),s));return new r(e,u,f-u)}function rf(a){return a instanceof ArrayBuffer?a:a.buffer}function nf(a){return a&&a.buffer instanceof ArrayBuffer&&a.byteLength!==void 0&&a.byteOffset!==void 0}function af(a){var o={key:a.type,description:"",data:"",mimeType:null,pictureType:null},n=3;if(!(a.size<2)){if(a.data[0]!==n){console.log("Ignore frame with unrecognized character encoding");return}var r=a.data.subarray(1).indexOf(0);if(r!==-1){var e=Ge(Fn(a.data,1,r)),t=a.data[2+r],i=a.data.subarray(3+r).indexOf(0);if(i!==-1){var s=Ge(Fn(a.data,3+r,i)),l;return e==="-->"?l=Ge(Fn(a.data,4+r+i)):l=ef(a.data.subarray(4+r+i)),o.mimeType=e,o.pictureType=t,o.description=s,o.data=l,o}}}}function sf(a){return a.type==="PRIV"?zu(a):a.type[0]==="W"?$u(a):a.type==="APIC"?af(a):Qu(a)}function of(a){var o=String.fromCharCode(a[0],a[1],a[2],a[3]),n=wi(a,4),r=10;return{type:o,size:n,data:a.subarray(r,r+n)}}var Oi=10,lf=10;function zs(a){for(var o=0,n=[];Mn(a,o);){var r=wi(a,o+6);a[o+5]>>6&1&&(o+=Oi),o+=Oi;for(var e=o+r;o+lf<e;){var t=of(a.subarray(o)),i=sf(t);i&&n.push(i),o+=t.size+Oi}Hs(a,o)&&(o+=Oi)}return n}function Qs(a){return a&&a.key==="PRIV"&&a.info==="com.apple.streaming.transportStreamTimestamp"}function uf(a){if(a.data.byteLength===8){var o=new Uint8Array(a.data),n=o[3]&1,r=(o[4]<<23)+(o[5]<<15)+(o[6]<<7)+o[7];return r/=45,n&&(r+=4772185884e-2),Math.round(r)}}function Nn(a){for(var o=zs(a),n=0;n<o.length;n++){var r=o[n];if(Qs(r))return uf(r)}}var Ft=function(a){return a.audioId3="org.id3",a.dateRange="com.apple.quicktime.HLS",a.emsg="https://aomedia.org/emsg/ID3",a.misbklv="urn:misb:KLV:bin:1910.1",a}({});function Zt(a,o){return a===void 0&&(a=""),o===void 0&&(o=9e4),{type:a,id:-1,pid:-1,inputTimeScale:o,sequenceNumber:-1,samples:[],dropped:0}}var Un=function(){function a(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}var o=a.prototype;return o.resetInitSegment=function(r,e,t,i){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}},o.resetTimeStamp=function(r){this.initPTS=r,this.resetContiguity()},o.resetContiguity=function(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0},o.canParse=function(r,e){return!1},o.appendFrame=function(r,e,t){},o.demux=function(r,e){this.cachedData&&(r=Gt(this.cachedData,r),this.cachedData=null);var t=ti(r,0),i=t?t.length:0,s,l=this._audioTrack,u=this._id3Track,f=t?Nn(t):void 0,d=r.length;for((this.basePTS===null||this.frameIndex===0&&N(f))&&(this.basePTS=ff(f,e,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),t&&t.length>0&&u.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:t,type:Ft.audioId3,duration:Number.POSITIVE_INFINITY});i<d;){if(this.canParse(r,i)){var h=this.appendFrame(l,r,i);h?(this.frameIndex++,this.lastPTS=h.sample.pts,i+=h.length,s=i):i=d}else Xu(r,i)?(t=ti(r,i),u.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:t,type:Ft.audioId3,duration:Number.POSITIVE_INFINITY}),i+=t.length,s=i):i++;if(i===d&&s!==d){var c=r.slice(s);this.cachedData?this.cachedData=Gt(this.cachedData,c):this.cachedData=c}}return{audioTrack:l,videoTrack:Zt(),id3Track:u,textTrack:Zt()}},o.demuxSampleAes=function(r,e,t){return Promise.reject(new Error("["+this+"] This demuxer does not support Sample-AES decryption"))},o.flush=function(r){var e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:Zt(),id3Track:this._id3Track,textTrack:Zt()}},o.destroy=function(){this.cachedData=null,this._audioTrack=this._id3Track=void 0},a}(),ff=function(o,n,r){if(N(o))return o*90;var e=r?r.baseTime*9e4/r.timescale:0;return n*9e4+e},Fi=null,df=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],hf=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],cf=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],vf=[0,1,1,4];function $s(a,o,n,r,e){if(!(n+24>o.length)){var t=Js(o,n);if(t&&n+t.frameLength<=o.length){var i=t.samplesPerFrame*9e4/t.sampleRate,s=r+e*i,l={unit:o.subarray(n,n+t.frameLength),pts:s,dts:s};return a.config=[],a.channelCount=t.channelCount,a.samplerate=t.sampleRate,a.samples.push(l),{sample:l,length:t.frameLength,missing:0}}}}function Js(a,o){var n=a[o+1]>>3&3,r=a[o+1]>>1&3,e=a[o+2]>>4&15,t=a[o+2]>>2&3;if(n!==1&&e!==0&&e!==15&&t!==3){var i=a[o+2]>>1&1,s=a[o+3]>>6,l=n===3?3-r:r===3?3:4,u=df[l*14+e-1]*1e3,f=n===3?0:n===2?1:2,d=hf[f*3+t],h=s===3?1:2,c=cf[n][r],v=vf[r],g=c*8*v,m=Math.floor(c*u/d+i)*v;if(Fi===null){var y=navigator.userAgent||"",E=y.match(/Chrome\/(\d+)/i);Fi=E?parseInt(E[1]):0}var T=!!Fi&&Fi<=87;return T&&r===2&&u>=224e3&&s===0&&(a[o+3]=a[o+3]|128),{sampleRate:d,channelCount:h,frameLength:m,samplesPerFrame:g}}}function Bn(a,o){return a[o]===255&&(a[o+1]&224)===224&&(a[o+1]&6)!==0}function Zs(a,o){return o+1<a.length&&Bn(a,o)}function gf(a,o){var n=4;return Bn(a,o)&&n<=a.length-o}function eo(a,o){if(o+1<a.length&&Bn(a,o)){var n=4,r=Js(a,o),e=n;r!=null&&r.frameLength&&(e=r.frameLength);var t=o+e;return t===a.length||Zs(a,t)}return!1}var mf=function(a){function o(r,e){var t;return t=a.call(this)||this,t.observer=void 0,t.config=void 0,t.observer=r,t.config=e,t}J(o,a);var n=o.prototype;return n.resetInitSegment=function(e,t,i,s){a.prototype.resetInitSegment.call(this,e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}},o.probe=function(e,t){if(!e)return!1;var i=ti(e,0),s=(i==null?void 0:i.length)||0;if(eo(e,s))return!1;for(var l=e.length;s<l;s++)if(qu(e,s))return t.log("ADTS sync word found !"),!0;return!1},n.canParse=function(e,t){return Yu(e,t)},n.appendFrame=function(e,t,i){Ys(e,this.observer,t,i,e.manifestCodec);var s=js(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s},o}(Un),to=function(o,n){var r=0,e=5;n+=e;for(var t=new Uint32Array(1),i=new Uint32Array(1),s=new Uint8Array(1);e>0;){s[0]=o[n];var l=Math.min(e,8),u=8-l;i[0]=4278190080>>>24+u<<u,t[0]=(s[0]&i[0])>>u,r=r?r<<l|t[0]:t[0],n+=1,e-=l}return r},pf=function(a){function o(r){var e;return e=a.call(this)||this,e.observer=void 0,e.observer=r,e}J(o,a);var n=o.prototype;return n.resetInitSegment=function(e,t,i,s){a.prototype.resetInitSegment.call(this,e,t,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}},n.canParse=function(e,t){return t+64<e.length},n.appendFrame=function(e,t,i){var s=ro(e,t,i,this.basePTS,this.frameIndex);if(s!==-1){var l=e.samples[e.samples.length-1];return{sample:l,length:s,missing:0}}},o.probe=function(e){if(!e)return!1;var t=ti(e,0);if(!t)return!1;var i=t.length;return e[i]===11&&e[i+1]===119&&Nn(t)!==void 0&&to(e,i)<16},o}(Un);function ro(a,o,n,r,e){if(n+8>o.length||o[n]!==11||o[n+1]!==119)return-1;var t=o[n+4]>>6;if(t>=3)return-1;var i=[48e3,44100,32e3],s=i[t],l=o[n+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920],f=u[l*3+t]*2;if(n+f>o.length)return-1;var d=o[n+6]>>5,h=0;d===2?h+=2:(d&1&&d!==1&&(h+=2),d&4&&(h+=2));var c=(o[n+6]<<8|o[n+7])>>12-h&1,v=[2,1,2,3,3,4,4,5],g=v[d]+c,m=o[n+5]>>3,y=o[n+5]&7,E=new Uint8Array([t<<6|m<<1|y>>2,(y&3)<<6|d<<3|c<<2|l>>4,l<<4&224]),T=1536/s*9e4,S=r+e*T,A=o.subarray(n,n+f);return a.config=E,a.channelCount=g,a.samplerate=s,a.samples.push({unit:A,pts:S}),f}var yf=function(a){function o(){return a.apply(this,arguments)||this}J(o,a);var n=o.prototype;return n.resetInitSegment=function(e,t,i,s){a.prototype.resetInitSegment.call(this,e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}},o.probe=function(e){if(!e)return!1;var t=ti(e,0),i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&Nn(t)!==void 0&&to(e,i)<=16)return!1;for(var s=e.length;i<s;i++)if(eo(e,i))return X.log("MPEG Audio sync word found !"),!0;return!1},n.canParse=function(e,t){return gf(e,t)},n.appendFrame=function(e,t,i){if(this.basePTS!==null)return $s(e,t,i,this.basePTS,this.frameIndex)},o}(Un),Ef=/\/emsg[-/]ID3/i,Tf=function(){function a(n,r){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=r}var o=a.prototype;return o.resetTimeStamp=function(){},o.resetInitSegment=function(r,e,t,i){var s=this.videoTrack=Zt("video",1),l=this.audioTrack=Zt("audio",1),u=this.txtTrack=Zt("text",1);if(this.id3Track=Zt("id3",1),this.timeOffset=0,!!(r!=null&&r.byteLength)){var f=Fa(r);if(f.video){var d=f.video,h=d.id,c=d.timescale,v=d.codec,g=d.supplemental;s.id=h,s.timescale=u.timescale=c,s.codec=v,s.supplemental=g}if(f.audio){var m=f.audio,y=m.id,E=m.timescale,T=m.codec;l.id=y,l.timescale=E,l.codec=T}u.id=ar.text,s.sampleDuration=0,s.duration=l.duration=i}},o.resetContiguity=function(){this.remainderData=null},a.probe=function(r){return xl(r)},o.demux=function(r,e){this.timeOffset=e;var t=r,i=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(t=Gt(this.remainderData,r));var l=Cl(t);this.remainderData=l.remainder,i.samples=l.valid||new Uint8Array}else i.samples=t;var u=this.extractID3Track(i,e);return s.samples=Ua(e,i),{videoTrack:i,audioTrack:this.audioTrack,id3Track:u,textTrack:this.txtTrack}},o.flush=function(){var r=this.timeOffset,e=this.videoTrack,t=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;var i=this.extractID3Track(e,this.timeOffset);return t.samples=Ua(r,e),{videoTrack:e,audioTrack:Zt(),id3Track:i,textTrack:Zt()}},o.extractID3Track=function(r,e){var t=this,i=this.id3Track;if(r.samples.length){var s=ue(r.samples,["emsg"]);s&&s.forEach(function(l){var u=wl(l);if(Ef.test(u.schemeIdUri)){var f=io(u,e),d=u.eventDuration===4294967295?Number.POSITIVE_INFINITY:u.eventDuration/u.timeScale;d<=.001&&(d=Number.POSITIVE_INFINITY);var h=u.payload;i.samples.push({data:h,len:h.byteLength,dts:f,pts:f,type:Ft.emsg,duration:d})}else if(t.config.enableEmsgKLVMetadata&&u.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){var c=io(u,e);i.samples.push({data:u.payload,len:u.payload.byteLength,dts:c,pts:c,type:Ft.misbklv,duration:Number.POSITIVE_INFINITY})}})}return i},o.demuxSampleAes=function(r,e,t){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))},o.destroy=function(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0},a}();function io(a,o){return N(a.presentationTime)?a.presentationTime/a.timeScale:o+a.presentationTimeDelta/a.timeScale}var Sf=function(){function a(n,r,e){this.keyData=void 0,this.decrypter=void 0,this.keyData=e,this.decrypter=new En(r,{removePKCS7Padding:!1})}var o=a.prototype;return o.decryptBuffer=function(r){return this.decrypter.decrypt(r,this.keyData.key.buffer,this.keyData.iv.buffer,cr.cbc)},o.decryptAacSample=function(r,e,t){var i=this,s=r[e].unit;if(!(s.length<=16)){var l=s.subarray(16,s.length-s.length%16),u=l.buffer.slice(l.byteOffset,l.byteOffset+l.length);this.decryptBuffer(u).then(function(f){var d=new Uint8Array(f);s.set(d,16),i.decrypter.isSync()||i.decryptAacSamples(r,e+1,t)})}},o.decryptAacSamples=function(r,e,t){for(;;e++){if(e>=r.length){t();return}if(!(r[e].unit.length<32)&&(this.decryptAacSample(r,e,t),!this.decrypter.isSync()))return}},o.getAvcEncryptedData=function(r){for(var e=Math.floor((r.length-48)/160)*16+16,t=new Int8Array(e),i=0,s=32;s<r.length-16;s+=160,i+=16)t.set(r.subarray(s,s+16),i);return t},o.getAvcDecryptedUnit=function(r,e){for(var t=new Uint8Array(e),i=0,s=32;s<r.length-16;s+=160,i+=16)r.set(t.subarray(i,i+16),s);return r},o.decryptAvcSample=function(r,e,t,i,s){var l=this,u=Ba(s.data),f=this.getAvcEncryptedData(u);this.decryptBuffer(f.buffer).then(function(d){s.data=l.getAvcDecryptedUnit(u,d),l.decrypter.isSync()||l.decryptAvcSamples(r,e,t+1,i)})},o.decryptAvcSamples=function(r,e,t,i){if(r instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;e++,t=0){if(e>=r.length){i();return}for(var s=r[e].units;!(t>=s.length);t++){var l=s[t];if(!(l.data.length<=48||l.type!==1&&l.type!==5)&&(this.decryptAvcSample(r,e,t,i,l),!this.decrypter.isSync()))return}}},a}(),no=function(){function a(){this.VideoSample=null}var o=a.prototype;return o.createVideoSample=function(r,e,t){return{key:r,frame:!1,pts:e,dts:t,units:[],length:0}},o.getLastNalUnit=function(r){var e,t=this.VideoSample,i;if((!t||t.units.length===0)&&(t=r[r.length-1]),(e=t)!=null&&e.units){var s=t.units;i=s[s.length-1]}return i},o.pushAccessUnit=function(r,e){if(r.units.length&&r.frame){if(r.pts===void 0){var t=e.samples,i=t.length;if(i){var s=t[i-1];r.pts=s.pts,r.dts=s.dts}else{e.dropped++;return}}e.samples.push(r)}},o.parseNALu=function(r,e,t){var i=e.byteLength,s=r.naluState||0,l=s,u=[],f=0,d,h,c,v=-1,g=0;for(s===-1&&(v=0,g=this.getNALuType(e,0),s=0,f=1);f<i;){if(d=e[f++],!s){s=d?0:1;continue}if(s===1){s=d?0:2;continue}if(!d)s=3;else if(d===1){if(h=f-s-1,v>=0){var m={data:e.subarray(v,h),type:g};u.push(m)}else{var y=this.getLastNalUnit(r.samples);y&&(l&&f<=4-l&&y.state&&(y.data=y.data.subarray(0,y.data.byteLength-l)),h>0&&(y.data=Gt(y.data,e.subarray(0,h)),y.state=0))}f<i?(c=this.getNALuType(e,f),v=f,g=c,s=0):s=-1}else s=0}if(v>=0&&s>=0){var E={data:e.subarray(v,i),type:g,state:s};u.push(E)}if(u.length===0){var T=this.getLastNalUnit(r.samples);T&&(T.data=Gt(T.data,e))}return r.naluState=s,u},a}(),ri=function(){function a(n){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=n,this.bytesAvailable=n.byteLength,this.word=0,this.bitsAvailable=0}var o=a.prototype;return o.loadWord=function(){var r=this.data,e=this.bytesAvailable,t=r.byteLength-e,i=new Uint8Array(4),s=Math.min(4,e);if(s===0)throw new Error("no bytes available");i.set(r.subarray(t,t+s)),this.word=new DataView(i.buffer).getUint32(0),this.bitsAvailable=s*8,this.bytesAvailable-=s},o.skipBits=function(r){var e;r=Math.min(r,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>r?(this.word<<=r,this.bitsAvailable-=r):(r-=this.bitsAvailable,e=r>>3,r-=e<<3,this.bytesAvailable-=e,this.loadWord(),this.word<<=r,this.bitsAvailable-=r)},o.readBits=function(r){var e=Math.min(this.bitsAvailable,r),t=this.word>>>32-e;if(r>32&&X.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return e=r-e,e>0&&this.bitsAvailable?t<<e|this.readBits(e):t},o.skipLZ=function(){var r;for(r=0;r<this.bitsAvailable;++r)if((this.word&2147483648>>>r)!==0)return this.word<<=r,this.bitsAvailable-=r,r;return this.loadWord(),r+this.skipLZ()},o.skipUEG=function(){this.skipBits(1+this.skipLZ())},o.skipEG=function(){this.skipBits(1+this.skipLZ())},o.readUEG=function(){var r=this.skipLZ();return this.readBits(r+1)-1},o.readEG=function(){var r=this.readUEG();return 1&r?1+r>>>1:-1*(r>>>1)},o.readBoolean=function(){return this.readBits(1)===1},o.readUByte=function(){return this.readBits(8)},o.readUShort=function(){return this.readBits(16)},o.readUInt=function(){return this.readBits(32)},a}(),ao=function(a){function o(){return a.apply(this,arguments)||this}J(o,a);var n=o.prototype;return n.parsePES=function(e,t,i,s){var l=this,u=this.parseNALu(e,i.data,s),f=this.VideoSample,d,h=!1;i.data=null,f&&u.length&&!e.audFound&&(this.pushAccessUnit(f,e),f=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),u.forEach(function(c){var v,g;switch(c.type){case 1:{var m=!1;d=!0;var y=c.data;if(h&&y.length>4){var E=l.readSliceType(y);(E===2||E===4||E===7||E===9)&&(m=!0)}if(m){var T;(T=f)!=null&&T.frame&&!f.key&&(l.pushAccessUnit(f,e),f=l.VideoSample=null)}f||(f=l.VideoSample=l.createVideoSample(!0,i.pts,i.dts)),f.frame=!0,f.key=m;break}case 5:d=!0,(v=f)!=null&&v.frame&&!f.key&&(l.pushAccessUnit(f,e),f=l.VideoSample=null),f||(f=l.VideoSample=l.createVideoSample(!0,i.pts,i.dts)),f.key=!0,f.frame=!0;break;case 6:{d=!0,cn(c.data,1,i.pts,t.samples);break}case 7:{var S,A;d=!0,h=!0;var x=c.data,L=l.readSPS(x);if(!e.sps||e.width!==L.width||e.height!==L.height||((S=e.pixelRatio)==null?void 0:S[0])!==L.pixelRatio[0]||((A=e.pixelRatio)==null?void 0:A[1])!==L.pixelRatio[1]){e.width=L.width,e.height=L.height,e.pixelRatio=L.pixelRatio,e.sps=[x];for(var I=x.subarray(1,4),k="avc1.",R=0;R<3;R++){var b=I[R].toString(16);b.length<2&&(b="0"+b),k+=b}e.codec=k}break}case 8:d=!0,e.pps=[c.data];break;case 9:d=!0,e.audFound=!0,(g=f)!=null&&g.frame&&(l.pushAccessUnit(f,e),f=null),f||(f=l.VideoSample=l.createVideoSample(!1,i.pts,i.dts));break;case 12:d=!0;break;default:d=!1;break}if(f&&d){var D=f.units;D.push(c)}}),s&&f&&(this.pushAccessUnit(f,e),this.VideoSample=null)},n.getNALuType=function(e,t){return e[t]&31},n.readSliceType=function(e){var t=new ri(e);return t.readUByte(),t.readUEG(),t.readUEG()},n.skipScalingList=function(e,t){for(var i=8,s=8,l,u=0;u<e;u++)s!==0&&(l=t.readEG(),s=(i+l+256)%256),i=s===0?i:s},n.readSPS=function(e){var t=new ri(e),i=0,s=0,l=0,u=0,f,d,h,c=t.readUByte.bind(t),v=t.readBits.bind(t),g=t.readUEG.bind(t),m=t.readBoolean.bind(t),y=t.skipBits.bind(t),E=t.skipEG.bind(t),T=t.skipUEG.bind(t),S=this.skipScalingList.bind(this);c();var A=c();if(v(5),y(3),c(),T(),A===100||A===110||A===122||A===244||A===44||A===83||A===86||A===118||A===128){var x=g();if(x===3&&y(1),T(),T(),y(1),m())for(d=x!==3?8:12,h=0;h<d;h++)m()&&(h<6?S(16,t):S(64,t))}T();var L=g();if(L===0)g();else if(L===1)for(y(1),E(),E(),f=g(),h=0;h<f;h++)E();T(),y(1);var I=g(),k=g(),R=v(1);R===0&&y(1),y(1),m()&&(i=g(),s=g(),l=g(),u=g());var b=[1,1];if(m()&&m()){var D=c();switch(D){case 1:b=[1,1];break;case 2:b=[12,11];break;case 3:b=[10,11];break;case 4:b=[16,11];break;case 5:b=[40,33];break;case 6:b=[24,11];break;case 7:b=[20,11];break;case 8:b=[32,11];break;case 9:b=[80,33];break;case 10:b=[18,11];break;case 11:b=[15,11];break;case 12:b=[64,33];break;case 13:b=[160,99];break;case 14:b=[4,3];break;case 15:b=[3,2];break;case 16:b=[2,1];break;case 255:{b=[c()<<8|c(),c()<<8|c()];break}}}return{width:Math.ceil((I+1)*16-i*2-s*2),height:(2-R)*(k+1)*16-(R?2:4)*(l+u),pixelRatio:b}},o}(no),so=function(a){function o(){for(var r,e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return r=a.call.apply(a,[this].concat(t))||this,r.initVPS=null,r}J(o,a);var n=o.prototype;return n.parsePES=function(e,t,i,s){var l=this,u=this.parseNALu(e,i.data,s),f=this.VideoSample,d,h=!1;i.data=null,f&&u.length&&!e.audFound&&(this.pushAccessUnit(f,e),f=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts)),u.forEach(function(c){var v,g;switch(c.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:f||(f=l.VideoSample=l.createVideoSample(!1,i.pts,i.dts)),f.frame=!0,d=!0;break;case 16:case 17:case 18:case 21:if(d=!0,h){var m;(m=f)!=null&&m.frame&&!f.key&&(l.pushAccessUnit(f,e),f=l.VideoSample=null)}f||(f=l.VideoSample=l.createVideoSample(!0,i.pts,i.dts)),f.key=!0,f.frame=!0;break;case 19:case 20:d=!0,(v=f)!=null&&v.frame&&!f.key&&(l.pushAccessUnit(f,e),f=l.VideoSample=null),f||(f=l.VideoSample=l.createVideoSample(!0,i.pts,i.dts)),f.key=!0,f.frame=!0;break;case 39:d=!0,cn(c.data,2,i.pts,t.samples);break;case 32:d=!0,e.vps||(typeof e.params!="object"&&(e.params={}),e.params=ae(e.params,l.readVPS(c.data)),l.initVPS=c.data),e.vps=[c.data];break;case 33:if(d=!0,h=!0,e.vps!==void 0&&e.vps[0]!==l.initVPS&&e.sps!==void 0&&!l.matchSPS(e.sps[0],c.data)&&(l.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){var y=l.readSPS(c.data);e.width=y.width,e.height=y.height,e.pixelRatio=y.pixelRatio,e.codec=y.codecString,e.sps=[],typeof e.params!="object"&&(e.params={});for(var E in y.params)e.params[E]=y.params[E]}l.pushParameterSet(e.sps,c.data,e.vps),f||(f=l.VideoSample=l.createVideoSample(!0,i.pts,i.dts)),f.key=!0;break;case 34:if(d=!0,typeof e.params=="object"){if(!e.pps){e.pps=[];var T=l.readPPS(c.data);for(var S in T)e.params[S]=T[S]}l.pushParameterSet(e.pps,c.data,e.vps)}break;case 35:d=!0,e.audFound=!0,(g=f)!=null&&g.frame&&(l.pushAccessUnit(f,e),f=null),f||(f=l.VideoSample=l.createVideoSample(!1,i.pts,i.dts));break;default:d=!1;break}if(f&&d){var A=f.units;A.push(c)}}),s&&f&&(this.pushAccessUnit(f,e),this.VideoSample=null)},n.pushParameterSet=function(e,t,i){(i&&i[0]===this.initVPS||!i&&!e.length)&&e.push(t)},n.getNALuType=function(e,t){return(e[t]&126)>>>1},n.ebsp2rbsp=function(e){for(var t=new Uint8Array(e.byteLength),i=0,s=0;s<e.byteLength;s++)s>=2&&e[s]===3&&e[s-1]===0&&e[s-2]===0||(t[i]=e[s],i++);return new Uint8Array(t.buffer,0,i)},n.pushAccessUnit=function(e,t){a.prototype.pushAccessUnit.call(this,e,t),this.initVPS&&(this.initVPS=null)},n.readVPS=function(e){var t=new ri(e);t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6);var i=t.readBits(3),s=t.readBoolean();return{numTemporalLayers:i+1,temporalIdNested:s}},n.readSPS=function(e){var t=new ri(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);var i=t.readBits(3);t.readBoolean();for(var s=t.readBits(2),l=t.readBoolean(),u=t.readBits(5),f=t.readUByte(),d=t.readUByte(),h=t.readUByte(),c=t.readUByte(),v=t.readUByte(),g=t.readUByte(),m=t.readUByte(),y=t.readUByte(),E=t.readUByte(),T=t.readUByte(),S=t.readUByte(),A=[],x=[],L=0;L<i;L++)A.push(t.readBoolean()),x.push(t.readBoolean());if(i>0)for(var I=i;I<8;I++)t.readBits(2);for(var k=0;k<i;k++)A[k]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),x[k]&&t.readUByte();t.readUEG();var R=t.readUEG();R==3&&t.skipBits(1);var b=t.readUEG(),D=t.readUEG(),P=t.readBoolean(),U=0,F=0,M=0,H=0;P&&(U+=t.readUEG(),F+=t.readUEG(),M+=t.readUEG(),H+=t.readUEG());for(var q=t.readUEG(),W=t.readUEG(),ee=t.readUEG(),ye=t.readBoolean(),le=ye?0:i;le<=i;le++)t.skipUEG(),t.skipUEG(),t.skipUEG();t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG();var Ae=t.readBoolean();if(Ae){var de=t.readBoolean();if(de)for(var xe=0;xe<4;xe++)for(var Le=0;Le<(xe===3?2:6);Le++){var Me=t.readBoolean();if(!Me)t.readUEG();else{var tt=Math.min(64,1<<4+(xe<<1));xe>1&&t.readEG();for(var Xe=0;Xe<tt;Xe++)t.readEG()}}}t.readBoolean(),t.readBoolean();var Ke=t.readBoolean();Ke&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());for(var rt=t.readUEG(),We=0,ge=0;ge<rt;ge++){var yt=!1;if(ge!==0&&(yt=t.readBoolean()),yt){ge===rt&&t.readUEG(),t.readBoolean(),t.readUEG();for(var ct=0,ft=0;ft<=We;ft++){var ze=t.readBoolean(),Et=!1;ze||(Et=t.readBoolean()),(ze||Et)&&ct++}We=ct}else{var Ye=t.readUEG(),it=t.readUEG();We=Ye+it;for(var rr=0;rr<Ye;rr++)t.readUEG(),t.readBoolean();for(var mr=0;mr<it;mr++)t.readUEG(),t.readBoolean()}}var Vt=t.readBoolean();if(Vt)for(var Hr=t.readUEG(),zt=0;zt<Hr;zt++){for(var Xi=0;Xi<ee+4;Xi++)t.readBits(1);t.readBits(1)}var Vr=0,pr=1,Wr=1,yr=!0,zi=1,Yr=0;t.readBoolean(),t.readBoolean();var li=!1,Qi=t.readBoolean();if(Qi){var ui=t.readBoolean();if(ui){var Tt=t.readUByte(),$i=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],Ji=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];Tt>0&&Tt<16?(pr=$i[Tt-1],Wr=Ji[Tt-1]):Tt===255&&(pr=t.readBits(16),Wr=t.readBits(16))}var pa=t.readBoolean();pa&&t.readBoolean();var ya=t.readBoolean();if(ya){t.readBits(3),t.readBoolean();var Ea=t.readBoolean();Ea&&(t.readUByte(),t.readUByte(),t.readUByte())}var Ta=t.readBoolean();Ta&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),li=t.readBoolean(),li&&(U+=t.readUEG(),F+=t.readUEG(),M+=t.readUEG(),H+=t.readUEG());var Sa=t.readBoolean();if(Sa){zi=t.readBits(32),Yr=t.readBits(32);var qr=t.readBoolean();qr&&t.readUEG();var Zi=t.readBoolean();if(Zi){var en=t.readBoolean(),tn=t.readBoolean(),fi=!1;(en||tn)&&(fi=t.readBoolean(),fi&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),fi&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(var fl=0;fl<=i;fl++){yr=t.readBoolean();var tc=yr||t.readBoolean(),dl=!1;tc?t.readEG():dl=t.readBoolean();var hl=dl?1:t.readUEG()+1;if(en)for(var cl=0;cl<hl;cl++)t.readUEG(),t.readUEG(),fi&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(tn)for(var vl=0;vl<hl;vl++)t.readUEG(),t.readUEG(),fi&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}}var rc=t.readBoolean();rc&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),Vr=t.readUEG())}var gl=b,ml=D;if(P||li){var rn=1,Aa=1;R===1?rn=Aa=2:R==2&&(rn=2),gl=b-rn*F-rn*U,ml=D-Aa*H-Aa*M}for(var ic=s?["A","B","C"][s]:"",nc=f<<24|d<<16|h<<8|c,xa=0,nn=0;nn<32;nn++)xa=(xa|(nc>>nn&1)<<31-nn)>>>0;var La=xa.toString(16);u===1&&La==="2"&&(La="6");var ac=l?"H":"L";return{codecString:"hvc1."+ic+u+"."+La+"."+ac+S+".B0",params:{general_tier_flag:l,general_profile_idc:u,general_profile_space:s,general_profile_compatibility_flags:[f,d,h,c],general_constraint_indicator_flags:[v,g,m,y,E,T],general_level_idc:S,bit_depth:q+8,bit_depth_luma_minus8:q,bit_depth_chroma_minus8:W,min_spatial_segmentation_idc:Vr,chroma_format_idc:R,frame_rate:{fixed:yr,fps:Yr/zi}},width:gl,height:ml,pixelRatio:[pr,Wr]}},n.readPPS=function(e){var t=new ri(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2);var i=t.readBoolean();i&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);var s=t.readBoolean(),l=t.readBoolean(),u=1;return l&&s?u=0:l?u=3:s&&(u=2),{parallelismType:u}},n.matchSPS=function(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)},o}(no),ht=188,Af=function(){function a(n,r,e,t){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=n,this.config=r,this.typeSupported=e,this.logger=t,this.videoParser=null}a.probe=function(r,e){var t=a.syncOffset(r);return t>0&&e.warn("MPEG2-TS detected but first sync word found @ offset "+t),t!==-1},a.syncOffset=function(r){for(var e=r.length,t=Math.min(ht*5,e-ht)+1,i=0;i<t;){for(var s=!1,l=-1,u=0,f=i;f<e;f+=ht)if(r[f]===71&&(e-f===ht||r[f+ht]===71)){if(u++,l===-1&&(l=f,l!==0&&(t=Math.min(l+ht*99,r.length-ht)+1)),s||(s=Gn(r,f)===0),s&&u>1&&(l===0&&u>2||f+ht>t))return l}else{if(u)return-1;break}i++}return-1},a.createTrack=function(r,e){return{container:r==="video"||r==="audio"?"video/mp2t":void 0,type:r,id:ar[r],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:r==="audio"?e:void 0}};var o=a.prototype;return o.resetInitSegment=function(r,e,t,i){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=a.createTrack("video"),this._videoTrack.duration=i,this._audioTrack=a.createTrack("audio",i),this._id3Track=a.createTrack("id3"),this._txtTrack=a.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=t},o.resetTimeStamp=function(){},o.resetContiguity=function(){var r=this._audioTrack,e=this._videoTrack,t=this._id3Track;r&&(r.pesData=null),e&&(e.pesData=null),t&&(t.pesData=null),this.aacOverFlow=null,this.remainderData=null},o.demux=function(r,e,t,i){t===void 0&&(t=!1),i===void 0&&(i=!1),t||(this.sampleAes=null);var s,l=this._videoTrack,u=this._audioTrack,f=this._id3Track,d=this._txtTrack,h=l.pid,c=l.pesData,v=u.pid,g=f.pid,m=u.pesData,y=f.pesData,E=null,T=this.pmtParsed,S=this._pmtId,A=r.length;if(this.remainderData&&(r=Gt(this.remainderData,r),A=r.length,this.remainderData=null),A<ht&&!i)return this.remainderData=r,{audioTrack:u,videoTrack:l,id3Track:f,textTrack:d};var x=Math.max(0,a.syncOffset(r));A-=(A-x)%ht,A<r.byteLength&&!i&&(this.remainderData=new Uint8Array(r.buffer,A,r.buffer.byteLength-A));for(var L=0,I=x;I<A;I+=ht)if(r[I]===71){var k=!!(r[I+1]&64),R=Gn(r,I),b=(r[I+3]&48)>>4,D=void 0;if(b>1){if(D=I+5+r[I+4],D===I+ht)continue}else D=I+4;switch(R){case h:if(k){if(c&&(s=Or(c,this.logger))){if(this.videoParser===null)switch(l.segmentCodec){case"avc":this.videoParser=new ao;break;case"hevc":this.videoParser=new so;break}this.videoParser!==null&&this.videoParser.parsePES(l,d,s,!1)}c={data:[],size:0}}c&&(c.data.push(r.subarray(D,I+ht)),c.size+=I+ht-D);break;case v:if(k){if(m&&(s=Or(m,this.logger)))switch(u.segmentCodec){case"aac":this.parseAACPES(u,s);break;case"mp3":this.parseMPEGPES(u,s);break;case"ac3":this.parseAC3PES(u,s);break}m={data:[],size:0}}m&&(m.data.push(r.subarray(D,I+ht)),m.size+=I+ht-D);break;case g:k&&(y&&(s=Or(y,this.logger))&&this.parseID3PES(f,s),y={data:[],size:0}),y&&(y.data.push(r.subarray(D,I+ht)),y.size+=I+ht-D);break;case 0:k&&(D+=r[D]+1),S=this._pmtId=xf(r,D);break;case S:{k&&(D+=r[D]+1);var P=Lf(r,D,this.typeSupported,t,this.observer,this.logger);h=P.videoPid,h>0&&(l.pid=h,l.segmentCodec=P.segmentVideoCodec),v=P.audioPid,v>0&&(u.pid=v,u.segmentCodec=P.segmentAudioCodec),g=P.id3Pid,g>0&&(f.pid=g),E!==null&&!T&&(this.logger.warn("MPEG-TS PMT found at "+I+" after unknown PID '"+E+"'. Backtracking to sync byte @"+x+" to parse all TS packets."),E=null,I=x-188),T=this.pmtParsed=!0;break}case 17:case 8191:break;default:E=R;break}}else L++;L>0&&Kn(this.observer,new Error("Found "+L+" TS packet/s that do not start with 0x47"),void 0,this.logger),l.pesData=c,u.pesData=m,f.pesData=y;var U={audioTrack:u,videoTrack:l,id3Track:f,textTrack:d};return i&&this.extractRemainingSamples(U),U},o.flush=function(){var r=this.remainderData;this.remainderData=null;var e;return r?e=this.demux(r,-1,!1,!0):e={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(e),this.sampleAes?this.decrypt(e,this.sampleAes):e},o.extractRemainingSamples=function(r){var e=r.audioTrack,t=r.videoTrack,i=r.id3Track,s=r.textTrack,l=t.pesData,u=e.pesData,f=i.pesData,d;if(l&&(d=Or(l,this.logger))){if(this.videoParser===null)switch(t.segmentCodec){case"avc":this.videoParser=new ao;break;case"hevc":this.videoParser=new so;break}this.videoParser!==null&&(this.videoParser.parsePES(t,s,d,!0),t.pesData=null)}else t.pesData=l;if(u&&(d=Or(u,this.logger))){switch(e.segmentCodec){case"aac":this.parseAACPES(e,d);break;case"mp3":this.parseMPEGPES(e,d);break;case"ac3":this.parseAC3PES(e,d);break}e.pesData=null}else u!=null&&u.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),e.pesData=u;f&&(d=Or(f,this.logger))?(this.parseID3PES(i,d),i.pesData=null):i.pesData=f},o.demuxSampleAes=function(r,e,t){var i=this.demux(r,t,!0,!this.config.progressive),s=this.sampleAes=new Sf(this.observer,this.config,e);return this.decrypt(i,s)},o.decrypt=function(r,e){return new Promise(function(t){var i=r.audioTrack,s=r.videoTrack;i.samples&&i.segmentCodec==="aac"?e.decryptAacSamples(i.samples,0,function(){s.samples?e.decryptAvcSamples(s.samples,0,0,function(){t(r)}):t(r)}):s.samples&&e.decryptAvcSamples(s.samples,0,0,function(){t(r)})})},o.destroy=function(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0},o.parseAACPES=function(r,e){var t=0,i=this.aacOverFlow,s=e.data;if(i){this.aacOverFlow=null;var l=i.missing,u=i.sample.unit.byteLength;if(l===-1)s=Gt(i.sample.unit,s);else{var f=u-l;i.sample.unit.set(s.subarray(0,l),f),r.samples.push(i.sample),t=i.missing}}var d,h;for(d=t,h=s.length;d<h-1&&!Mi(s,d);d++);if(d!==t){var c,v=d<h-1;if(v?c="AAC PES did not start with ADTS header,offset:"+d:c="No ADTS header found in AAC PES",Kn(this.observer,new Error(c),v,this.logger),!v)return}Ys(r,this.observer,s,d,this.audioCodec);var g;if(e.pts!==void 0)g=e.pts;else if(i){var m=qs(r.samplerate);g=i.sample.pts+m}else{this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}for(var y=0,E;d<h;)if(E=js(r,s,d,g,y),d+=E.length,E.missing){this.aacOverFlow=E;break}else for(y++;d<h-1&&!Mi(s,d);d++);},o.parseMPEGPES=function(r,e){var t=e.data,i=t.length,s=0,l=0,u=e.pts;if(u===void 0){this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;l<i;)if(Zs(t,l)){var f=$s(r,t,l,u,s);if(f)l+=f.length,s++;else break}else l++},o.parseAC3PES=function(r,e){{var t=e.data,i=e.pts;if(i===void 0){this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");return}for(var s=t.length,l=0,u=0,f;u<s&&(f=ro(r,t,u,i,l++))>0;)u+=f}},o.parseID3PES=function(r,e){if(e.pts===void 0){this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}var t=ae({},e,{type:this._videoTrack?Ft.emsg:Ft.audioId3,duration:Number.POSITIVE_INFINITY});r.samples.push(t)},a}();function Gn(a,o){return((a[o+1]&31)<<8)+a[o+2]}function xf(a,o){return(a[o+10]&31)<<8|a[o+11]}function Lf(a,o,n,r,e,t){var i={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},s=(a[o+1]&15)<<8|a[o+2],l=o+3+s-4,u=(a[o+10]&15)<<8|a[o+11];for(o+=12+u;o<l;){var f=Gn(a,o),d=(a[o+3]&15)<<8|a[o+4];switch(a[o]){case 207:if(!r){Hn("ADTS AAC",t);break}case 15:i.audioPid===-1&&(i.audioPid=f);break;case 21:i.id3Pid===-1&&(i.id3Pid=f);break;case 219:if(!r){Hn("H.264",t);break}case 27:i.videoPid===-1&&(i.videoPid=f);break;case 3:case 4:!n.mpeg&&!n.mp3?t.log("MPEG audio found, not supported in this browser"):i.audioPid===-1&&(i.audioPid=f,i.segmentAudioCodec="mp3");break;case 193:if(!r){Hn("AC-3",t);break}case 129:n.ac3?i.audioPid===-1&&(i.audioPid=f,i.segmentAudioCodec="ac3"):t.log("AC-3 audio found, not supported in this browser");break;case 6:if(i.audioPid===-1&&d>0)for(var h=o+5,c=d;c>2;){var v=a[h];switch(v){case 106:n.ac3!==!0?t.log("AC-3 audio found, not supported in this browser for now"):(i.audioPid=f,i.segmentAudioCodec="ac3");break}var g=a[h+1]+2;h+=g,c-=g}break;case 194:case 135:return Kn(e,new Error("Unsupported EC-3 in M2TS found"),void 0,t),i;case 36:i.videoPid===-1&&(i.videoPid=f,i.segmentVideoCodec="hevc",t.log("HEVC in M2TS found"));break}o+=d+5}return i}function Kn(a,o,n,r){r.warn("parsing error: "+o.message),a.emit(p.ERROR,p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:!1,levelRetry:n,error:o,reason:o.message})}function Hn(a,o){o.log(a+" with AES-128-CBC encryption found in unencrypted stream")}function Or(a,o){var n=0,r,e,t,i,s,l=a.data;if(!a||a.size===0)return null;for(;l[0].length<19&&l.length>1;)l[0]=Gt(l[0],l[1]),l.splice(1,1);r=l[0];var u=(r[0]<<16)+(r[1]<<8)+r[2];if(u===1){if(e=(r[4]<<8)+r[5],e&&e>a.size-6)return null;var f=r[7];f&192&&(i=(r[9]&14)*536870912+(r[10]&255)*4194304+(r[11]&254)*16384+(r[12]&255)*128+(r[13]&254)/2,f&64?(s=(r[14]&14)*536870912+(r[15]&255)*4194304+(r[16]&254)*16384+(r[17]&255)*128+(r[18]&254)/2,i-s>60*9e4&&(o.warn(Math.round((i-s)/9e4)+"s delta between PTS and DTS, align them"),i=s)):s=i),t=r[8];var d=t+9;if(a.size<=d)return null;a.size-=d;for(var h=new Uint8Array(a.size),c=0,v=l.length;c<v;c++){r=l[c];var g=r.byteLength;if(d)if(d>g){d-=g;continue}else r=r.subarray(d),g-=d,d=0;h.set(r,n),n+=g}return e&&(e-=t+3),{data:h,pts:i,dts:s,len:e}}return null}var bf=function(){function a(){}return a.getSilentFrame=function(n,r){switch(n){case"mp4a.40.2":if(r===1)return new Uint8Array([0,200,0,128,35,128]);if(r===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(r===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(r===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(r===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(r===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(r===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(r===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(r===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}},a}(),vr=Math.pow(2,32)-1,pt=function(){function a(){}return a.init=function(){a.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var n;for(n in a.types)a.types.hasOwnProperty(n)&&(a.types[n]=[n.charCodeAt(0),n.charCodeAt(1),n.charCodeAt(2),n.charCodeAt(3)]);var r=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),e=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);a.HDLR_TYPES={video:r,audio:e};var t=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),i=new Uint8Array([0,0,0,0,0,0,0,0]);a.STTS=a.STSC=a.STCO=i,a.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),a.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),a.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),a.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var s=new Uint8Array([105,115,111,109]),l=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);a.FTYP=a.box(a.types.ftyp,s,u,s,l),a.DINF=a.box(a.types.dinf,a.box(a.types.dref,t))},a.box=function(n){for(var r=8,e=arguments.length,t=new Array(e>1?e-1:0),i=1;i<e;i++)t[i-1]=arguments[i];for(var s=t.length,l=s;s--;)r+=t[s].byteLength;var u=new Uint8Array(r);for(u[0]=r>>24&255,u[1]=r>>16&255,u[2]=r>>8&255,u[3]=r&255,u.set(n,4),s=0,r=8;s<l;s++)u.set(t[s],r),r+=t[s].byteLength;return u},a.hdlr=function(n){return a.box(a.types.hdlr,a.HDLR_TYPES[n])},a.mdat=function(n){return a.box(a.types.mdat,n)},a.mdhd=function(n,r){r*=n;var e=Math.floor(r/(vr+1)),t=Math.floor(r%(vr+1));return a.box(a.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,n>>24&255,n>>16&255,n>>8&255,n&255,e>>24,e>>16&255,e>>8&255,e&255,t>>24,t>>16&255,t>>8&255,t&255,85,196,0,0]))},a.mdia=function(n){return a.box(a.types.mdia,a.mdhd(n.timescale||0,n.duration||0),a.hdlr(n.type),a.minf(n))},a.mfhd=function(n){return a.box(a.types.mfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255]))},a.minf=function(n){return n.type==="audio"?a.box(a.types.minf,a.box(a.types.smhd,a.SMHD),a.DINF,a.stbl(n)):a.box(a.types.minf,a.box(a.types.vmhd,a.VMHD),a.DINF,a.stbl(n))},a.moof=function(n,r,e){return a.box(a.types.moof,a.mfhd(n),a.traf(e,r))},a.moov=function(n){for(var r=n.length,e=[];r--;)e[r]=a.trak(n[r]);return a.box.apply(null,[a.types.moov,a.mvhd(n[0].timescale||0,n[0].duration||0)].concat(e).concat(a.mvex(n)))},a.mvex=function(n){for(var r=n.length,e=[];r--;)e[r]=a.trex(n[r]);return a.box.apply(null,[a.types.mvex].concat(e))},a.mvhd=function(n,r){r*=n;var e=Math.floor(r/(vr+1)),t=Math.floor(r%(vr+1)),i=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,n>>24&255,n>>16&255,n>>8&255,n&255,e>>24,e>>16&255,e>>8&255,e&255,t>>24,t>>16&255,t>>8&255,t&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return a.box(a.types.mvhd,i)},a.sdtp=function(n){var r=n.samples||[],e=new Uint8Array(4+r.length),t,i;for(t=0;t<r.length;t++)i=r[t].flags,e[t+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return a.box(a.types.sdtp,e)},a.stbl=function(n){return a.box(a.types.stbl,a.stsd(n),a.box(a.types.stts,a.STTS),a.box(a.types.stsc,a.STSC),a.box(a.types.stsz,a.STSZ),a.box(a.types.stco,a.STCO))},a.avc1=function(n){var r=[],e=[],t,i,s;for(t=0;t<n.sps.length;t++)i=n.sps[t],s=i.byteLength,r.push(s>>>8&255),r.push(s&255),r=r.concat(Array.prototype.slice.call(i));for(t=0;t<n.pps.length;t++)i=n.pps[t],s=i.byteLength,e.push(s>>>8&255),e.push(s&255),e=e.concat(Array.prototype.slice.call(i));var l=a.box(a.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|n.sps.length].concat(r).concat([n.pps.length]).concat(e))),u=n.width,f=n.height,d=n.pixelRatio[0],h=n.pixelRatio[1];return a.box(a.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,f>>8&255,f&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l,a.box(a.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),a.box(a.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,d&255,h>>24,h>>16&255,h>>8&255,h&255])))},a.esds=function(n){var r=n.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2].concat(r,[6,1,2]))},a.audioStsd=function(n){var r=n.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,n.channelCount||0,0,16,0,0,0,0,r>>8&255,r&255,0,0])},a.mp4a=function(n){return a.box(a.types.mp4a,a.audioStsd(n),a.box(a.types.esds,a.esds(n)))},a.mp3=function(n){return a.box(a.types[".mp3"],a.audioStsd(n))},a.ac3=function(n){return a.box(a.types["ac-3"],a.audioStsd(n),a.box(a.types.dac3,n.config))},a.stsd=function(n){var r=n.segmentCodec;if(n.type==="audio"){if(r==="aac")return a.box(a.types.stsd,a.STSD,a.mp4a(n));if(r==="ac3"&&n.config)return a.box(a.types.stsd,a.STSD,a.ac3(n));if(r==="mp3"&&n.codec==="mp3")return a.box(a.types.stsd,a.STSD,a.mp3(n))}else if(n.pps&&n.sps){if(r==="avc")return a.box(a.types.stsd,a.STSD,a.avc1(n));if(r==="hevc"&&n.vps)return a.box(a.types.stsd,a.STSD,a.hvc1(n))}else throw new Error("video track missing pps or sps");throw new Error("unsupported "+n.type+" segment codec ("+r+"/"+n.codec+")")},a.tkhd=function(n){var r=n.id,e=(n.duration||0)*(n.timescale||0),t=n.width||0,i=n.height||0,s=Math.floor(e/(vr+1)),l=Math.floor(e%(vr+1));return a.box(a.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,r>>24&255,r>>16&255,r>>8&255,r&255,0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255,l>>24,l>>16&255,l>>8&255,l&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,t>>8&255,t&255,0,0,i>>8&255,i&255,0,0]))},a.traf=function(n,r){var e=a.sdtp(n),t=n.id,i=Math.floor(r/(vr+1)),s=Math.floor(r%(vr+1));return a.box(a.types.traf,a.box(a.types.tfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255])),a.box(a.types.tfdt,new Uint8Array([1,0,0,0,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255])),a.trun(n,e.length+16+20+8+16+8+8),e)},a.trak=function(n){return n.duration=n.duration||4294967295,a.box(a.types.trak,a.tkhd(n),a.mdia(n))},a.trex=function(n){var r=n.id;return a.box(a.types.trex,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))},a.trun=function(n,r){var e=n.samples||[],t=e.length,i=12+16*t,s=new Uint8Array(i),l,u,f,d,h,c;for(r+=8+i,s.set([n.type==="video"?1:0,0,15,1,t>>>24&255,t>>>16&255,t>>>8&255,t&255,r>>>24&255,r>>>16&255,r>>>8&255,r&255],0),l=0;l<t;l++)u=e[l],f=u.duration,d=u.size,h=u.flags,c=u.cts,s.set([f>>>24&255,f>>>16&255,f>>>8&255,f&255,d>>>24&255,d>>>16&255,d>>>8&255,d&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,c>>>24&255,c>>>16&255,c>>>8&255,c&255],12+16*l);return a.box(a.types.trun,s)},a.initSegment=function(n){a.types||a.init();var r=a.moov(n),e=Gt(a.FTYP,r);return e},a.hvc1=function(n){for(var r=n.params,e=[n.vps,n.sps,n.pps],t=4,i=new Uint8Array([1,r.general_profile_space<<6|(r.general_tier_flag?32:0)|r.general_profile_idc,r.general_profile_compatibility_flags[0],r.general_profile_compatibility_flags[1],r.general_profile_compatibility_flags[2],r.general_profile_compatibility_flags[3],r.general_constraint_indicator_flags[0],r.general_constraint_indicator_flags[1],r.general_constraint_indicator_flags[2],r.general_constraint_indicator_flags[3],r.general_constraint_indicator_flags[4],r.general_constraint_indicator_flags[5],r.general_level_idc,240|r.min_spatial_segmentation_idc>>8,255&r.min_spatial_segmentation_idc,252|r.parallelismType,252|r.chroma_format_idc,248|r.bit_depth_luma_minus8,248|r.bit_depth_chroma_minus8,0,parseInt(r.frame_rate.fps),t-1|r.temporal_id_nested<<2|r.num_temporal_layers<<3|(r.frame_rate.fixed?64:0),e.length]),s=i.length,l=0;l<e.length;l+=1){s+=3;for(var u=0;u<e[l].length;u+=1)s+=2+e[l][u].length}var f=new Uint8Array(s);f.set(i,0),s=i.length;for(var d=e.length-1,h=0;h<e.length;h+=1){f.set(new Uint8Array([32+h|(h===d?128:0),0,e[h].length]),s),s+=3;for(var c=0;c<e[h].length;c+=1)f.set(new Uint8Array([e[h][c].length>>8,e[h][c].length&255]),s),s+=2,f.set(e[h][c],s),s+=e[h][c].length}var v=a.box(a.types.hvcC,f),g=n.width,m=n.height,y=n.pixelRatio[0],E=n.pixelRatio[1];return a.box(a.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,g>>8&255,g&255,m>>8&255,m&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),v,a.box(a.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),a.box(a.types.pasp,new Uint8Array([y>>24,y>>16&255,y>>8&255,y&255,E>>24,E>>16&255,E>>8&255,E&255])))},a}();pt.types=void 0,pt.HDLR_TYPES=void 0,pt.STTS=void 0,pt.STSC=void 0,pt.STCO=void 0,pt.STSZ=void 0,pt.VMHD=void 0,pt.SMHD=void 0,pt.STSD=void 0,pt.FTYP=void 0,pt.DINF=void 0;var oo=9e4;function Vn(a,o,n,r){n===void 0&&(n=1),r===void 0&&(r=!1);var e=a*o*n;return r?Math.round(e):e}function Rf(a,o,n,r){return n===void 0&&(n=1),r===void 0&&(r=!1),Vn(a,o,1/n,r)}function ii(a,o){return Vn(a,1e3,1/oo,o)}function If(a,o){return o===void 0&&(o=1),Vn(a,oo,1/o)}var _f=10*1e3,Df=1024,kf=1152,Cf=1536,Fr=null,Wn=null;function lo(a,o,n,r){return{duration:o,size:n,cts:r,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:a?2:1,isNonSync:a?0:1}}}var Ni=function(){function a(n,r,e,t){if(this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=n,this.config=r,this.typeSupported=e,this.logger=t,this.ISGenerated=!1,Fr===null){var i=navigator.userAgent||"",s=i.match(/Chrome\/(\d+)/i);Fr=s?parseInt(s[1]):0}if(Wn===null){var l=navigator.userAgent.match(/Safari\/(\d+)/i);Wn=l?parseInt(l[1]):0}}var o=a.prototype;return o.destroy=function(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null},o.resetTimeStamp=function(r){this.logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=r},o.resetNextTimestamp=function(){this.logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1},o.resetInitSegment=function(){this.logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0},o.getVideoStartPts=function(r){var e=!1,t=r[0].pts,i=r.reduce(function(s,l){var u=l.pts,f=u-s;return f<-4294967296&&(e=!0,u=Kt(u,t),f=u-s),f>0?s:u},t);return e&&this.logger.debug("PTS rollover detected"),i},o.remux=function(r,e,t,i,s,l,u,f){var d,h,c,v,g,m,y=s,E=s,T=r.pid>-1,S=e.pid>-1,A=e.samples.length,x=r.samples.length>0,L=u&&A>0||A>1,I=(!T||x)&&(!S||L)||this.ISGenerated||u;if(I){if(this.ISGenerated){var k,R,b,D,P=this.videoTrackConfig;(P&&(e.width!==P.width||e.height!==P.height||((k=e.pixelRatio)==null?void 0:k[0])!==((R=P.pixelRatio)==null?void 0:R[0])||((b=e.pixelRatio)==null?void 0:b[1])!==((D=P.pixelRatio)==null?void 0:D[1]))||!P&&L||this.nextAudioPts===null&&x)&&this.resetInitSegment()}this.ISGenerated||(c=this.generateIS(r,e,s,l));var U=this.isVideoContiguous,F=-1,M;if(L&&(F=Pf(e.samples),!U&&this.config.forceKeyFrameOnDiscontinuity))if(m=!0,F>0){this.logger.warn("[mp4-remuxer]: Dropped "+F+" out of "+A+" video samples due to a missing keyframe");var H=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(F),e.dropped+=F,E+=(e.samples[0].pts-H)/e.inputTimeScale,M=E}else F===-1&&(this.logger.warn("[mp4-remuxer]: No keyframe found out of "+A+" video samples"),m=!1);if(this.ISGenerated){if(x&&L){var q=this.getVideoStartPts(e.samples),W=Kt(r.samples[0].pts,q)-q,ee=W/e.inputTimeScale;y+=Math.max(0,ee),E+=Math.max(0,-ee)}if(x){if(r.samplerate||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),c=this.generateIS(r,e,s,l)),h=this.remuxAudio(r,y,this.isAudioContiguous,l,S||L||f===K.AUDIO?E:void 0),L){var ye=h?h.endPTS-h.startPTS:0;e.inputTimeScale||(this.logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),c=this.generateIS(r,e,s,l)),d=this.remuxVideo(e,E,U,ye)}}else L&&(d=this.remuxVideo(e,E,U,0));d&&(d.firstKeyFrame=F,d.independent=F!==-1,d.firstKeyFramePTS=M)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(t.samples.length&&(g=uo(t,s,this._initPTS,this._initDTS)),i.samples.length&&(v=fo(i,s,this._initPTS))),{audio:h,video:d,initSegment:c,independent:m,text:v,id3:g}},o.generateIS=function(r,e,t,i){var s=r.samples,l=e.samples,u=this.typeSupported,f={},d=this._initPTS,h=!d||i,c="audio/mp4",v,g,m;if(h&&(v=g=1/0),r.config&&s.length){switch(r.timescale=r.samplerate,r.segmentCodec){case"mp3":u.mpeg?(c="audio/mpeg",r.codec=""):u.mp3&&(r.codec="mp3");break;case"ac3":r.codec="ac-3";break}f.audio={id:"audio",container:c,codec:r.codec,initSegment:r.segmentCodec==="mp3"&&u.mpeg?new Uint8Array(0):pt.initSegment([r]),metadata:{channelCount:r.channelCount}},h&&(m=r.inputTimeScale,!d||m!==d.timescale?v=g=s[0].pts-Math.round(m*t):h=!1)}if(e.sps&&e.pps&&l.length){if(e.timescale=e.inputTimeScale,f.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:pt.initSegment([e]),metadata:{width:e.width,height:e.height}},h)if(m=e.inputTimeScale,!d||m!==d.timescale){var y=this.getVideoStartPts(l),E=Math.round(m*t);g=Math.min(g,Kt(l[0].dts,y)-E),v=Math.min(v,y-E)}else h=!1;this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(f).length)return this.ISGenerated=!0,h?(this._initPTS={baseTime:v,timescale:m},this._initDTS={baseTime:g,timescale:m}):v=m=void 0,{tracks:f,initPTS:v,timescale:m}},o.remuxVideo=function(r,e,t,i){var s=r.inputTimeScale,l=r.samples,u=[],f=l.length,d=this._initPTS,h=this.nextAvcDts,c=8,v=this.videoSampleDuration,g,m,y=Number.POSITIVE_INFINITY,E=Number.NEGATIVE_INFINITY,T=!1;if(!t||h===null){var S=e*s,A=l[0].pts-Kt(l[0].dts,l[0].pts);Fr&&h!==null&&Math.abs(S-A-h)<15e3?t=!0:h=S-A}for(var x=d.baseTime*s/d.timescale,L=0;L<f;L++){var I=l[L];I.pts=Kt(I.pts-x,h),I.dts=Kt(I.dts-x,h),I.dts<l[L>0?L-1:L].dts&&(T=!0)}T&&l.sort(function(qr,Zi){var en=qr.dts-Zi.dts,tn=qr.pts-Zi.pts;return en||tn}),g=l[0].dts,m=l[l.length-1].dts;var k=m-g,R=k?Math.round(k/(f-1)):v||r.inputTimeScale/30;if(t){var b=g-h,D=b>R,P=b<-1;if((D||P)&&(D?this.logger.warn((r.segmentCodec||"").toUpperCase()+": "+ii(b,!0)+" ms ("+b+"dts) hole between fragments detected at "+e.toFixed(3)):this.logger.warn((r.segmentCodec||"").toUpperCase()+": "+ii(-b,!0)+" ms ("+b+"dts) overlapping between fragments detected at "+e.toFixed(3)),!P||h>=l[0].pts||Fr)){g=h;var U=l[0].pts-b;if(D)l[0].dts=g,l[0].pts=U;else for(var F=!0,M=0;M<l.length&&!(l[M].dts>U&&F);M++){var H=l[M].pts;if(l[M].dts-=b,l[M].pts-=b,M<l.length-1){var q=l[M+1].pts,W=l[M].pts,ee=q<=W,ye=q<=H;F=ee==ye}}this.logger.log("Video: Initial PTS/DTS adjusted: "+ii(U,!0)+"/"+ii(g,!0)+", delta: "+ii(b,!0)+" ms")}}g=Math.max(0,g);for(var le=0,Ae=0,de=g,xe=0;xe<f;xe++){for(var Le=l[xe],Me=Le.units,tt=Me.length,Xe=0,Ke=0;Ke<tt;Ke++)Xe+=Me[Ke].data.length;Ae+=Xe,le+=tt,Le.length=Xe,Le.dts<de?(Le.dts=de,de+=R/4|0||1):de=Le.dts,y=Math.min(Le.pts,y),E=Math.max(Le.pts,E)}m=l[f-1].dts;var rt=Ae+4*le+8,We;try{We=new Uint8Array(rt)}catch(qr){this.observer.emit(p.ERROR,p.ERROR,{type:V.MUX_ERROR,details:_.REMUX_ALLOC_ERROR,fatal:!1,error:qr,bytes:rt,reason:"fail allocating video mdat "+rt});return}var ge=new DataView(We.buffer);ge.setUint32(0,rt),We.set(pt.types.mdat,4);for(var yt=!1,ct=Number.POSITIVE_INFINITY,ft=Number.POSITIVE_INFINITY,ze=Number.NEGATIVE_INFINITY,Et=Number.NEGATIVE_INFINITY,Ye=0;Ye<f;Ye++){for(var it=l[Ye],rr=it.units,mr=0,Vt=0,Hr=rr.length;Vt<Hr;Vt++){var zt=rr[Vt],Xi=zt.data,Vr=zt.data.byteLength;ge.setUint32(c,Vr),c+=4,We.set(Xi,c),c+=Vr,mr+=4+Vr}var pr=void 0;if(Ye<f-1)v=l[Ye+1].dts-it.dts,pr=l[Ye+1].pts-it.pts;else{var Wr=this.config,yr=Ye>0?it.dts-l[Ye-1].dts:R;if(pr=Ye>0?it.pts-l[Ye-1].pts:R,Wr.stretchShortVideoTrack&&this.nextAudioPts!==null){var zi=Math.floor(Wr.maxBufferHole*s),Yr=(i?y+i*s:this.nextAudioPts)-it.pts;Yr>zi?(v=Yr-yr,v<0?v=yr:yt=!0,this.logger.log("[mp4-remuxer]: It is approximately "+Yr/90+" ms to the next segment; using duration "+v/90+" ms for the last video frame.")):v=yr}else v=yr}var li=Math.round(it.pts-it.dts);ct=Math.min(ct,v),ze=Math.max(ze,v),ft=Math.min(ft,pr),Et=Math.max(Et,pr),u.push(lo(it.key,v,mr,li))}if(u.length){if(Fr){if(Fr<70){var Qi=u[0].flags;Qi.dependsOn=2,Qi.isNonSync=0}}else if(Wn&&Et-ft<ze-ct&&R/ze<.025&&u[0].cts===0){this.logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");for(var ui=g,Tt=0,$i=u.length;Tt<$i;Tt++){var Ji=ui+u[Tt].duration,pa=ui+u[Tt].cts;if(Tt<$i-1){var ya=Ji+u[Tt+1].cts;u[Tt].duration=ya-pa}else u[Tt].duration=Tt?u[Tt-1].duration:R;u[Tt].cts=0,ui=Ji}}}v=yt||!v?R:v,this.nextAvcDts=h=m+v,this.videoSampleDuration=v,this.isVideoContiguous=!0;var Ea=pt.moof(r.sequenceNumber++,g,ae(r,{samples:u})),Ta="video",Sa={data1:Ea,data2:We,startPTS:y/s,endPTS:(E+v)/s,startDTS:g/s,endDTS:h/s,type:Ta,hasAudio:!1,hasVideo:!0,nb:u.length,dropped:r.dropped};return r.samples=[],r.dropped=0,Sa},o.getSamplesPerFrame=function(r){switch(r.segmentCodec){case"mp3":return kf;case"ac3":return Cf;default:return Df}},o.remuxAudio=function(r,e,t,i,s){var l=r.inputTimeScale,u=r.samplerate?r.samplerate:l,f=l/u,d=this.getSamplesPerFrame(r),h=d*f,c=this._initPTS,v=r.segmentCodec==="mp3"&&this.typeSupported.mpeg,g=[],m=s!==void 0,y=r.samples,E=v?0:8,T=this.nextAudioPts||-1,S=e*l,A=c.baseTime*l/c.timescale;if(this.isAudioContiguous=t=t||y.length&&T>0&&(i&&Math.abs(S-T)<9e3||Math.abs(Kt(y[0].pts-A,S)-T)<20*h),y.forEach(function(ze){ze.pts=Kt(ze.pts-A,S)}),!t||T<0){if(y=y.filter(function(ze){return ze.pts>=0}),!y.length)return;s===0?T=0:i&&!m?T=Math.max(0,S):T=y[0].pts}if(r.segmentCodec==="aac")for(var x=this.config.maxAudioFramesDrift,L=0,I=T;L<y.length;L++){var k=y[L],R=k.pts,b=R-I,D=Math.abs(1e3*b/l);if(b<=-x*h&&m)L===0&&(this.logger.warn("Audio frame @ "+(R/l).toFixed(3)+"s overlaps nextAudioPts by "+Math.round(1e3*b/l)+" ms."),this.nextAudioPts=T=I=R);else if(b>=x*h&&D<_f&&m){var P=Math.round(b/h);I=R-P*h,I<0&&(P--,I+=h),L===0&&(this.nextAudioPts=T=I),this.logger.warn("[mp4-remuxer]: Injecting "+P+" audio frame @ "+(I/l).toFixed(3)+"s due to "+Math.round(1e3*b/l)+" ms gap.");for(var U=0;U<P;U++){var F=Math.max(I,0),M=bf.getSilentFrame(r.parsedCodec||r.manifestCodec||r.codec,r.channelCount);M||(this.logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),M=k.unit.subarray()),y.splice(L,0,{unit:M,pts:F}),I+=h,L++}}k.pts=I,I+=h}for(var H=null,q=null,W,ee=0,ye=y.length;ye--;)ee+=y[ye].unit.byteLength;for(var le=0,Ae=y.length;le<Ae;le++){var de=y[le],xe=de.unit,Le=de.pts;if(q!==null){var Me=g[le-1];Me.duration=Math.round((Le-q)/f)}else if(t&&r.segmentCodec==="aac"&&(Le=T),H=Le,ee>0){ee+=E;try{W=new Uint8Array(ee)}catch(ze){this.observer.emit(p.ERROR,p.ERROR,{type:V.MUX_ERROR,details:_.REMUX_ALLOC_ERROR,fatal:!1,error:ze,bytes:ee,reason:"fail allocating audio mdat "+ee});return}if(!v){var tt=new DataView(W.buffer);tt.setUint32(0,ee),W.set(pt.types.mdat,4)}}else return;W.set(xe,E);var Xe=xe.byteLength;E+=Xe,g.push(lo(!0,d,Xe,0)),q=Le}var Ke=g.length;if(Ke){var rt=g[g.length-1];this.nextAudioPts=T=q+f*rt.duration;var We=v?new Uint8Array(0):pt.moof(r.sequenceNumber++,H/f,ae({},r,{samples:g}));r.samples=[];var ge=H/l,yt=T/l,ct="audio",ft={data1:We,data2:W,startPTS:ge,endPTS:yt,startDTS:ge,endDTS:yt,type:ct,hasAudio:!0,hasVideo:!1,nb:Ke};return this.isAudioContiguous=!0,ft}},a}();function Kt(a,o){var n;if(o===null)return a;for(o<a?n=-8589934592:n=8589934592;Math.abs(a-o)>4294967296;)a+=n;return a}function Pf(a){for(var o=0;o<a.length;o++)if(a[o].key)return o;return-1}function uo(a,o,n,r){var e=a.samples.length;if(e){for(var t=a.inputTimeScale,i=0;i<e;i++){var s=a.samples[i];s.pts=Kt(s.pts-n.baseTime*t/n.timescale,o*t)/t,s.dts=Kt(s.dts-r.baseTime*t/r.timescale,o*t)/t}var l=a.samples;return a.samples=[],{samples:l}}}function fo(a,o,n){var r=a.samples.length;if(r){for(var e=a.inputTimeScale,t=0;t<r;t++){var i=a.samples[t];i.pts=Kt(i.pts-n.baseTime*e/n.timescale,o*e)/e}a.samples.sort(function(l,u){return l.pts-u.pts});var s=a.samples;return a.samples=[],{samples:s}}}var wf=function(){function a(n,r,e,t){this.logger=void 0,this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.logger=t}var o=a.prototype;return o.destroy=function(){},o.resetTimeStamp=function(r){this.initPTS=r,this.lastEndTime=null},o.resetNextTimestamp=function(){this.lastEndTime=null},o.resetInitSegment=function(r,e,t,i){this.audioCodec=e,this.videoCodec=t,this.generateInitSegment(Rl(r,i)),this.emitInitSegment=!0},o.generateInitSegment=function(r){var e=this.audioCodec,t=this.videoCodec;if(!(r!=null&&r.byteLength)){this.initTracks=void 0,this.initData=void 0;return}var i=this.initData=Fa(r);i.audio&&(e=ho(i.audio,oe.AUDIO)),i.video&&(t=ho(i.video,oe.VIDEO));var s={};i.audio&&i.video?s.audiovideo={container:"video/mp4",codec:e+","+t,supplemental:i.video.supplemental,initSegment:r,id:"main"}:i.audio?s.audio={container:"audio/mp4",codec:e,initSegment:r,id:"audio"}:i.video?s.video={container:"video/mp4",codec:t,supplemental:i.video.supplemental,initSegment:r,id:"main"}:this.logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s},o.remux=function(r,e,t,i,s,l){var u,f,d=this.initPTS,h=this.lastEndTime,c={audio:void 0,video:void 0,text:i,id3:t,initSegment:void 0};N(h)||(h=this.lastEndTime=s||0);var v=e.samples;if(!(v!=null&&v.length))return c;var g={initPTS:void 0,timescale:1},m=this.initData;if((u=m)!=null&&u.length||(this.generateInitSegment(v),m=this.initData),!((f=m)!=null&&f.length))return this.logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),c;this.emitInitSegment&&(g.tracks=this.initTracks,this.emitInitSegment=!1);var y=_l(v,m),E=Il(m,v),T=E===null?s:E;(l||!d)&&(Mf(d,T,s,y)||g.timescale!==d.timescale)&&(g.initPTS=T-s,d&&d.timescale===1&&this.logger.warn("Adjusting initPTS @"+s+" from "+d.baseTime/d.timescale+" to "+g.initPTS),this.initPTS=d={baseTime:g.initPTS,timescale:1});var S=r?T-d.baseTime/d.timescale:h,A=S+y;kl(m,v,d.baseTime/d.timescale),y>0?this.lastEndTime=A:(this.logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());var x=!!m.audio,L=!!m.video,I="";x&&(I+="audio"),L&&(I+="video");var k={data1:v,startPTS:S,startDTS:S,endPTS:A,endDTS:A,type:I,hasAudio:x,hasVideo:L,nb:1,dropped:0};return c.audio=k.type==="audio"?k:void 0,c.video=k.type!=="audio"?k:void 0,c.initSegment=g,c.id3=uo(t,s,d,d),i.samples.length&&(c.text=fo(i,s,d)),c},a}();function Mf(a,o,n,r){if(a===null)return!0;var e=Math.max(r,1),t=o-a.baseTime/a.timescale;return Math.abs(t-n)>e}function ho(a,o){var n=a==null?void 0:a.codec;if(n&&n.length>4)return n;if(o===oe.AUDIO){if(n==="ec-3"||n==="ac-3"||n==="alac")return n;if(n==="fLaC"||n==="Opus"){var r=!1;return Ei(n,r)}return X.warn('Unhandled audio codec "'+n+'" in mp4 MAP'),n||"mp4a"}return X.warn('Unhandled video codec "'+n+'" in mp4 MAP'),n||"avc1"}var lr;try{lr=self.performance.now.bind(self.performance)}catch{lr=Date.now}var Ui=[{demux:Tf,remux:wf},{demux:Af,remux:Ni},{demux:mf,remux:Ni},{demux:yf,remux:Ni}];Ui.splice(2,0,{demux:pf,remux:Ni});var Yn=function(){function a(n,r,e,t,i,s){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=n,this.typeSupported=r,this.config=e,this.id=i,this.logger=s}var o=a.prototype;return o.configure=function(r){this.transmuxConfig=r,this.decrypter&&this.decrypter.reset()},o.push=function(r,e,t,i){var s=this,l=t.transmuxing;l.executeStart=lr();var u=new Uint8Array(r),f=this.currentTransmuxState,d=this.transmuxConfig;i&&(this.currentTransmuxState=i);var h=i||f,c=h.contiguous,v=h.discontinuity,g=h.trackSwitch,m=h.accurateTimeOffset,y=h.timeOffset,E=h.initSegmentChange,T=d.audioCodec,S=d.videoCodec,A=d.defaultInitPts,x=d.duration,L=d.initSegmentData,I=Of(u,e);if(I&&Mr(I.method)){var k=this.getDecrypter(),R=An(I.method);if(k.isSync()){var b=k.softwareDecrypt(u,I.key.buffer,I.iv.buffer,R),D=t.part>-1;if(D){var P=k.flush();b=P&&P.buffer}if(!b)return l.executeEnd=lr(),qn(t);u=new Uint8Array(b)}else return this.asyncResult=!0,this.decryptionPromise=k.webCryptoDecrypt(u,I.key.buffer,I.iv.buffer,R).then(function(q){var W=s.push(q,null,t);return s.decryptionPromise=null,W}),this.decryptionPromise}var U=this.needsProbing(v,g);if(U){var F=this.configureTransmuxer(u);if(F)return this.logger.warn("[transmuxer] "+F.message),this.observer.emit(p.ERROR,p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,fatal:!1,error:F,reason:F.message}),l.executeEnd=lr(),qn(t)}(v||g||E||U)&&this.resetInitSegment(L,T,S,x,e),(v||E||U)&&this.resetInitialTimestamp(A),c||this.resetContiguity();var M=this.transmux(u,I,y,m,t);this.asyncResult=Rr(M);var H=this.currentTransmuxState;return H.contiguous=!0,H.discontinuity=!1,H.trackSwitch=!1,l.executeEnd=lr(),M},o.flush=function(r){var e=this,t=r.transmuxing;t.executeStart=lr();var i=this.decrypter,s=this.currentTransmuxState,l=this.decryptionPromise;if(l)return this.asyncResult=!0,l.then(function(){return e.flush(r)});var u=[],f=s.timeOffset;if(i){var d=i.flush();d&&u.push(this.push(d.buffer,null,r))}var h=this.demuxer,c=this.remuxer;if(!h||!c){t.executeEnd=lr();var v=[qn(r)];return this.asyncResult?Promise.resolve(v):v}var g=h.flush(f);return Rr(g)?(this.asyncResult=!0,g.then(function(m){return e.flushRemux(u,m,r),u})):(this.flushRemux(u,g,r),this.asyncResult?Promise.resolve(u):u)},o.flushRemux=function(r,e,t){var i=e.audioTrack,s=e.videoTrack,l=e.id3Track,u=e.textTrack,f=this.currentTransmuxState,d=f.accurateTimeOffset,h=f.timeOffset;this.logger.log("[transmuxer.ts]: Flushed "+this.id+" sn: "+t.sn+(t.part>-1?" part: "+t.part:"")+" of "+(this.id===K.MAIN?"level":"track")+" "+t.level);var c=this.remuxer.remux(i,s,l,u,h,d,!0,this.id);r.push({remuxResult:c,chunkMeta:t}),t.transmuxing.executeEnd=lr()},o.resetInitialTimestamp=function(r){var e=this.demuxer,t=this.remuxer;!e||!t||(e.resetTimeStamp(r),t.resetTimeStamp(r))},o.resetContiguity=function(){var r=this.demuxer,e=this.remuxer;!r||!e||(r.resetContiguity(),e.resetNextTimestamp())},o.resetInitSegment=function(r,e,t,i,s){var l=this.demuxer,u=this.remuxer;!l||!u||(l.resetInitSegment(r,e,t,i),u.resetInitSegment(r,e,t,s))},o.destroy=function(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)},o.transmux=function(r,e,t,i,s){var l;return e&&e.method==="SAMPLE-AES"?l=this.transmuxSampleAes(r,e,t,i,s):l=this.transmuxUnencrypted(r,t,i,s),l},o.transmuxUnencrypted=function(r,e,t,i){var s=this.demuxer.demux(r,e,!1,!this.config.progressive),l=s.audioTrack,u=s.videoTrack,f=s.id3Track,d=s.textTrack,h=this.remuxer.remux(l,u,f,d,e,t,!1,this.id);return{remuxResult:h,chunkMeta:i}},o.transmuxSampleAes=function(r,e,t,i,s){var l=this;return this.demuxer.demuxSampleAes(r,e,t).then(function(u){var f=l.remuxer.remux(u.audioTrack,u.videoTrack,u.id3Track,u.textTrack,t,i,!1,l.id);return{remuxResult:f,chunkMeta:s}})},o.configureTransmuxer=function(r){for(var e=this.config,t=this.observer,i=this.typeSupported,s,l=0,u=Ui.length;l<u;l++){var f;if((f=Ui[l].demux)!=null&&f.probe(r,this.logger)){s=Ui[l];break}}if(!s)return new Error("Failed to find demuxer by probing fragment data");var d=this.demuxer,h=this.remuxer,c=s.remux,v=s.demux;(!h||!(h instanceof c))&&(this.remuxer=new c(t,e,i,this.logger)),(!d||!(d instanceof v))&&(this.demuxer=new v(t,e,i,this.logger),this.probe=v.probe)},o.needsProbing=function(r,e){return!this.demuxer||!this.remuxer||r||e},o.getDecrypter=function(){var r=this.decrypter;return r||(r=this.decrypter=new En(this.config)),r},a}();function Of(a,o){var n=null;return a.byteLength>0&&(o==null?void 0:o.key)!=null&&o.iv!==null&&o.method!=null&&(n=o),n}var qn=function(o){return{remuxResult:{},chunkMeta:o}};function Rr(a){return"then"in a&&a.then instanceof Function}var Ff=function(o,n,r,e,t){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=o,this.videoCodec=n,this.initSegmentData=r,this.duration=e,this.defaultInitPts=t||null},Nf=function(o,n,r,e,t,i){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=o,this.contiguous=n,this.accurateTimeOffset=r,this.trackSwitch=e,this.timeOffset=t,this.initSegmentChange=i},jn=[];typeof Y<"u"&&Y&&Uf();function Uf(){self.addEventListener("message",function(a){var o=a.data,n=o.instanceNo;if(n!==void 0){var r=jn[n];if(o.cmd==="reset"&&(delete jn[o.resetNo],r&&r.destroy(),o.cmd="init"),o.cmd==="init"){var e=JSON.parse(o.config),t=new ce;t.on(p.FRAG_DECRYPTED,Nr),t.on(p.ERROR,Nr);var i=_t(e.debug,o.id);Bf(i,n),jn[n]=new Yn(t,o.typeSupported,e,"",o.id,i),Nr("init",null,n);return}if(r)switch(o.cmd){case"configure":{r.configure(o.config);break}case"demux":{var s=r.push(o.data,o.decryptdata,o.chunkMeta,o.state);Rr(s)?s.then(function(f){Xn(self,f,n)}).catch(function(f){Nr(p.ERROR,{instanceNo:n,type:V.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,chunkMeta:o.chunkMeta,fatal:!1,error:f,err:f,reason:"transmuxer-worker push error"},n)}):Xn(self,s,n);break}case"flush":{var l=o.chunkMeta,u=r.flush(l);Rr(u)?u.then(function(f){vo(self,f,l,n)}).catch(function(f){Nr(p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,chunkMeta:o.chunkMeta,fatal:!1,error:f,err:f,reason:"transmuxer-worker flush error"},n)}):vo(self,u,l,n);break}}}})}function Xn(a,o,n){if(Gf(o.remuxResult))return!1;var r=[],e=o.remuxResult,t=e.audio,i=e.video;return t&&co(r,t),i&&co(r,i),a.postMessage({event:"transmuxComplete",data:o,instanceNo:n},r),!0}function co(a,o){o.data1&&a.push(o.data1.buffer),o.data2&&a.push(o.data2.buffer)}function vo(a,o,n,r){var e=o.reduce(function(t,i){return Xn(a,i,r)||t},!1);e||a.postMessage({event:"transmuxComplete",data:o[0],instanceNo:r}),a.postMessage({event:"flush",data:n,instanceNo:r})}function Nr(a,o,n){self.postMessage({event:a,data:o,instanceNo:n})}function Bf(a,o){var n=function(t){var i=function(l){Nr("workerLog",{logType:t,message:l},o)};a[t]=i};for(var r in a)n(r)}function Gf(a){return!a.audio&&!a.video&&!a.text&&!a.id3&&!a.initSegment}var ni="1.6.2",Ur={};function Kf(){return typeof G=="function"}function Hf(){var a=Ur[ni];if(a)return a.clientCount++,a;var o=new self.Blob(["var exports={};var module={exports:exports};function define(f){f()};define.amd=true;("+G.toString()+")(true);"],{type:"text/javascript"}),n=self.URL.createObjectURL(o),r=new self.Worker(n),e={worker:r,objectURL:n,clientCount:1};return Ur[ni]=e,e}function Vf(a){var o=Ur[a];if(o)return o.clientCount++,o;var n=new self.URL(a,self.location.href).href,r=new self.Worker(n),e={worker:r,scriptURL:n,clientCount:1};return Ur[a]=e,e}function Wf(a){var o=Ur[a||ni];if(o){var n=o.clientCount--;if(n===1){var r=o.worker,e=o.objectURL;delete Ur[a||ni],e&&self.URL.revokeObjectURL(e),r.terminate()}}}var go=0,mo=function(){function a(n,r,e,t){var i=this;this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=go++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=function(c){var v=c.data,g=i.hls;if(!(!g||!(v!=null&&v.event)||v.instanceNo!==i.instanceNo))switch(v.event){case"init":{var m,y=(m=i.workerContext)==null?void 0:m.objectURL;y&&self.URL.revokeObjectURL(y);break}case"transmuxComplete":{i.handleTransmuxComplete(v.data);break}case"flush":{i.onFlush(v.data);break}case"workerLog":{g.logger[v.data.logType]&&g.logger[v.data.logType](v.data.message);break}default:{v.data=v.data||{},v.data.frag=i.frag,v.data.part=i.part,v.data.id=i.id,g.trigger(v.event,v.data);break}}},this.onWorkerError=function(c){if(i.hls){var v=new Error(c.message+"  ("+c.filename+":"+c.lineno+")");i.hls.config.enableWorker=!1,i.hls.logger.warn('Error in "'+i.id+'" Web Worker, fallback to inline'),i.hls.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:v})}};var s=n.config;this.hls=n,this.id=r,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=e,this.onFlush=t;var l=function(v,g){g=g||{},g.frag=i.frag||void 0,v===p.ERROR&&(g=g,g.parent=i.id,g.part=i.part,i.error=g.error),i.hls.trigger(v,g)};this.observer=new ce,this.observer.on(p.FRAG_DECRYPTED,l),this.observer.on(p.ERROR,l);var u=Wa(s.preferManagedMediaSource);if(this.useWorker&&typeof Worker<"u"){var f=this.hls.logger,d=s.workerPath||Kf();if(d){try{s.workerPath?(f.log("loading Web Worker "+s.workerPath+' for "'+r+'"'),this.workerContext=Vf(s.workerPath)):(f.log('injecting Web Worker for "'+r+'"'),this.workerContext=Hf());var h=this.workerContext.worker;h.addEventListener("message",this.onWorkerMessage),h.addEventListener("error",this.onWorkerError),h.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:u,id:r,config:He(s)})}catch(c){f.warn('Error setting up "'+r+'" Web Worker, fallback to inline',c),this.terminateWorker(),this.error=null,this.transmuxer=new Yn(this.observer,u,s,"",r,n.logger)}return}}this.transmuxer=new Yn(this.observer,u,s,"",r,n.logger)}var o=a.prototype;return o.reset=function(){if(this.frag=null,this.part=null,this.workerContext){var r=this.instanceNo;this.instanceNo=go++;var e=this.hls.config,t=Wa(e.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:r,typeSupported:t,id:this.id,config:He(e)})}},o.terminateWorker=function(){if(this.workerContext){var r=this.workerContext.worker;this.workerContext=null,r.removeEventListener("message",this.onWorkerMessage),r.removeEventListener("error",this.onWorkerError),Wf(this.hls.config.workerPath)}},o.destroy=function(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{var r=this.transmuxer;r&&(r.destroy(),this.transmuxer=null)}var e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null},o.push=function(r,e,t,i,s,l,u,f,d,h){var c,v,g=this;d.transmuxing.start=self.performance.now();var m=this.instanceNo,y=this.transmuxer,E=l?l.start:s.start,T=s.decryptdata,S=this.frag,A=!(S&&s.cc===S.cc),x=!(S&&d.level===S.level),L=S?d.sn-S.sn:-1,I=this.part?d.part-this.part.index:-1,k=L===0&&d.id>1&&d.id===(S==null?void 0:S.stats.chunkCount),R=!x&&(L===1||L===0&&(I===1||k&&I<=0)),b=self.performance.now();(x||L||s.stats.parsing.start===0)&&(s.stats.parsing.start=b),l&&(I||!R)&&(l.stats.parsing.start=b);var D=!(S&&((c=s.initSegment)==null?void 0:c.url)===((v=S.initSegment)==null?void 0:v.url)),P=new Nf(A,R,f,x,E,D);if(!R||A||D){this.hls.logger.log("[transmuxer-interface]: Starting new transmux session for "+s.type+" sn: "+d.sn+(d.part>-1?" part: "+d.part:"")+" "+(this.id===K.MAIN?"level":"track")+": "+d.level+" id: "+d.id+`
        discontinuity: `+A+`
        trackSwitch: `+x+`
        contiguous: `+R+`
        accurateTimeOffset: `+f+`
        timeOffset: `+E+`
        initSegmentChange: `+D);var U=new Ff(t,i,e,u,h);this.configureTransmuxer(U)}if(this.frag=s,this.part=l,this.workerContext)this.workerContext.worker.postMessage({instanceNo:m,cmd:"demux",data:r,decryptdata:T,chunkMeta:d,state:P},r instanceof ArrayBuffer?[r]:[]);else if(y){var F=y.push(r,T,d,P);Rr(F)?F.then(function(M){g.handleTransmuxComplete(M)}).catch(function(M){g.transmuxerError(M,d,"transmuxer-interface push error")}):this.handleTransmuxComplete(F)}},o.flush=function(r){var e=this;r.transmuxing.start=self.performance.now();var t=this.instanceNo,i=this.transmuxer;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:r});else if(i){var s=i.flush(r);Rr(s)?s.then(function(l){e.handleFlushResult(l,r)}).catch(function(l){e.transmuxerError(l,r,"transmuxer-interface flush error")}):this.handleFlushResult(s,r)}},o.transmuxerError=function(r,e,t){this.hls&&(this.error=r,this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_PARSING_ERROR,chunkMeta:e,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:r,err:r,reason:t}))},o.handleFlushResult=function(r,e){var t=this;r.forEach(function(i){t.handleTransmuxComplete(i)}),this.onFlush(e)},o.configureTransmuxer=function(r){var e=this.instanceNo,t=this.transmuxer;this.workerContext?this.workerContext.worker.postMessage({instanceNo:e,cmd:"configure",config:r}):t&&t.configure(r)},o.handleTransmuxComplete=function(r){r.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(r)},a}(),po=100,Yf=function(a){function o(r,e,t){var i;return i=a.call(this,r,e,t,"audio-stream-controller",K.AUDIO)||this,i.mainAnchor=null,i.mainFragLoading=null,i.audioOnly=!1,i.bufferedTrack=null,i.switchingTrack=null,i.trackId=-1,i.waitingData=null,i.mainDetails=null,i.flushing=!1,i.bufferFlushed=!1,i.cachedTrackLoadedData=null,i.registerListeners(),i}J(o,a);var n=o.prototype;return n.onHandlerDestroying=function(){this.unregisterListeners(),a.prototype.onHandlerDestroying.call(this),this.resetItem()},n.resetItem=function(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null},n.registerListeners=function(){a.prototype.registerListeners.call(this);var e=this.hls;e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(p.BUFFER_RESET,this.onBufferReset,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(p.FRAG_LOADING,this.onFragLoading,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this)},n.unregisterListeners=function(){var e=this.hls;e&&(a.prototype.unregisterListeners.call(this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(p.BUFFER_RESET,this.onBufferReset,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(p.FRAG_LOADING,this.onFragLoading,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this))},n.onInitPtsFound=function(e,t){var i=t.frag,s=t.id,l=t.initPTS,u=t.timescale;if(s===K.MAIN){var f=i.cc,d=this.fragCurrent;if(this.initPTS[f]={baseTime:l,timescale:u},this.log("InitPTS for cc: "+f+" found from main: "+l+"/"+u),this.mainAnchor=i,this.state===w.WAITING_INIT_PTS){var h=this.waitingData;(!h&&!this.loadingParts||h&&h.frag.cc!==f)&&(this.nextLoadPosition=this.findSyncFrag(i).start),this.tick()}else!this.hls.hasEnoughToStart&&d&&d.cc!==f?(this.startFragRequested=!1,this.nextLoadPosition=this.findSyncFrag(i).start,d.abortRequests(),this.resetLoadingState()):this.state===w.IDLE&&this.tick()}},n.findSyncFrag=function(e){var t=this.getLevelDetails(),i=e.cc;return au(t,i,e)||t&&is(t.fragments,i)||e},n.startLoad=function(e,t){if(!this.levels){this.startPosition=e,this.state=w.STOPPED;return}var i=this.lastCurrentTime;this.stopLoad(),this.setInterval(po),i>0&&e===-1?(this.log("Override startPosition with lastCurrentTime @"+i.toFixed(3)),e=i,this.state=w.IDLE):this.state=w.WAITING_TRACK,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()},n.doTick=function(){switch(this.state){case w.IDLE:this.doTickIdle();break;case w.WAITING_TRACK:{var e=this.levels,t=this.trackId,i=e==null?void 0:e[t],s=i==null?void 0:i.details;if(s&&!this.waitForLive(i)){if(this.waitForCdnTuneIn(s))break;this.state=w.WAITING_INIT_PTS}break}case w.FRAG_LOADING_WAITING_RETRY:{var l,u=performance.now(),f=this.retryDate;if(!f||u>=f||(l=this.media)!=null&&l.seeking){var d=this.levels,h=this.trackId;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((d==null?void 0:d[h])||null),this.state=w.IDLE}break}case w.WAITING_INIT_PTS:{var c=this.waitingData;if(c){var v=c.frag,g=c.part,m=c.cache,y=c.complete,E=this.mainAnchor;if(this.initPTS[v.cc]!==void 0){this.waitingData=null,this.state=w.FRAG_LOADING;var T=m.flush().buffer,S={frag:v,part:g,payload:T,networkDetails:null};this._handleFragmentLoadProgress(S),y&&a.prototype._handleFragmentLoadComplete.call(this,S)}else E&&E.cc!==c.frag.cc&&(this.log("Waiting fragment cc ("+v.cc+") cancelled because video is at cc "+E.cc),this.nextLoadPosition=this.findSyncFrag(E).start,this.clearWaitingFragment())}else this.state=w.IDLE}}this.onTickEnd()},n.clearWaitingFragment=function(){var e=this.waitingData;e&&(this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.state!==w.STOPPED&&(this.state=w.IDLE))},n.resetLoadingState=function(){this.clearWaitingFragment(),a.prototype.resetLoadingState.call(this)},n.onTickEnd=function(){var e=this.media;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)},n.doTickIdle=function(){var e,t=this.hls,i=this.levels,s=this.media,l=this.trackId,u=t.config;if(!(!this.buffering||!s&&!this.primaryPrefetch&&(this.startFragRequested||!u.startFragPrefetch)||!(i!=null&&i[l]))){var f=i[l],d=f.details;if(!d||this.waitForLive(f)||this.waitForCdnTuneIn(d)){this.state=w.WAITING_TRACK,this.startFragRequested=!1;return}var h=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&h&&(this.bufferFlushed=!1,this.afterBufferFlushed(h,oe.AUDIO,K.AUDIO));var c=this.getFwdBufferInfo(h,K.AUDIO);if(c!==null){if(!this.switchingTrack&&this._streamEnded(c,d)){t.trigger(p.BUFFER_EOS,{type:"audio"}),this.state=w.ENDED;return}var v=c.len,g=t.maxBufferLength,m=d.fragments,y=m[0].start,E=this.getLoadPosition(),T=this.flushing?E:c.end;if(this.switchingTrack&&s){var S=E;d.PTSKnown&&S<y&&(c.end>y||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),s.currentTime=y+.05)}if(!(v>=g&&!this.switchingTrack&&T<m[m.length-1].start)){var A=this.getNextFragment(T,d);if(A&&this.isLoopLoading(A,T)&&(A=this.getNextFragmentLoopLoading(A,d,c,K.MAIN,g)),!A){this.bufferFlushed=!0;return}var x=((e=this.mainFragLoading)==null?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&x&&Ie(A)&&!A.endList&&(!d.live||!this.loadingParts&&T<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(x)===ut.OK&&(this.mainFragLoading=x=null),x&&Ie(x))){if(A.start>x.end){var L=this.fragmentTracker.getFragAtPos(T,K.MAIN);L&&L.end>x.end&&(x=L,this.mainFragLoading={frag:L,targetBufferTime:null})}var I=A.start>x.end;if(I)return}this.loadFragment(A,f,T)}}}},n.onMediaDetaching=function(e,t){this.bufferFlushed=this.flushing=!1,a.prototype.onMediaDetaching.call(this,e,t)},n.onAudioTracksUpdated=function(e,t){var i=t.audioTracks;this.resetTransmuxer(),this.levels=i.map(function(s){return new $r(s)})},n.onAudioTrackSwitching=function(e,t){var i=!!t.url;this.trackId=t.id;var s=this.fragCurrent;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==w.STOPPED&&(this.setInterval(po),this.state=w.IDLE,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())},n.onManifestLoading=function(){a.prototype.onManifestLoading.call(this),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1},n.onLevelLoaded=function(e,t){this.mainDetails=t.details;var i=this.cachedTrackLoadedData;i&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(p.AUDIO_TRACK_LOADED,i))},n.onAudioTrackLoaded=function(e,t){var i,s=this.levels,l=t.details,u=t.id,f=t.groupId,d=t.track;if(!s){this.warn("Audio tracks reset while loading track "+u+' "'+d.name+'" of "'+f+'"');return}var h=this.mainDetails;if(!h||l.endCC>h.endCC||h.expired){this.cachedTrackLoadedData=t,this.state!==w.STOPPED&&(this.state=w.WAITING_TRACK);return}this.cachedTrackLoadedData=null,this.log("Audio track "+u+' "'+d.name+'" of "'+f+'" loaded ['+l.startSN+","+l.endSN+"]"+(l.lastPartSn?"[part-"+l.lastPartSn+"-"+l.lastPartIndex+"]":"")+",duration:"+l.totalduration);var c=s[u],v=0;if(l.live||(i=c.details)!=null&&i.live){if(this.checkLiveUpdate(l),l.deltaUpdateFailed)return;if(c.details){var g;v=this.alignPlaylists(l,c.details,(g=this.levelLastLoaded)==null?void 0:g.details)}l.alignedSliding||(Bs(l,h),l.alignedSliding||Pi(l,h),v=l.fragmentStart)}c.details=l,this.levelLastLoaded=c,this.startFragRequested||this.setStartPosition(h,v),this.hls.trigger(p.AUDIO_TRACK_UPDATED,{details:l,id:u,groupId:t.groupId}),this.state===w.WAITING_TRACK&&!this.waitForCdnTuneIn(l)&&(this.state=w.IDLE),this.tick()},n._handleFragmentLoadProgress=function(e){var t,i=e.frag,s=e.part,l=e.payload,u=this.config,f=this.trackId,d=this.levels;if(!d){this.warn("Audio tracks were reset while fragment load was in progress. Fragment "+i.sn+" of level "+i.level+" will not be buffered");return}var h=d[f];if(!h){this.warn("Audio track is undefined on fragment load progress");return}var c=h.details;if(!c){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}var v=u.defaultAudioCodec||h.audioCodec||"mp4a.40.2",g=this.transmuxer;g||(g=this.transmuxer=new mo(this.hls,K.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));var m=this.initPTS[i.cc],y=(t=i.initSegment)==null?void 0:t.data;if(m!==void 0){var E=!1,T=s?s.index:-1,S=T!==-1,A=new Tn(i.level,i.sn,i.stats.chunkCount,l.byteLength,T,S);g.push(l,y,v,"",i,s,c.totalduration,E,A,m)}else{this.log("Unknown video PTS for cc "+i.cc+", waiting for video PTS before demuxing audio frag "+i.sn+" of ["+c.startSN+" ,"+c.endSN+"],track "+f);var x=this.waitingData=this.waitingData||{frag:i,part:s,cache:new Ks,complete:!1},L=x.cache;L.push(new Uint8Array(l)),this.state!==w.STOPPED&&(this.state=w.WAITING_INIT_PTS)}},n._handleFragmentLoadComplete=function(e){if(this.waitingData){this.waitingData.complete=!0;return}a.prototype._handleFragmentLoadComplete.call(this,e)},n.onBufferReset=function(){this.mediaBuffer=null},n.onBufferCreated=function(e,t){this.bufferFlushed=this.flushing=!1;var i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null)},n.onFragLoading=function(e,t){!this.audioOnly&&t.frag.type===K.MAIN&&Ie(t.frag)&&(this.mainFragLoading=t,this.state===w.IDLE&&this.tick())},n.onFragBuffered=function(e,t){var i=t.frag,s=t.part;if(i.type!==K.AUDIO){!this.audioOnly&&i.type===K.MAIN&&!i.elementaryStreams.video&&!i.elementaryStreams.audiovideo&&(this.audioOnly=!0,this.mainFragLoading=null);return}if(this.fragContextChanged(i)){this.warn("Fragment "+i.sn+(s?" p: "+s.index:"")+" of level "+i.level+" finished buffering, but was aborted. state: "+this.state+", audioSwitch: "+(this.switchingTrack?this.switchingTrack.name:"false"));return}if(Ie(i)){this.fragPrevious=i;var l=this.switchingTrack;l&&(this.bufferedTrack=l,this.switchingTrack=null,this.hls.trigger(p.AUDIO_TRACK_SWITCHED,Q({},l)))}this.fragBufferedComplete(i,s),this.media&&this.tick()},n.onError=function(e,t){var i;if(t.fatal){this.state=w.ERROR;return}switch(t.details){case _.FRAG_GAP:case _.FRAG_PARSING_ERROR:case _.FRAG_DECRYPT_ERROR:case _.FRAG_LOAD_ERROR:case _.FRAG_LOAD_TIMEOUT:case _.KEY_LOAD_ERROR:case _.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(K.AUDIO,t);break;case _.AUDIO_TRACK_LOAD_ERROR:case _.AUDIO_TRACK_LOAD_TIMEOUT:case _.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===w.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===j.AUDIO_TRACK&&(this.state=w.IDLE);break;case _.BUFFER_ADD_CODEC_ERROR:case _.BUFFER_APPEND_ERROR:if(t.parent!=="audio")return;this.resetLoadingState();break;case _.BUFFER_FULL_ERROR:if(t.parent!=="audio")return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,a.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio"));break;case _.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}},n.onBufferFlushing=function(e,t){var i=t.type;i!==oe.VIDEO&&(this.flushing=!0)},n.onBufferFlushed=function(e,t){var i=t.type;if(i!==oe.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===w.ENDED&&(this.state=w.IDLE);var s=this.mediaBuffer||this.media;s&&(this.afterBufferFlushed(s,i,K.AUDIO),this.tick())}},n._handleTransmuxComplete=function(e){var t,i="audio",s=this.hls,l=e.remuxResult,u=e.chunkMeta,f=this.getCurrentContext(u);if(!f){this.resetWhenMissingContext(u);return}var d=f.frag,h=f.part,c=f.level,v=c.details,g=l.audio,m=l.text,y=l.id3,E=l.initSegment;if(this.fragContextChanged(d)||!v){this.fragmentTracker.removeFragment(d);return}if(this.state=w.PARSING,this.switchingTrack&&g&&this.completeAudioSwitch(this.switchingTrack),E!=null&&E.tracks){var T=d.initSegment||d;this._bufferInitSegment(c,E.tracks,T,u),s.trigger(p.FRAG_PARSING_INIT_SEGMENT,{frag:T,id:i,tracks:E.tracks})}if(g){var S=g.startPTS,A=g.endPTS,x=g.startDTS,L=g.endDTS;h&&(h.elementaryStreams[oe.AUDIO]={startPTS:S,endPTS:A,startDTS:x,endDTS:L}),d.setElementaryStreamInfo(oe.AUDIO,S,A,x,L),this.bufferFragmentData(g,d,h,u)}if(y!=null&&(t=y.samples)!=null&&t.length){var I=ae({id:i,frag:d,details:v},y);s.trigger(p.FRAG_PARSING_METADATA,I)}if(m){var k=ae({id:i,frag:d,details:v},m);s.trigger(p.FRAG_PARSING_USERDATA,k)}},n._bufferInitSegment=function(e,t,i,s){if(this.state===w.PARSING&&(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!!t.audio)){var l=t.audio;l.id=K.AUDIO;var u=e.audioCodec;this.log("Init audio buffer, container:"+l.container+", codecs[level/parsed]=["+u+"/"+l.codec+"]"),u&&u.split(",").length===1&&(l.levelCodec=u),this.hls.trigger(p.BUFFER_CODECS,t);var f=l.initSegment;if(f!=null&&f.byteLength){var d={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:f};this.hls.trigger(p.BUFFER_APPENDING,d)}this.tickImmediate()}},n.loadFragment=function(e,t,i){var s=this.fragmentTracker.getState(e);if(this.switchingTrack||s===ut.NOT_LOADED||s===ut.PARTIAL){var l;if(!Ie(e))this._loadInitSegment(e,t);else if((l=t.details)!=null&&l.live&&!this.initPTS[e.cc]){this.log("Waiting for video PTS in continuity counter "+e.cc+" of live stream before loading audio fragment "+e.sn+" of level "+this.trackId),this.state=w.WAITING_INIT_PTS;var u=this.mainDetails;u&&u.fragmentStart!==t.details.fragmentStart&&Pi(t.details,u)}else a.prototype.loadFragment.call(this,e,t,i)}else this.clearTrackerIfNeeded(e)},n.flushAudioIfNeeded=function(e){if(this.media&&this.bufferedTrack){var t=this.bufferedTrack,i=t.name,s=t.lang,l=t.assocLang,u=t.characteristics,f=t.audioCodec,d=t.channels;xr({name:i,lang:s,assocLang:l,characteristics:u,audioCodec:f,channels:d},e,Lr)||(xi(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),a.prototype.flushMainBuffer.call(this,0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}},n.completeAudioSwitch=function(e){var t=this.hls;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(p.AUDIO_TRACK_SWITCHED,Q({},e))},o}(wn),zn=function(a){function o(r,e){var t;return t=a.call(this,e,r.logger)||this,t.hls=void 0,t.canLoad=!1,t.timer=-1,t.hls=r,t}J(o,a);var n=o.prototype;return n.destroy=function(){this.clearTimer(),this.hls=this.log=this.warn=null},n.clearTimer=function(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)},n.startLoad=function(){this.canLoad=!0,this.loadPlaylist()},n.stopLoad=function(){this.canLoad=!1,this.clearTimer()},n.switchParams=function(e,t,i){var s=t==null?void 0:t.renditionReports;if(s){for(var l=-1,u=0;u<s.length;u++){var f=s[u],d=void 0;try{d=new self.URL(f.URI,t.url).href}catch(y){this.warn("Could not construct new URL for Rendition Report: "+y),d=f.URI||""}if(d===e){l=u;break}else d===e.substring(0,d.length)&&(l=u)}if(l!==-1){var h=s[l],c=parseInt(h["LAST-MSN"])||(t==null?void 0:t.lastPartSn),v=parseInt(h["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){var g=Math.min(t.age-t.partTarget,t.targetduration);v>=0&&g>t.partTarget&&(v+=1)}var m=i&&Qa(i);return new $a(c,v>=0?v:void 0,m)}}},n.loadPlaylist=function(e){this.clearTimer()},n.loadingPlaylist=function(e,t){this.clearTimer()},n.shouldLoadPlaylist=function(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)},n.getUrlWithDirectives=function(e,t){if(t)try{return t.addDirectives(e)}catch(i){this.warn("Could not construct new URL with HLS Delivery Directives: "+i)}return e},n.playlistLoaded=function(e,t,i){var s=t.details,l=t.stats,u=self.performance.now(),f=l.loading.first?Math.max(0,u-l.loading.first):0;s.advancedDateTime=Date.now()-f;var d=this.hls.config.timelineOffset;if(d!==s.appliedTimelineOffset){var h=Math.max(d||0,0);s.appliedTimelineOffset=h,s.fragments.forEach(function(ee){ee.start=ee.playlistOffset+h})}if(s.live||i!=null&&i.live){var c="levelInfo"in t?t.levelInfo:t.track;if(s.reloaded(i),i&&s.fragments.length>0){Ou(i,s);var v=s.playlistParsingError;if(v){this.warn(v);var g=this.hls;if(!g.config.ignorePlaylistParsingErrors){var m,y=t.networkDetails;g.trigger(p.ERROR,{type:V.NETWORK_ERROR,details:_.LEVEL_PARSING_ERROR,fatal:!1,url:s.url,error:v,reason:v.message,level:t.level||void 0,parent:(m=s.fragments[0])==null?void 0:m.type,networkDetails:y,stats:l});return}s.playlistParsingError=null}}s.requestScheduled===-1&&(s.requestScheduled=l.loading.start);var E=this.hls.mainForwardBufferInfo,T=E?E.end-E.len:0,S=(s.edge-T)*1e3,A=Ps(s,S);if(s.requestScheduled+A<u?s.requestScheduled=u:s.requestScheduled+=A,this.log("live playlist "+e+" "+(s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED")),!this.canLoad||!s.live)return;var x,L=void 0,I=void 0;if(s.canBlockReload&&s.endSN&&s.advanced){var k=this.hls.config.lowLatencyMode,R=s.lastPartSn,b=s.endSN,D=s.lastPartIndex,P=D!==-1,U=R===b;P?U?(L=b+1,I=k?0:D):(L=R,I=k?D+1:s.maxPartIndex):L=b+1;var F=s.age,M=F+s.ageHeader,H=Math.min(M-s.partTarget,s.targetduration*1.5);if(H>0){if(M>s.targetduration*3)this.log("Playlist last advanced "+F.toFixed(2)+"s ago. Omitting segment and part directives."),L=void 0,I=void 0;else if(i!=null&&i.tuneInGoal&&M-s.partTarget>i.tuneInGoal)this.warn("CDN Tune-in goal increased from: "+i.tuneInGoal+" to: "+H+" with playlist age: "+s.age),H=0;else{var q=Math.floor(H/s.targetduration);if(L+=q,I!==void 0){var W=Math.round(H%s.targetduration/s.partTarget);I+=W}this.log("CDN Tune-in age: "+s.ageHeader+"s last advanced "+F.toFixed(2)+"s goal: "+H+" skip sn "+q+" to part "+I)}s.tuneInGoal=H}if(x=this.getDeliveryDirectives(s,t.deliveryDirectives,L,I),k||!U){s.requestScheduled=u,this.loadingPlaylist(c,x);return}}else(s.canBlockReload||s.canSkipUntil)&&(x=this.getDeliveryDirectives(s,t.deliveryDirectives,L,I));x&&L!==void 0&&s.canBlockReload&&(s.requestScheduled=l.loading.first+Math.max(A-f*2,A/2)),this.scheduleLoading(c,x,s)}else this.clearTimer()},n.scheduleLoading=function(e,t,i){var s=this,l=i||e.details;if(!l){this.loadingPlaylist(e,t);return}var u=self.performance.now(),f=l.requestScheduled;if(u>=f){this.loadingPlaylist(e,t);return}var d=f-u;this.log("reload live playlist "+(e.name||e.bitrate+"bps")+" in "+Math.round(d)+" ms"),this.clearTimer(),this.timer=self.setTimeout(function(){return s.loadingPlaylist(e,t)},d)},n.getDeliveryDirectives=function(e,t,i,s){var l=Qa(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,l=Ai.No),new $a(i,s,l)},n.checkRetry=function(e){var t=this,i=e.details,s=Li(e),l=e.errorAction,u=l||{},f=u.action,d=u.retryCount,h=d===void 0?0:d,c=u.retryConfig,v=!!l&&!!c&&(f===bt.RetryRequest||!l.resolved&&f===bt.SendAlternateToPenaltyBox);if(v){var g;if(h>=c.maxNumRetry)return!1;if(s&&(g=e.context)!=null&&g.deliveryDirectives)this.warn("Retrying playlist loading "+(h+1)+"/"+c.maxNumRetry+' after "'+i+'" without delivery-directives'),this.loadPlaylist();else{var m=yn(c,h);this.clearTimer(),this.timer=self.setTimeout(function(){return t.loadPlaylist()},m),this.warn("Retrying playlist loading "+(h+1)+"/"+c.maxNumRetry+' after "'+i+'" in '+m+"ms")}e.levelRetry=!0,l.resolved=!0}return v},o}(ie);function yo(a,o){if(a.length!==o.length)return!1;for(var n=0;n<a.length;n++)if(!ai(a[n].attrs,o[n].attrs))return!1;return!0}function ai(a,o,n){var r=a["STABLE-RENDITION-ID"];return r&&!n?r===o["STABLE-RENDITION-ID"]:!(n||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(function(e){return a[e]!==o[e]})}function Qn(a,o){return o.label.toLowerCase()===a.name.toLowerCase()&&(!o.language||o.language.toLowerCase()===(a.lang||"").toLowerCase())}var qf=function(a){function o(r){var e;return e=a.call(this,r,"audio-track-controller")||this,e.tracks=[],e.groupIds=null,e.tracksInGroup=[],e.trackId=-1,e.currentTrack=null,e.selectDefaultTrack=!0,e.registerListeners(),e}J(o,a);var n=o.prototype;return n.registerListeners=function(){var e=this.hls;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(p.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(p.ERROR,this.onError,this)},n.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,a.prototype.destroy.call(this)},n.onManifestLoading=function(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0},n.onManifestParsed=function(e,t){this.tracks=t.audioTracks||[]},n.onAudioTrackLoaded=function(e,t){var i=t.id,s=t.groupId,l=t.details,u=this.tracksInGroup[i];if(!u||u.groupId!==s){this.warn("Audio track with id:"+i+" and group:"+s+" not found in active group "+(u==null?void 0:u.groupId));return}var f=u.details;u.details=t.details,this.log("Audio track "+i+' "'+u.name+'" lang:'+u.lang+" group:"+s+" loaded ["+l.startSN+"-"+l.endSN+"]"),i===this.trackId&&this.playlistLoaded(i,t,f)},n.onLevelLoading=function(e,t){this.switchLevel(t.level)},n.onLevelSwitching=function(e,t){this.switchLevel(t.level)},n.switchLevel=function(e){var t=this.hls.levels[e];if(t){var i=t.audioGroups||null,s=this.groupIds,l=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(function(E){return(s==null?void 0:s.indexOf(E))===-1})){this.groupIds=i,this.trackId=-1,this.currentTrack=null;var u=this.tracks.filter(function(E){return!i||i.indexOf(E.groupId)!==-1});if(u.length)this.selectDefaultTrack&&!u.some(function(E){return E.default})&&(this.selectDefaultTrack=!1),u.forEach(function(E,T){E.id=T});else if(!l&&!this.tracksInGroup.length)return;this.tracksInGroup=u;var f=this.hls.config.audioPreference;if(!l&&f){var d=Jt(f,u,Lr);if(d>-1)l=u[d];else{var h=Jt(f,this.tracks);l=this.tracks[h]}}var c=this.findTrackId(l);c===-1&&l&&(c=this.findTrackId(null));var v={audioTracks:u};this.log("Updating audio tracks, "+u.length+" track(s) found in group(s): "+(i==null?void 0:i.join(","))),this.hls.trigger(p.AUDIO_TRACKS_UPDATED,v);var g=this.trackId;if(c!==-1&&g===-1)this.setAudioTrack(c);else if(u.length&&g===-1){var m,y=new Error("No audio track selected for current audio group-ID(s): "+((m=this.groupIds)==null?void 0:m.join(","))+" track count: "+u.length);this.warn(y.message),this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:y})}}}},n.onError=function(e,t){t.fatal||!t.context||t.context.type===j.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)},n.setAudioOption=function(e){var t=this.hls;if(t.config.audioPreference=e,e){var i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){var s=this.currentTrack;if(s&&xr(e,s,Lr))return s;var l=Jt(e,this.tracksInGroup,Lr);if(l>-1){var u=this.tracksInGroup[l];return this.setAudioTrack(l),u}else if(s){var f=t.loadLevel;f===-1&&(f=t.firstAutoLevel);var d=eu(e,t.levels,i,f,Lr);if(d===-1)return null;t.nextLoadLevel=d}if(e.channels||e.audioCodec){var h=Jt(e,i);if(h>-1)return i[h]}}}return null},n.setAudioTrack=function(e){var t=this.tracksInGroup;if(e<0||e>=t.length){this.warn("Invalid audio track id: "+e);return}this.selectDefaultTrack=!1;var i=this.currentTrack,s=t[e],l=s.details&&!s.details.live;if(!(e===this.trackId&&s===i&&l)&&(this.log("Switching to audio-track "+e+' "'+s.name+'" lang:'+s.lang+" group:"+s.groupId+" channels:"+s.channels),this.trackId=e,this.currentTrack=s,this.hls.trigger(p.AUDIO_TRACK_SWITCHING,Q({},s)),!l)){var u=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(u)}},n.findTrackId=function(e){for(var t=this.tracksInGroup,i=0;i<t.length;i++){var s=t[i];if(!(this.selectDefaultTrack&&!s.default)&&(!e||xr(e,s,Lr)))return i}if(e){for(var l=e.name,u=e.lang,f=e.assocLang,d=e.characteristics,h=e.audioCodec,c=e.channels,v=0;v<t.length;v++){var g=t[v];if(xr({name:l,lang:u,assocLang:f,characteristics:d,audioCodec:h,channels:c},g,Lr))return v}for(var m=0;m<t.length;m++){var y=t[m];if(ai(e.attrs,y.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return m}for(var E=0;E<t.length;E++){var T=t[E];if(ai(e.attrs,T.attrs,["LANGUAGE"]))return E}}return-1},n.loadPlaylist=function(e){a.prototype.loadPlaylist.call(this);var t=this.currentTrack;this.shouldLoadPlaylist(t)&&xi(t.url,this.hls)&&this.scheduleLoading(t,e)},n.loadingPlaylist=function(e,t){a.prototype.loadingPlaylist.call(this,e,t);var i=e.id,s=e.groupId,l=this.getUrlWithDirectives(e.url,t),u=e.details,f=u==null?void 0:u.age;this.log("Loading audio-track "+i+' "'+e.name+'" lang:'+e.lang+" group:"+s+((t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:"")+(f&&u.live?" age "+f.toFixed(1)+(u.type&&" "+u.type||""):"")+" "+l),this.hls.trigger(p.AUDIO_TRACK_LOADING,{url:l,id:i,groupId:s,deliveryDirectives:t||null,track:e})},z(o,[{key:"allAudioTracks",get:function(){return this.tracks}},{key:"audioTracks",get:function(){return this.tracksInGroup}},{key:"audioTrack",get:function(){return this.trackId},set:function(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}}])}(zn),jf=function(){function a(n){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=n}var o=a.prototype;return o.destroy=function(){this.tracks=this.queues=null},o.append=function(r,e,t){if(!(this.queues===null||this.tracks===null)){var i=this.queues[e];i.push(r),i.length===1&&!t&&this.executeNext(e)}},o.appendBlocker=function(r){var e=this;return new Promise(function(t){var i={label:"async-blocker",execute:t,onStart:function(){},onComplete:function(){},onError:function(){}};e.append(i,r)})},o.prependBlocker=function(r){var e=this;return new Promise(function(t){if(e.queues){var i={label:"async-blocker-prepend",execute:t,onStart:function(){},onComplete:function(){},onError:function(){}};e.queues[r].unshift(i)}})},o.removeBlockers=function(){this.queues!==null&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(function(r){var e,t=(e=r[0])==null?void 0:e.label;(t==="async-blocker"||t==="async-blocker-prepend")&&(r[0].execute(),r.splice(0,1))})},o.unblockAudio=function(r){if(this.queues!==null){var e=this.queues.audio;e[0]===r&&this.shiftAndExecuteNext("audio")}},o.executeNext=function(r){if(!(this.queues===null||this.tracks===null)){var e=this.queues[r];if(e.length){var t=e[0];try{t.execute()}catch(l){var i;if(t.onError(l),this.queues===null||this.tracks===null)return;var s=(i=this.tracks[r])==null?void 0:i.buffer;s!=null&&s.updating||this.shiftAndExecuteNext(r)}}}},o.shiftAndExecuteNext=function(r){this.queues!==null&&(this.queues[r].shift(),this.executeNext(r))},o.current=function(r){var e;return((e=this.queues)==null?void 0:e[r][0])||null},o.toString=function(){var r=this.queues,e=this.tracks;return r===null||e===null?"<destroyed>":`
`+this.list("video")+`
`+this.list("audio")+`
`+this.list("audiovideo")+"}"},o.list=function(r){var e,t;return(e=this.queues)!=null&&e[r]||(t=this.tracks)!=null&&t[r]?r+": ("+this.listSbInfo(r)+") "+this.listOps(r):""},o.listSbInfo=function(r){var e,t=(e=this.tracks)==null?void 0:e[r],i=t==null?void 0:t.buffer;return i?"SourceBuffer"+(i.updating?" updating":"")+(t.ended?" ended":"")+(t.ending?" ending":""):"none"},o.listOps=function(r){var e;return((e=this.queues)==null?void 0:e[r].map(function(t){return t.label}).join(", "))||""},a}(),Eo=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,To="HlsJsTrackRemovedError",Xf=function(a){function o(n){var r;return r=a.call(this,n)||this,r.name=To,r}return J(o,a),o}(dt(Error)),zf=function(a){function o(r,e){var t;return t=a.call(this,"buffer-controller",r.logger)||this,t.hls=void 0,t.fragmentTracker=void 0,t.details=null,t._objectUrl=null,t.operationQueue=null,t.bufferCodecEventsTotal=0,t.media=null,t.mediaSource=null,t.lastMpegAudioChunk=null,t.blockedAudioAppend=null,t.lastVideoAppendEnd=0,t.appendSource=void 0,t.transferData=void 0,t.overrides=void 0,t.appendErrors={audio:0,video:0,audiovideo:0},t.tracks={},t.sourceBuffers=[[null,null],[null,null]],t._onEndStreaming=function(i){var s;t.hls&&((s=t.mediaSource)==null?void 0:s.readyState)==="open"&&t.hls.pauseBuffering()},t._onStartStreaming=function(i){t.hls&&t.hls.resumeBuffering()},t._onMediaSourceOpen=function(i){var s=t,l=s.media,u=s.mediaSource;i&&t.log("Media source opened"),!(!l||!u)&&(u.removeEventListener("sourceopen",t._onMediaSourceOpen),l.removeEventListener("emptied",t._onMediaEmptied),t.updateDuration(),t.hls.trigger(p.MEDIA_ATTACHED,{media:l,mediaSource:u}),t.mediaSource!==null&&t.checkPendingTracks())},t._onMediaSourceClose=function(){t.log("Media source closed")},t._onMediaSourceEnded=function(){t.log("Media source ended")},t._onMediaEmptied=function(){var i=t,s=i.mediaSrc,l=i._objectUrl;s!==l&&t.error("Media element src was set while attaching MediaSource ("+l+" > "+s+")")},t.hls=r,t.fragmentTracker=e,t.appendSource=pe(re(r.config.preferManagedMediaSource)),t.initTracks(),t.registerListeners(),t}J(o,a);var n=o.prototype;return n.hasSourceTypes=function(){return Object.keys(this.tracks).length>0},n.destroy=function(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null},n.registerListeners=function(){var e=this.hls;e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.BUFFER_RESET,this.onBufferReset,this),e.on(p.BUFFER_APPENDING,this.onBufferAppending,this),e.on(p.BUFFER_CODECS,this.onBufferCodecs,this),e.on(p.BUFFER_EOS,this.onBufferEos,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(p.FRAG_PARSED,this.onFragParsed,this),e.on(p.FRAG_CHANGED,this.onFragChanged,this),e.on(p.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.BUFFER_RESET,this.onBufferReset,this),e.off(p.BUFFER_APPENDING,this.onBufferAppending,this),e.off(p.BUFFER_CODECS,this.onBufferCodecs,this),e.off(p.BUFFER_EOS,this.onBufferEos,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(p.FRAG_PARSED,this.onFragParsed,this),e.off(p.FRAG_CHANGED,this.onFragChanged,this),e.off(p.ERROR,this.onError,this)},n.transferMedia=function(){var e=this,t=this.media,i=this.mediaSource;if(!t)return null;var s={};if(this.operationQueue){var l=this.isUpdating();l||this.operationQueue.removeBlockers();var u=this.isQueued();(l||u)&&this.warn("Transfering MediaSource with"+(u?" operations in queue":"")+(l?" updating SourceBuffer(s)":"")+" "+this.operationQueue),this.operationQueue.destroy()}var f=this.transferData;return!this.sourceBufferCount&&f&&f.mediaSource===i?ae(s,f.tracks):this.sourceBuffers.forEach(function(d){var h=d[0];h&&(s[h]=ae({},e.tracks[h]),e.removeBuffer(h)),d[0]=d[1]=null}),{media:t,mediaSource:i,tracks:s}},n.initTracks=function(){var e={};this.sourceBuffers=[[null,null],[null,null]],this.tracks=e,this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0},n.onManifestLoading=function(){this.bufferCodecEventsTotal=0,this.details=null},n.onManifestParsed=function(e,t){var i,s=2;(t.audio&&!t.video||!t.altAudio)&&(s=1),this.bufferCodecEventsTotal=s,this.log(s+" bufferCodec event(s) expected."),(i=this.transferData)!=null&&i.mediaSource&&this.sourceBufferCount&&s&&this.bufferCreated()},n.onMediaAttaching=function(e,t){var i=this.media=t.media,s=re(this.appendSource);if(this.transferData=this.overrides=void 0,i&&s){var l=!!t.mediaSource;(l||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);var u=this.mediaSource=t.mediaSource||new s;if(this.assignMediaSource(u),l)this._objectUrl=i.src,this.attachTransferred();else{var f=this._objectUrl=self.URL.createObjectURL(u);if(this.appendSource)try{i.removeAttribute("src");var d=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||d&&u instanceof d,So(i),Qf(i,f),i.load()}catch{i.src=f}else i.src=f}i.addEventListener("emptied",this._onMediaEmptied)}},n.assignMediaSource=function(e){var t,i;this.log((((t=this.transferData)==null?void 0:t.mediaSource)===e?"transferred":"created")+" media source: "+((i=e.constructor)==null?void 0:i.name)),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))},n.attachTransferred=function(){var e=this,t=this.media,i=this.transferData;if(!(!i||!t)){var s=this.tracks,l=i.tracks,u=l?Object.keys(l):null,f=u?u.length:0,d=function(){e.media&&e.mediaSourceOpenOrEnded&&e._onMediaSourceOpen()};if(l&&u&&f){if(!this.tracksReady){this.hls.config.startFragPrefetch=!0,this.log("attachTransferred: waiting for SourceBuffer track info");return}if(this.log("attachTransferred: (bufferCodecEventsTotal "+this.bufferCodecEventsTotal+`)
required tracks: `+He(s,function(g,m){return g==="initSegment"?void 0:m})+`;
transfer tracks: `+He(l,function(g,m){return g==="initSegment"?void 0:m})+"}"),!Rt(l,s)){i.mediaSource=null,i.tracks=void 0;var h=t.currentTime,c=this.details,v=Math.max(h,(c==null?void 0:c.fragments[0].start)||0);if(v-h>1){this.log("attachTransferred: waiting for playback to reach new tracks start time "+h+" -> "+v);return}this.warn('attachTransferred: resetting MediaSource for incompatible tracks ("'+Object.keys(l)+'"->"'+Object.keys(s)+'") start time: '+v+" currentTime: "+h),this.onMediaDetaching(p.MEDIA_DETACHING,{}),this.onMediaAttaching(p.MEDIA_ATTACHING,i),t.currentTime=v;return}this.transferData=void 0,u.forEach(function(g){var m=g,y=l[m];if(y){var E=y.buffer;if(E){var T=e.fragmentTracker,S=y.id;if(T.hasFragments(S)||T.hasParts(S)){var A=Se.getBuffered(E);T.detectEvictedFragments(m,A,S,null,!0)}var x=$n(m),L=[m,E];e.sourceBuffers[x]=L,E.updating&&e.operationQueue&&e.operationQueue.prependBlocker(m),e.trackSourceBuffer(m,y)}}}),d(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),d()}},n.onMediaDetaching=function(e,t){var i=this,s=!!t.transferMedia;this.transferData=this.overrides=void 0;var l=this.media,u=this.mediaSource,f=this._objectUrl;if(u){if(this.log("media source "+(s?"transferring":"detaching")),s)this.sourceBuffers.forEach(function(v){var g=v[0];g&&i.removeBuffer(g)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){var d=u.readyState==="open";try{for(var h=u.sourceBuffers,c=h.length;c--;)d&&h[c].abort(),u.removeSourceBuffer(h[c]);d&&u.endOfStream()}catch(v){this.warn("onMediaDetaching: "+v.message+" while calling endOfStream")}}this.sourceBufferCount&&this.onBufferReset()}u.removeEventListener("sourceopen",this._onMediaSourceOpen),u.removeEventListener("sourceended",this._onMediaSourceEnded),u.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(u.removeEventListener("startstreaming",this._onStartStreaming),u.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}l&&(l.removeEventListener("emptied",this._onMediaEmptied),s||(f&&self.URL.revokeObjectURL(f),this.mediaSrc===f?(l.removeAttribute("src"),this.appendSource&&So(l),l.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(p.MEDIA_DETACHED,t)},n.onBufferReset=function(){var e=this;this.sourceBuffers.forEach(function(t){var i=t[0];i&&e.resetBuffer(i)}),this.initTracks()},n.resetBuffer=function(e){var t,i=(t=this.tracks[e])==null?void 0:t.buffer;if(this.removeBuffer(e),i)try{var s;(s=this.mediaSource)!=null&&s.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(i)}catch(l){this.warn("onBufferReset "+e,l)}delete this.tracks[e]},n.removeBuffer=function(e){this.removeBufferListeners(e),this.sourceBuffers[$n(e)]=[null,null];var t=this.tracks[e];t&&(t.buffer=void 0)},n.resetQueue=function(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new jf(this.tracks)},n.onBufferCodecs=function(e,t){var i=this,s=this.tracks,l=Object.keys(t);this.log('BUFFER_CODECS: "'+l+'" (current SB count '+this.sourceBufferCount+")");var u="audiovideo"in t&&(s.audio||s.video)||s.audiovideo&&("audio"in t||"video"in t),f=!u&&this.sourceBufferCount&&this.media&&l.some(function(d){return!s[d]});if(u||f){this.warn('Unsupported transition between "'+Object.keys(s)+'" and "'+l+'" SourceBuffers');return}l.forEach(function(d){var h,c,v,g=t[d],m=g.id,y=g.codec,E=g.levelCodec,T=g.container,S=g.metadata,A=g.supplemental,x=s[d],L=(h=i.transferData)==null||(c=h.tracks)==null?void 0:c[d],I=L!=null&&L.buffer?L:x,k=(I==null?void 0:I.pendingCodec)||(I==null?void 0:I.codec),R=I==null?void 0:I.levelCodec;x||(x=s[d]={buffer:void 0,listeners:[],codec:y,supplemental:A,container:T,levelCodec:E,metadata:S,id:m});var b=Ti(k,R),D=b==null?void 0:b.replace(Eo,"$1"),P=Ti(y,E),U=(v=P)==null?void 0:v.replace(Eo,"$1");P&&b&&D!==U&&(d.slice(0,5)==="audio"&&(P=Ei(P,i.appendSource)),i.log("switching codec "+k+" to "+P),P!==(x.pendingCodec||x.codec)&&(x.pendingCodec=P),x.container=T,i.appendChangeType(d,T,P))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),!this.sourceBufferCount&&this.mediaSourceOpenOrEnded&&this.checkPendingTracks()},n.appendChangeType=function(e,t,i){var s=this,l=t+";codecs="+i,u={label:"change-type="+l,execute:function(){var d=s.tracks[e];if(d){var h=d.buffer;h!=null&&h.changeType&&(s.log("changing "+e+" sourceBuffer type to "+l),h.changeType(l),d.codec=i,d.container=t)}s.shiftAndExecuteNext(e)},onStart:function(){},onComplete:function(){},onError:function(d){s.warn("Failed to change "+e+" SourceBuffer type",d)}};this.append(u,e,this.isPending(this.tracks[e]))},n.blockAudio=function(e){var t,i=this,s=e.start,l=s+e.duration*.05,u=((t=this.fragmentTracker.getAppendedFrag(s,K.MAIN))==null?void 0:t.gap)===!0;if(!u){var f={label:"block-audio",execute:function(){var h,c=i.tracks.video;(i.lastVideoAppendEnd>l||c!=null&&c.buffer&&Se.isBuffered(c.buffer,l)||((h=i.fragmentTracker.getAppendedFrag(l,K.MAIN))==null?void 0:h.gap)===!0)&&(i.blockedAudioAppend=null,i.shiftAndExecuteNext("audio"))},onStart:function(){},onComplete:function(){},onError:function(h){i.warn("Error executing block-audio operation",h)}};this.blockedAudioAppend={op:f,frag:e},this.append(f,"audio",!0)}},n.unblockAudio=function(){var e=this.blockedAudioAppend,t=this.operationQueue;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))},n.onBufferAppending=function(e,t){var i=this,s=this.tracks,l=t.data,u=t.type,f=t.parent,d=t.frag,h=t.part,c=t.chunkMeta,v=c.buffering[u],g=d.sn,m=self.performance.now();v.start=m;var y=d.stats.buffering,E=h?h.stats.buffering:null;y.start===0&&(y.start=m),E&&E.start===0&&(E.start=m);var T=s.audio,S=!1;u==="audio"&&(T==null?void 0:T.container)==="audio/mpeg"&&(S=!this.lastMpegAudioChunk||c.id===1||this.lastMpegAudioChunk.sn!==c.sn,this.lastMpegAudioChunk=c);var A=this.tracks.video,x=A==null?void 0:A.buffer;if(x&&g!=="initSegment"){var L=h||d,I=this.blockedAudioAppend;if(u==="audio"&&f!=="main"&&!this.blockedAudioAppend){var k=L.start,R=k+L.duration*.05,b=x.buffered,D=this.currentOp("video");!b.length&&!D?this.blockAudio(L):!D&&!Se.isBuffered(x,R)&&this.lastVideoAppendEnd<R&&this.blockAudio(L)}else if(u==="video"){var P=L.end;if(I){var U=I.frag.start;(P>U||P<this.lastVideoAppendEnd||Se.isBuffered(x,U))&&this.unblockAudio()}this.lastVideoAppendEnd=P}}var F=(h||d).start,M={label:"append-"+u,execute:function(){if(v.executeStart=self.performance.now(),S){var q=i.tracks[u];if(q){var W=q.buffer;if(W){var ee=F-W.timestampOffset;Math.abs(ee)>=.1&&(i.log("Updating audio SourceBuffer timestampOffset to "+F+" (delta: "+ee+") sn: "+g+")"),W.timestampOffset=F)}}}i.appendExecutor(l,u)},onStart:function(){},onComplete:function(){var q=self.performance.now();v.executeEnd=v.end=q,y.first===0&&(y.first=q),E&&E.first===0&&(E.first=q);var W={};i.sourceBuffers.forEach(function(ee){var ye=ee[0],le=ee[1];ye&&(W[ye]=Se.getBuffered(le))}),i.appendErrors[u]=0,u==="audio"||u==="video"?i.appendErrors.audiovideo=0:(i.appendErrors.audio=0,i.appendErrors.video=0),i.hls.trigger(p.BUFFER_APPENDED,{type:u,frag:d,part:h,chunkMeta:c,parent:d.type,timeRanges:W})},onError:function(q){var W,ee={type:V.MEDIA_ERROR,parent:d.type,details:_.BUFFER_APPEND_ERROR,sourceBufferName:u,frag:d,part:h,chunkMeta:c,error:q,err:q,fatal:!1},ye=(W=i.media)==null?void 0:W.error;if(q.code===DOMException.QUOTA_EXCEEDED_ERR)ee.details=_.BUFFER_FULL_ERROR;else if(q.code===DOMException.INVALID_STATE_ERR&&i.mediaSourceOpenOrEnded&&!ye)ee.errorAction=Jr(!0);else if(q.name===To&&i.sourceBufferCount===0)ee.errorAction=Jr(!0);else{var le=++i.appendErrors[u];i.warn("Failed "+le+"/"+i.hls.config.appendErrorMaxRetry+' times to append segment in "'+u+'" sourceBuffer ('+(ye||"no media error")+")"),(le>=i.hls.config.appendErrorMaxRetry||ye)&&(ee.fatal=!0)}i.hls.trigger(p.ERROR,ee)}};this.append(M,u,this.isPending(this.tracks[u]))},n.getFlushOp=function(e,t,i){var s=this;return this.log('queuing "'+e+'" remove '+t+"-"+i),{label:"remove",execute:function(){s.removeExecutor(e,t,i)},onStart:function(){},onComplete:function(){s.hls.trigger(p.BUFFER_FLUSHED,{type:e})},onError:function(u){s.warn("Failed to remove "+t+"-"+i+' from "'+e+'" SourceBuffer',u)}}},n.onBufferFlushing=function(e,t){var i=this,s=t.type,l=t.startOffset,u=t.endOffset;s?this.append(this.getFlushOp(s,l,u),s):this.sourceBuffers.forEach(function(f){var d=f[0];d&&i.append(i.getFlushOp(d,l,u),d)})},n.onFragParsed=function(e,t){var i=this,s=t.frag,l=t.part,u=[],f=l?l.elementaryStreams:s.elementaryStreams;f[oe.AUDIOVIDEO]?u.push("audiovideo"):(f[oe.AUDIO]&&u.push("audio"),f[oe.VIDEO]&&u.push("video"));var d=function(){var c=self.performance.now();s.stats.buffering.end=c,l&&(l.stats.buffering.end=c);var v=l?l.stats:s.stats;i.hls.trigger(p.FRAG_BUFFERED,{frag:s,part:l,stats:v,id:s.type})};u.length===0&&this.warn("Fragments must have at least one ElementaryStreamType set. type: "+s.type+" level: "+s.level+" sn: "+s.sn),this.blockBuffers(d,u).catch(function(h){i.warn("Fragment buffered callback "+h),i.stepOperationQueue(i.sourceBufferTypes)})},n.onFragChanged=function(e,t){this.trimBuffers()},n.onBufferEos=function(e,t){var i=this,s;this.sourceBuffers.forEach(function(f){var d=f[0];if(d){var h=i.tracks[d];(!t.type||t.type===d)&&(h.ending=!0,h.ended||(h.ended=!0,i.log(d+" buffer reached EOS")))}});var l=((s=this.overrides)==null?void 0:s.endOfStream)!==!1,u=this.sourceBufferCount>0&&!this.sourceBuffers.some(function(f){var d,h=f[0];return h&&!((d=i.tracks[h])!=null&&d.ended)});u&&(l?(this.log("Queueing EOS"),this.blockUntilOpen(function(){i.tracksEnded();var f=i.mediaSource;if(!f||f.readyState!=="open"){f&&i.log("Could not call mediaSource.endOfStream(). mediaSource.readyState: "+f.readyState);return}i.log("Calling mediaSource.endOfStream()"),f.endOfStream(),i.hls.trigger(p.BUFFERED_TO_END,void 0)})):(this.tracksEnded(),this.hls.trigger(p.BUFFERED_TO_END,void 0)))},n.tracksEnded=function(){var e=this;this.sourceBuffers.forEach(function(t){var i=t[0];if(i!==null){var s=e.tracks[i];s&&(s.ending=!1)}})},n.onLevelUpdated=function(e,t){var i=t.details;i.fragments.length&&(this.details=i,this.updateDuration())},n.updateDuration=function(){var e=this,t=this.getDurationAndRange();t&&this.blockUntilOpen(function(){return e.updateMediaSource(t)})},n.onError=function(e,t){if(t.details===_.BUFFER_APPEND_ERROR&&t.frag){var i,s=(i=t.errorAction)==null?void 0:i.nextAutoLevel;N(s)&&s!==t.frag.level&&this.resetAppendErrors()}},n.resetAppendErrors=function(){this.appendErrors={audio:0,video:0,audiovideo:0}},n.trimBuffers=function(){var e=this.hls,t=this.details,i=this.media;if(!(!i||t===null)&&this.sourceBufferCount){var s=e.config,l=i.currentTime,u=t.levelTargetDuration,f=t.live&&s.liveBackBufferLength!==null?s.liveBackBufferLength:s.backBufferLength;if(N(f)&&f>=0){var d=Math.max(f,u),h=Math.floor(l/u)*u-d;this.flushBackBuffer(l,u,h)}if(N(s.frontBufferFlushThreshold)&&s.frontBufferFlushThreshold>0){var c=Math.max(s.maxBufferLength,s.frontBufferFlushThreshold),v=Math.max(c,u),g=Math.floor(l/u)*u+v;this.flushFrontBuffer(l,u,g)}}},n.flushBackBuffer=function(e,t,i){var s=this;this.sourceBuffers.forEach(function(l){var u=l[0],f=l[1];if(f){var d=Se.getBuffered(f);if(d.length>0&&i>d.start(0)){var h;s.hls.trigger(p.BACK_BUFFER_REACHED,{bufferEnd:i});var c=s.tracks[u];if((h=s.details)!=null&&h.live)s.hls.trigger(p.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(c!=null&&c.ended){s.log("Cannot flush "+u+" back buffer while SourceBuffer is in ended state");return}s.hls.trigger(p.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:u})}}})},n.flushFrontBuffer=function(e,t,i){var s=this;this.sourceBuffers.forEach(function(l){var u=l[0],f=l[1];if(f){var d=Se.getBuffered(f),h=d.length;if(h<2)return;var c=d.start(h-1),v=d.end(h-1);if(i>c||e>=c&&e<=v)return;s.hls.trigger(p.BUFFER_FLUSHING,{startOffset:c,endOffset:1/0,type:u})}})},n.getDurationAndRange=function(){var e,t=this.details,i=this.mediaSource;if(!t||!this.media||(i==null?void 0:i.readyState)!=="open")return null;var s=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){var l=t.fragments.length;if(l&&t.live&&i.setLiveSeekableRange){var u=Math.max(0,t.fragmentStart),f=Math.max(u,s);return{duration:1/0,start:u,end:f}}return{duration:1/0}}var d=(e=this.overrides)==null?void 0:e.duration;if(d)return N(d)?{duration:d}:null;var h=this.media.duration,c=N(i.duration)?i.duration:0;return s>c&&s>h||!N(h)?{duration:s}:null},n.updateMediaSource=function(e){var t=e.duration,i=e.start,s=e.end,l=this.mediaSource;!this.media||!l||l.readyState!=="open"||(l.duration!==t&&(N(t)&&this.log("Updating MediaSource duration to "+t.toFixed(3)),l.duration=t),i!==void 0&&s!==void 0&&(this.log("MediaSource duration is set to "+l.duration+". Setting seekable range to "+i+"-"+s+"."),l.setLiveSeekableRange(i,s)))},n.checkPendingTracks=function(){var e=this.bufferCodecEventsTotal,t=this.pendingTrackCount,i=this.tracks;if(this.log("checkPendingTracks (pending: "+t+" codec events expected: "+e+") "+He(i)),this.tracksReady){var s,l=(s=this.transferData)==null?void 0:s.tracks;l&&Object.keys(l).length?this.attachTransferred():this.createSourceBuffers()}},n.bufferCreated=function(){var e=this;if(this.sourceBufferCount){var t={};this.sourceBuffers.forEach(function(s){var l=s[0],u=s[1];if(l){var f=e.tracks[l];t[l]={buffer:u,container:f.container,codec:f.codec,supplemental:f.supplemental,levelCodec:f.levelCodec,id:f.id,metadata:f.metadata}}}),this.hls.trigger(p.BUFFER_CREATED,{tracks:t}),this.log("SourceBuffers created. Running queue: "+this.operationQueue),this.sourceBuffers.forEach(function(s){var l=s[0];e.executeNext(l)})}else{var i=new Error("could not create source buffer for media codec(s)");this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:i,reason:i.message})}},n.createSourceBuffers=function(){var e=this.tracks,t=this.sourceBuffers,i=this.mediaSource;if(!i)throw new Error("createSourceBuffers called when mediaSource was null");for(var s in e){var l=s,u=e[l];if(this.isPending(u)){var f=this.getTrackCodec(u,l),d=u.container+";codecs="+f;u.codec=f,this.log("creating sourceBuffer("+d+")"+(this.currentOp(l)?" Queued":"")+" "+He(u));try{var h=i.addSourceBuffer(d),c=$n(l),v=[l,h];t[c]=v,u.buffer=h}catch(m){var g;this.error("error while trying to add sourceBuffer: "+m.message),this.shiftAndExecuteNext(l),(g=this.operationQueue)==null||g.removeBlockers(),delete this.tracks[l],this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:m,sourceBufferName:l,mimeType:d,parent:u.id});return}this.trackSourceBuffer(l,u)}}this.bufferCreated()},n.getTrackCodec=function(e,t){var i=e.supplemental,s=e.codec;i&&(t==="video"||t==="audiovideo")&&vn(i,"video")&&(s=Gl(s,i));var l=Ti(s,e.levelCodec);return l?t.slice(0,5)==="audio"?Ei(l,this.appendSource):l:""},n.trackSourceBuffer=function(e,t){var i=this,s=t.buffer;if(s){var l=this.getTrackCodec(t,e);this.tracks[e]={buffer:s,codec:l,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",function(u,f){var d=f.removedRanges;d!=null&&d.length&&i.hls.trigger(p.BUFFER_FLUSHED,{type:u})})}},n.onSBUpdateStart=function(e){var t=this.currentOp(e);t&&t.onStart()},n.onSBUpdateEnd=function(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}var i=this.currentOp(e);i&&(i.onComplete(),this.shiftAndExecuteNext(e))},n.onSBUpdateError=function(e,t){var i,s=new Error(e+" SourceBuffer error. MediaSource readyState: "+((i=this.mediaSource)==null?void 0:i.readyState));this.error(""+s,t),this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:s,fatal:!1});var l=this.currentOp(e);l&&l.onError(s)},n.removeExecutor=function(e,t,i){var s=this.media,l=this.mediaSource,u=this.tracks[e],f=u==null?void 0:u.buffer;if(!s||!l||!f){this.warn("Attempting to remove from the "+e+" SourceBuffer, but it does not exist"),this.shiftAndExecuteNext(e);return}var d=N(s.duration)?s.duration:1/0,h=N(l.duration)?l.duration:1/0,c=Math.max(0,t),v=Math.min(i,d,h);v>c&&(!u.ending||u.ended)?(u.ended=!1,this.log("Removing ["+c+","+v+"] from the "+e+" SourceBuffer"),f.remove(c,v)):this.shiftAndExecuteNext(e)},n.appendExecutor=function(e,t){var i=this.tracks[t],s=i==null?void 0:i.buffer;if(!s)throw new Xf("Attempting to append to the "+t+" SourceBuffer, but it does not exist");i.ending=!1,i.ended=!1,s.appendBuffer(e)},n.blockUntilOpen=function(e){var t=this;if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(function(i){t.warn("SourceBuffer blocked callback "+i),t.stepOperationQueue(t.sourceBufferTypes)});else try{e()}catch(i){this.warn("Callback run without blocking "+this.operationQueue+" "+i)}},n.isUpdating=function(){return this.sourceBuffers.some(function(e){var t=e[0],i=e[1];return t&&i.updating})},n.isQueued=function(){var e=this;return this.sourceBuffers.some(function(t){var i=t[0];return i&&!!e.currentOp(i)})},n.isPending=function(e){return!!e&&!e.buffer},n.blockBuffers=function(e,t){var i=this;if(t===void 0&&(t=this.sourceBufferTypes),!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);var s=this.operationQueue,l=t.map(function(f){return i.appendBlocker(f)}),u=t.length>1&&!!this.blockedAudioAppend;return u&&this.unblockAudio(),Promise.all(l).then(function(f){s===i.operationQueue&&(e(),i.stepOperationQueue(i.sourceBufferTypes))})},n.stepOperationQueue=function(e){var t=this;e.forEach(function(i){var s,l=(s=t.tracks[i])==null?void 0:s.buffer;!l||l.updating||t.shiftAndExecuteNext(i)})},n.append=function(e,t,i){this.operationQueue&&this.operationQueue.append(e,t,i)},n.appendBlocker=function(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)},n.currentOp=function(e){return this.operationQueue?this.operationQueue.current(e):null},n.executeNext=function(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)},n.shiftAndExecuteNext=function(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)},n.addBufferListener=function(e,t,i){var s=this.tracks[e];if(s){var l=s.buffer;if(l){var u=i.bind(this,e);s.listeners.push({event:t,listener:u}),l.addEventListener(t,u)}}},n.removeBufferListeners=function(e){var t=this.tracks[e];if(t){var i=t.buffer;i&&(t.listeners.forEach(function(s){i.removeEventListener(s.event,s.listener)}),t.listeners.length=0)}},z(o,[{key:"mediaSourceOpenOrEnded",get:function(){var e,t=(e=this.mediaSource)==null?void 0:e.readyState;return t==="open"||t==="ended"}},{key:"sourceBufferTracks",get:function(){var e=this;return Object.keys(this.tracks).reduce(function(t,i){var s=e.tracks[i];return t[i]={id:s.id,container:s.container,codec:s.codec,levelCodec:s.levelCodec},t},{})}},{key:"bufferedToEnd",get:function(){var e=this;return this.sourceBufferCount>0&&!this.sourceBuffers.some(function(t){var i,s,l=t[0];return l&&(!((i=e.tracks[l])!=null&&i.ended)||((s=e.tracks[l])==null?void 0:s.ending))})}},{key:"tracksReady",get:function(){var e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}},{key:"mediaSrc",get:function(){var e,t,i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i==null?void 0:i.src}},{key:"pendingTrackCount",get:function(){var e=this;return Object.keys(this.tracks).reduce(function(t,i){return t+(e.isPending(e.tracks[i])?1:0)},0)}},{key:"sourceBufferCount",get:function(){return this.sourceBuffers.reduce(function(e,t){var i=t[0];return e+(i?1:0)},0)}},{key:"sourceBufferTypes",get:function(){return this.sourceBuffers.map(function(e){var t=e[0];return t}).filter(function(e){return!!e})}}])}(ie);function So(a){var o=a.querySelectorAll("source");[].slice.call(o).forEach(function(n){a.removeChild(n)})}function Qf(a,o){var n=self.document.createElement("source");n.type="video/mp4",n.src=o,a.appendChild(n)}function $n(a){return a==="audio"?1:0}var $f=function(){function a(n){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=n,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}var o=a.prototype;return o.setStreamController=function(r){this.streamController=r},o.destroy=function(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null},o.registerListeners=function(){var r=this.hls;r.on(p.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),r.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),r.on(p.MANIFEST_PARSED,this.onManifestParsed,this),r.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),r.on(p.BUFFER_CODECS,this.onBufferCodecs,this),r.on(p.MEDIA_DETACHING,this.onMediaDetaching,this)},o.unregisterListener=function(){var r=this.hls;r.off(p.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),r.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),r.off(p.MANIFEST_PARSED,this.onManifestParsed,this),r.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),r.off(p.BUFFER_CODECS,this.onBufferCodecs,this),r.off(p.MEDIA_DETACHING,this.onMediaDetaching,this)},o.onFpsDropLevelCapping=function(r,e){var t=this.hls.levels[e.droppedLevel];this.isLevelAllowed(t)&&this.restrictedLevels.push({bitrate:t.bitrate,height:t.height,width:t.width})},o.onMediaAttaching=function(r,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()},o.onManifestParsed=function(r,e){var t=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,t.config.capLevelToPlayerSize&&e.video&&this.startCapping()},o.onLevelsUpdated=function(r,e){this.timer&&N(this.autoLevelCapping)&&this.detectPlayerSize()},o.onBufferCodecs=function(r,e){var t=this.hls;t.config.capLevelToPlayerSize&&e.video&&this.startCapping()},o.onMediaDetaching=function(){this.stopCapping(),this.media=null},o.detectPlayerSize=function(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}var r=this.hls.levels;if(r.length){var e=this.hls,t=this.getMaxLevel(r.length-1);t!==this.autoLevelCapping&&e.logger.log("Setting autoLevelCapping to "+t+": "+r[t].height+"p@"+r[t].bitrate+" for media "+this.mediaWidth+"x"+this.mediaHeight),e.autoLevelCapping=t,e.autoLevelEnabled&&e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}},o.getMaxLevel=function(r){var e=this,t=this.hls.levels;if(!t.length)return-1;var i=t.filter(function(s,l){return e.isLevelAllowed(s)&&l<=r});return this.clientRect=null,a.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)},o.startCapping=function(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())},o.stopCapping=function(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)},o.getDimensions=function(){if(this.clientRect)return this.clientRect;var r=this.media,e={width:0,height:0};if(r){var t=r.getBoundingClientRect();e.width=t.width,e.height=t.height,!e.width&&!e.height&&(e.width=t.right-t.left||r.width||0,e.height=t.bottom-t.top||r.height||0)}return this.clientRect=e,e},o.isLevelAllowed=function(r){var e=this.restrictedLevels;return!e.some(function(t){return r.bitrate===t.bitrate&&r.width===t.width&&r.height===t.height})},a.getMaxLevelByMediaSize=function(r,e,t){if(!(r!=null&&r.length))return-1;for(var i=function(h,c){return c?h.width!==c.width||h.height!==c.height:!0},s=r.length-1,l=Math.max(e,t),u=0;u<r.length;u+=1){var f=r[u];if((f.width>=l||f.height>=l)&&i(f,r[u+1])){s=u;break}}return s},z(a,[{key:"mediaWidth",get:function(){return this.getDimensions().width*this.contentScaleFactor}},{key:"mediaHeight",get:function(){return this.getDimensions().height*this.contentScaleFactor}},{key:"contentScaleFactor",get:function(){var r=1;if(!this.hls.config.ignoreDevicePixelRatio)try{r=self.devicePixelRatio}catch{}return Math.min(r,this.hls.config.maxDevicePixelRatio)}}])}(),Jf={MANIFEST:"m",AUDIO:"a",VIDEO:"v",MUXED:"av",INIT:"i",CAPTION:"c",TIMED_TEXT:"tt",KEY:"k",OTHER:"o"},Pt=Jf,Zf={HLS:"h"},ed=Zf,td="CMCD-Object",rd="CMCD-Request",id="CMCD-Session",nd="CMCD-Status",si={OBJECT:td,REQUEST:rd,SESSION:id,STATUS:nd},Br,ad=(Br={},Br[si.OBJECT]=["br","d","ot","tb"],Br[si.REQUEST]=["bl","dl","mtp","nor","nrr","su"],Br[si.SESSION]=["cid","pr","sf","sid","st","v"],Br[si.STATUS]=["bs","rtp"],Br),Jn=function a(o,n){Array.isArray(o)&&(o=o.map(function(r){return r instanceof a?r:new a(r)})),this.value=o,this.params=n},sd="Dict";function od(a){return Array.isArray(a)?JSON.stringify(a):a instanceof Map?"Map{}":a instanceof Set?"Set{}":typeof a=="object"?JSON.stringify(a):String(a)}function ld(a,o,n,r){return new Error("failed to "+a+' "'+od(o)+'" as '+n,{cause:r})}function er(a,o,n){return ld("serialize",a,o,n)}var Ao=function(o){this.description=o},xo="Bare Item",ud="Boolean";function fd(a){if(typeof a!="boolean")throw er(a,ud);return a?"?1":"?0"}var dd="Byte Sequence";function hd(a){if(ArrayBuffer.isView(a)===!1)throw er(a,dd);return":"+Ju(a)+":"}var cd="Integer";function vd(a){return a<-999999999999999||999999999999999<a}function Lo(a){if(vd(a))throw er(a,cd);return a.toString()}function gd(a){return"@"+Lo(a.getTime()/1e3)}var md="Decimal";function pd(a){var o=Xs(a,3);if(Math.floor(Math.abs(o)).toString().length>12)throw er(a,md);var n=o.toString();return n.includes(".")?n:n+".0"}var yd="String",Ed=/[\x00-\x1f\x7f]+/;function Td(a){if(Ed.test(a))throw er(a,yd);return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'}function Sd(a){return a.description||a.toString().slice(7,-1)}var Ad="Token";function bo(a){var o=Sd(a);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(o)===!1)throw er(o,Ad);return o}function Zn(a){switch(typeof a){case"number":if(!N(a))throw er(a,xo);return Number.isInteger(a)?Lo(a):pd(a);case"string":return Td(a);case"symbol":return bo(a);case"boolean":return fd(a);case"object":if(a instanceof Date)return gd(a);if(a instanceof Uint8Array)return hd(a);if(a instanceof Ao)return bo(a);default:throw er(a,xo)}}var xd="Key";function ea(a){if(/^[a-z*][a-z0-9\-_.*]*$/.test(a)===!1)throw er(a,xd);return a}function ta(a){return a==null?"":Object.entries(a).map(function(o){var n=o[0],r=o[1];return r===!0?";"+ea(n):";"+ea(n)+"="+Zn(r)}).join("")}function Ro(a){return a instanceof Jn?""+Zn(a.value)+ta(a.params):Zn(a)}function Ld(a){return"("+a.value.map(Ro).join(" ")+")"+ta(a.params)}function bd(a,o){if(o===void 0&&(o={whitespace:!0}),typeof a!="object")throw er(a,sd);var n=a instanceof Map?a.entries():Object.entries(a),r=o!=null&&o.whitespace?" ":"";return Array.from(n).map(function(e){var t=e[0],i=e[1];i instanceof Jn||(i=new Jn(i));var s=ea(t);return i.value===!0?s+=ta(i.params):(s+="=",Array.isArray(i.value)?s+=Ld(i):s+=Ro(i)),s}).join(","+r)}function Rd(a,o){return bd(a,o)}function Id(a){return a==="ot"||a==="sf"||a==="st"}function _d(a){return typeof a=="number"?N(a):a!=null&&a!==""&&a!==!1}var Bi=function(o){return Math.round(o)},Dd=function(o,n){return n!=null&&n.baseUrl&&(o=Zu(o,n.baseUrl)),encodeURIComponent(o)},Gi=function(o){return Bi(o/100)*100},kd={br:Bi,d:Bi,bl:Gi,dl:Gi,mtp:Gi,nor:Dd,rtp:Gi,tb:Bi};function Cd(a,o){var n={};if(a==null||typeof a!="object")return n;var r=Object.keys(a).sort(),e=ae({},kd,o==null?void 0:o.formatters),t=o==null?void 0:o.filter;return r.forEach(function(i){if(!(t!=null&&t(i))){var s=a[i],l=e[i];l&&(s=l(s,o)),!(i==="v"&&s===1)&&(i=="pr"&&s===1||_d(s)&&(Id(i)&&typeof s=="string"&&(s=new Ao(s)),n[i]=s))}}),n}function Io(a,o){return o===void 0&&(o={}),a?Rd(Cd(a,o),ae({whitespace:!1},o)):""}function Pd(a,o){o===void 0&&(o={});var n={};if(!a)return n;var r=Object.entries(a),e=Object.entries(ad).concat(Object.entries((o==null?void 0:o.customHeaderMap)||{})),t=r.reduce(function(i,s){var l,u,f=s[0],d=s[1],h=((l=e.find(function(c){return c[1].includes(f)}))===null||l===void 0?void 0:l[0])||si.REQUEST;return(u=i[h])!==null&&u!==void 0||(i[h]={}),i[h][f]=d,i},{});return Object.entries(t).reduce(function(i,s){var l=s[0],u=s[1];return i[l]=Io(u,o),i},n)}function wd(a,o,n){return ae(a,Pd(o,n))}var Md="CMCD";function Od(a,o){if(o===void 0&&(o={}),!a)return"";var n=Io(a,o);return Md+"="+encodeURIComponent(n)}var _o=/CMCD=[^&#]+/;function Fd(a,o,n){var r=Od(o,n);if(!r)return a;if(_o.test(a))return a.replace(_o,r);var e=a.includes("?")?"&":"?";return""+a+e+r}var Nd=function(){function a(n){var r=this;this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=function(){r.initialized&&(r.starved=!0),r.buffering=!0},this.onPlaying=function(){r.initialized||(r.initialized=!0),r.buffering=!1},this.applyPlaylistData=function(i){try{r.apply(i,{ot:Pt.MANIFEST,su:!r.initialized})}catch(s){r.hls.logger.warn("Could not generate manifest CMCD data.",s)}},this.applyFragmentData=function(i){try{var s=i.frag,l=i.part,u=r.hls.levels[s.level],f=r.getObjectType(s),d={d:(l||s).duration*1e3,ot:f};(f===Pt.VIDEO||f===Pt.AUDIO||f==Pt.MUXED)&&(d.br=u.bitrate/1e3,d.tb=r.getTopBandwidth(f)/1e3,d.bl=r.getBufferLength(f));var h=l?r.getNextPart(l):r.getNextFrag(s);h!=null&&h.url&&h.url!==s.url&&(d.nor=h.url),r.apply(i,d)}catch(c){r.hls.logger.warn("Could not generate segment CMCD data.",c)}},this.hls=n;var e=this.config=n.config,t=e.cmcd;t!=null&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=t.sessionId||n.sessionId,this.cid=t.contentId,this.useHeaders=t.useHeaders===!0,this.includeKeys=t.includeKeys,this.registerListeners())}var o=a.prototype;return o.registerListeners=function(){var r=this.hls;r.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),r.on(p.MEDIA_DETACHED,this.onMediaDetached,this),r.on(p.BUFFER_CREATED,this.onBufferCreated,this)},o.unregisterListeners=function(){var r=this.hls;r.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),r.off(p.MEDIA_DETACHED,this.onMediaDetached,this),r.off(p.BUFFER_CREATED,this.onBufferCreated,this)},o.destroy=function(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null},o.onMediaAttached=function(r,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)},o.onMediaDetached=function(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)},o.onBufferCreated=function(r,e){var t,i;this.audioBuffer=(t=e.tracks.audio)==null?void 0:t.buffer,this.videoBuffer=(i=e.tracks.video)==null?void 0:i.buffer},o.createData=function(){var r;return{v:1,sf:ed.HLS,sid:this.sid,cid:this.cid,pr:(r=this.media)==null?void 0:r.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}},o.apply=function(r,e){e===void 0&&(e={}),ae(e,this.createData());var t=e.ot===Pt.INIT||e.ot===Pt.VIDEO||e.ot===Pt.MUXED;this.starved&&t&&(e.bs=!0,e.su=!0,this.starved=!1),e.su==null&&(e.su=this.buffering);var i=this.includeKeys;i&&(e=Object.keys(e).reduce(function(l,u){return i.includes(u)&&(l[u]=e[u]),l},{}));var s={baseUrl:r.url};this.useHeaders?(r.headers||(r.headers={}),wd(r.headers,e,s)):r.url=Fd(r.url,e,s)},o.getNextFrag=function(r){var e,t=(e=this.hls.levels[r.level])==null?void 0:e.details;if(t){var i=r.sn-t.startSN;return t.fragments[i+1]}},o.getNextPart=function(r){var e,t,i=r.index,s=r.fragment,l=(e=this.hls.levels[s.level])==null||(t=e.details)==null?void 0:t.partList;if(l)for(var u=s.sn,f=l.length-1;f>=0;f--){var d=l[f];if(d.index===i&&d.fragment.sn===u)return l[f+1]}},o.getObjectType=function(r){var e=r.type;if(e==="subtitle")return Pt.TIMED_TEXT;if(r.sn==="initSegment")return Pt.INIT;if(e==="audio")return Pt.AUDIO;if(e==="main")return this.hls.audioTracks.length?Pt.VIDEO:Pt.MUXED},o.getTopBandwidth=function(r){var e=0,t,i=this.hls;if(r===Pt.AUDIO)t=i.audioTracks;else{var s=i.maxAutoLevel,l=s>-1?s+1:i.levels.length;t=i.levels.slice(0,l)}for(var u=Ue(t),f;!(f=u()).done;){var d=f.value;d.bitrate>e&&(e=d.bitrate)}return e>0?e:NaN},o.getBufferLength=function(r){var e=this.media,t=r===Pt.AUDIO?this.audioBuffer:this.videoBuffer;if(!t||!e)return NaN;var i=Se.bufferInfo(t,e.currentTime,this.config.maxBufferHole);return i.len*1e3},o.createPlaylistLoader=function(){var r=this.config.pLoader,e=this.applyPlaylistData,t=r||this.config.loader;return function(){function i(l){this.loader=void 0,this.loader=new t(l)}var s=i.prototype;return s.destroy=function(){this.loader.destroy()},s.abort=function(){this.loader.abort()},s.load=function(u,f,d){e(u),this.loader.load(u,f,d)},z(i,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}])}()},o.createFragmentLoader=function(){var r=this.config.fLoader,e=this.applyFragmentData,t=r||this.config.loader;return function(){function i(l){this.loader=void 0,this.loader=new t(l)}var s=i.prototype;return s.destroy=function(){this.loader.destroy()},s.abort=function(){this.loader.abort()},s.load=function(u,f,d){e(u),this.loader.load(u,f,d)},z(i,[{key:"stats",get:function(){return this.loader.stats}},{key:"context",get:function(){return this.loader.context}}])}()},a}(),Ud=3e5,Bd=function(a){function o(r){var e;return e=a.call(this,"content-steering",r.logger)||this,e.hls=void 0,e.loader=null,e.uri=null,e.pathwayId=".",e._pathwayPriority=null,e.timeToLoad=300,e.reloadTimer=-1,e.updated=0,e.started=!1,e.enabled=!0,e.levels=null,e.audioTracks=null,e.subtitleTracks=null,e.penalizedPathways={},e.hls=r,e.registerListeners(),e}J(o,a);var n=o.prototype;return n.registerListeners=function(){var e=this.hls;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e&&(e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.ERROR,this.onError,this))},n.pathways=function(){return(this.levels||[]).reduce(function(e,t){return e.indexOf(t.pathwayId)===-1&&e.push(t.pathwayId),e},[])},n.startLoad=function(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){var e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}},n.stopLoad=function(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()},n.clearTimeout=function(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)},n.destroy=function(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null},n.removeLevel=function(e){var t=this.levels;t&&(this.levels=t.filter(function(i){return i!==e}))},n.onManifestLoading=function(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null},n.onManifestLoaded=function(e,t){var i=t.contentSteering;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())},n.onManifestParsed=function(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks},n.onError=function(e,t){var i=t.errorAction;if((i==null?void 0:i.action)===bt.SendAlternateToPenaltyBox&&i.flags===jt.MoveAllAlternatesMatchingHost){var s=this.levels,l=this._pathwayPriority,u=this.pathwayId;if(t.context){var f=t.context,d=f.groupId,h=f.pathwayId,c=f.type;d&&s?u=this.getPathwayForGroupId(d,c,u):h&&(u=h)}u in this.penalizedPathways||(this.penalizedPathways[u]=performance.now()),!l&&s&&(l=this.pathways()),l&&l.length>1&&(this.updatePathwayPriority(l),i.resolved=this.pathwayId!==u),i.resolved||this.warn("Could not resolve "+t.details+' ("'+t.error.message+'") with content-steering for Pathway: '+u+" levels: "+(s&&s.length)+" priorities: "+He(l)+" penalized: "+He(this.penalizedPathways))}},n.filterParsedLevels=function(e){this.levels=e;var t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){var i=e[0].pathwayId;this.log("No levels found in Pathway "+this.pathwayId+'. Setting initial Pathway to "'+i+'"'),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log("Found "+t.length+"/"+e.length+' levels in Pathway "'+this.pathwayId+'"'),t},n.getLevelsForPathway=function(e){return this.levels===null?[]:this.levels.filter(function(t){return e===t.pathwayId})},n.updatePathwayPriority=function(e){this._pathwayPriority=e;var t,i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(function(c){s-i[c]>Ud&&delete i[c]});for(var l=0;l<e.length;l++){var u=e[l];if(!(u in i)){if(u===this.pathwayId)return;var f=this.hls.nextLoadLevel,d=this.hls.levels[f];if(t=this.getLevelsForPathway(u),t.length>0){this.log('Setting Pathway to "'+u+'"'),this.pathwayId=u,Fs(t),this.hls.trigger(p.LEVELS_UPDATED,{levels:t});var h=this.hls.levels[f];d&&h&&this.levels&&(h.attrs["STABLE-VARIANT-ID"]!==d.attrs["STABLE-VARIANT-ID"]&&h.bitrate!==d.bitrate&&this.log("Unstable Pathways change from bitrate "+d.bitrate+" to "+h.bitrate),this.hls.nextLoadLevel=f);break}}}},n.getPathwayForGroupId=function(e,t,i){for(var s=this.getLevelsForPathway(i).concat(this.levels||[]),l=0;l<s.length;l++)if(t===j.AUDIO_TRACK&&s[l].hasAudioGroup(e)||t===j.SUBTITLE_TRACK&&s[l].hasSubtitleGroup(e))return s[l].pathwayId;return i},n.clonePathways=function(e){var t=this,i=this.levels;if(i){var s={},l={};e.forEach(function(u){var f=u.ID,d=u["BASE-ID"],h=u["URI-REPLACEMENT"];if(!i.some(function(v){return v.pathwayId===f})){var c=t.getLevelsForPathway(d).map(function(v){var g=new et(v.attrs);g["PATHWAY-ID"]=f;var m=g.AUDIO&&g.AUDIO+"_clone_"+f,y=g.SUBTITLES&&g.SUBTITLES+"_clone_"+f;m&&(s[g.AUDIO]=m,g.AUDIO=m),y&&(l[g.SUBTITLES]=y,g.SUBTITLES=y);var E=ko(v.uri,g["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",h),T=new $r({attrs:g,audioCodec:v.audioCodec,bitrate:v.bitrate,height:v.height,name:v.name,url:E,videoCodec:v.videoCodec,width:v.width});if(v.audioGroups)for(var S=1;S<v.audioGroups.length;S++)T.addGroupId("audio",v.audioGroups[S]+"_clone_"+f);if(v.subtitleGroups)for(var A=1;A<v.subtitleGroups.length;A++)T.addGroupId("text",v.subtitleGroups[A]+"_clone_"+f);return T});i.push.apply(i,c),Do(t.audioTracks,s,h,f),Do(t.subtitleTracks,l,h,f)}})}},n.loadSteeringManifest=function(e){var t=this,i=this.hls.config,s=i.loader;this.loader&&this.loader.destroy(),this.loader=new s(i);var l;try{l=new self.URL(e)}catch{this.enabled=!1,this.log("Failed to parse Steering Manifest URI: "+e);return}if(l.protocol!=="data:"){var u=(this.hls.bandwidthEstimate||i.abrEwmaDefaultEstimate)|0;l.searchParams.set("_HLS_pathway",this.pathwayId),l.searchParams.set("_HLS_throughput",""+u)}var f={responseType:"json",url:l.href},d=i.steeringManifestLoadPolicy.default,h=d.errorRetry||d.timeoutRetry||{},c={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:h.maxNumRetry||0,retryDelay:h.retryDelayMs||0,maxRetryDelay:h.maxRetryDelayMs||0},v={onSuccess:function(m,y,E,T){t.log('Loaded steering manifest: "'+l+'"');var S=m.data;if((S==null?void 0:S.VERSION)!==1){t.log("Steering VERSION "+S.VERSION+" not supported!");return}t.updated=performance.now(),t.timeToLoad=S.TTL;var A=S["RELOAD-URI"],x=S["PATHWAY-CLONES"],L=S["PATHWAY-PRIORITY"];if(A)try{t.uri=new self.URL(A,l).href}catch{t.enabled=!1,t.log("Failed to parse Steering Manifest RELOAD-URI: "+A);return}t.scheduleRefresh(t.uri||E.url),x&&t.clonePathways(x);var I={steeringManifest:S,url:l.toString()};t.hls.trigger(p.STEERING_MANIFEST_LOADED,I),L&&t.updatePathwayPriority(L)},onError:function(m,y,E,T){if(t.log("Error loading steering manifest: "+m.code+" "+m.text+" ("+y.url+")"),t.stopLoad(),m.code===410){t.enabled=!1,t.log("Steering manifest "+y.url+" no longer available");return}var S=t.timeToLoad*1e3;if(m.code===429){var A=t.loader;if(typeof(A==null?void 0:A.getResponseHeader)=="function"){var x=A.getResponseHeader("Retry-After");x&&(S=parseFloat(x)*1e3)}t.log("Steering manifest "+y.url+" rate limited");return}t.scheduleRefresh(t.uri||y.url,S)},onTimeout:function(m,y,E){t.log("Timeout loading steering manifest ("+y.url+")"),t.scheduleRefresh(t.uri||y.url)}};this.log("Requesting steering manifest: "+l),this.loader.load(f,c,v)},n.scheduleRefresh=function(e,t){var i=this;t===void 0&&(t=this.timeToLoad*1e3),this.clearTimeout(),this.reloadTimer=self.setTimeout(function(){var s,l=(s=i.hls)==null?void 0:s.media;if(l&&!l.ended){i.loadSteeringManifest(e);return}i.scheduleRefresh(e,i.timeToLoad*1e3)},t)},z(o,[{key:"pathwayPriority",get:function(){return this._pathwayPriority},set:function(e){this.updatePathwayPriority(e)}}])}(ie);function Do(a,o,n,r){a&&Object.keys(o).forEach(function(e){var t=a.filter(function(i){return i.groupId===e}).map(function(i){var s=ae({},i);return s.details=void 0,s.attrs=new et(s.attrs),s.url=s.attrs.URI=ko(i.url,i.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",n),s.groupId=s.attrs["GROUP-ID"]=o[e],s.attrs["PATHWAY-ID"]=r,s});a.push.apply(a,t)})}function ko(a,o,n,r){var e=r.HOST,t=r.PARAMS,i=r[n],s;o&&(s=i==null?void 0:i[o],s&&(a=s));var l=new self.URL(a);return e&&!s&&(l.host=e),t&&Object.keys(t).sort().forEach(function(u){u&&l.searchParams.set(u,t[u])}),l.href}var Co=function(a){function o(r){var e;return e=a.call(this,"eme",r.logger)||this,e.hls=void 0,e.config=void 0,e.media=null,e.keyFormatPromise=null,e.keySystemAccessPromises={},e._requestLicenseFailureCount=0,e.mediaKeySessions=[],e.keyIdToKeySessionPromise={},e.setMediaKeysQueue=o.CDMCleanupPromise?[o.CDMCleanupPromise]:[],e.onMediaEncrypted=function(t){var i=t.initDataType,s=t.initData,l='"'+t.type+'" event: init data type: "'+i+'"';if(e.debug(l),s!==null){if(!e.keyFormatPromise){var u=Object.keys(e.keySystemAccessPromises);u.length||(u=ki(e.config));var f=u.map(In).filter(function(d){return!!d});e.keyFormatPromise=e.getKeyFormatPromise(f)}e.keyFormatPromise.then(function(d){var h=bn(d),c,v;if(i==="sinf"){if(h!==De.FAIRPLAY){e.warn('Ignoring unexpected "'+t.type+'" event with init data type: "'+i+'" for selected key-system '+h);return}var g=je(new Uint8Array(s));try{var m=xn(JSON.parse(g).sinf),y=Na(m);if(!y)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");c=new Uint8Array(y.subarray(8,24)),v=De.FAIRPLAY}catch(U){e.warn(l+" Failed to parse sinf: "+U);return}}else{if(h!==De.WIDEVINE&&h!==De.PLAYREADY){e.warn('Ignoring unexpected "'+t.type+'" event with init data type: "'+i+'" for selected key-system '+h);return}var E=Fl(s),T=E.filter(function(U){return!!U.systemId&&Rn(U.systemId)===h});T.length>1&&e.warn(l+" Using first of "+T.length+" pssh found for selected key-system "+h);var S=T[0];if(!S){E.length===0||E.some(function(U){return!U.systemId})?e.warn(l+" contains incomplete or invalid pssh data"):e.log("ignoring "+l+" for "+E.map(function(U){return Rn(U.systemId)}).join(",")+" pssh data in favor of playlist keys");return}if(v=Rn(S.systemId),S.version===0&&S.data)if(v===De.WIDEVINE){var A=S.data.length-22;c=new Uint8Array(S.data.subarray(A,A+16))}else v===De.PLAYREADY&&(c=ys(S.data))}if(!(!v||!c)){for(var x=Ne.hexDump(c),L=e,I=L.keyIdToKeySessionPromise,k=L.mediaKeySessions,R=I[x],b=function(){var F=k[P],M=F.decryptdata;if(!M.keyId)return 0;var H=Ne.hexDump(M.keyId);if(x===H||M.uri.replace(/-/g,"").indexOf(x)!==-1)return R=I[H],M.pssh||(delete I[H],M.pssh=new Uint8Array(s),M.keyId=c,R=I[x]=R.then(function(){return e.generateRequestWithPreferredKeySession(F,i,s,"encrypted-event-key-match")}),R.catch(function(q){return e.handleError(q)})),1},D,P=0;P<k.length&&(D=b(),!(D!==0&&D===1));P++);if(!R){if(v!==h){e.log('Ignoring "'+t.type+'" event with '+v+" init data for selected key-system "+h);return}R=I[x]=e.getKeySystemSelectionPromise([v]).then(function(U){var F,M=U.keySystem,H=U.mediaKeys;e.throwIfDestroyed();var q=new _n("ISO-23001-7",x,(F=In(M))!=null?F:"");return q.pssh=new Uint8Array(s),q.keyId=c,e.attemptSetMediaKeys(M,H).then(function(){e.throwIfDestroyed();var W=e.createMediaKeySessionContext({decryptdata:q,keySystem:M,mediaKeys:H});return e.generateRequestWithPreferredKeySession(W,i,s,"encrypted-event-no-match")})}),R.catch(function(U){return e.handleError(U)})}}})}},e.onWaitingForKey=function(t){e.log('"'+t.type+'" event')},e.hls=r,e.config=r.config,e.registerListeners(),e}J(o,a);var n=o.prototype;return n.destroy=function(){var e=this.media;this.unregisterListeners(),this.onMediaDetached(),this._clear(e);var t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onMediaEncrypted=this.onWaitingForKey=null},n.registerListeners=function(){this.hls.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(p.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(p.MANIFEST_LOADED,this.onManifestLoaded,this)},n.unregisterListeners=function(){this.hls.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(p.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(p.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(p.MANIFEST_LOADED,this.onManifestLoaded,this)},n.getLicenseServerUrl=function(e){var t=this.config,i=t.drmSystems,s=t.widevineLicenseUrl,l=i[e];if(l)return l.licenseUrl;if(e===De.WIDEVINE&&s)return s},n.getLicenseServerUrlOrThrow=function(e){var t=this.getLicenseServerUrl(e);if(t===void 0)throw new Error('no license server URL configured for key-system "'+e+'"');return t},n.getServerCertificateUrl=function(e){var t=this.config.drmSystems,i=t[e];if(i)return i.serverCertificateUrl;this.log('No Server Certificate in config.drmSystems["'+e+'"]')},n.attemptKeySystemAccess=function(e){var t=this,i=this.hls.levels,s=function(d,h,c){return!!d&&c.indexOf(d)===h},l=i.map(function(f){return f.audioCodec}).filter(s),u=i.map(function(f){return f.videoCodec}).filter(s);return l.length+u.length===0&&u.push("avc1.42e01e"),new Promise(function(f,d){var h=function(v){var g=v.shift();t.getMediaKeysPromise(g,l,u).then(function(m){return f({keySystem:g,mediaKeys:m})}).catch(function(m){v.length?h(v):m instanceof Ht?d(m):d(new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_ACCESS,error:m,fatal:!0},m.message))})};h(e)})},n.requestMediaKeySystemAccess=function(e,t){var i=this.config.requestMediaKeySystemAccessFunc;if(typeof i!="function"){var s="Configured requestMediaKeySystemAccess is not a function "+i;return ps===null&&self.location.protocol==="http:"&&(s="navigator.requestMediaKeySystemAccess is not available over insecure protocol "+location.protocol),Promise.reject(new Error(s))}return i(e,t)},n.getMediaKeysPromise=function(e,t,i){var s=this,l=Iu(e,t,i,this.config.drmSystemOptions),u=this.keySystemAccessPromises[e],f=u==null?void 0:u.keySystemAccess;if(!f){this.log('Requesting encrypted media "'+e+'" key-system access with config: '+He(l)),f=this.requestMediaKeySystemAccess(e,l);var d=this.keySystemAccessPromises[e]={keySystemAccess:f};return f.catch(function(h){s.log('Failed to obtain access to key-system "'+e+'": '+h)}),f.then(function(h){s.log('Access for key-system "'+h.keySystem+'" obtained');var c=s.fetchServerCertificate(e);return s.log('Create media-keys for "'+e+'"'),d.mediaKeys=h.createMediaKeys().then(function(v){return s.log('Media-keys created for "'+e+'"'),c.then(function(g){return g?s.setMediaKeysServerCertificate(v,e,g):v})}),d.mediaKeys.catch(function(v){s.error('Failed to create media-keys for "'+e+'"}: '+v)}),d.mediaKeys})}return f.then(function(){return u.mediaKeys})},n.createMediaKeySessionContext=function(e){var t=e.decryptdata,i=e.keySystem,s=e.mediaKeys;this.log('Creating key-system session "'+i+'" keyId: '+Ne.hexDump(t.keyId||[]));var l=s.createSession(),u={decryptdata:t,keySystem:i,mediaKeys:s,mediaKeysSession:l,keyStatus:"status-pending"};return this.mediaKeySessions.push(u),u},n.renewKeySession=function(e){var t=e.decryptdata;if(t.pssh){var i=this.createMediaKeySessionContext(e),s=this.getKeyIdString(t),l="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,l,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)},n.getKeyIdString=function(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return Ne.hexDump(e.keyId)},n.updateKeySession=function(e,t){var i,s=e.mediaKeysSession;return this.log('Updating key-session "'+s.sessionId+'" for keyID '+Ne.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])+`
      } (data length: `+(t&&t.byteLength)+")"),s.update(t)},n.selectKeySystemFormat=function(e){var t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: "+e.sn+" "+e.type+": "+e.level+") key formats "+t.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise},n.getKeyFormatPromise=function(e){var t=this;return new Promise(function(i,s){var l=ki(t.config),u=e.map(bn).filter(function(f){return!!f&&l.indexOf(f)!==-1});return t.getKeySystemSelectionPromise(u).then(function(f){var d=f.keySystem,h=In(d);h?i(h):s(new Error('Unable to find format for key-system "'+d+'"'))}).catch(s)})},n.loadKey=function(e){var t=this,i=e.keyInfo.decryptdata,s=this.getKeyIdString(i),l="(keyId: "+s+' format: "'+i.keyFormat+'" method: '+i.method+" uri: "+i.uri+")";this.log("Starting session for key "+l);var u=this.keyIdToKeySessionPromise[s];if(!u){u=this.getKeySystemForKeyPromise(i).then(function(d){var h=d.keySystem,c=d.mediaKeys;return t.throwIfDestroyed(),t.log("Handle encrypted media sn: "+e.frag.sn+" "+e.frag.type+": "+e.frag.level+" using key "+l),t.attemptSetMediaKeys(h,c).then(function(){return t.throwIfDestroyed(),t.createMediaKeySessionContext({keySystem:h,mediaKeys:c,decryptdata:i})})});var f=this.keyIdToKeySessionPromise[s]=u.then(function(d){var h="cenc",c=i.pssh?i.pssh.buffer:null;return t.generateRequestWithPreferredKeySession(d,h,c,"playlist-key")});f.catch(function(d){return t.handleError(d)})}return u},n.throwIfDestroyed=function(e){if(!this.hls)throw new Error("invalid state")},n.handleError=function(e){this.hls&&(this.error(e.message),e instanceof Ht?this.hls.trigger(p.ERROR,e.data):this.hls.trigger(p.ERROR,{type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))},n.getKeySystemForKeyPromise=function(e){var t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){var s=bn(e.keyFormat),l=s?[s]:ki(this.config);return this.attemptKeySystemAccess(l)}return i},n.getKeySystemSelectionPromise=function(e){if(e.length||(e=ki(this.config)),e.length===0)throw new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options "+He({drmSystems:this.config.drmSystems}));return this.attemptKeySystemAccess(e)},n.attemptSetMediaKeys=function(e,t){var i=this,s=this.setMediaKeysQueue.slice();this.log('Setting media-keys for "'+e+'"');var l=Promise.all(s).then(function(){if(!i.media)throw new Error("Attempted to set mediaKeys without media element attached");return i.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(l),l.then(function(){i.log('Media-keys set for "'+e+'"'),s.push(l),i.setMediaKeysQueue=i.setMediaKeysQueue.filter(function(u){return s.indexOf(u)===-1})})},n.generateRequestWithPreferredKeySession=function(e,t,i,s){var l,u,f=this,d=(l=this.config.drmSystems)==null||(u=l[e.keySystem])==null?void 0:u.generateRequest;if(d)try{var h=d.call(this.hls,t,i,e);if(!h)throw new Error("Invalid response from configured generateRequest filter");t=h.initDataType,i=h.initData?h.initData:null,e.decryptdata.pssh=i?new Uint8Array(i):null}catch(T){var c;if(this.warn(T.message),(c=this.hls)!=null&&c.config.debug)throw T}if(i===null)return this.log('Skipping key-session request for "'+s+'" (no initData)'),Promise.resolve(e);var v=this.getKeyIdString(e.decryptdata);this.log('Generating key-session request for "'+s+'": '+v+" (init data type: "+t+" length: "+(i?i.byteLength:null)+")");var g=new ce,m=e._onmessage=function(T){var S=e.mediaKeysSession;if(!S){g.emit("error",new Error("invalid state"));return}var A=T.messageType,x=T.message;f.log('"'+A+'" message event for session "'+S.sessionId+'" message size: '+x.byteLength),A==="license-request"||A==="license-renewal"?f.renewLicense(e,x).catch(function(L){g.eventNames().length?g.emit("error",L):f.handleError(L)}):A==="license-release"?e.keySystem===De.FAIRPLAY&&(f.updateKeySession(e,Ln("acknowledged")),f.removeSession(e)):f.warn('unhandled media key message type "'+A+'"')},y=e._onkeystatuseschange=function(T){var S=e.mediaKeysSession;if(!S){g.emit("error",new Error("invalid state"));return}f.onKeyStatusChange(e);var A=e.keyStatus;g.emit("keyStatus",A),A==="expired"&&(f.warn(e.keySystem+" expired for key "+v),f.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",m),e.mediaKeysSession.addEventListener("keystatuseschange",y);var E=new Promise(function(T,S){g.on("error",S),g.on("keyStatus",function(A){A.startsWith("usable")?T():A==="output-restricted"?S(new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):A==="internal-error"?S(new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},'key status changed to "'+A+'"')):A==="expired"?S(new Error("key expired while generating request")):f.warn('unhandled key status change "'+A+'"')})});return e.mediaKeysSession.generateRequest(t,i).then(function(){var T;f.log('Request generated for key-session "'+((T=e.mediaKeysSession)==null?void 0:T.sessionId)+'" keyId: '+v)}).catch(function(T){throw new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_NO_SESSION,error:T,fatal:!1},"Error generating key-session request: "+T)}).then(function(){return E}).catch(function(T){throw g.removeAllListeners(),f.removeSession(e),T}).then(function(){return g.removeAllListeners(),e})},n.onKeyStatusChange=function(e){var t=this;e.mediaKeysSession.keyStatuses.forEach(function(i,s){if(typeof s=="string"&&typeof i=="object"){var l=s;s=i,i=l}t.log('key status change "'+i+'" for keyStatuses keyId: '+Ne.hexDump("buffer"in s?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):new Uint8Array(s))+" session keyId: "+Ne.hexDump(new Uint8Array(e.decryptdata.keyId||[]))+" uri: "+e.decryptdata.uri),e.keyStatus=i})},n.fetchServerCertificate=function(e){var t=this.config,i=t.loader,s=new i(t),l=this.getServerCertificateUrl(e);return l?(this.log('Fetching server certificate for "'+e+'"'),new Promise(function(u,f){var d={responseType:"arraybuffer",url:l},h=t.certLoadPolicy.default,c={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},v={onSuccess:function(m,y,E,T){u(m.data)},onError:function(m,y,E,T){f(new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:E,response:Q({url:d.url,data:void 0},m)},'"'+e+'" certificate request failed ('+l+"). Status: "+m.code+" ("+m.text+")"))},onTimeout:function(m,y,E){f(new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:E,response:{url:d.url,data:void 0}},'"'+e+'" certificate request timed out ('+l+")"))},onAbort:function(m,y,E){f(new Error("aborted"))}};s.load(d,c,v)})):Promise.resolve()},n.setMediaKeysServerCertificate=function(e,t,i){var s=this;return new Promise(function(l,u){e.setServerCertificate(i).then(function(f){s.log("setServerCertificate "+(f?"success":"not supported by CDM")+" ("+(i==null?void 0:i.byteLength)+') on "'+t+'"'),l(e)}).catch(function(f){u(new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:f,fatal:!0},f.message))})})},n.renewLicense=function(e,t){var i=this;return this.requestLicense(e,new Uint8Array(t)).then(function(s){return i.updateKeySession(e,new Uint8Array(s)).catch(function(l){throw new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:l,fatal:!0},l.message)})})},n.unpackPlayReadyKeyMessage=function(e,t){var i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;var s=new DOMParser().parseFromString(i,"application/xml"),l=s.querySelectorAll("HttpHeader");if(l.length>0)for(var u,f=0,d=l.length;f<d;f++){var h,c;u=l[f];var v=(h=u.querySelector("name"))==null?void 0:h.textContent,g=(c=u.querySelector("value"))==null?void 0:c.textContent;v&&g&&e.setRequestHeader(v,g)}var m=s.querySelector("Challenge"),y=m==null?void 0:m.textContent;if(!y)throw new Error("Cannot find <Challenge> in key message");return Ln(atob(y))},n.setupLicenseXHR=function(e,t,i,s){var l=this,u=this.config.licenseXhrSetup;return u?Promise.resolve().then(function(){if(!i.decryptdata)throw new Error("Key removed");return u.call(l.hls,e,t,i,s)}).catch(function(f){if(!i.decryptdata)throw f;return e.open("POST",t,!0),u.call(l.hls,e,t,i,s)}).then(function(f){e.readyState||e.open("POST",t,!0);var d=f||s;return{xhr:e,licenseChallenge:d}}):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:s}))},n.requestLicense=function(e,t){var i=this,s=this.config.keyLoadPolicy.default;return new Promise(function(l,u){var f=i.getLicenseServerUrlOrThrow(e.keySystem);i.log("Sending license request to URL: "+f);var d=new XMLHttpRequest;d.responseType="arraybuffer",d.onreadystatechange=function(){if(!i.hls||!e.mediaKeysSession)return u(new Error("invalid state"));if(d.readyState===4)if(d.status===200){i._requestLicenseFailureCount=0;var h=d.response;i.log("License received "+(h instanceof ArrayBuffer?h.byteLength:h));var c=i.config.licenseResponseCallback;if(c)try{h=c.call(i.hls,d,f,e)}catch(y){i.error(y)}l(h)}else{var v=s.errorRetry,g=v?v.maxNumRetry:0;if(i._requestLicenseFailureCount++,i._requestLicenseFailureCount>g||d.status>=400&&d.status<500)u(new Ht({type:V.KEY_SYSTEM_ERROR,details:_.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:d,response:{url:f,data:void 0,code:d.status,text:d.statusText}},"License Request XHR failed ("+f+"). Status: "+d.status+" ("+d.statusText+")"));else{var m=g-i._requestLicenseFailureCount+1;i.warn("Retrying license request, "+m+" attempts left"),i.requestLicense(e,t).then(l,u)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=d,i.setupLicenseXHR(d,f,e,t).then(function(h){var c=h.xhr,v=h.licenseChallenge;e.keySystem==De.PLAYREADY&&(v=i.unpackPlayReadyKeyMessage(c,v)),c.send(v)})})},n.onMediaAttached=function(e,t){if(this.config.emeEnabled){var i=t.media;this.media=i,i.removeEventListener("encrypted",this.onMediaEncrypted),i.removeEventListener("waitingforkey",this.onWaitingForKey),i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}},n.onMediaDetached=function(){var e=this.media;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null)},n._clear=function(e){var t=this,i,s=this.mediaKeySessions;this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},_n.clearKeyUriToKeyIdMap();var l=s.length;o.CDMCleanupPromise=Promise.all(s.map(function(u){return t.removeSession(u)}).concat(e==null||(i=e.setMediaKeys(null))==null?void 0:i.catch(function(u){var f;t.log("Could not clear media keys: "+u),(f=t.hls)==null||f.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error("Could not clear media keys: "+u)})}))).then(function(){l&&(t.log("finished closing key sessions and clearing media keys"),s.length=0)}).catch(function(u){var f;t.log("Could not close sessions and clear media keys: "+u),(f=t.hls)==null||f.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error("Could not close sessions and clear media keys: "+u)})})},n.onManifestLoading=function(){this.keyFormatPromise=null},n.onManifestLoaded=function(e,t){var i=t.sessionKeys;if(!(!i||!this.config.emeEnabled)&&!this.keyFormatPromise){var s=i.reduce(function(l,u){return l.indexOf(u.keyFormat)===-1&&l.push(u.keyFormat),l},[]);this.log("Selecting key-system from session-keys "+s.join(", ")),this.keyFormatPromise=this.getKeyFormatPromise(s)}},n.removeSession=function(e){var t=this,i=e.mediaKeysSession,s=e.licenseXhr;if(i){this.log("Remove licenses and keys and close session "+i.sessionId),e._onmessage&&(i.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(i.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),s&&s.readyState!==XMLHttpRequest.DONE&&s.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;var l=this.mediaKeySessions.indexOf(e);l>-1&&this.mediaKeySessions.splice(l,1);var u=this.config.drmSystemOptions,f=Du(u)?new Promise(function(d,h){self.setTimeout(function(){return h(new Error("MediaKeySession.remove() timeout"))},8e3),i.remove().then(d)}):Promise.resolve();return f.catch(function(d){var h;t.log("Could not remove session: "+d),(h=t.hls)==null||h.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error("Could not remove session: "+d)})}).then(function(){return i.close()}).catch(function(d){var h;t.log("Could not close session: "+d),(h=t.hls)==null||h.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error("Could not close session: "+d)})})}},o}(ie);Co.CDMCleanupPromise=void 0;var Ht=function(a){function o(n,r){var e;return e=a.call(this,r)||this,e.data=void 0,n.error||(n.error=new Error(r)),e.data=n,n.err=n.error,e}return J(o,a),o}(dt(Error)),Gd=function(){function a(n){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=n,this.registerListeners()}var o=a.prototype;return o.setStreamController=function(r){this.streamController=r},o.registerListeners=function(){this.hls.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(p.MEDIA_DETACHING,this.onMediaDetaching,this)},o.unregisterListeners=function(){this.hls.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(p.MEDIA_DETACHING,this.onMediaDetaching,this)},o.destroy=function(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null},o.onMediaAttaching=function(r,e){var t=this.hls.config;if(t.capLevelOnFPSDrop){var i=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=i,i&&typeof i.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),t.fpsDroppedMonitoringPeriod)}},o.onMediaDetaching=function(){this.media=null},o.checkFPS=function(r,e,t){var i=performance.now();if(e){if(this.lastTime){var s=i-this.lastTime,l=t-this.lastDroppedFrames,u=e-this.lastDecodedFrames,f=1e3*l/s,d=this.hls;if(d.trigger(p.FPS_DROP,{currentDropped:l,currentDecoded:u,totalDroppedFrames:t}),f>0&&l>d.config.fpsDroppedMonitoringThreshold*u){var h=d.currentLevel;d.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+h),h>0&&(d.autoLevelCapping===-1||d.autoLevelCapping>=h)&&(h=h-1,d.trigger(p.FPS_DROP_LEVEL_CAPPING,{level:h,droppedLevel:d.currentLevel}),d.autoLevelCapping=h,this.streamController.nextLevelSwitch())}}this.lastTime=i,this.lastDroppedFrames=t,this.lastDecodedFrames=e}},o.checkFPSInterval=function(){var r=this.media;if(r)if(this.isVideoPlaybackQualityAvailable){var e=r.getVideoPlaybackQuality();this.checkFPS(r,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(r,r.webkitDecodedFrameCount,r.webkitDroppedFrameCount)},a}();function oi(a){for(var o=5381,n=a.length;n;)o=o*33^a.charCodeAt(--n);return(o>>>0).toString()}var Gr=.025,Ki=function(a){return a[a.Point=0]="Point",a[a.Range=1]="Range",a}({});function Kd(a,o,n){return a.identifier+"-"+(n+1)+"-"+oi(o)}var Hd=function(){function a(n,r){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=r,this.dateRange=n,this.setDateRange(n)}var o=a.prototype;return o.setDateRange=function(r){this.dateRange=r,this.resumeOffset=r.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=r.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=r.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=r.attr.enumeratedStringList("X-SNAP",this.snapOptions)},o.reset=function(){var r;this.appendInPlaceStarted=!1,(r=this.assetListLoader)==null||r.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)},o.isAssetPastPlayoutLimit=function(r){if(r>=this.assetList.length)return!0;var e=this.playoutLimit;if(r<=0||isNaN(e))return!1;var t=this.assetList[r].startOffset;return t>e},o.findAssetIndex=function(r){var e=this.assetList.indexOf(r);return e},o.toString=function(){return Vd(this)},z(a,[{key:"identifier",get:function(){return this.dateRange.id}},{key:"startDate",get:function(){return this.dateRange.startDate}},{key:"startTime",get:function(){var r=this.dateRange.startTime;if(this.snapOptions.out){var e=this.dateRange.tagAnchor;if(e)return ra(r,e)}return r}},{key:"startOffset",get:function(){return this.cue.pre?0:this.startTime}},{key:"startIsAligned",get:function(){if(this.startTime===0||this.snapOptions.out)return!0;var r=this.dateRange.tagAnchor;if(r){var e=this.dateRange.startTime,t=ra(e,r);return e-t<.1}return!1}},{key:"resumptionOffset",get:function(){var r=this.resumeOffset,e=N(r)?r:this.duration;return this.cumulativeDuration+e}},{key:"resumeTime",get:function(){var r=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){var e=this.resumeAnchor;if(e)return ra(r,e)}return r}},{key:"appendInPlace",get:function(){return this.appendInPlaceStarted?!0:this.appendInPlaceDisabled?!1:!!(!this.cue.once&&!this.cue.pre&&this.startIsAligned&&(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<Gr))},set:function(r){if(this.appendInPlaceStarted){this.resetOnResume=!r;return}this.appendInPlaceDisabled=!r}},{key:"timelineStart",get:function(){return this._timelineStart!==null?this._timelineStart:this.startTime},set:function(r){this._timelineStart=r}},{key:"duration",get:function(){var r=this.playoutLimit,e;return this._duration!==null?e=this._duration:this.dateRange.duration?e=this.dateRange.duration:e=this.dateRange.plannedDuration||0,!isNaN(r)&&r<e&&(e=r),e},set:function(r){this._duration=r}},{key:"cue",get:function(){return this.dateRange.cue}},{key:"timelineOccupancy",get:function(){return this.dateRange.attr["X-TIMELINE-OCCUPIES"]==="RANGE"?Ki.Range:Ki.Point}},{key:"supplementsPrimary",get:function(){return this.dateRange.attr["X-TIMELINE-STYLE"]==="PRIMARY"}},{key:"contentMayVary",get:function(){return this.dateRange.attr["X-CONTENT-MAY-VARY"]!=="NO"}},{key:"assetUrl",get:function(){return this.dateRange.attr["X-ASSET-URI"]}},{key:"assetListUrl",get:function(){return this.dateRange.attr["X-ASSET-LIST"]}},{key:"baseUrl",get:function(){return this.base.url}},{key:"assetListLoaded",get:function(){return this.assetList.length>0||this.assetListResponse!==null}}])}();function ra(a,o){return a-o.start<o.duration/2&&!(Math.abs(a-(o.start+o.duration))<Gr)?o.start:o.start+o.duration}function Po(a,o,n){var r=new self.URL(a,n);return r.protocol!=="data:"&&r.searchParams.set("_HLS_primary_id",o),r}function Vd(a){return'["'+a.identifier+'" '+(a.cue.pre?"<pre>":a.cue.post?"<post>":"")+a.timelineStart.toFixed(2)+"-"+a.resumeTime.toFixed(2)+"]"}function ia(a){var o=a.timelineStart,n=a.duration||0;return'["'+a.identifier+'" '+o.toFixed(2)+"-"+(o+n).toFixed(2)+"]"}var Wd=function(){function a(n,r,e,t){var i=this;this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=function(){var f=i.interstitial,d=f.playoutLimit,h=i.currentTime;i.startOffset+h>=d&&i.hls.trigger(p.PLAYOUT_LIMIT_REACHED,{})};var s=this.hls=new n(r);this.interstitial=e,this.assetItem=t;var l=t.uri;try{l=Po(l,s.sessionId).href}catch{}s.loadSource(l);var u=function(){i.hasDetails=!0};s.once(p.LEVEL_LOADED,u),s.once(p.AUDIO_TRACK_LOADED,u),s.once(p.SUBTITLE_TRACK_LOADED,u),s.on(p.MEDIA_ATTACHING,function(f,d){var h=d.media;i.removeMediaListeners(),i.mediaAttached=h;var c=i.interstitial;c.playoutLimit&&h.addEventListener("timeupdate",i.checkPlayout)})}var o=a.prototype;return o.bufferedInPlaceToEnd=function(r){var e;if(!this.interstitial.appendInPlace)return!1;if((e=this.hls)!=null&&e.bufferedToEnd)return!0;if(!r||!this._bufferedEosTime)return!1;var t=this.timelineOffset,i=Se.bufferInfo(r,t,0),s=this.getAssetTime(i.end);return s>=this._bufferedEosTime-.02},o.getAssetTime=function(r){var e=this.timelineOffset,t=this.duration;return Math.min(Math.max(0,r-e),t)},o.removeMediaListeners=function(){var r=this.mediaAttached;r&&(this._currentTime=r.currentTime,this.bufferSnapShot(),r.removeEventListener("timeupdate",this.checkPlayout))},o.bufferSnapShot=function(){if(this.mediaAttached){var r;(r=this.hls)!=null&&r.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}},o.destroy=function(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null},o.attachMedia=function(r){this.hls.attachMedia(r)},o.detachMedia=function(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()},o.resumeBuffering=function(){this.hls.resumeBuffering()},o.pauseBuffering=function(){this.hls.pauseBuffering()},o.transferMedia=function(){return this.bufferSnapShot(),this.hls.transferMedia()},o.on=function(r,e,t){this.hls.on(r,e)},o.once=function(r,e,t){this.hls.once(r,e)},o.off=function(r,e,t){this.hls.off(r,e)},o.toString=function(){var r,e;return"HlsAssetPlayer: "+ia(this.assetItem)+" "+((r=this.hls)==null?void 0:r.sessionId)+" "+((e=this.interstitial)!=null&&e.appendInPlace?"append-in-place":"")},z(a,[{key:"destroyed",get:function(){var r;return!((r=this.hls)!=null&&r.userConfig)}},{key:"assetId",get:function(){return this.assetItem.identifier}},{key:"interstitialId",get:function(){return this.assetItem.parentIdentifier}},{key:"media",get:function(){var r;return((r=this.hls)==null?void 0:r.media)||null}},{key:"bufferedEnd",get:function(){var r=this.media||this.mediaAttached;if(!r)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;var e=Se.bufferInfo(r,r.currentTime,.001);return this.getAssetTime(e.end)}},{key:"currentTime",get:function(){var r=this.media||this.mediaAttached;return r?this.getAssetTime(r.currentTime):this._currentTime||0}},{key:"duration",get:function(){var r=this.assetItem.duration;return r||0}},{key:"remaining",get:function(){var r=this.duration;return r?Math.max(0,r-this.currentTime):0}},{key:"startOffset",get:function(){return this.assetItem.startOffset}},{key:"timelineOffset",get:function(){var r;return((r=this.hls)==null?void 0:r.config.timelineOffset)||0},set:function(r){var e=this.timelineOffset;if(r!==e){var t=r-e;if(Math.abs(t)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=r}}}}])}(),wo=.033,Yd=function(a){function o(r,e){var t;return t=a.call(this,"interstitials-sched",e)||this,t.onScheduleUpdate=void 0,t.eventMap={},t.events=null,t.items=null,t.durations={primary:0,playout:0,integrated:0},t.onScheduleUpdate=r,t}J(o,a);var n=o.prototype;return n.destroy=function(){this.reset(),this.onScheduleUpdate=null},n.reset=function(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(function(e){return e.reset()}),this.events=this.items=null},n.resetErrorsInRange=function(e,t){return this.events?this.events.reduce(function(i,s){return e<=s.startOffset&&t>s.startOffset?(delete s.error,i+1):i},0):0},n.getEvent=function(e){return e&&this.eventMap[e]||null},n.hasEvent=function(e){return e in this.eventMap},n.findItemIndex=function(e,t){if(e.event)return this.findEventIndex(e.event.identifier);var i=-1;e.nextEvent?i=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(i=this.findEventIndex(e.previousEvent.identifier)+1);var s=this.items;if(s)for(s[i]||(t===void 0&&(t=e.start),i=this.findItemIndexAtTime(t));i>=0&&(l=s[i])!=null&&l.event;){var l;i--}return i},n.findItemIndexAtTime=function(e,t){var i=this.items;if(i)for(var s=0;s<i.length;s++){var l=i[s];if(t&&t!=="primary"&&(l=l[t]),e===l.start||e>l.start&&e<l.end)return s}return-1},n.findJumpRestrictedIndex=function(e,t){var i=this.items;if(i)for(var s=e;s<=t&&i[s];s++){var l=i[s].event;if(l!=null&&l.restrictions.jump&&!l.appendInPlace)return s}return-1},n.findEventIndex=function(e){var t=this.items;if(t)for(var i=t.length;i--;){var s;if(((s=t[i].event)==null?void 0:s.identifier)===e)return i}return-1},n.findAssetIndex=function(e,t){var i=e.assetList,s=i.length;if(s>1)for(var l=0;l<s;l++){var u=i[l];if(!u.error){var f=u.timelineStart;if(t===f||t>f&&t<f+(u.duration||0))return l}}return 0},n.parseInterstitialDateRanges=function(e,t){var i=this,s=e.main.details,l=s.dateRanges,u=this.events,f=this.parseDateRanges(l,{url:s.url},t),d=Object.keys(l),h=u?u.filter(function(c){return!d.includes(c.identifier)}):[];f.length&&f.sort(function(c,v){var g=c.cue.pre,m=c.cue.post,y=v.cue.pre,E=v.cue.post;if(g&&!y)return-1;if(y&&!g||m&&!E)return 1;if(E&&!m)return-1;if(!g&&!y&&!m&&!E){var T=c.startTime,S=v.startTime;if(T!==S)return T-S}return c.dateRange.tagOrder-v.dateRange.tagOrder}),this.events=f,h.forEach(function(c){i.removeEvent(c)}),this.updateSchedule(e,h)},n.updateSchedule=function(e,t){t===void 0&&(t=[]);var i=this.events||[];if(i.length||t.length||this.length<2){var s=this.items,l=this.parseSchedule(i,e),u=t.length||(s==null?void 0:s.length)!==l.length||l.some(function(f,d){return Math.abs(f.playout.start-s[d].playout.start)>.005||Math.abs(f.playout.end-s[d].playout.end)>.005});u&&(this.items=l,this.onScheduleUpdate(t,s))}},n.parseDateRanges=function(e,t,i){for(var s=[],l=Object.keys(e),u=0;u<l.length;u++){var f=l[u],d=e[f];if(d.isInterstitial){var h=this.eventMap[f];h?h.setDateRange(d):(h=new Hd(d,t),this.eventMap[f]=h,i===!1&&(h.appendInPlace=i)),s.push(h)}}return s},n.parseSchedule=function(e,t){var i=[],s=t.main.details,l=s.live?1/0:s.edge,u=0;if(e=e.filter(function(E){return!E.error&&!(E.cue.once&&E.hasPlayed)}),e.length){this.resolveOffsets(e,t);var f=0,d=0;if(e.forEach(function(E,T){var S=E.cue.pre,A=E.cue.post,x=e[T-1]||null,L=E.appendInPlace,I=A?l:E.startOffset,k=E.duration,R=E.timelineOccupancy===Ki.Range?k:0,b=E.resumptionOffset,D=(x==null?void 0:x.startTime)===I,P=I+E.cumulativeDuration,U=L?P+k:I+b;if(S||!A&&I<=0){var F=d;d+=R,E.timelineStart=P;var M=u;u+=k,i.push({event:E,start:P,end:U,playout:{start:M,end:u},integrated:{start:F,end:d}})}else if(I<=l){if(!D){var H=I-f;if(H>wo){var q=f,W=d;d+=H;var ee=u;u+=H;var ye={previousEvent:e[T-1]||null,nextEvent:E,start:q,end:q+H,playout:{start:ee,end:u},integrated:{start:W,end:d}};i.push(ye)}else H>0&&x&&(x.cumulativeDuration+=H,i[i.length-1].end=I)}A&&(U=P),E.timelineStart=P;var le=d;d+=R;var Ae=u;u+=k,i.push({event:E,start:P,end:U,playout:{start:Ae,end:u},integrated:{start:le,end:d}})}else return;var de=E.resumeTime;A||de>l?f=l:f=de}),f<l){var h,c=f,v=d,g=l-f;d+=g;var m=u;u+=g,i.push({previousEvent:((h=i[i.length-1])==null?void 0:h.event)||null,nextEvent:null,start:f,end:c+g,playout:{start:m,end:u},integrated:{start:v,end:d}})}this.setDurations(l,u,d)}else{var y=0;i.push({previousEvent:null,nextEvent:null,start:y,end:l,playout:{start:y,end:l},integrated:{start:y,end:l}}),this.setDurations(l,l,l)}return i},n.setDurations=function(e,t,i){this.durations={primary:e,playout:t,integrated:i}},n.resolveOffsets=function(e,t){var i=this,s=t.main.details,l=s.live?1/0:s.edge,u=0,f=-1;e.forEach(function(d,h){var c=d.cue.pre,v=d.cue.post,g=c?0:v?l:d.startTime;i.updateAssetDurations(d);var m=f===g;if(m?d.cumulativeDuration=u:(u=0,f=g),!v&&d.snapOptions.in&&(d.resumeAnchor=br(null,s.fragments,d.startOffset+d.resumptionOffset,0,0)||void 0),d.appendInPlace&&!d.appendInPlaceStarted){var y=i.primaryCanResumeInPlaceAt(d,t);y||(d.appendInPlace=!1)}if(!d.appendInPlace&&h+1<e.length){var E=e[h+1].startTime-e[h].resumeTime;E<wo&&(e[h+1].appendInPlace=!1,e[h+1].appendInPlace&&i.warn("Could not change append strategy for abutting event "+d))}var T=N(d.resumeOffset)?d.resumeOffset:d.duration;u+=T})},n.primaryCanResumeInPlaceAt=function(e,t){var i=this,s=e.resumeTime,l=e.startTime+e.resumptionOffset;if(Math.abs(s-l)>Gr)return this.log('"'+e.identifier+'" resumption '+s+" not aligned with estimated timeline end "+l),!1;if(!t)return this.log('"'+e.identifier+'" resumption '+s+" can not be aligned with media (none selected)"),!1;var u=Object.keys(t);return!u.some(function(f){var d=t[f].details,h=d.edge;if(s>=h)return i.log('"'+e.identifier+'" resumption '+s+" past "+f+" playlist end "+h),!1;var c=br(null,d.fragments,s);if(!c)return i.log('"'+e.identifier+'" resumption '+s+" does not align with any fragments in "+f+" playlist ("+d.fragStart+"-"+d.fragmentEnd+")"),!0;var v=f==="audio"?.175:0,g=Math.abs(c.start-s)<Gr+v||Math.abs(c.end-s)<Gr+v;return g?!1:(i.log('"'+e.identifier+'" resumption '+s+" not aligned with "+f+" fragment bounds ("+c.start+"-"+c.end+" sn: "+c.sn+" cc: "+c.cc+")"),!0)})},n.updateAssetDurations=function(e){if(e.assetListLoaded){var t=e.timelineStart,i=0,s=!1,l=!1;e.assetList.forEach(function(u,f){var d=t+i;u.startOffset=i,u.timelineStart=d,s||(s=u.duration===null),l||(l=!!u.error);var h=u.error?0:u.duration||0;i+=h}),s&&!l?e.duration=Math.max(i,e.duration):e.duration=i}},n.removeEvent=function(e){e.reset(),delete this.eventMap[e.identifier]},z(o,[{key:"duration",get:function(){var e=this.items;return e?e[e.length-1].end:0}},{key:"length",get:function(){return this.items?this.items.length:0}},{key:"assetIdAtEnd",get:function(){var e,t,i=(e=this.items)==null||(t=e[this.length-1])==null?void 0:t.event;if(i){var s=i.assetList,l=s[s.length-1];if(l)return l.identifier}return null}}])}(ie);function gr(a){return"["+(a.event?'"'+a.event.identifier+'"':"primary")+": "+a.start.toFixed(2)+"-"+a.end.toFixed(2)+"]"}var qd=function(){function a(n){this.hls=void 0,this.hls=n}var o=a.prototype;return o.destroy=function(){this.hls=null},o.loadAssetList=function(r,e){var t=this,i=r.assetListUrl,s;try{s=Po(i,this.hls.sessionId,r.baseUrl)}catch(m){var l=this.assignAssetListError(r,_.ASSET_LIST_LOAD_ERROR,m,i);this.hls.trigger(p.ERROR,l);return}e&&s.protocol!=="data:"&&s.searchParams.set("_HLS_start_offset",""+e);var u=this.hls.config,f=u.loader,d=new f(u),h={responseType:"json",url:s.href},c=u.interstitialAssetListLoadPolicy.default,v={loadPolicy:c,timeout:c.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},g={onSuccess:function(y,E,T,S){var A=y.data,x=A==null?void 0:A.ASSETS;if(!Array.isArray(x)){var L=t.assignAssetListError(r,_.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),T.url,E,S);t.hls.trigger(p.ERROR,L);return}r.assetListResponse=A,t.hls.trigger(p.ASSET_LIST_LOADED,{event:r,assetListResponse:A,networkDetails:S})},onError:function(y,E,T,S){var A=t.assignAssetListError(r,_.ASSET_LIST_LOAD_ERROR,new Error("Error loading X-ASSET-LIST: HTTP status "+y.code+" "+y.text+" ("+E.url+")"),E.url,S,T);t.hls.trigger(p.ERROR,A)},onTimeout:function(y,E,T){var S=t.assignAssetListError(r,_.ASSET_LIST_LOAD_TIMEOUT,new Error("Timeout loading X-ASSET-LIST ("+E.url+")"),E.url,y,T);t.hls.trigger(p.ERROR,S)}};return d.load(h,v,g),this.hls.trigger(p.ASSET_LIST_LOADING,{event:r}),d},o.assignAssetListError=function(r,e,t,i,s,l){return r.error=t,{type:V.NETWORK_ERROR,details:e,fatal:!1,interstitial:r,url:i,error:t,networkDetails:l,stats:s}},a}();function ur(a,o,n){tr(a,o,n),a.addEventListener(o,n)}function tr(a,o,n){a.removeEventListener(o,n)}function Mo(a){a==null||a.play().catch(function(){})}var jd=function(a){function o(r,e){var t;return t=a.call(this,"interstitials",r.logger)||this,t.HlsPlayerClass=void 0,t.hls=void 0,t.assetListLoader=void 0,t.mediaSelection=null,t.altSelection=null,t.media=null,t.detachedData=null,t.requiredTracks=null,t.manager=null,t.playerQueue=[],t.bufferedPos=-1,t.timelinePos=-1,t.schedule=void 0,t.playingItem=null,t.bufferingItem=null,t.waitingItem=null,t.endedItem=null,t.playingAsset=null,t.endedAsset=null,t.bufferingAsset=null,t.shouldPlay=!1,t.onPlay=function(){t.shouldPlay=!0},t.onPause=function(){t.shouldPlay=!1},t.onSeeking=function(){var i=t.currentTime;if(!(i===void 0||t.playbackDisabled)){var s=i-t.timelinePos,l=Math.abs(s)<1/7056e5;if(!l){var u=s<=-.01;t.timelinePos=i,t.bufferedPos=i;var f=t.playingItem;if(!f){t.checkBuffer();return}if(u){var d=t.schedule.resetErrorsInRange(i,i-s);d&&t.updateSchedule()}if(t.checkBuffer(),u&&i<f.start||i>=f.end){var h,c=t.schedule.findItemIndexAtTime(t.timelinePos);if(!t.isInterstitial(f)&&(h=t.media)!=null&&h.paused&&(t.shouldPlay=!1),!u){var v=t.findItemIndex(f);if(c>v){var g=t.schedule.findJumpRestrictedIndex(v+1,c);if(g>v){t.setSchedulePosition(g);return}}}t.setSchedulePosition(c);return}var m=t.playingAsset;if(!m){if(t.playingLastItem&&t.isInterstitial(f)){var y=f.event.assetList[0];y&&(t.endedItem=t.playingItem,t.playingItem=null,t.setScheduleToAssetAtTime(i,y))}return}var E=m.timelineStart,T=m.duration||0;(u&&i<E||i>=E+T)&&t.setScheduleToAssetAtTime(i,m)}}},t.onTimeupdate=function(){var i=t.currentTime;if(!(i===void 0||t.playbackDisabled)){if(i>t.timelinePos)t.timelinePos=i,i>t.bufferedPos&&t.checkBuffer();else return;var s=t.playingItem;if(!(!s||t.playingLastItem)){if(i>=s.end){t.timelinePos=s.end;var l=t.findItemIndex(s);t.setSchedulePosition(l+1)}var u=t.playingAsset;if(u){var f=u.timelineStart+(u.duration||0);i>=f&&t.setScheduleToAssetAtTime(i,u)}}}},t.onScheduleUpdate=function(i,s){var l=t.schedule,u=t.playingItem,f=l.events||[],d=l.items||[],h=l.durations,c=i.map(function(E){return E.identifier}),v=!!(f.length||c.length);if(v&&t.log("INTERSTITIALS_UPDATED ("+f.length+"): "+f+`
Schedule: `+d.map(function(E){return gr(E)})),c.length&&t.log("Removed events "+c),t.playerQueue.forEach(function(E){if(E.interstitial.appendInPlace){var T=E.assetItem.timelineStart,S=E.timelineOffset-T;if(S)try{E.timelineOffset=T}catch(A){Math.abs(S)>Gr&&t.warn(A+' ("'+E.assetId+'" '+E.timelineOffset+"->"+T+")")}}}),u){var g=t.updateItem(u,t.timelinePos);t.itemsMatch(u,g)&&(t.playingItem=g,t.waitingItem=t.endedItem=null)}else t.waitingItem=t.updateItem(t.waitingItem),t.endedItem=t.updateItem(t.endedItem);var m=t.bufferingItem;if(m){var y=t.updateItem(m,t.bufferedPos);t.itemsMatch(m,y)?t.bufferingItem=y:m.event&&(t.bufferingItem=t.playingItem,t.clearInterstitial(m.event,null))}if(i.forEach(function(E){E.assetList.forEach(function(T){t.clearAssetPlayer(T.identifier,null)})}),v||s){if(t.hls.trigger(p.INTERSTITIALS_UPDATED,{events:f.slice(0),schedule:d.slice(0),durations:h,removedIds:c}),t.isInterstitial(u)&&c.includes(u.event.identifier)){t.warn('Interstitial "'+u.event.identifier+'" removed while playing'),t.primaryFallback(u.event);return}t.checkBuffer()}},t.hls=r,t.HlsPlayerClass=e,t.assetListLoader=new qd(r),t.schedule=new Yd(t.onScheduleUpdate,r.logger),t.registerListeners(),t}J(o,a);var n=o.prototype;return n.registerListeners=function(){var e=this.hls;e.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(p.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(p.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(p.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(p.BUFFER_APPENDED,this.onBufferAppended,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(p.MEDIA_ENDED,this.onMediaEnded,this),e.on(p.ERROR,this.onError,this),e.on(p.DESTROYING,this.onDestroying,this)},n.unregisterListeners=function(){var e=this.hls;e&&(e.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(p.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(p.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(p.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(p.BUFFER_CODECS,this.onBufferCodecs,this),e.off(p.BUFFER_APPENDED,this.onBufferAppended,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(p.MEDIA_ENDED,this.onMediaEnded,this),e.off(p.ERROR,this.onError,this),e.off(p.DESTROYING,this.onDestroying,this))},n.startLoad=function(){this.resumeBuffering()},n.stopLoad=function(){this.pauseBuffering()},n.resumeBuffering=function(){var e;(e=this.getBufferingPlayer())==null||e.resumeBuffering()},n.pauseBuffering=function(){var e;(e=this.getBufferingPlayer())==null||e.pauseBuffering()},n.destroy=function(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null},n.onDestroying=function(){var e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)},n.removeMediaListeners=function(e){tr(e,"play",this.onPlay),tr(e,"pause",this.onPause),tr(e,"seeking",this.onSeeking),tr(e,"timeupdate",this.onTimeupdate)},n.onMediaAttaching=function(e,t){var i=this.media=t.media;ur(i,"seeking",this.onSeeking),ur(i,"timeupdate",this.onTimeupdate),ur(i,"play",this.onPlay),ur(i,"pause",this.onPause)},n.onMediaAttached=function(e,t){var i=this.effectivePlayingItem,s=this.detachedData;if(this.detachedData=null,i===null)this.checkStart();else if(!s){this.clearScheduleState();var l=this.findItemIndex(i);this.setSchedulePosition(l)}},n.clearScheduleState=function(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null},n.onMediaDetaching=function(e,t){var i=!!t.transferMedia,s=this.media;if(this.media=null,!i&&(s&&this.removeMediaListeners(s),this.detachedData)){var l=this.getBufferingPlayer();l&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,l.detachMedia()),this.shouldPlay=!1}},n.isInterstitial=function(e){return!!(e!=null&&e.event)},n.retreiveMediaSource=function(e,t){var i=this.getAssetPlayer(e);i&&this.transferMediaFromPlayer(i,t)},n.transferMediaFromPlayer=function(e,t){var i=e.interstitial.appendInPlace,s=e.media;if(i&&s===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&s){this.detachedData={media:s};return}var l=e.transferMedia();this.log("transfer MediaSource from "+e+" "+He(l)),this.detachedData=l}else t&&s&&(this.shouldPlay||(this.shouldPlay=!s.paused))},n.transferMediaTo=function(e,t){var i,s=this,l;if(e.media!==t){var u=null,f=this.hls,d=e!==f,h=d&&e.interstitial.appendInPlace,c=(i=this.detachedData)==null?void 0:i.mediaSource,v;if(f.media)h&&(u=f.transferMedia(),this.detachedData=u),v="Primary";else if(c){var g=this.getBufferingPlayer();g?(u=g.transferMedia(),v=""+g):v="detached MediaSource"}else v="detached media";if(!u){if(c)u=this.detachedData,this.log("using detachedData: MediaSource "+He(u));else if(!this.detachedData||f.media===t){var m=this.playerQueue;m.length>1&&m.forEach(function(S){if(d&&S.interstitial.appendInPlace!==h){var A=S.interstitial;s.clearInterstitial(S.interstitial,null),A.appendInPlace=!1,A.appendInPlace&&s.warn("Could not change append strategy for queued assets "+A)}}),this.hls.detachMedia(),this.detachedData={media:t}}}var y=u&&"mediaSource"in u&&((l=u.mediaSource)==null?void 0:l.readyState)!=="closed",E=y&&u?u:t;if(this.log((y?"transfering MediaSource":"attaching media")+" to "+(d?e:"Primary")+" from "+v),E===u){var T=d&&e.assetId===this.schedule.assetIdAtEnd;E.overrides={duration:this.schedule.duration,endOfStream:!d||T,cueRemoval:!d}}e.attachMedia(E)}},n.onInterstitialCueEnter=function(){this.onTimeupdate()},n.checkStart=function(){var e=this.schedule,t=e.events;if(!(!t||this.playbackDisabled||!this.media)){this.bufferedPos===-1&&(this.bufferedPos=0);var i=this.timelinePos,s=this.effectivePlayingItem;if(i===-1){var l=this.hls.startPosition;if(this.timelinePos=l,t.length&&t[0].cue.pre){var u=e.findEventIndex(t[0].identifier);this.setSchedulePosition(u)}else if(l>=0||!this.primaryLive){var f=this.timelinePos=l>0?l:0,d=e.findItemIndexAtTime(f);this.setSchedulePosition(d)}}else if(s&&!this.playingItem){var h=e.findItemIndex(s);this.setSchedulePosition(h)}}},n.advanceAfterAssetEnded=function(e,t,i){var s=i+1;if(!e.isAssetPastPlayoutLimit(s)&&!e.assetList[s].error)this.setSchedulePosition(t,s);else{var l=this.schedule.items;if(l){var u=t+1,f=l.length;if(u>=f){this.setSchedulePosition(-1);return}var d=e.resumeTime;this.timelinePos<d&&(this.timelinePos=d,this.checkBuffer()),this.setSchedulePosition(u)}}},n.setScheduleToAssetAtTime=function(e,t){var i=this.schedule,s=t.parentIdentifier,l=i.getEvent(s);if(l){var u=i.findEventIndex(s),f=i.findAssetIndex(l,e);this.setSchedulePosition(u,f)}},n.setSchedulePosition=function(e,t){var i=this.schedule.items;if(!(!i||this.playbackDisabled)){this.log("setSchedulePosition "+e+", "+t);var s=e>=0?i[e]:null,l=this.playingItem,u=this.playingLastItem;if(this.isInterstitial(l)){var f,d=l.event,h=this.playingAsset,c=h==null?void 0:h.identifier,v=c?this.getAssetPlayer(c):null;if(v&&c&&(!this.eventItemsMatch(l,s)||t!==void 0&&c!==((f=d.assetList)==null?void 0:f[t].identifier))){var g,m=d.findAssetIndex(h);this.log("INTERSTITIAL_ASSET_ENDED "+(m+1)+"/"+d.assetList.length+" "+ia(h)),this.endedAsset=h,this.playingAsset=null,this.hls.trigger(p.INTERSTITIAL_ASSET_ENDED,{asset:h,assetListIndex:m,event:d,schedule:i.slice(0),scheduleIndex:e,player:v}),this.retreiveMediaSource(c,s),v.media&&!((g=this.detachedData)!=null&&g.mediaSource)&&v.detachMedia()}if(!this.eventItemsMatch(l,s)&&(this.endedItem=l,this.playingItem=null,this.log("INTERSTITIAL_ENDED "+d+" "+gr(l)),d.hasPlayed=!0,this.hls.trigger(p.INTERSTITIAL_ENDED,{event:d,schedule:i.slice(0),scheduleIndex:e}),d.cue.once)){this.updateSchedule();var y=this.schedule.items;if(s&&y){var E=this.schedule.findItemIndex(s);this.advanceSchedule(E,y,t,l,u)}return}}this.advanceSchedule(e,i,t,l,u)}},n.advanceSchedule=function(e,t,i,s,l){var u=this,f=e>=0?t[e]:null,d=this.primaryMedia,h=this.playerQueue;if(h.length&&h.forEach(function(S){var A=S.interstitial,x=u.schedule.findEventIndex(A.identifier);(x<e||x>e+1)&&u.clearInterstitial(A,f)}),this.isInterstitial(f)){this.timelinePos=Math.min(Math.max(this.timelinePos,f.start),f.end);var c=f.event;i===void 0&&(i=this.schedule.findAssetIndex(c,this.timelinePos));var v=this.waitingItem;this.assetsBuffered(f,d)||this.setBufferingItem(f);var g=this.preloadAssets(c,i);if(this.eventItemsMatch(f,v||s)||(this.waitingItem=f,this.log("INTERSTITIAL_STARTED "+gr(f)+" "+(c.appendInPlace?"append in place":"")),this.hls.trigger(p.INTERSTITIAL_STARTED,{event:c,schedule:t.slice(0),scheduleIndex:e})),!c.assetListLoaded){this.log("Waiting for ASSET-LIST to complete loading "+c);return}if(c.assetListLoader&&(c.assetListLoader.destroy(),c.assetListLoader=void 0),!d){this.log("Waiting for attachMedia to start Interstitial "+c);return}this.waitingItem=this.endedItem=null,this.playingItem=f;var m=c.assetList[i];if(!m){var y=t[e+1],E=this.media;y&&E&&!this.isInterstitial(y)&&E.currentTime<y.start&&(E.currentTime=this.timelinePos=y.start),this.advanceAfterAssetEnded(c,e,i||0);return}if(g||(g=this.getAssetPlayer(m.identifier)),g===null||g.destroyed){var T=c.assetList.length;this.warn("asset "+(i+1)+"/"+T+" player destroyed "+c),g=this.createAssetPlayer(c,m,i)}if(!this.eventItemsMatch(f,this.bufferingItem)&&c.appendInPlace&&this.isAssetBuffered(m))return;this.startAssetPlayer(g,i,t,e,d),this.shouldPlay&&Mo(g.media)}else f!==null?(this.resumePrimary(f,e,s),this.shouldPlay&&Mo(this.hls.media)):l&&this.isInterstitial(s)&&(this.endedItem=null,this.playingItem=s,s.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))},n.resumePrimary=function(e,t,i){var s;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log("resuming "+gr(e)),!((s=this.detachedData)!=null&&s.mediaSource)){var l=this.timelinePos;(l<e.start||l>=e.end)&&(l=this.getPrimaryResumption(e,t),this.timelinePos=l),this.attachPrimary(l,e)}if(i){var u=this.schedule.items;u&&(this.log("resumed "+gr(e)),this.hls.trigger(p.INTERSTITIALS_PRIMARY_RESUMED,{schedule:u.slice(0),scheduleIndex:t}),this.checkBuffer())}},n.getPrimaryResumption=function(e,t){var i=e.start;if(this.primaryLive){var s=this.primaryDetails;if(t===0)return this.hls.startPosition;if(s&&(i<s.fragmentStart||i>s.edge))return this.hls.liveSyncPosition||-1}return i},n.isAssetBuffered=function(e){var t=this.getAssetPlayer(e.identifier);if(t!=null&&t.hls)return t.hls.bufferedToEnd;var i=Se.bufferInfo(this.primaryMedia,this.timelinePos,0);return i.end+1>=e.timelineStart+(e.duration||0)},n.attachPrimary=function(e,t,i){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;var s=this.primaryMedia;if(s){var l=this.hls;l.media?this.checkBuffer():(this.transferMediaTo(l,s),i&&this.startLoadingPrimaryAt(e,i)),i||(this.timelinePos=e,this.startLoadingPrimaryAt(e,i))}},n.startLoadingPrimaryAt=function(e,t){var i,s=this.hls;!s.loadingEnabled||!s.media||Math.abs((((i=s.mainForwardBufferInfo)==null?void 0:i.start)||s.media.currentTime)-e)>.5?s.startLoad(e,t):s.bufferingEnabled||s.resumeBuffering()},n.onManifestLoading=function(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(p.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(p.BUFFER_CODECS,this.onBufferCodecs,this)},n.onLevelUpdated=function(e,t){if(t.level!==-1){var i=this.hls.levels[t.level],s=Q(Q({},this.mediaSelection||this.altSelection),{},{main:i});this.mediaSelection=s,this.schedule.parseInterstitialDateRanges(s,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}},n.onAudioTrackUpdated=function(e,t){var i=this.hls.audioTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=Q(Q({},this.altSelection),{},{audio:i});return}var l=Q(Q({},s),{},{audio:i});this.mediaSelection=l},n.onSubtitleTrackUpdated=function(e,t){var i=this.hls.subtitleTracks[t.id],s=this.mediaSelection;if(!s){this.altSelection=Q(Q({},this.altSelection),{},{subtitles:i});return}var l=Q(Q({},s),{},{subtitles:i});this.mediaSelection=l},n.onAudioTrackSwitching=function(e,t){var i=es(t);this.playerQueue.forEach(function(s){return s.hls.setAudioOption(t)||s.hls.setAudioOption(i)})},n.onSubtitleTrackSwitch=function(e,t){var i=es(t);this.playerQueue.forEach(function(s){return s.hls.setSubtitleOption(t)||t.id!==-1&&s.hls.setSubtitleOption(i)})},n.onBufferCodecs=function(e,t){var i=t.tracks;i&&(this.requiredTracks=i)},n.onBufferAppended=function(e,t){this.checkBuffer()},n.onBufferFlushed=function(e,t){var i=this.playingItem;if(i&&!this.itemsMatch(i,this.bufferingItem)&&!this.isInterstitial(i)){var s=this.timelinePos;this.bufferedPos=s,this.checkBuffer()}},n.onBufferedToEnd=function(e){var t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(var i=0;i<t.length;i++){var s=t[i];if(s.cue.post){var l,u=this.schedule.findEventIndex(s.identifier),f=(l=this.schedule.items)==null?void 0:l[u];this.isInterstitial(f)&&this.eventItemsMatch(f,this.bufferingItem)&&this.bufferedToItem(f,0);break}}this.bufferedPos=Number.MAX_VALUE}},n.onMediaEnded=function(e){var t=this.playingItem;if(!this.playingLastItem&&t){var i=this.findItemIndex(t);this.setSchedulePosition(i+1)}else this.shouldPlay=!1},n.updateItem=function(e,t){var i=this.schedule.items;if(e&&i){var s=this.findItemIndex(e,t);return i[s]||null}return null},n.itemsMatch=function(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))},n.eventItemsMatch=function(e,t){var i;return!!t&&(e===t||e.event.identifier===((i=t.event)==null?void 0:i.identifier))},n.findItemIndex=function(e,t){return e?this.schedule.findItemIndex(e,t):-1},n.updateSchedule=function(){var e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])},n.checkBuffer=function(e){var t=this.schedule.items;if(t){var i=Se.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=i.len<1),this.updateBufferedPos(i.end,t,e)}},n.updateBufferedPos=function(e,t,i){var s=this.schedule,l=this.bufferingItem;if(!(this.bufferedPos>e)){if(t.length===1&&this.itemsMatch(t[0],l)){this.bufferedPos=e;return}var u=this.playingItem,f=this.findItemIndex(u),d=s.findItemIndexAtTime(e);if(this.bufferedPos<e){var h,c,v=this.findItemIndex(l),g=Math.min(v+1,t.length-1),m=t[g];if((d===-1&&l&&e>=l.end||(h=m.event)!=null&&h.appendInPlace&&e+.01>=m.start)&&(d=g),g-f>1&&(l==null||(c=l.event)==null?void 0:c.appendInPlace)===!1)return;if(this.bufferedPos=e,d>v&&d>f)this.bufferedToItem(m);else{var y=this.primaryDetails;this.primaryLive&&y&&e>y.edge-y.targetduration&&m.start<y.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(m)&&this.preloadAssets(m.event,0)}}else i&&u&&!this.itemsMatch(u,l)&&(d===f?this.bufferedToItem(u):d===f+1&&this.bufferedToItem(t[d]))}},n.assetsBuffered=function(e,t){var i=this,s=e.event.assetList;return s.length===0?!1:!e.event.assetList.some(function(l){var u=i.getAssetPlayer(l.identifier);return!(u!=null&&u.bufferedInPlaceToEnd(t))})},n.setBufferingItem=function(e){var t=this,i=this.bufferingItem,s=this.schedule;if(this.itemsMatch(e,i))this.bufferingItem!==e&&(this.bufferingItem=e);else{var l=s.items,u=s.events;if(!l||!u)return i;var f=this.isInterstitial(e),d=this.getBufferingPlayer();if(this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos)),!this.playbackDisabled){var h=d?d.remaining:i?i.end-this.timelinePos:0;this.log("buffered to boundary "+gr(e)+(i?" ("+h.toFixed(2)+" remaining)":"")),f?e.event.assetList.forEach(function(c){var v=t.getAssetPlayer(c.identifier);v&&v.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(function(c){return c.pauseBuffering()}))}this.hls.trigger(p.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:u.slice(0),schedule:l.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return i},n.bufferedToItem=function(e,t){t===void 0&&(t=0);var i=this.setBufferingItem(e);if(!this.playbackDisabled){if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(i!==null){this.bufferingAsset=null;var s=this.detachedData;if(s)if(s.mediaSource){var l=!0;this.attachPrimary(e.start,e,l)}else this.preloadPrimary(e);else this.preloadPrimary(e)}}},n.preloadPrimary=function(e){var t=this.findItemIndex(e),i=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(i)},n.bufferedToEvent=function(e,t){var i=e.event,s=i.assetList.length===0&&!i.assetListLoader,l=i.cue.once;if(s||!l){var u=this.preloadAssets(i,t);if(u!=null&&u.interstitial.appendInPlace){var f=i.assetList[t],d=this.primaryMedia;f&&d&&this.bufferAssetPlayer(u,d)}}},n.preloadAssets=function(e,t){var i=e.assetUrl,s=e.assetList.length,l=s===0&&!e.assetListLoader,u=e.cue.once;if(l){var f=e.timelineStart;if(e.appendInPlace){var d,h=this.playingItem;!this.isInterstitial(h)&&(h==null||(d=h.nextEvent)==null?void 0:d.identifier)===e.identifier&&this.flushFrontBuffer(f+.25)}var c,v=0;if(!this.playingItem&&this.primaryLive&&(v=this.hls.startPosition,v===-1&&(v=this.hls.liveSyncPosition||0)),v&&!(e.cue.pre||e.cue.post)){var g=v-f;g>0&&(c=Math.round(g*1e3)/1e3)}if(this.log("Load interstitial asset "+(t+1)+"/"+(i?1:s)+" "+e+(c?" live-start: "+v+" start-offset: "+c:"")),i)return this.createAsset(e,0,0,f,e.duration,i);var m=this.assetListLoader.loadAssetList(e,c);m&&(e.assetListLoader=m)}else if(!u&&s){for(var y=t;y<s;y++){var E=e.assetList[y],T=this.getAssetPlayerQueueIndex(E.identifier);(T===-1||this.playerQueue[T].destroyed)&&!E.error&&this.createAssetPlayer(e,E,y)}return this.getAssetPlayer(e.assetList[t].identifier)}return null},n.flushFrontBuffer=function(e){var t=this,i=this.requiredTracks;if(i){this.log("Removing front buffer starting at "+e);var s=Object.keys(i);s.forEach(function(l){t.hls.trigger(p.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:l})})}},n.getAssetPlayerQueueIndex=function(e){for(var t=this.playerQueue,i=0;i<t.length;i++)if(e===t[i].assetId)return i;return-1},n.getAssetPlayer=function(e){var t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null},n.getBufferingPlayer=function(){var e=this.playerQueue,t=this.primaryMedia;if(t){for(var i=0;i<e.length;i++)if(e[i].media===t)return e[i]}return null},n.createAsset=function(e,t,i,s,l,u){var f={parentIdentifier:e.identifier,identifier:Kd(e,u,t),duration:l,startOffset:i,timelineStart:s,uri:u};return this.createAssetPlayer(e,f,t)},n.createAssetPlayer=function(e,t,i){var s=this;this.log("create HLSAssetPlayer for "+ia(t));var l=this.hls,u=l.userConfig,f=u.videoPreference,d=l.loadLevelObj||l.levels[l.currentLevel];(f||d)&&(f=ae({},f),d.videoCodec&&(f.videoCodec=d.videoCodec),d.videoRange&&(f.allowedVideoRanges=[d.videoRange]));var h=l.audioTracks[l.audioTrack],c=l.subtitleTracks[l.subtitleTrack],v=0;if(this.primaryLive||e.appendInPlace){var g=this.timelinePos-t.timelineStart;if(g>1){var m=t.duration;m&&g<m&&(v=g)}}var y=t.identifier,E=Q(Q({},u),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:l.sessionId,assetPlayerId:y,abrEwmaDefaultEstimate:l.bandwidthEstimate,interstitialsController:void 0,startPosition:v,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:f,audioPreference:h||u.audioPreference,subtitlePreference:c||u.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(E.timelineOffset=t.timelineStart));var T=E.cmcd;T!=null&&T.sessionId&&T.contentId&&(E.cmcd=ae({},T,{contentId:oi(t.uri)})),this.getAssetPlayer(y)&&this.warn("Duplicate date range identifier "+e+" and asset "+y);var S=new Wd(this.HlsPlayerClass,E,e,t);this.playerQueue.push(S),e.assetList[i]=t;var A=function(R){if(R.live){var b=new Error("Interstitials MUST be VOD assets "+e),D={fatal:!0,type:V.OTHER_ERROR,details:_.INTERSTITIAL_ASSET_ITEM_ERROR,error:b};s.handleAssetItemError(D,e,s.schedule.findEventIndex(e.identifier),i,b.message);return}var P=R.edge-R.fragmentStart,U=t.duration;(U===null||P>U)&&(s.log('Interstitial asset "'+y+'" duration change '+U+" > "+P),t.duration=P,s.updateSchedule())};S.on(p.LEVEL_UPDATED,function(k,R){var b=R.details;return A(b)}),S.on(p.LEVEL_PTS_UPDATED,function(k,R){var b=R.details;return A(b)});var x=function(R,b){var D=s.getAssetPlayer(y);if(D&&b.tracks){D.off(p.BUFFER_CODECS,x),D.tracks=b.tracks;var P=s.primaryMedia;s.bufferingAsset===D.assetItem&&P&&!D.media&&s.bufferAssetPlayer(D,P)}};S.on(p.BUFFER_CODECS,x);var L=function(){var R,b=s.getAssetPlayer(y);if(s.log("buffered to end of asset "+b),!!b){var D=s.schedule.findEventIndex(e.identifier),P=e.findAssetIndex(t),U=P+1,F=(R=s.schedule.items)==null?void 0:R[D];if(s.isInterstitial(F))if(P!==-1&&!e.isAssetPastPlayoutLimit(U)&&!e.assetList[U].error)s.bufferedToItem(F,U);else{var M,H=(M=s.schedule.items)==null?void 0:M[D+1];H&&s.bufferedToItem(H)}}};S.on(p.BUFFERED_TO_END,L);var I=function(R){return function(){var b=s.getAssetPlayer(y);if(b){s.shouldPlay=!0;var D=s.schedule.findEventIndex(e.identifier);s.advanceAfterAssetEnded(e,D,R)}}};return S.once(p.MEDIA_ENDED,I(i)),S.once(p.PLAYOUT_LIMIT_REACHED,I(1/0)),S.on(p.ERROR,function(k,R){var b=s.getAssetPlayer(y);if(R.details===_.BUFFER_STALLED_ERROR){if(b!=null&&b.media){var D=b.currentTime,P=b.duration-D;D&&e.appendInPlace&&P/b.media.playbackRate<.5?(s.log("Advancing buffer past end of asset "+y+" "+e+" at "+b.media.currentTime),L()):(s.warn("Stalled at "+D+" of "+(D+P)+" in asset "+y+" "+e),s.onTimeupdate(),s.checkBuffer(!0))}return}s.handleAssetItemError(R,e,s.schedule.findEventIndex(e.identifier),i,"Asset player error "+R.error+" "+e)}),S.on(p.DESTROYING,function(){var k=s.getAssetPlayer(y);if(k){var R=new Error("Asset player destroyed unexpectedly "+y),b={fatal:!0,type:V.OTHER_ERROR,details:_.INTERSTITIAL_ASSET_ITEM_ERROR,error:R};s.handleAssetItemError(b,e,s.schedule.findEventIndex(e.identifier),i,R.message)}}),this.hls.trigger(p.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:i,event:e,player:S}),S},n.clearInterstitial=function(e,t){var i=this;e.assetList.forEach(function(s){i.clearAssetPlayer(s.identifier,t)}),e.reset()},n.clearAssetPlayer=function(e,t){var i=this.getAssetPlayerQueueIndex(e);if(i!==-1){this.log('clearAssetPlayer "'+e+'" toSegment: '+(t&&gr(t)));var s=this.playerQueue[i];this.transferMediaFromPlayer(s,t),this.playerQueue.splice(i,1),s.destroy()}},n.emptyPlayerQueue=function(){for(var e;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]},n.startAssetPlayer=function(e,t,i,s,l){var u=e.interstitial,f=e.assetItem,d=e.assetId,h=u.assetList.length,c=this.playingAsset;this.endedAsset=null,this.playingAsset=f,(!c||c.identifier!==d)&&(c&&(this.clearAssetPlayer(c.identifier,i[s]),delete c.error),this.log("INTERSTITIAL_ASSET_STARTED "+(t+1)+"/"+h+" "+e),this.hls.trigger(p.INTERSTITIAL_ASSET_STARTED,{asset:f,assetListIndex:t,event:u,schedule:i.slice(0),scheduleIndex:s,player:e})),this.bufferAssetPlayer(e,l)},n.bufferAssetPlayer=function(e,t){var i,s,l=e.interstitial,u=e.assetItem,f=e.assetId,d=this.schedule.findEventIndex(l.identifier),h=(i=this.schedule.items)==null?void 0:i[d];if(h){this.setBufferingItem(h),this.bufferingAsset=u;var c=this.getBufferingPlayer();if(c!==e){var v=l.appendInPlace;if(!(v&&(c==null?void 0:c.interstitial.appendInPlace)===!1)){var g=(c==null?void 0:c.tracks)||((s=this.detachedData)==null?void 0:s.tracks)||this.requiredTracks;if(v&&u!==this.playingAsset){if(!e.tracks)return;if(g&&!Rt(g,e.tracks)){var m=new Error('Asset "'+f+`" SourceBuffer tracks ('`+Object.keys(e.tracks)+"') are not compatible with primary content tracks ('"+Object.keys(g)+"')"),y={fatal:!0,type:V.OTHER_ERROR,details:_.INTERSTITIAL_ASSET_ITEM_ERROR,error:m},E=l.findAssetIndex(u);this.handleAssetItemError(y,l,d,E,m.message);return}}this.transferMediaTo(e,t)}}}},n.handleAssetItemError=function(e,t,i,s,l){if(e.details!==_.BUFFER_STALLED_ERROR){var u=t.assetList[s]||null,f=null;if(u){var d=this.getAssetPlayerQueueIndex(u.identifier);f=this.playerQueue[d]||null}var h=this.schedule.items,c=ae({},e,{fatal:!1,errorAction:Jr(!0),asset:u,assetListIndex:s,event:t,schedule:h,scheduleIndex:i,player:f});if(this.warn("Asset item error: "+e.error),this.hls.trigger(p.INTERSTITIAL_ASSET_ERROR,c),!!e.fatal){var v=new Error(l);u&&(this.playingAsset!==u&&this.clearAssetPlayer(u.identifier,null),u.error=v),t.assetList.some(function(g){return!g.error})?t.appendInPlace&&(t.error=v):t.error=v,this.primaryFallback(t)}}},n.primaryFallback=function(e){var t=e.timelineStart,i=this.effectivePlayingItem;if(this.updateSchedule(),i){this.log('Fallback to primary from event "'+e.identifier+'" start: '+t+" pos: "+this.timelinePos+" playing: "+(i?gr(i):"<none>")+" error: "+e.error),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));var s=this.timelinePos;s===-1&&(s=this.hls.startPosition);var l=this.updateItem(i,s);if(this.itemsMatch(i,l))this.clearInterstitial(e,null);else{var u=this.schedule.findItemIndexAtTime(s);this.setSchedulePosition(u)}}else this.checkStart()},n.onAssetListLoaded=function(e,t){var i=this,s,l=t.event,u=l.identifier,f=t.assetListResponse.ASSETS;if(this.schedule.hasEvent(u)){var d=l.timelineStart,h=l.duration,c=0;f.forEach(function(I,k){var R=parseFloat(I.DURATION);i.createAsset(l,k,c,d+c,R,I.URI),c+=R}),l.duration=c,this.log("Loaded asset-list with duration: "+c+" (was: "+h+") "+l);var v=this.waitingItem,g=(v==null?void 0:v.event.identifier)===u;this.updateSchedule();var m=(s=this.bufferingItem)==null?void 0:s.event;if(g){var y,E=this.schedule.findEventIndex(u),T=(y=this.schedule.items)==null?void 0:y[E];if(T){if(!this.playingItem&&this.timelinePos>T.end){var S=this.schedule.findItemIndexAtTime(this.timelinePos);if(S!==E){l.error=new Error("Interstitial no longer within playback range "+this.timelinePos+" "+l),this.primaryFallback(l);return}}this.setBufferingItem(T)}this.setSchedulePosition(E)}else if((m==null?void 0:m.identifier)===u&&m.appendInPlace){var A=l.assetList[0],x=this.getAssetPlayer(A.identifier),L=this.primaryMedia;A&&x&&L&&this.bufferAssetPlayer(x,L)}}},n.onError=function(e,t){switch(t.details){case _.ASSET_LIST_PARSING_ERROR:case _.ASSET_LIST_LOAD_ERROR:case _.ASSET_LIST_LOAD_TIMEOUT:{var i=t.interstitial;i&&this.primaryFallback(i);break}case _.BUFFER_STALLED_ERROR:{this.onTimeupdate(),this.checkBuffer(!0);break}}},z(o,[{key:"interstitialsManager",get:function(){if(!this.manager){if(!this.hls)return null;var e=this,t=function(){return e.bufferingItem||e.waitingItem},i=function(g){return g&&e.getAssetPlayer(g.identifier)},s=function(g,m,y,E,T){if(g){var S=g[m].start,A=g.event;if(A){if(m==="playout"||A.timelineOccupancy!==Ki.Point){var x=i(y);(x==null?void 0:x.interstitial)===A&&(S+=x.assetItem.startOffset+x[T])}}else{var L=E==="bufferedPos"?u():e[E];S+=L-g.start}return S}return 0},l=function(g,m){if(g!==0&&m!=="primary"&&e.schedule.length){var y,E=e.schedule.findItemIndexAtTime(g),T=(y=e.schedule.items)==null?void 0:y[E];if(T){var S=T[m].start-T.start;return g+S}}return g},u=function(){var g=e.bufferedPos;return g===Number.MAX_VALUE?f("primary"):Math.max(g,0)},f=function(g){var m;return(m=e.primaryDetails)!=null&&m.live?e.primaryDetails.edge:e.schedule.durations[g]},d=function(g,m){var y,E,T=e.effectivePlayingItem;if(!(T!=null&&(y=T.event)!=null&&y.restrictions.skip)){e.log("seek to "+g+' "'+m+'"');var S=e.effectivePlayingItem,A=e.schedule.findItemIndexAtTime(g,m),x=(E=e.schedule.items)==null?void 0:E[A],L=e.getBufferingPlayer(),I=L==null?void 0:L.interstitial,k=I==null?void 0:I.appendInPlace,R=S&&e.itemsMatch(S,x);if(S&&(k||R)){var b=i(e.playingAsset),D=(b==null?void 0:b.media)||e.primaryMedia;if(D){var P=m==="primary"?D.currentTime:s(S,m,e.playingAsset,"timelinePos","currentTime"),U=g-P,F=(k?P:D.currentTime)+U;if(F>=0&&(!b||k||F<=b.duration)){D.currentTime=F;return}}}if(x){var M=g;if(m!=="primary"){var H=x[m].start,q=g-H;M=x.start+q}var W=!e.isInterstitial(x);if((!e.isInterstitial(S)||S.event.appendInPlace)&&(W||x.event.appendInPlace)){var ee=e.media||(k?L==null?void 0:L.media:null);ee&&(ee.currentTime=M)}else if(S){var ye=e.findItemIndex(S);if(A>ye){var le=e.schedule.findJumpRestrictedIndex(ye+1,A);if(le>ye){e.setSchedulePosition(le);return}}var Ae=0;if(W)e.timelinePos=M,e.checkBuffer();else{var de,xe=x==null||(de=x.event)==null?void 0:de.assetList;if(xe)for(var Le=g-(x[m]||x).start,Me=xe.length;Me--;){var tt=xe[Me];if(tt.duration&&Le>=tt.startOffset&&Le<tt.startOffset+tt.duration){Ae=Me;break}}}e.setSchedulePosition(A,Ae)}}}},h=function(){var g=e.effectivePlayingItem;if(e.isInterstitial(g))return g;var m=t();return e.isInterstitial(m)?m:null},c={get currentTime(){var v=h(),g=e.effectivePlayingItem;return g&&g===v?s(g,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-g.playout.start:0},set currentTime(v){var g=h(),m=e.effectivePlayingItem;m&&m===g&&d(v+m.playout.start,"playout")},get duration(){var v=h();return v?v.playout.end-v.playout.start:0},get assetPlayers(){var v,g=(v=h())==null?void 0:v.event.assetList;return g?g.map(function(m){return e.getAssetPlayer(m.identifier)}):[]},get playingIndex(){var v,g=(v=h())==null?void 0:v.event;return g&&e.effectivePlayingAsset?g.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return h()}};this.manager={get events(){var v,g;return((v=e.schedule)==null||(g=v.events)==null?void 0:g.slice(0))||[]},get schedule(){var v,g;return((v=e.schedule)==null||(g=v.items)==null?void 0:g.slice(0))||[]},get interstitialPlayer(){return h()?c:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){var v=t();return e.findItemIndex(v)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){var v=e.effectivePlayingItem;return e.findItemIndex(v)},primary:{get bufferedEnd(){return u()},get currentTime(){var v=e.timelinePos;return v>0?v:0},set currentTime(v){d(v,"primary")},get duration(){return f("primary")},get seekableStart(){var v;return((v=e.primaryDetails)==null?void 0:v.fragmentStart)||0}},integrated:{get bufferedEnd(){return s(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return s(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(v){d(v,"integrated")},get duration(){return f("integrated")},get seekableStart(){var v;return l(((v=e.primaryDetails)==null?void 0:v.fragmentStart)||0,"integrated")}},skip:function(){var g=e.effectivePlayingItem,m=g==null?void 0:g.event;if(m&&!m.restrictions.skip){var y=e.findItemIndex(g);if(m.appendInPlace){var E=g.playout.start+g.event.duration;d(E+.001,"playout")}else e.advanceAfterAssetEnded(m,y,1/0)}}}}return this.manager}},{key:"effectivePlayingItem",get:function(){return this.waitingItem||this.playingItem||this.endedItem}},{key:"effectivePlayingAsset",get:function(){return this.playingAsset||this.endedAsset}},{key:"playingLastItem",get:function(){var e,t=this.playingItem,i=(e=this.schedule)==null?void 0:e.items;return!this.playbackStarted||!t||!i?!1:this.findItemIndex(t)===i.length-1}},{key:"playbackStarted",get:function(){return this.effectivePlayingItem!==null}},{key:"currentTime",get:function(){var e,t,i;if(this.mediaSelection!==null){var s=this.waitingItem||this.playingItem;if(!(this.isInterstitial(s)&&!s.event.appendInPlace)){var l=this.media;!l&&(e=this.bufferingItem)!=null&&(t=e.event)!=null&&t.appendInPlace&&(l=this.primaryMedia);var u=(i=l)==null?void 0:i.currentTime;if(!(u===void 0||!N(u)))return u}}}},{key:"primaryMedia",get:function(){var e;return this.media||((e=this.detachedData)==null?void 0:e.media)||null}},{key:"playbackDisabled",get:function(){return this.hls.config.enableInterstitialPlayback===!1}},{key:"primaryDetails",get:function(){var e,t;return(e=this.mediaSelection)==null||(t=e.main)==null?void 0:t.details}},{key:"primaryLive",get:function(){var e;return!!((e=this.primaryDetails)!=null&&e.live)}}])}(ie),Oo=500,Xd=function(a){function o(r,e,t){var i;return i=a.call(this,r,e,t,"subtitle-stream-controller",K.SUBTITLE)||this,i.currentTrackId=-1,i.tracksBuffered=[],i.mainDetails=null,i.registerListeners(),i}J(o,a);var n=o.prototype;return n.onHandlerDestroying=function(){this.unregisterListeners(),a.prototype.onHandlerDestroying.call(this),this.mainDetails=null},n.registerListeners=function(){a.prototype.registerListeners.call(this);var e=this.hls;e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(p.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this)},n.unregisterListeners=function(){a.prototype.unregisterListeners.call(this);var e=this.hls;e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(p.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(p.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this)},n.startLoad=function(e,t){this.stopLoad(),this.state=w.IDLE,this.setInterval(Oo),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()},n.onManifestLoading=function(){a.prototype.onManifestLoading.call(this),this.mainDetails=null},n.onMediaDetaching=function(e,t){this.tracksBuffered=[],a.prototype.onMediaDetaching.call(this,e,t)},n.onLevelLoaded=function(e,t){this.mainDetails=t.details},n.onSubtitleFragProcessed=function(e,t){var i=t.frag,s=t.success;if(Ie(i)&&(this.fragPrevious=i),this.state=w.IDLE,!!s){var l=this.tracksBuffered[this.currentTrackId];if(l){for(var u,f=i.start,d=0;d<l.length;d++)if(f>=l[d].start&&f<=l[d].end){u=l[d];break}var h=i.start+i.duration;u?u.end=h:(u={start:f,end:h},l.push(u)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null),this.media&&this.tick()}}},n.onBufferFlushing=function(e,t){var i=t.startOffset,s=t.endOffset;if(i===0&&s!==Number.POSITIVE_INFINITY){var l=s-1;if(l<=0)return;t.endOffsetSubtitles=Math.max(0,l),this.tracksBuffered.forEach(function(u){for(var f=0;f<u.length;){if(u[f].end<=l){u.shift();continue}else if(u[f].start<l)u[f].start=l;else break;f++}}),this.fragmentTracker.removeFragmentsInRange(i,l,K.SUBTITLE)}},n.onError=function(e,t){var i=t.frag;(i==null?void 0:i.type)===K.SUBTITLE&&(t.details===_.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==w.STOPPED&&(this.state=w.IDLE))},n.onSubtitleTracksUpdated=function(e,t){var i=this,s=t.subtitleTracks;if(this.levels&&yo(this.levels,s)){this.levels=s.map(function(l){return new $r(l)});return}this.tracksBuffered=[],this.levels=s.map(function(l){var u=new $r(l);return i.tracksBuffered[u.id]=[],u}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,K.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null},n.onSubtitleTrackSwitch=function(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}var s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.state!==w.STOPPED&&this.setInterval(Oo)},n.onSubtitleTrackLoaded=function(e,t){var i,s=this.currentTrackId,l=this.levels,u=t.details,f=t.id;if(!l){this.warn("Subtitle tracks were reset while loading level "+f);return}var d=l[f];if(!(f>=l.length||!d)){this.log("Subtitle track "+f+" loaded ["+u.startSN+","+u.endSN+"]"+(u.lastPartSn?"[part-"+u.lastPartSn+"-"+u.lastPartIndex+"]":"")+",duration:"+u.totalduration),this.mediaBuffer=this.mediaBufferTimeRanges;var h=0;if(u.live||(i=d.details)!=null&&i.live){var c=this.mainDetails;if(u.deltaUpdateFailed||!c)return;var v=c.fragments[0];if(!d.details)u.hasProgramDateTime&&c.hasProgramDateTime?(Pi(u,c),h=u.fragmentStart):v&&(h=v.start,Pn(u,h));else{var g;h=this.alignPlaylists(u,d.details,(g=this.levelLastLoaded)==null?void 0:g.details),h===0&&v&&(h=v.start,Pn(u,h))}}if(d.details=u,this.levelLastLoaded=d,f===s&&(this.hls.trigger(p.SUBTITLE_TRACK_UPDATED,{details:u,id:f,groupId:t.groupId}),this.tick(),u.live&&!this.fragCurrent&&this.media&&this.state===w.IDLE)){var m=br(null,u.fragments,this.media.currentTime,0);m||(this.warn("Subtitle playlist not aligned with playback"),d.details=void 0)}}},n._handleFragmentLoadComplete=function(e){var t=this,i=e.frag,s=e.payload,l=i.decryptdata,u=this.hls;if(!this.fragContextChanged(i)&&s&&s.byteLength>0&&l!=null&&l.key&&l.iv&&Mr(l.method)){var f=performance.now();this.decrypter.decrypt(new Uint8Array(s),l.key.buffer,l.iv.buffer,An(l.method)).catch(function(d){throw u.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.FRAG_DECRYPT_ERROR,fatal:!1,error:d,reason:d.message,frag:i}),d}).then(function(d){var h=performance.now();u.trigger(p.FRAG_DECRYPTED,{frag:i,payload:d,stats:{tstart:f,tdecrypt:h}})}).catch(function(d){t.warn(d.name+": "+d.message),t.state=w.IDLE})}},n.doTick=function(){if(!this.media){this.state=w.IDLE;return}if(this.state===w.IDLE){var e=this.currentTrackId,t=this.levels,i=t==null?void 0:t[e];if(!i||!t.length||!i.details||this.waitForLive(i))return;var s=this.config,l=this.getLoadPosition(),u=Se.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],l,s.maxBufferHole),f=u.end,d=u.len,h=i.details,c=this.hls.maxBufferLength+h.levelTargetDuration;if(d>c)return;var v=h.fragments,g=v.length,m=h.edge,y=null,E=this.fragPrevious;if(f<m){var T=s.maxFragLookUpTolerance,S=f>m-T?0:T;y=br(E,v,Math.max(v[0].start,f),S),!y&&E&&E.start<v[0].start&&(y=v[0])}else y=v[g-1];if(y=this.filterReplacedPrimary(y,i.details),!y)return;var A=y.sn-h.startSN,x=v[A-1];if(x&&x.cc===y.cc&&this.fragmentTracker.getState(x)===ut.NOT_LOADED&&(y=x),this.fragmentTracker.getState(y)===ut.NOT_LOADED){var L=this.mapToInitFragWhenRequired(y);L&&this.loadFragment(L,i,f)}}},n.loadFragment=function(e,t,i){Ie(e)?a.prototype.loadFragment.call(this,e,t,i):this._loadInitSegment(e,t)},z(o,[{key:"mediaBufferTimeRanges",get:function(){return new zd(this.tracksBuffered[this.currentTrackId]||[])}}])}(wn),zd=function(o){this.buffered=void 0;var n=function(e,t,i){if(t=t>>>0,t>i-1)throw new DOMException("Failed to execute '"+e+"' on 'TimeRanges': The index provided ("+t+") is greater than the maximum bound ("+i+")");return o[t][e]};this.buffered={get length(){return o.length},end:function(e){return n("end",e,o.length)},start:function(e){return n("start",e,o.length)}}};function Fo(a,o){var n;try{n=new Event("addtrack")}catch{n=document.createEvent("Event"),n.initEvent("addtrack",!1,!1)}n.track=a,o.dispatchEvent(n)}function No(a,o){var n=a.mode;if(n==="disabled"&&(a.mode="hidden"),a.cues&&!a.cues.getCueById(o.id))try{if(a.addCue(o),!a.cues.getCueById(o.id))throw new Error("addCue is failed for: "+o)}catch(e){X.debug("[texttrack-utils]: "+e);try{var r=new self.TextTrackCue(o.startTime,o.endTime,o.text);r.id=o.id,a.addCue(r)}catch(t){X.debug("[texttrack-utils]: Legacy TextTrackCue fallback failed: "+t)}}n==="disabled"&&(a.mode=n)}function Kr(a,o){var n=a.mode;if(n==="disabled"&&(a.mode="hidden"),a.cues)for(var r=a.cues.length;r--;)o&&a.cues[r].removeEventListener("enter",o),a.removeCue(a.cues[r]);n==="disabled"&&(a.mode=n)}function na(a,o,n,r){var e=a.mode;if(e==="disabled"&&(a.mode="hidden"),a.cues&&a.cues.length>0)for(var t=$d(a.cues,o,n),i=0;i<t.length;i++)(!r||r(t[i]))&&a.removeCue(t[i]);e==="disabled"&&(a.mode=e)}function Qd(a,o){if(o<=a[0].startTime)return 0;var n=a.length-1;if(o>a[n].endTime)return-1;for(var r=0,e=n,t;r<=e;)if(t=Math.floor((e+r)/2),o<a[t].startTime)e=t-1;else if(o>a[t].startTime&&r<n)r=t+1;else return t;return a[r].startTime-o<o-a[e].startTime?r:e}function $d(a,o,n){var r=[],e=Qd(a,o);if(e>-1)for(var t=e,i=a.length;t<i;t++){var s=a[t];if(s.startTime>=o&&s.endTime<=n)r.push(s);else if(s.startTime>n)return r}return r}function Hi(a){for(var o=[],n=0;n<a.length;n++){var r=a[n];(r.kind==="subtitles"||r.kind==="captions")&&r.label&&o.push(a[n])}return o}var Jd=function(a){function o(r){var e;return e=a.call(this,r,"subtitle-track-controller")||this,e.media=null,e.tracks=[],e.groupIds=null,e.tracksInGroup=[],e.trackId=-1,e.currentTrack=null,e.selectDefaultTrack=!0,e.queuedDefaultTrack=-1,e.useTextTrackPolling=!1,e.subtitlePollingInterval=-1,e._subtitleDisplay=!0,e.asyncPollTrackChange=function(){return e.pollTrackChange(0)},e.onTextTracksChanged=function(){if(e.useTextTrackPolling||self.clearInterval(e.subtitlePollingInterval),!(!e.media||!e.hls.config.renderTextTracksNatively)){for(var t=null,i=Hi(e.media.textTracks),s=0;s<i.length;s++)if(i[s].mode==="hidden")t=i[s];else if(i[s].mode==="showing"){t=i[s];break}var l=e.findTrackForTextTrack(t);e.subtitleTrack!==l&&e.setSubtitleTrack(l)}},e.registerListeners(),e}J(o,a);var n=o.prototype;return n.destroy=function(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,a.prototype.destroy.call(this)},n.registerListeners=function(){var e=this.hls;e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(p.ERROR,this.onError,this)},n.unregisterListeners=function(){var e=this.hls;e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADING,this.onLevelLoading,this),e.off(p.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(p.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(p.ERROR,this.onError,this)},n.onMediaAttached=function(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))},n.pollTrackChange=function(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)},n.onMediaDetaching=function(e,t){var i=this.media;if(i){var s=!!t.transferMedia;if(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||i.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,!s){var l=Hi(i.textTracks);l.forEach(function(u){Kr(u)})}}},n.onManifestLoading=function(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0},n.onManifestParsed=function(e,t){this.tracks=t.subtitleTracks},n.onSubtitleTrackLoaded=function(e,t){var i=t.id,s=t.groupId,l=t.details,u=this.tracksInGroup[i];if(!u||u.groupId!==s){this.warn("Subtitle track with id:"+i+" and group:"+s+" not found in active group "+(u==null?void 0:u.groupId));return}var f=u.details;u.details=t.details,this.log("Subtitle track "+i+' "'+u.name+'" lang:'+u.lang+" group:"+s+" loaded ["+l.startSN+"-"+l.endSN+"]"),i===this.trackId&&this.playlistLoaded(i,t,f)},n.onLevelLoading=function(e,t){this.switchLevel(t.level)},n.onLevelSwitching=function(e,t){this.switchLevel(t.level)},n.switchLevel=function(e){var t=this.hls.levels[e];if(t){var i=t.subtitleGroups||null,s=this.groupIds,l=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(function(g){return(s==null?void 0:s.indexOf(g))===-1})){this.groupIds=i,this.trackId=-1,this.currentTrack=null;var u=this.tracks.filter(function(g){return!i||i.indexOf(g.groupId)!==-1});if(u.length)this.selectDefaultTrack&&!u.some(function(g){return g.default})&&(this.selectDefaultTrack=!1),u.forEach(function(g,m){g.id=m});else if(!l&&!this.tracksInGroup.length)return;this.tracksInGroup=u;var f=this.hls.config.subtitlePreference;if(!l&&f){this.selectDefaultTrack=!1;var d=Jt(f,u);if(d>-1)l=u[d];else{var h=Jt(f,this.tracks);l=this.tracks[h]}}var c=this.findTrackId(l);c===-1&&l&&(c=this.findTrackId(null));var v={subtitleTracks:u};this.log("Updating subtitle tracks, "+u.length+' track(s) found in "'+(i==null?void 0:i.join(","))+'" group-id'),this.hls.trigger(p.SUBTITLE_TRACKS_UPDATED,v),c!==-1&&this.trackId===-1&&this.setSubtitleTrack(c)}}},n.findTrackId=function(e){for(var t=this.tracksInGroup,i=this.selectDefaultTrack,s=0;s<t.length;s++){var l=t[s];if(!(i&&!l.default||!i&&!e)&&(!e||xr(l,e)))return s}if(e){for(var u=0;u<t.length;u++){var f=t[u];if(ai(e.attrs,f.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return u}for(var d=0;d<t.length;d++){var h=t[d];if(ai(e.attrs,h.attrs,["LANGUAGE"]))return d}}return-1},n.findTrackForTextTrack=function(e){if(e)for(var t=this.tracksInGroup,i=0;i<t.length;i++){var s=t[i];if(Qn(s,e))return i}return-1},n.onError=function(e,t){t.fatal||!t.context||t.context.type===j.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)},n.setSubtitleOption=function(e){if(this.hls.config.subtitlePreference=e,e){if(e.id===-1)return this.setSubtitleTrack(-1),null;var t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){var i=this.currentTrack;if(i&&xr(e,i))return i;var s=Jt(e,this.tracksInGroup);if(s>-1){var l=this.tracksInGroup[s];return this.setSubtitleTrack(s),l}else{if(i)return null;var u=Jt(e,t);if(u>-1)return t[u]}}}return null},n.loadPlaylist=function(e){a.prototype.loadPlaylist.call(this),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)},n.loadingPlaylist=function(e,t){a.prototype.loadingPlaylist.call(this,e,t);var i=e.id,s=e.groupId,l=this.getUrlWithDirectives(e.url,t),u=e.details,f=u==null?void 0:u.age;this.log("Loading subtitle "+i+' "'+e.name+'" lang:'+e.lang+" group:"+s+((t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:"")+(f&&u.live?" age "+f.toFixed(1)+(u.type&&" "+u.type||""):"")+" "+l),this.hls.trigger(p.SUBTITLE_TRACK_LOADING,{url:l,id:i,groupId:s,deliveryDirectives:t||null,track:e})},n.toggleTrackModes=function(){var e=this.media;if(e){var t=Hi(e.textTracks),i=this.currentTrack,s;if(i&&(s=t.filter(function(u){return Qn(i,u)})[0],s||this.warn('Unable to find subtitle TextTrack with name "'+i.name+'" and language "'+i.lang+'"')),[].slice.call(t).forEach(function(u){u.mode!=="disabled"&&u!==s&&(u.mode="disabled")}),s){var l=this.subtitleDisplay?"showing":"hidden";s.mode!==l&&(s.mode=l)}}},n.setSubtitleTrack=function(e){var t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!N(e)){this.warn("Invalid subtitle track id: "+e);return}this.selectDefaultTrack=!1;var i=this.currentTrack,s=t[e]||null;if(this.trackId=e,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(p.SUBTITLE_TRACK_SWITCH,{id:e});return}var l=!!s.details&&!s.details.live;if(!(e===this.trackId&&s===i&&l)){this.log("Switching to subtitle-track "+e+(s?' "'+s.name+'" lang:'+s.lang+" group:"+s.groupId:""));var u=s.id,f=s.groupId,d=f===void 0?"":f,h=s.name,c=s.type,v=s.url;this.hls.trigger(p.SUBTITLE_TRACK_SWITCH,{id:u,groupId:d,name:h,type:c,url:v});var g=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(g)}},z(o,[{key:"subtitleDisplay",get:function(){return this._subtitleDisplay},set:function(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}},{key:"allSubtitleTracks",get:function(){return this.tracks}},{key:"subtitleTracks",get:function(){return this.tracksInGroup}},{key:"subtitleTrack",get:function(){return this.trackId},set:function(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}}])}(zn),Zd={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Uo=function(o){return String.fromCharCode(Zd[o]||o)},Xt=15,fr=100,eh={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},th={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rh={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},ih={25:2,26:4,29:6,30:8,31:10,27:13,28:15},nh=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],ah=function(){function a(){this.time=null,this.verboseLevel=0}var o=a.prototype;return o.log=function(r,e){if(this.verboseLevel>=r){var t=typeof e=="function"?e():e;X.log(this.time+" ["+r+"] "+t)}},a}(),Ir=function(o){for(var n=[],r=0;r<o.length;r++)n.push(o[r].toString(16));return n},Bo=function(){function a(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}var o=a.prototype;return o.reset=function(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1},o.setStyles=function(r){for(var e=["foreground","underline","italics","background","flash"],t=0;t<e.length;t++){var i=e[t];r.hasOwnProperty(i)&&(this[i]=r[i])}},o.isDefault=function(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash},o.equals=function(r){return this.foreground===r.foreground&&this.underline===r.underline&&this.italics===r.italics&&this.background===r.background&&this.flash===r.flash},o.copy=function(r){this.foreground=r.foreground,this.underline=r.underline,this.italics=r.italics,this.background=r.background,this.flash=r.flash},o.toString=function(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash},a}(),sh=function(){function a(){this.uchar=" ",this.penState=new Bo}var o=a.prototype;return o.reset=function(){this.uchar=" ",this.penState.reset()},o.setChar=function(r,e){this.uchar=r,this.penState.copy(e)},o.setPenState=function(r){this.penState.copy(r)},o.equals=function(r){return this.uchar===r.uchar&&this.penState.equals(r.penState)},o.copy=function(r){this.uchar=r.uchar,this.penState.copy(r.penState)},o.isEmpty=function(){return this.uchar===" "&&this.penState.isDefault()},a}(),oh=function(){function a(n){this.chars=[],this.pos=0,this.currPenState=new Bo,this.cueStartTime=null,this.logger=void 0;for(var r=0;r<fr;r++)this.chars.push(new sh);this.logger=n}var o=a.prototype;return o.equals=function(r){for(var e=0;e<fr;e++)if(!this.chars[e].equals(r.chars[e]))return!1;return!0},o.copy=function(r){for(var e=0;e<fr;e++)this.chars[e].copy(r.chars[e])},o.isEmpty=function(){for(var r=!0,e=0;e<fr;e++)if(!this.chars[e].isEmpty()){r=!1;break}return r},o.setCursor=function(r){this.pos!==r&&(this.pos=r),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>fr&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=fr)},o.moveCursor=function(r){var e=this.pos+r;if(r>1)for(var t=this.pos+1;t<e+1;t++)this.chars[t].setPenState(this.currPenState);this.setCursor(e)},o.backSpace=function(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)},o.insertChar=function(r){var e=this;r>=144&&this.backSpace();var t=Uo(r);if(this.pos>=fr){this.logger.log(0,function(){return"Cannot insert "+r.toString(16)+" ("+t+") at position "+e.pos+". Skipping it!"});return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)},o.clearFromPos=function(r){var e;for(e=r;e<fr;e++)this.chars[e].reset()},o.clear=function(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()},o.clearToEndOfRow=function(){this.clearFromPos(this.pos)},o.getTextString=function(){for(var r=[],e=!0,t=0;t<fr;t++){var i=this.chars[t].uchar;i!==" "&&(e=!1),r.push(i)}return e?"":r.join("")},o.setPenStyles=function(r){this.currPenState.setStyles(r);var e=this.chars[this.pos];e.setPenState(this.currPenState)},a}(),aa=function(){function a(n){this.rows=[],this.currRow=Xt-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(var r=0;r<Xt;r++)this.rows.push(new oh(n));this.logger=n}var o=a.prototype;return o.reset=function(){for(var r=0;r<Xt;r++)this.rows[r].clear();this.currRow=Xt-1},o.equals=function(r){for(var e=!0,t=0;t<Xt;t++)if(!this.rows[t].equals(r.rows[t])){e=!1;break}return e},o.copy=function(r){for(var e=0;e<Xt;e++)this.rows[e].copy(r.rows[e])},o.isEmpty=function(){for(var r=!0,e=0;e<Xt;e++)if(!this.rows[e].isEmpty()){r=!1;break}return r},o.backSpace=function(){var r=this.rows[this.currRow];r.backSpace()},o.clearToEndOfRow=function(){var r=this.rows[this.currRow];r.clearToEndOfRow()},o.insertChar=function(r){var e=this.rows[this.currRow];e.insertChar(r)},o.setPen=function(r){var e=this.rows[this.currRow];e.setPenStyles(r)},o.moveCursor=function(r){var e=this.rows[this.currRow];e.moveCursor(r)},o.setCursor=function(r){this.logger.log(2,"setCursor: "+r);var e=this.rows[this.currRow];e.setCursor(r)},o.setPAC=function(r){this.logger.log(2,function(){return"pacData = "+He(r)});var e=r.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(var t=0;t<Xt;t++)this.rows[t].clear();var i=this.currRow+1-this.nrRollUpRows,s=this.lastOutputScreen;if(s){var l=s.rows[i].cueStartTime,u=this.logger.time;if(l!==null&&u!==null&&l<u)for(var f=0;f<this.nrRollUpRows;f++)this.rows[e-this.nrRollUpRows+f+1].copy(s.rows[i+f])}}this.currRow=e;var d=this.rows[this.currRow];if(r.indent!==null){var h=r.indent,c=Math.max(h-1,0);d.setCursor(r.indent),r.color=d.chars[c].penState.foreground}var v={foreground:r.color,underline:r.underline,italics:r.italics,background:"black",flash:!1};this.setPen(v)},o.setBkgData=function(r){this.logger.log(2,function(){return"bkgData = "+He(r)}),this.backSpace(),this.setPen(r),this.insertChar(32)},o.setRollUpRows=function(r){this.nrRollUpRows=r},o.rollUp=function(){var r=this;if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,function(){return r.getDisplayText()});var e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")},o.getDisplayText=function(r){r=r||!1;for(var e=[],t="",i=-1,s=0;s<Xt;s++){var l=this.rows[s].getTextString();l&&(i=s+1,r?e.push("Row "+i+": '"+l+"'"):e.push(l.trim()))}return e.length>0&&(r?t="["+e.join(" | ")+"]":t=e.join(`
`)),t},o.getTextAndFormat=function(){return this.rows},a}(),Go=function(){function a(n,r,e){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=n,this.outputFilter=r,this.mode=null,this.verbose=0,this.displayedMemory=new aa(e),this.nonDisplayedMemory=new aa(e),this.lastOutputScreen=new aa(e),this.currRollUpRow=this.displayedMemory.rows[Xt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=e}var o=a.prototype;return o.reset=function(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Xt-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null},o.getHandler=function(){return this.outputFilter},o.setHandler=function(r){this.outputFilter=r},o.setPAC=function(r){this.writeScreen.setPAC(r)},o.setBkgData=function(r){this.writeScreen.setBkgData(r)},o.setMode=function(r){r!==this.mode&&(this.mode=r,this.logger.log(2,function(){return"MODE="+r}),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=r)},o.insertChars=function(r){for(var e=this,t=0;t<r.length;t++)this.writeScreen.insertChar(r[t]);var i=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,function(){return i+": "+e.writeScreen.getDisplayText(!0)}),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,function(){return"DISPLAYED: "+e.displayedMemory.getDisplayText(!0)}),this.outputDataUpdate())},o.ccRCL=function(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")},o.ccBS=function(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())},o.ccAOF=function(){},o.ccAON=function(){},o.ccDER=function(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()},o.ccRU=function(r){this.logger.log(2,"RU("+r+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(r)},o.ccFON=function(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})},o.ccRDC=function(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")},o.ccTR=function(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")},o.ccRTD=function(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")},o.ccEDM=function(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)},o.ccCR=function(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)},o.ccENM=function(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()},o.ccEOC=function(){var r=this;if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){var e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,function(){return"DISP: "+r.displayedMemory.getDisplayText()})}this.outputDataUpdate(!0)},o.ccTO=function(r){this.logger.log(2,"TO("+r+") - Tab Offset"),this.writeScreen.moveCursor(r)},o.ccMIDROW=function(r){var e={flash:!1};if(e.underline=r%2===1,e.italics=r>=46,e.italics)e.foreground="white";else{var t=Math.floor(r/2)-16,i=["white","green","blue","cyan","red","yellow","magenta"];e.foreground=i[t]}this.logger.log(2,"MIDROW: "+He(e)),this.writeScreen.setPen(e)},o.outputDataUpdate=function(r){r===void 0&&(r=!1);var e=this.logger.time;e!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=e:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),r&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e),this.lastOutputScreen.copy(this.displayedMemory))},o.cueSplitAtTime=function(r){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,r,this.displayedMemory),this.cueStartTime=r))},a}(),Ko=function(){function a(n,r,e){this.channels=void 0,this.currentChannel=0,this.cmdHistory=uh(),this.logger=void 0;var t=this.logger=new ah;this.channels=[null,new Go(n,r,t),new Go(n+1,e,t)]}var o=a.prototype;return o.getHandler=function(r){return this.channels[r].getHandler()},o.setHandler=function(r,e){this.channels[r].setHandler(e)},o.addData=function(r,e){var t=this;this.logger.time=r;for(var i=function(f){var d=e[f]&127,h=e[f+1]&127,c=!1,v=null;if(d===0&&h===0)return 0;t.logger.log(3,function(){return"["+Ir([e[f],e[f+1]])+"] -> ("+Ir([d,h])+")"});var g=t.cmdHistory,m=d>=16&&d<=31;if(m){if(lh(d,h,g))return Vi(null,null,g),t.logger.log(3,function(){return"Repeated command ("+Ir([d,h])+") is dropped"}),0;Vi(d,h,t.cmdHistory),c=t.parseCmd(d,h),c||(c=t.parseMidrow(d,h)),c||(c=t.parsePAC(d,h)),c||(c=t.parseBackgroundAttributes(d,h))}else Vi(null,null,g);if(!c&&(v=t.parseChars(d,h),v)){var y=t.currentChannel;if(y&&y>0){var E=t.channels[y];E.insertChars(v)}else t.logger.log(2,"No channel found yet. TEXT-MODE?")}!c&&!v&&t.logger.log(2,function(){return"Couldn't parse cleaned data "+Ir([d,h])+" orig: "+Ir([e[f],e[f+1]])})},s,l=0;l<e.length;l+=2)s=i(l)},o.parseCmd=function(r,e){var t=(r===20||r===28||r===21||r===29)&&e>=32&&e<=47,i=(r===23||r===31)&&e>=33&&e<=35;if(!(t||i))return!1;var s=r===20||r===21||r===23?1:2,l=this.channels[s];return r===20||r===21||r===28||r===29?e===32?l.ccRCL():e===33?l.ccBS():e===34?l.ccAOF():e===35?l.ccAON():e===36?l.ccDER():e===37?l.ccRU(2):e===38?l.ccRU(3):e===39?l.ccRU(4):e===40?l.ccFON():e===41?l.ccRDC():e===42?l.ccTR():e===43?l.ccRTD():e===44?l.ccEDM():e===45?l.ccCR():e===46?l.ccENM():e===47&&l.ccEOC():l.ccTO(e-32),this.currentChannel=s,!0},o.parseMidrow=function(r,e){var t=0;if((r===17||r===25)&&e>=32&&e<=47){if(r===17?t=1:t=2,t!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;var i=this.channels[t];return i?(i.ccMIDROW(e),this.logger.log(3,function(){return"MIDROW ("+Ir([r,e])+")"}),!0):!1}return!1},o.parsePAC=function(r,e){var t,i=(r>=17&&r<=23||r>=25&&r<=31)&&e>=64&&e<=127,s=(r===16||r===24)&&e>=64&&e<=95;if(!(i||s))return!1;var l=r<=23?1:2;e>=64&&e<=95?t=l===1?eh[r]:rh[r]:t=l===1?th[r]:ih[r];var u=this.channels[l];return u?(u.setPAC(this.interpretPAC(t,e)),this.currentChannel=l,!0):!1},o.interpretPAC=function(r,e){var t,i={color:null,italics:!1,indent:null,underline:!1,row:r};return e>95?t=e-96:t=e-64,i.underline=(t&1)===1,t<=13?i.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(t/2)]:t<=15?(i.italics=!0,i.color="white"):i.indent=Math.floor((t-16)/2)*4,i},o.parseChars=function(r,e){var t,i=null,s=null;if(r>=25?(t=2,s=r-8):(t=1,s=r),s>=17&&s<=19){var l;s===17?l=e+80:s===18?l=e+112:l=e+144,this.logger.log(2,function(){return"Special char '"+Uo(l)+"' in channel "+t}),i=[l]}else r>=32&&r<=127&&(i=e===0?[r]:[r,e]);return i&&this.logger.log(3,function(){return"Char codes =  "+Ir(i).join(",")}),i},o.parseBackgroundAttributes=function(r,e){var t=(r===16||r===24)&&e>=32&&e<=47,i=(r===23||r===31)&&e>=45&&e<=47;if(!(t||i))return!1;var s,l={};r===16||r===24?(s=Math.floor((e-32)/2),l.background=nh[s],e%2===1&&(l.background=l.background+"_semi")):e===45?l.background="transparent":(l.foreground="black",e===47&&(l.underline=!0));var u=r<=23?1:2,f=this.channels[u];return f.setBkgData(l),!0},o.reset=function(){for(var r=0;r<Object.keys(this.channels).length;r++){var e=this.channels[r];e&&e.reset()}Vi(null,null,this.cmdHistory)},o.cueSplitAtTime=function(r){for(var e=0;e<this.channels.length;e++){var t=this.channels[e];t&&t.cueSplitAtTime(r)}},a}();function Vi(a,o,n){n.a=a,n.b=o}function lh(a,o,n){return n.a===a&&n.b===o}function uh(){return{a:null,b:null}}var sa=function(){if(_i!=null&&_i.VTTCue)return self.VTTCue;var a=["","lr","rl"],o=["start","middle","end","left","right"];function n(s,l){if(typeof l!="string"||!Array.isArray(s))return!1;var u=l.toLowerCase();return~s.indexOf(u)?u:!1}function r(s){return n(a,s)}function e(s){return n(o,s)}function t(s){for(var l=arguments.length,u=new Array(l>1?l-1:0),f=1;f<l;f++)u[f-1]=arguments[f];for(var d=1;d<arguments.length;d++){var h=arguments[d];for(var c in h)s[c]=h[c]}return s}function i(s,l,u){var f=this,d={enumerable:!0};f.hasBeenReset=!1;var h="",c=!1,v=s,g=l,m=u,y=null,E="",T=!0,S="auto",A="start",x=50,L="middle",I=50,k="middle";Object.defineProperty(f,"id",t({},d,{get:function(){return h},set:function(b){h=""+b}})),Object.defineProperty(f,"pauseOnExit",t({},d,{get:function(){return c},set:function(b){c=!!b}})),Object.defineProperty(f,"startTime",t({},d,{get:function(){return v},set:function(b){if(typeof b!="number")throw new TypeError("Start time must be set to a number.");v=b,this.hasBeenReset=!0}})),Object.defineProperty(f,"endTime",t({},d,{get:function(){return g},set:function(b){if(typeof b!="number")throw new TypeError("End time must be set to a number.");g=b,this.hasBeenReset=!0}})),Object.defineProperty(f,"text",t({},d,{get:function(){return m},set:function(b){m=""+b,this.hasBeenReset=!0}})),Object.defineProperty(f,"region",t({},d,{get:function(){return y},set:function(b){y=b,this.hasBeenReset=!0}})),Object.defineProperty(f,"vertical",t({},d,{get:function(){return E},set:function(b){var D=r(b);if(D===!1)throw new SyntaxError("An invalid or illegal string was specified.");E=D,this.hasBeenReset=!0}})),Object.defineProperty(f,"snapToLines",t({},d,{get:function(){return T},set:function(b){T=!!b,this.hasBeenReset=!0}})),Object.defineProperty(f,"line",t({},d,{get:function(){return S},set:function(b){if(typeof b!="number"&&b!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");S=b,this.hasBeenReset=!0}})),Object.defineProperty(f,"lineAlign",t({},d,{get:function(){return A},set:function(b){var D=e(b);if(!D)throw new SyntaxError("An invalid or illegal string was specified.");A=D,this.hasBeenReset=!0}})),Object.defineProperty(f,"position",t({},d,{get:function(){return x},set:function(b){if(b<0||b>100)throw new Error("Position must be between 0 and 100.");x=b,this.hasBeenReset=!0}})),Object.defineProperty(f,"positionAlign",t({},d,{get:function(){return L},set:function(b){var D=e(b);if(!D)throw new SyntaxError("An invalid or illegal string was specified.");L=D,this.hasBeenReset=!0}})),Object.defineProperty(f,"size",t({},d,{get:function(){return I},set:function(b){if(b<0||b>100)throw new Error("Size must be between 0 and 100.");I=b,this.hasBeenReset=!0}})),Object.defineProperty(f,"align",t({},d,{get:function(){return k},set:function(b){var D=e(b);if(!D)throw new SyntaxError("An invalid or illegal string was specified.");k=D,this.hasBeenReset=!0}})),f.displayState=void 0}return i.prototype.getCueAsHTML=function(){var s=self.WebVTT;return s.convertCueToDOMTree(self,this.text)},i}(),fh=function(){function a(){}var o=a.prototype;return o.decode=function(r,e){if(!r)return"";if(typeof r!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(r))},a}();function Ho(a){function o(r,e,t,i){return(r|0)*3600+(e|0)*60+(t|0)+parseFloat(i||0)}var n=a.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return n?parseFloat(n[2])>59?o(n[2],n[3],0,n[4]):o(n[1],n[2],n[3],n[4]):null}var dh=function(){function a(){this.values=Object.create(null)}var o=a.prototype;return o.set=function(r,e){!this.get(r)&&e!==""&&(this.values[r]=e)},o.get=function(r,e,t){return t?this.has(r)?this.values[r]:e[t]:this.has(r)?this.values[r]:e},o.has=function(r){return r in this.values},o.alt=function(r,e,t){for(var i=0;i<t.length;++i)if(e===t[i]){this.set(r,e);break}},o.integer=function(r,e){/^-?\d+$/.test(e)&&this.set(r,parseInt(e,10))},o.percent=function(r,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){var t=parseFloat(e);if(t>=0&&t<=100)return this.set(r,t),!0}return!1},a}();function Vo(a,o,n,r){var e=r?a.split(r):[a];for(var t in e)if(typeof e[t]=="string"){var i=e[t].split(n);if(i.length===2){var s=i[0],l=i[1];o(s,l)}}}var oa=new sa(0,0,""),Wi=oa.align==="middle"?"middle":"center";function hh(a,o,n){var r=a;function e(){var s=Ho(a);if(s===null)throw new Error("Malformed timestamp: "+r);return a=a.replace(/^[^\sa-zA-Z-]+/,""),s}function t(s,l){var u=new dh;Vo(s,function(h,c){var v;switch(h){case"region":for(var g=n.length-1;g>=0;g--)if(n[g].id===c){u.set(h,n[g].region);break}break;case"vertical":u.alt(h,c,["rl","lr"]);break;case"line":v=c.split(","),u.integer(h,v[0]),u.percent(h,v[0])&&u.set("snapToLines",!1),u.alt(h,v[0],["auto"]),v.length===2&&u.alt("lineAlign",v[1],["start",Wi,"end"]);break;case"position":v=c.split(","),u.percent(h,v[0]),v.length===2&&u.alt("positionAlign",v[1],["start",Wi,"end","line-left","line-right","auto"]);break;case"size":u.percent(h,c);break;case"align":u.alt(h,c,["start",Wi,"end","left","right"]);break}},/:/,/\s/),l.region=u.get("region",null),l.vertical=u.get("vertical","");var f=u.get("line","auto");f==="auto"&&oa.line===-1&&(f=-1),l.line=f,l.lineAlign=u.get("lineAlign","start"),l.snapToLines=u.get("snapToLines",!0),l.size=u.get("size",100),l.align=u.get("align",Wi);var d=u.get("position","auto");d==="auto"&&oa.position===50&&(d=l.align==="start"||l.align==="left"?0:l.align==="end"||l.align==="right"?100:50),l.position=d}function i(){a=a.replace(/^\s+/,"")}if(i(),o.startTime=e(),i(),a.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+r);a=a.slice(3),i(),o.endTime=e(),i(),t(a,o)}function Wo(a){return a.replace(/<br(?: \/)?>/gi,`
`)}var ch=function(){function a(){this.state="INITIAL",this.buffer="",this.decoder=new fh,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}var o=a.prototype;return o.parse=function(r){var e=this;r&&(e.buffer+=e.decoder.decode(r,{stream:!0}));function t(){var d=e.buffer,h=0;for(d=Wo(d);h<d.length&&d[h]!=="\r"&&d[h]!==`
`;)++h;var c=d.slice(0,h);return d[h]==="\r"&&++h,d[h]===`
`&&++h,e.buffer=d.slice(h),c}function i(d){Vo(d,function(h,c){},/:/)}try{var s="";if(e.state==="INITIAL"){if(!/\r\n|\n/.test(e.buffer))return this;s=t();var l=s.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(l!=null&&l[0]))throw new Error("Malformed WebVTT signature.");e.state="HEADER"}for(var u=!1;e.buffer;){if(!/\r\n|\n/.test(e.buffer))return this;switch(u?u=!1:s=t(),e.state){case"HEADER":/:/.test(s)?i(s):s||(e.state="ID");continue;case"NOTE":s||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(s)){e.state="NOTE";break}if(!s)continue;if(e.cue=new sa(0,0,""),e.state="CUE",s.indexOf("-->")===-1){e.cue.id=s;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{hh(s,e.cue,e.regionList)}catch{e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{var f=s.indexOf("-->")!==-1;if(!s||f&&(u=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(e.cue===null)continue;e.cue.text&&(e.cue.text+=`
`),e.cue.text+=s}continue;case"BADCUE":s||(e.state="ID")}}}catch{e.state==="CUETEXT"&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state=e.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this},o.flush=function(){var r=this;try{if((r.cue||r.state==="HEADER")&&(r.buffer+=`

`,r.parse()),r.state==="INITIAL"||r.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(e){r.onparsingerror&&r.onparsingerror(e)}return r.onflush&&r.onflush(),this},a}(),vh=/\r\n|\n\r|\n|\r/g,la=function(o,n,r){return r===void 0&&(r=0),o.slice(r,r+n.length)===n},gh=function(o){var n=parseInt(o.slice(-3)),r=parseInt(o.slice(-6,-4)),e=parseInt(o.slice(-9,-7)),t=o.length>9?parseInt(o.substring(0,o.indexOf(":"))):0;if(!N(n)||!N(r)||!N(e)||!N(t))throw Error("Malformed X-TIMESTAMP-MAP: Local:"+o);return n+=1e3*r,n+=60*1e3*e,n+=60*60*1e3*t,n};function ua(a,o,n){return oi(a.toString())+oi(o.toString())+oi(n)}var mh=function(o,n,r){var e=o[n],t=o[e.prevCC];if(!t||!t.new&&e.new){o.ccOffset=o.presentationOffset=e.start,e.new=!1;return}for(;(i=t)!=null&&i.new;){var i;o.ccOffset+=e.start-t.start,e.new=!1,e=t,t=o[e.prevCC]}o.presentationOffset=r};function ph(a,o,n,r,e,t,i){var s=new ch,l=Ge(new Uint8Array(a)).trim().replace(vh,`
`).split(`
`),u=[],f=o?If(o.baseTime,o.timescale):0,d="00:00.000",h=0,c=0,v,g=!0;s.oncue=function(m){var y=n[r],E=n.ccOffset,T=(h-f)/9e4;if(y!=null&&y.new&&(c!==void 0?E=n.ccOffset=y.start:mh(n,r,T)),T){if(!o){v=new Error("Missing initPTS for VTT MPEGTS");return}E=T-n.presentationOffset}var S=m.endTime-m.startTime,A=Kt((m.startTime+E-c)*9e4,e*9e4)/9e4;m.startTime=Math.max(A,0),m.endTime=Math.max(A+S,0);var x=m.text.trim();m.text=decodeURIComponent(encodeURIComponent(x)),m.id||(m.id=ua(m.startTime,m.endTime,x)),m.endTime>0&&u.push(m)},s.onparsingerror=function(m){v=m},s.onflush=function(){if(v){i(v);return}t(u)},l.forEach(function(m){if(g)if(la(m,"X-TIMESTAMP-MAP=")){g=!1,m.slice(16).split(",").forEach(function(y){la(y,"LOCAL:")?d=y.slice(6):la(y,"MPEGTS:")&&(h=parseInt(y.slice(7)))});try{c=gh(d)/1e3}catch(y){v=y}return}else m===""&&(g=!1);s.parse(m+`
`)}),s.flush()}var fa="stpp.ttml.im1t",Yo=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,qo=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,yh={left:"start",center:"center",right:"end",start:"start",end:"end"};function jo(a,o,n,r){var e=ue(new Uint8Array(a),["mdat"]);if(e.length===0){r(new Error("Could not parse IMSC1 mdat"));return}var t=e.map(function(s){return Ge(s)}),i=Rf(o.baseTime,1,o.timescale);try{t.forEach(function(s){return n(Eh(s,i))})}catch(s){r(s)}}function Eh(a,o){var n=new DOMParser,r=n.parseFromString(a,"text/xml"),e=r.getElementsByTagName("tt")[0];if(!e)throw new Error("Invalid ttml");var t={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},i=Object.keys(t).reduce(function(d,h){return d[h]=e.getAttribute("ttp:"+h)||t[h],d},{}),s=e.getAttribute("xml:space")!=="preserve",l=Xo(da(e,"styling","style")),u=Xo(da(e,"layout","region")),f=da(e,"body","[begin]");return[].map.call(f,function(d){var h=zo(d,s);if(!h||!d.hasAttribute("begin"))return null;var c=ca(d.getAttribute("begin"),i),v=ca(d.getAttribute("dur"),i),g=ca(d.getAttribute("end"),i);if(c===null)throw Qo(d);if(g===null){if(v===null)throw Qo(d);g=c+v}var m=new sa(c-o,g-o,h);m.id=ua(m.startTime,m.endTime,m.text);var y=u[d.getAttribute("region")],E=l[d.getAttribute("style")],T=Th(y,E,l),S=T.textAlign;if(S){var A=yh[S];A&&(m.lineAlign=A),m.align=S}return ae(m,T),m}).filter(function(d){return d!==null})}function da(a,o,n){var r=a.getElementsByTagName(o)[0];return r?[].slice.call(r.querySelectorAll(n)):[]}function Xo(a){return a.reduce(function(o,n){var r=n.getAttribute("xml:id");return r&&(o[r]=n),o},{})}function zo(a,o){return[].slice.call(a.childNodes).reduce(function(n,r,e){var t;return r.nodeName==="br"&&e?n+`
`:(t=r.childNodes)!=null&&t.length?zo(r,o):o?n+r.textContent.trim().replace(/\s+/g," "):n+r.textContent},"")}function Th(a,o,n){var r="http://www.w3.org/ns/ttml#styling",e=null,t=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],i=a!=null&&a.hasAttribute("style")?a.getAttribute("style"):null;return i&&n.hasOwnProperty(i)&&(e=n[i]),t.reduce(function(s,l){var u=ha(o,r,l)||ha(a,r,l)||ha(e,r,l);return u&&(s[l]=u),s},{})}function ha(a,o,n){return a&&a.hasAttributeNS(o,n)?a.getAttributeNS(o,n):null}function Qo(a){return new Error("Could not parse ttml timestamp "+a)}function ca(a,o){if(!a)return null;var n=Ho(a);return n===null&&(Yo.test(a)?n=Sh(a,o):qo.test(a)&&(n=Ah(a,o))),n}function Sh(a,o){var n=Yo.exec(a),r=(n[4]|0)+(n[5]|0)/o.subFrameRate;return(n[1]|0)*3600+(n[2]|0)*60+(n[3]|0)+r/o.frameRate}function Ah(a,o){var n=qo.exec(a),r=Number(n[1]),e=n[2];switch(e){case"h":return r*3600;case"m":return r*60;case"ms":return r*1e3;case"f":return r/o.frameRate;case"t":return r/o.tickRate}return r}var Yi=function(){function a(n,r){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=n,this.trackName=r}var o=a.prototype;return o.dispatchCue=function(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)},o.newCue=function(r,e,t){(this.startTime===null||this.startTime>r)&&(this.startTime=r),this.endTime=e,this.screen=t,this.timelineController.createCaptionsTrack(this.trackName)},o.reset=function(){this.cueRanges=[],this.startTime=null},a}(),xh=function(){function a(n){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Zo(),this.captionsProperties=void 0,this.hls=n,this.config=n.config,this.Cues=n.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},n.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),n.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),n.on(p.MANIFEST_LOADING,this.onManifestLoading,this),n.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),n.on(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),n.on(p.FRAG_LOADING,this.onFragLoading,this),n.on(p.FRAG_LOADED,this.onFragLoaded,this),n.on(p.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),n.on(p.FRAG_DECRYPTED,this.onFragDecrypted,this),n.on(p.INIT_PTS_FOUND,this.onInitPtsFound,this),n.on(p.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),n.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this)}var o=a.prototype;return o.destroy=function(){var r=this.hls;r.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),r.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),r.off(p.MANIFEST_LOADING,this.onManifestLoading,this),r.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),r.off(p.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),r.off(p.FRAG_LOADING,this.onFragLoading,this),r.off(p.FRAG_LOADED,this.onFragLoaded,this),r.off(p.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),r.off(p.FRAG_DECRYPTED,this.onFragDecrypted,this),r.off(p.INIT_PTS_FOUND,this.onInitPtsFound,this),r.off(p.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),r.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0},o.initCea608Parsers=function(){var r=new Yi(this,"textTrack1"),e=new Yi(this,"textTrack2"),t=new Yi(this,"textTrack3"),i=new Yi(this,"textTrack4");this.cea608Parser1=new Ko(1,r,e),this.cea608Parser2=new Ko(3,t,i)},o.addCues=function(r,e,t,i,s){for(var l=!1,u=s.length;u--;){var f=s[u],d=Lh(f[0],f[1],e,t);if(d>=0&&(f[0]=Math.min(f[0],e),f[1]=Math.max(f[1],t),l=!0,d/(t-e)>.5))return}if(l||s.push([e,t]),this.config.renderTextTracksNatively){var h=this.captionsTracks[r];this.Cues.newCue(h,e,t,i)}else{var c=this.Cues.newCue(null,e,t,i);this.hls.trigger(p.CUES_PARSED,{type:"captions",cues:c,track:r})}},o.onInitPtsFound=function(r,e){var t=this,i=e.frag,s=e.id,l=e.initPTS,u=e.timescale,f=this.unparsedVttFrags;s===K.MAIN&&(this.initPTS[i.cc]={baseTime:l,timescale:u}),f.length&&(this.unparsedVttFrags=[],f.forEach(function(d){t.onFragLoaded(p.FRAG_LOADED,d)}))},o.getExistingTrack=function(r,e){var t=this.media;if(t)for(var i=0;i<t.textTracks.length;i++){var s=t.textTracks[i];if(Jo(s,{name:r,lang:e,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return s}return null},o.createCaptionsTrack=function(r){this.config.renderTextTracksNatively?this.createNativeTrack(r):this.createNonNativeTrack(r)},o.createNativeTrack=function(r){if(!this.captionsTracks[r]){var e=this.captionsProperties,t=this.captionsTracks,i=this.media,s=e[r],l=s.label,u=s.languageCode,f=this.getExistingTrack(l,u);if(f)t[r]=f,Kr(t[r]),Fo(t[r],i);else{var d=this.createTextTrack("captions",l,u);d&&(d[r]=!0,t[r]=d)}}},o.createNonNativeTrack=function(r){if(!this.nonNativeCaptionsTracks[r]){var e=this.captionsProperties[r];if(e){var t=e.label,i={_id:r,label:t,kind:"captions",default:e.media?!!e.media.default:!1,closedCaptions:e.media};this.nonNativeCaptionsTracks[r]=i,this.hls.trigger(p.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}}},o.createTextTrack=function(r,e,t){var i=this.media;if(i)return i.addTextTrack(r,e,t)},o.onMediaAttaching=function(r,e){this.media=e.media,e.mediaSource||this._cleanTracks()},o.onMediaDetaching=function(r,e){var t=!!e.transferMedia;if(this.media=null,!t){var i=this.captionsTracks;Object.keys(i).forEach(function(s){Kr(i[s]),delete i[s]}),this.nonNativeCaptionsTracks={}}},o.onManifestLoading=function(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=Zo(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())},o._cleanTracks=function(){var r=this.media;if(r){var e=r.textTracks;if(e)for(var t=0;t<e.length;t++)Kr(e[t])}},o.onSubtitleTracksUpdated=function(r,e){var t=this,i=e.subtitleTracks||[],s=i.some(function(c){return c.textCodec===fa});if(this.config.enableWebVTT||s&&this.config.enableIMSC1){var l=yo(this.tracks,i);if(l){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){var u=this.media,f=u?Hi(u.textTracks):null;if(this.tracks.forEach(function(c,v){var g;if(f){for(var m=null,y=0;y<f.length;y++)if(f[y]&&Jo(f[y],c)){m=f[y],f[y]=null;break}m&&(g=m)}if(g)Kr(g);else{var E=$o(c);g=t.createTextTrack(E,c.name,c.lang),g&&(g.mode="disabled")}g&&t.textTracks.push(g)}),f!=null&&f.length){var d=f.filter(function(c){return c!==null}).map(function(c){return c.label});d.length&&this.hls.logger.warn("Media element contains unused subtitle tracks: "+d.join(", ")+". Replace media element for each source to clear TextTracks and captions menu.")}}else if(this.tracks.length){var h=this.tracks.map(function(c){return{label:c.name,kind:c.type.toLowerCase(),default:c.default,subtitleTrack:c}});this.hls.trigger(p.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:h})}}},o.onManifestLoaded=function(r,e){var t=this;this.config.enableCEA708Captions&&e.captions&&e.captions.forEach(function(i){var s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(s){var l="textTrack"+s[1],u=t.captionsProperties[l];u&&(u.label=i.name,i.lang&&(u.languageCode=i.lang),u.media=i)}})},o.closedCaptionsForLevel=function(r){var e=this.hls.levels[r.level];return e==null?void 0:e.attrs["CLOSED-CAPTIONS"]},o.onFragLoading=function(r,e){if(this.enabled&&e.frag.type===K.MAIN){var t,i,s=this.cea608Parser1,l=this.cea608Parser2,u=this.lastSn,f=e.frag,d=f.cc,h=f.sn,c=(t=(i=e.part)==null?void 0:i.index)!=null?t:-1;s&&l&&(h!==u+1||h===u&&c!==this.lastPartIndex+1||d!==this.lastCc)&&(s.reset(),l.reset()),this.lastCc=d,this.lastSn=h,this.lastPartIndex=c}},o.onFragLoaded=function(r,e){var t=e.frag,i=e.payload;if(t.type===K.SUBTITLE)if(i.byteLength){var s=t.decryptdata,l="stats"in e;if(s==null||!s.encrypted||l){var u=this.tracks[t.level],f=this.vttCCs;f[t.cc]||(f[t.cc]={start:t.start,prevCC:this.prevCC,new:!0},this.prevCC=t.cc),u&&u.textCodec===fa?this._parseIMSC1(t,i):this._parseVTTs(e)}}else this.hls.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:new Error("Empty subtitle payload")})},o._parseIMSC1=function(r,e){var t=this,i=this.hls;jo(e,this.initPTS[r.cc],function(s){t._appendCues(s,r.level),i.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:r})},function(s){i.logger.log("Failed to parse IMSC1: "+s),i.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:r,error:s})})},o._parseVTTs=function(r){var e,t=this,i=r.frag,s=r.payload,l=this.initPTS,u=this.unparsedVttFrags,f=l.length-1;if(!l[i.cc]&&f===-1){u.push(r);return}var d=this.hls,h=(e=i.initSegment)!=null&&e.data?Gt(i.initSegment.data,new Uint8Array(s)).buffer:s;ph(h,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,function(c){t._appendCues(c,i.level),d.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},function(c){var v=c.message==="Missing initPTS for VTT MPEGTS";v?u.push(r):t._fallbackToIMSC1(i,s),d.logger.log("Failed to parse VTT cue: "+c),!(v&&f>i.cc)&&d.trigger(p.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:c})})},o._fallbackToIMSC1=function(r,e){var t=this,i=this.tracks[r.level];i.textCodec||jo(e,this.initPTS[r.cc],function(){i.textCodec=fa,t._parseIMSC1(r,e)},function(){i.textCodec="wvtt"})},o._appendCues=function(r,e){var t=this.hls;if(this.config.renderTextTracksNatively){var i=this.textTracks[e];if(!i||i.mode==="disabled")return;r.forEach(function(u){return No(i,u)})}else{var s=this.tracks[e];if(!s)return;var l=s.default?"default":"subtitles"+e;t.trigger(p.CUES_PARSED,{type:"subtitles",cues:r,track:l})}},o.onFragDecrypted=function(r,e){var t=e.frag;t.type===K.SUBTITLE&&this.onFragLoaded(p.FRAG_LOADED,e)},o.onSubtitleTracksCleared=function(){this.tracks=[],this.captionsTracks={}},o.onFragParsingUserdata=function(r,e){if(!(!this.enabled||!this.config.enableCEA708Captions)){var t=e.frag,i=e.samples;if(!(t.type===K.MAIN&&this.closedCaptionsForLevel(t)==="NONE"))for(var s=0;s<i.length;s++){var l=i[s].bytes;if(l){this.cea608Parser1||this.initCea608Parsers();var u=this.extractCea608Data(l);this.cea608Parser1.addData(i[s].pts,u[0]),this.cea608Parser2.addData(i[s].pts,u[1])}}}},o.onBufferFlushing=function(r,e){var t=e.startOffset,i=e.endOffset,s=e.endOffsetSubtitles,l=e.type,u=this.media;if(!(!u||u.currentTime<i)){if(!l||l==="video"){var f=this.captionsTracks;Object.keys(f).forEach(function(h){return na(f[h],t,i)})}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){var d=this.textTracks;Object.keys(d).forEach(function(h){return na(d[h],t,s)})}}},o.extractCea608Data=function(r){for(var e=[[],[]],t=r[0]&31,i=2,s=0;s<t;s++){var l=r[i++],u=127&r[i++],f=127&r[i++];if(!(u===0&&f===0)){var d=(4&l)!==0;if(d){var h=3&l;(h===0||h===1)&&(e[h].push(u),e[h].push(f))}}}return e},a}();function $o(a){return a.characteristics&&/transcribes-spoken-dialog/gi.test(a.characteristics)&&/describes-music-and-sound/gi.test(a.characteristics)?"captions":"subtitles"}function Jo(a,o){return!!a&&a.kind===$o(o)&&Qn(o,a)}function Lh(a,o,n,r){return Math.min(o,r)-Math.max(a,n)}function Zo(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}var bh=/\s/,Rh={newCue:function(o,n,r,e){for(var t=[],i,s,l,u,f,d=self.VTTCue||self.TextTrackCue,h=0;h<e.rows.length;h++)if(i=e.rows[h],l=!0,u=0,f="",!i.isEmpty()){for(var c,v=0;v<i.chars.length;v++)bh.test(i.chars[v].uchar)&&l?u++:(f+=i.chars[v].uchar,l=!1);i.cueStartTime=n,n===r&&(r+=1e-4),u>=16?u--:u++;var g=Wo(f.trim()),m=ua(n,r,g);o!=null&&(c=o.cues)!=null&&c.getCueById(m)||(s=new d(n,r,g),s.id=m,s.line=h+1,s.align="left",s.position=10+Math.min(80,Math.floor(u*8/32)*10),t.push(s))}return o&&t.length&&(t.sort(function(y,E){return y.line==="auto"||E.line==="auto"?0:y.line>8&&E.line>8?E.line-y.line:y.line-E.line}),t.forEach(function(y){return No(o,y)})),t}};function Ih(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}var _h=/(\d+)-(\d+)\/(\d+)/,el=function(){function a(n){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=n.fetchSetup||Ph,this.controller=new self.AbortController,this.stats=new _e}var o=a.prototype;return o.destroy=function(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null},o.abortInternal=function(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())},o.abort=function(){var r;this.abortInternal(),(r=this.callbacks)!=null&&r.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)},o.load=function(r,e,t){var i=this,s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();var l=Dh(r,this.controller.signal),u=r.responseType==="arraybuffer",f=u?"byteLength":"length",d=e.loadPolicy,h=d.maxTimeToFirstByteMs,c=d.maxLoadTimeMs;this.context=r,this.config=e,this.callbacks=t,this.request=this.fetchSetup(r,l),self.clearTimeout(this.requestTimeout),e.timeout=h&&N(h)?h:c,this.requestTimeout=self.setTimeout(function(){i.callbacks&&(i.abortInternal(),i.callbacks.onTimeout(s,r,i.response))},e.timeout);var v=Rr(this.request)?this.request.then(self.fetch):self.fetch(this.request);v.then(function(g){var m;i.response=i.loader=g;var y=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(i.requestTimeout),e.timeout=c,i.requestTimeout=self.setTimeout(function(){i.callbacks&&(i.abortInternal(),i.callbacks.onTimeout(s,r,i.response))},c-(y-s.loading.start)),!g.ok){var E=g.status,T=g.statusText;throw new wh(T||"fetch, bad network response",E,g)}s.loading.first=y,s.total=Ch(g.headers)||s.total;var S=(m=i.callbacks)==null?void 0:m.onProgress;return S&&N(e.highWaterMark)?i.loadProgressively(g,s,r,e.highWaterMark,S):u?g.arrayBuffer():r.responseType==="json"?g.json():g.text()}).then(function(g){var m,y,E=i.response;if(!E)throw new Error("loader destroyed");self.clearTimeout(i.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);var T=g[f];T&&(s.loaded=s.total=T);var S={url:E.url,data:g,code:E.status},A=(m=i.callbacks)==null?void 0:m.onProgress;A&&!N(e.highWaterMark)&&A(s,r,g,E),(y=i.callbacks)==null||y.onSuccess(S,s,r,E)}).catch(function(g){var m;if(self.clearTimeout(i.requestTimeout),!s.aborted){var y=g&&g.code||0,E=g?g.message:null;(m=i.callbacks)==null||m.onError({code:y,text:E},r,g?g.details:null,s)}})},o.getCacheAge=function(){var r=null;if(this.response){var e=this.response.headers.get("age");r=e?parseFloat(e):null}return r},o.getResponseHeader=function(r){return this.response?this.response.headers.get(r):null},o.loadProgressively=function(r,e,t,i,s){i===void 0&&(i=0);var l=new Ks,u=r.body.getReader(),f=function(){return u.read().then(function(h){if(h.done)return l.dataLength&&s(e,t,l.flush().buffer,r),Promise.resolve(new ArrayBuffer(0));var c=h.value,v=c.length;return e.loaded+=v,v<i||l.dataLength?(l.push(c),l.dataLength>=i&&s(e,t,l.flush().buffer,r)):s(e,t,c.buffer,r),f()}).catch(function(){return Promise.reject()})};return f()},a}();function Dh(a,o){var n={method:"GET",mode:"cors",credentials:"same-origin",signal:o,headers:new self.Headers(ae({},a.headers))};return a.rangeEnd&&n.headers.set("Range","bytes="+a.rangeStart+"-"+String(a.rangeEnd-1)),n}function kh(a){var o=_h.exec(a);if(o)return parseInt(o[2])-parseInt(o[1])+1}function Ch(a){var o=a.get("Content-Range");if(o){var n=kh(o);if(N(n))return n}var r=a.get("Content-Length");if(r)return parseInt(r)}function Ph(a,o){return new self.Request(a.url,o)}var wh=function(a){function o(n,r,e){var t;return t=a.call(this,n)||this,t.code=void 0,t.details=void 0,t.code=r,t.details=e,t}return J(o,a),o}(dt(Error)),Mh=/^age:\s*[\d.]+\s*$/im,tl=function(){function a(n){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=n&&n.xhrSetup||null,this.stats=new _e,this.retryDelay=0}var o=a.prototype;return o.destroy=function(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null},o.abortInternal=function(){var r=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),r&&(r.onreadystatechange=null,r.onprogress=null,r.readyState!==4&&(this.stats.aborted=!0,r.abort()))},o.abort=function(){var r;this.abortInternal(),(r=this.callbacks)!=null&&r.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)},o.load=function(r,e,t){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=r,this.config=e,this.callbacks=t,this.loadInternal()},o.loadInternal=function(){var r=this,e=this.config,t=this.context;if(!(!e||!t)){var i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;var l=this.xhrSetup;l?Promise.resolve().then(function(){if(!(r.loader!==i||r.stats.aborted))return l(i,t.url)}).catch(function(u){if(!(r.loader!==i||r.stats.aborted))return i.open("GET",t.url,!0),l(i,t.url)}).then(function(){r.loader!==i||r.stats.aborted||r.openAndSendXhr(i,t,e)}).catch(function(u){var f;(f=r.callbacks)==null||f.onError({code:i.status,text:u.message},t,i,s)}):this.openAndSendXhr(i,t,e)}},o.openAndSendXhr=function(r,e,t){r.readyState||r.open("GET",e.url,!0);var i=e.headers,s=t.loadPolicy,l=s.maxTimeToFirstByteMs,u=s.maxLoadTimeMs;if(i)for(var f in i)r.setRequestHeader(f,i[f]);e.rangeEnd&&r.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),r.onreadystatechange=this.readystatechange.bind(this),r.onprogress=this.loadprogress.bind(this),r.responseType=e.responseType,self.clearTimeout(this.requestTimeout),t.timeout=l&&N(l)?l:u,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),t.timeout),r.send()},o.readystatechange=function(){var r=this.context,e=this.loader,t=this.stats;if(!(!r||!e)){var i=e.readyState,s=this.config;if(!t.aborted&&i>=2&&(t.loading.first===0&&(t.loading.first=Math.max(self.performance.now(),t.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(t.loading.first-t.loading.start)))),i===4)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;var l=e.status,u=e.responseType==="text"?e.responseText:null;if(l>=200&&l<300){var f=u??e.response;if(f!=null){var d,h;t.loading.end=Math.max(self.performance.now(),t.loading.first);var c=e.responseType==="arraybuffer"?f.byteLength:f.length;t.loaded=t.total=c,t.bwEstimate=t.total*8e3/(t.loading.end-t.loading.first);var v=(d=this.callbacks)==null?void 0:d.onProgress;v&&v(t,r,f,e);var g={url:e.responseURL,data:f,code:l};(h=this.callbacks)==null||h.onSuccess(g,t,r,e);return}}var m=s.loadPolicy.errorRetry,y=t.retry,E={url:r.url,data:void 0,code:l};if(bi(m,y,!1,E))this.retry(m);else{var T;X.error(l+" while loading "+r.url),(T=this.callbacks)==null||T.onError({code:l,text:e.statusText},r,e,t)}}}},o.loadtimeout=function(){if(this.config){var r=this.config.loadPolicy.timeoutRetry,e=this.stats.retry;if(bi(r,e,!0))this.retry(r);else{var t;X.warn("timeout while loading "+((t=this.context)==null?void 0:t.url));var i=this.callbacks;i&&(this.abortInternal(),i.onTimeout(this.stats,this.context,this.loader))}}},o.retry=function(r){var e=this.context,t=this.stats;this.retryDelay=yn(r,t.retry),t.retry++,X.warn((status?"HTTP Status "+status:"Timeout")+" while loading "+(e==null?void 0:e.url)+", retrying "+t.retry+"/"+r.maxNumRetry+" in "+this.retryDelay+"ms"),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)},o.loadprogress=function(r){var e=this.stats;e.loaded=r.loaded,r.lengthComputable&&(e.total=r.total)},o.getCacheAge=function(){var r=null;if(this.loader&&Mh.test(this.loader.getAllResponseHeaders())){var e=this.loader.getResponseHeader("age");r=e?parseFloat(e):null}return r},o.getResponseHeader=function(r){return this.loader&&new RegExp("^"+r+":\\s*[\\d.]+\\s*$","im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(r):null},a}(),Oh={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Fh=Q(Q({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:tl,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:tu,bufferController:zf,capLevelController:$f,errorController:ou,fpsController:Gd,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:ps,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,certLoadPolicy:{default:Oh},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},Nh()),{},{subtitleStreamController:Xd,subtitleTrackController:Jd,timelineController:xh,audioStreamController:Yf,audioTrackController:qf,emeController:Co,cmcdController:Nd,contentSteeringController:Bd,interstitialsController:jd});function Nh(){return{cueHandler:Rh,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function Uh(a,o,n){if((o.liveSyncDurationCount||o.liveMaxLatencyDurationCount)&&(o.liveSyncDuration||o.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(o.liveMaxLatencyDurationCount!==void 0&&(o.liveSyncDurationCount===void 0||o.liveMaxLatencyDurationCount<=o.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(o.liveMaxLatencyDuration!==void 0&&(o.liveSyncDuration===void 0||o.liveMaxLatencyDuration<=o.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');var r=va(a),e=["manifest","level","frag"],t=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return e.forEach(function(i){var s=(i==="level"?"playlist":i)+"LoadPolicy",l=o[s]===void 0,u=[];t.forEach(function(f){var d=i+"Loading"+f,h=o[d];if(h!==void 0&&l){u.push(d);var c=r[s].default;switch(o[s]={default:c},f){case"TimeOut":c.maxLoadTimeMs=h,c.maxTimeToFirstByteMs=h;break;case"MaxRetry":c.errorRetry.maxNumRetry=h,c.timeoutRetry.maxNumRetry=h;break;case"RetryDelay":c.errorRetry.retryDelayMs=h,c.timeoutRetry.retryDelayMs=h;break;case"MaxRetryTimeout":c.errorRetry.maxRetryDelayMs=h,c.timeoutRetry.maxRetryDelayMs=h;break}}}),u.length&&n.warn('hls.js config: "'+u.join('", "')+'" setting(s) are deprecated, use "'+s+'": '+He(o[s]))}),Q(Q({},r),o)}function va(a){return a&&typeof a=="object"?Array.isArray(a)?a.map(va):Object.keys(a).reduce(function(o,n){return o[n]=va(a[n]),o},{}):a}function Bh(a,o){var n=a.loader;if(n!==el&&n!==tl)o.log("[config]: Custom loader detected, cannot enable progressive streaming"),a.progressive=!1;else{var r=Ih();r&&(a.loader=el,a.progressive=!0,a.enableSoftwareAES=!0,o.log("[config]: Progressive streaming enabled, using FetchLoader"))}}var qi=2,Gh=.1,Kh=.05,Hh=100,Vh=function(a){function o(r,e){var t;return t=a.call(this,"gap-controller",r.logger)||this,t.hls=null,t.fragmentTracker=null,t.media=null,t.mediaSource=void 0,t.nudgeRetry=0,t.stallReported=!1,t.stalled=null,t.moved=!1,t.seeking=!1,t.buffered={},t.lastCurrentTime=0,t.ended=0,t.waiting=0,t.onMediaPlaying=function(){t.ended=0,t.waiting=0},t.onMediaWaiting=function(){var i;(i=t.media)!=null&&i.seeking||(t.waiting=self.performance.now(),t.tick())},t.onMediaEnded=function(){if(t.hls){var i;t.ended=((i=t.media)==null?void 0:i.currentTime)||1,t.hls.trigger(p.MEDIA_ENDED,{stalled:!1})}},t.hls=r,t.fragmentTracker=e,t.registerListeners(),t}J(o,a);var n=o.prototype;return n.registerListeners=function(){var e=this.hls;e&&(e.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(p.BUFFER_APPENDED,this.onBufferAppended,this))},n.unregisterListeners=function(){var e=this.hls;e&&(e.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(p.BUFFER_APPENDED,this.onBufferAppended,this))},n.destroy=function(){a.prototype.destroy.call(this),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0},n.onMediaAttached=function(e,t){this.setInterval(Hh),this.mediaSource=t.mediaSource;var i=this.media=t.media;ur(i,"playing",this.onMediaPlaying),ur(i,"waiting",this.onMediaWaiting),ur(i,"ended",this.onMediaEnded)},n.onMediaDetaching=function(e,t){this.clearInterval();var i=this.media;i&&(tr(i,"playing",this.onMediaPlaying),tr(i,"waiting",this.onMediaWaiting),tr(i,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0},n.onBufferAppended=function(e,t){this.buffered=t.timeRanges},n.tick=function(){var e;if(!(!((e=this.media)!=null&&e.readyState)||!this.hasBuffered)){var t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}},n.poll=function(e,t){var i,s,l=(i=this.hls)==null?void 0:i.config;if(l){var u=this.media,f=this.stalled;if(u){var d=u.seeking,h=this.seeking&&!d,c=!this.seeking&&d,v=u.paused&&!d||u.ended||u.playbackRate===0;if(this.seeking=d,e!==t){t&&(this.ended=0),this.moved=!0,d||(this.nudgeRetry=0,l.nudgeOnVideoHole&&!v&&e>t&&this.nudgeOnVideoHole(e,t)),this.waiting===0&&this.stallResolved(e);return}if(c||h){h&&this.stallResolved(e);return}if(v){this.nudgeRetry=0,this.stallResolved(e),!this.ended&&u.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(p.MEDIA_ENDED,{stalled:!1}));return}if(!Se.getBuffered(u).length){this.nudgeRetry=0;return}var g=Se.bufferInfo(u,e,0),m=g.nextStart||0,y=this.fragmentTracker;if(d&&y&&this.hls){var E=rl(this.hls.inFlightFragments,e),T=g.len>qi,S=!m||E||m-e>qi&&!y.getPartialFragment(e);if(T||S)return;this.moved=!1}var A=(s=this.hls)==null?void 0:s.latestLevelDetails;if(!this.moved&&this.stalled!==null&&y){var x=g.len>0;if(!x&&!m)return;var L=Math.max(m,g.start||0)-e,I=!!(A!=null&&A.live),k=I?A.targetduration*2:qi,R=y.getPartialFragment(e);if(L>0&&(L<=k||R)){u.paused||this._trySkipBufferHole(R);return}}var b=l.detectStallWithCurrentTimeMs,D=self.performance.now(),P=this.waiting;if(f===null){P>0&&D-P<b?this.stalled=P:this.stalled=D;return}var U=D-f;if(!d&&(U>=b||P)&&this.hls){var F;if(((F=this.mediaSource)==null?void 0:F.readyState)==="ended"&&!(A!=null&&A.live)&&Math.abs(e-((A==null?void 0:A.edge)||0))<1){if(this.ended)return;this.ended=e||1,this.hls.trigger(p.MEDIA_ENDED,{stalled:!0});return}if(this._reportStall(g),!this.media||!this.hls)return}var M=Se.bufferInfo(u,e,l.maxBufferHole);this._tryFixBufferStall(M,U)}}},n.stallResolved=function(e){var t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){var i=self.performance.now()-t;this.log("playback not stuck anymore @"+e+", after "+Math.round(i)+"ms"),this.stallReported=!1,this.waiting=0,this.hls.trigger(p.STALL_RESOLVED,{})}},n.nudgeOnVideoHole=function(e,t){var i,s=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&(i=this.buffered.audio)!=null&&i.length&&s&&s.length>1&&e>s.end(0)){var l=Se.bufferedInfo(Se.timeRangesToArray(this.buffered.audio),e,0);if(l.len>1&&t>=l.start){var u=Se.timeRangesToArray(s),f=Se.bufferedInfo(u,t,0).bufferedIndex;if(f>-1&&f<u.length-1){var d=Se.bufferedInfo(u,e,0).bufferedIndex,h=u[f].end,c=u[f+1].start;if((d===-1||d>f)&&c-h<1&&e-h<2){var v=new Error("nudging playhead to flush pipeline after video hole. currentTime: "+e+" hole: "+h+" -> "+c+" buffered index: "+d);this.warn(v.message),this.media.currentTime+=1e-6;var g=this.fragmentTracker.getPartialFragment(e)||void 0,m=Se.bufferInfo(this.media,e,0);this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:v,reason:v.message,frag:g,buffer:m.len,bufferInfo:m})}}}}},n._tryFixBufferStall=function(e,t){var i,s,l=this.fragmentTracker,u=this.media,f=(i=this.hls)==null?void 0:i.config;if(!(!u||!l||!f)){var d=u.currentTime,h=(s=this.hls)==null?void 0:s.latestLevelDetails,c=l.getPartialFragment(d);if(c||h!=null&&h.live&&d<h.fragmentStart){var v=this._trySkipBufferHole(c);if(v||!this.media)return}var g=e.buffered;(g&&g.length>1&&e.len>f.maxBufferHole||e.nextStart&&e.nextStart-d<f.maxBufferHole)&&(t>f.highBufferWatchdogPeriod*1e3||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}},n._reportStall=function(e){var t=this.hls,i=this.media,s=this.stallReported,l=this.stalled;if(!s&&l!==null&&i&&t){this.stallReported=!0;var u=new Error("Playback stalling at @"+i.currentTime+" due to low buffer ("+He(e)+")");this.warn(u.message),t.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_STALLED_ERROR,fatal:!1,error:u,buffer:e.len,bufferInfo:e,stalled:{start:l}})}},n._trySkipBufferHole=function(e){var t,i=this.fragmentTracker,s=this.media,l=(t=this.hls)==null?void 0:t.config;if(!s||!i||!l)return 0;var u=s.currentTime,f=Se.bufferInfo(s,u,0),d=u<f.start?f.start:f.nextStart;if(d&&this.hls){var h=f.len<=l.maxBufferHole,c=f.len>0&&f.len<1&&s.readyState<3,v=d-u;if(v>0&&(h||c)){if(v>l.maxBufferHole){var g=!1;if(u===0){var m=i.getAppendedFrag(0,K.MAIN);m&&d<m.end&&(g=!0)}if(!g){var y=e||i.getAppendedFrag(u,K.MAIN);if(y){var E;if(!((E=this.hls.loadLevelObj)!=null&&E.details))return 0;var T=rl(this.hls.inFlightFragments,d);if(T)return 0;for(var S=!1,A=y.end;A<d;){var x=i.getPartialFragment(A);if(x)A+=x.duration;else{S=!0;break}}if(S)return 0}}}var L=Math.max(d+Kh,u+Gh);if(this.warn("skipping hole, adjusting currentTime from "+u+" to "+L),this.moved=!0,s.currentTime=L,!(e!=null&&e.gap)){var I=new Error("fragment loaded with buffer holes, seeking from "+u+" to "+L);this.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:I,reason:I.message,frag:e||void 0,buffer:f.len,bufferInfo:f})}return L}}return 0},n._tryNudgeBuffer=function(e){var t=this.hls,i=this.media,s=this.nudgeRetry,l=t==null?void 0:t.config;if(!i||!l)return 0;var u=i.currentTime;if(this.nudgeRetry++,s<l.nudgeMaxRetry){var f=u+(s+1)*l.nudgeOffset,d=new Error("Nudging 'currentTime' from "+u+" to "+f);this.warn(d.message),i.currentTime=f,t.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_NUDGE_ON_STALL,error:d,fatal:!1,buffer:e.len,bufferInfo:e})}else{var h=new Error("Playhead still not moving while enough data buffered @"+u+" after "+l.nudgeMaxRetry+" nudges");this.error(h.message),t.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.BUFFER_STALLED_ERROR,error:h,fatal:!0,buffer:e.len,bufferInfo:e})}},z(o,[{key:"hasBuffered",get:function(){return Object.keys(this.buffered).length>0}}])}(fs);function rl(a,o){var n=il(a.main);if(n&&n.start<=o)return n;var r=il(a.audio);return r&&r.start<=o?r:null}function il(a){if(!a)return null;switch(a.state){case w.IDLE:case w.STOPPED:case w.ENDED:case w.ERROR:return null}return a.frag}var Wh=.25;function ga(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function nl(a,o,n,r,e){var t=new a(o,n,"");try{t.value=r,e&&(t.type=e)}catch{t=new a(o,n,He(e?Q({type:e},r):r))}return t}var ji=function(){var a=ga();try{a&&new a(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY}();function Yh(a){return Uint8Array.from(a.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}var qh=function(){function a(n){var r=this;this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=function(){r.hls&&r.hls.trigger(p.EVENT_CUE_ENTER,{})},this.hls=n,this._registerListeners()}var o=a.prototype;return o.destroy=function(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null},o._registerListeners=function(){var r=this.hls;r.on(p.MEDIA_ATTACHING,this.onMediaAttaching,this),r.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),r.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),r.on(p.MANIFEST_LOADING,this.onManifestLoading,this),r.on(p.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),r.on(p.BUFFER_FLUSHING,this.onBufferFlushing,this),r.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),r.on(p.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)},o._unregisterListeners=function(){var r=this.hls;r.off(p.MEDIA_ATTACHING,this.onMediaAttaching,this),r.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),r.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),r.off(p.MANIFEST_LOADING,this.onManifestLoading,this),r.off(p.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),r.off(p.BUFFER_FLUSHING,this.onBufferFlushing,this),r.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),r.off(p.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)},o.onMediaAttaching=function(r,e){var t;this.media=e.media,((t=e.overrides)==null?void 0:t.cueRemoval)===!1&&(this.removeCues=!1)},o.onMediaAttached=function(){var r=this.hls.latestLevelDetails;r&&this.updateDateRangeCues(r)},o.onMediaDetaching=function(r,e){this.media=null;var t=!!e.transferMedia;t||(this.id3Track&&(this.removeCues&&Kr(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})},o.onManifestLoading=function(){this.dateRangeCuesAppended={}},o.createTrack=function(r){var e=this.getID3Track(r.textTracks);return e.mode="hidden",e},o.getID3Track=function(r){if(this.media){for(var e=0;e<r.length;e++){var t=r[e];if(t.kind==="metadata"&&t.label==="id3")return Fo(t,this.media),t}return this.media.addTextTrack("metadata","id3")}},o.onFragParsingMetadata=function(r,e){if(this.media){var t=this.hls.config,i=t.enableEmsgMetadataCues,s=t.enableID3MetadataCues;if(!(!i&&!s)){var l=e.samples;this.id3Track||(this.id3Track=this.createTrack(this.media));var u=ga();if(u)for(var f=0;f<l.length;f++){var d=l[f].type;if(!(d===Ft.emsg&&!i||!s)){var h=zs(l[f].data);if(h){var c=l[f].pts,v=c+l[f].duration;v>ji&&(v=ji);var g=v-c;g<=0&&(v=c+Wh);for(var m=0;m<h.length;m++){var y=h[m];if(!Qs(y)){this.updateId3CueEnds(c,d);var E=nl(u,c,v,y,d);E&&this.id3Track.addCue(E)}}}}}}}},o.updateId3CueEnds=function(r,e){var t,i=(t=this.id3Track)==null?void 0:t.cues;if(i)for(var s=i.length;s--;){var l=i[s];l.type===e&&l.startTime<r&&l.endTime===ji&&(l.endTime=r)}},o.onBufferFlushing=function(r,e){var t=e.startOffset,i=e.endOffset,s=e.type,l=this.id3Track,u=this.hls;if(u){var f=u.config,d=f.enableEmsgMetadataCues,h=f.enableID3MetadataCues;if(l&&(d||h)){var c;s==="audio"?c=function(g){return g.type===Ft.audioId3&&h}:s==="video"?c=function(g){return g.type===Ft.emsg&&d}:c=function(g){return g.type===Ft.audioId3&&h||g.type===Ft.emsg&&d},na(l,t,i,c)}}},o.onLevelUpdated=function(r,e){var t=e.details;this.updateDateRangeCues(t,!0)},o.onLevelPtsUpdated=function(r,e){Math.abs(e.drift)>.01&&this.updateDateRangeCues(e.details)},o.updateDateRangeCues=function(r,e){var t=this;if(!(!this.media||!r.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)){var i=this.id3Track,s=r.dateRanges,l=Object.keys(s),u=this.dateRangeCuesAppended;if(i&&e){var f;if((f=i.cues)!=null&&f.length)for(var d=Object.keys(u).filter(function(E){return!l.includes(E)}),h=function(){var T=d[c],S=u[T].cues;delete u[T],Object.keys(S).forEach(function(A){try{var x=S[A];x.removeEventListener("enter",t.onEventCueEnter),i.removeCue(x)}catch{}})},c=d.length;c--;)h();else u=this.dateRangeCuesAppended={}}var v=r.fragments[r.fragments.length-1];if(!(l.length===0||!N(v==null?void 0:v.programDateTime))){this.id3Track||(this.id3Track=this.createTrack(this.media));for(var g=ga(),m=function(){var T=l[y],S=s[T],A=S.startTime,x=u[T],L=(x==null?void 0:x.cues)||{},I=(x==null?void 0:x.durationKnown)||!1,k=ji,R=S.duration,b=S.endDate;if(b&&R!==null)k=A+R,I=!0;else if(S.endOnNext&&!I){var D=l.reduce(function(ee,ye){if(ye!==S.id){var le=s[ye];if(le.class===S.class&&le.startDate>S.startDate&&(!ee||S.startDate<ee.startDate))return le}return ee},null);D&&(k=D.startTime,I=!0)}for(var P=Object.keys(S.attr),U=0;U<P.length;U++){var F=P[U];if(Tu(F)){var M=L[F];if(M)I&&!x.durationKnown?M.endTime=k:Math.abs(M.startTime-A)>.01&&(M.startTime=A,M.endTime=k);else if(g){var H=S.attr[F];Su(F)&&(H=Yh(H));var q={key:F,data:H},W=nl(g,A,k,q,Ft.dateRange);W&&(W.id=T,t.id3Track.addCue(W),L[F]=W,t.hls.config.interstitialsController&&(F==="X-ASSET-LIST"||F==="X-ASSET-URL")&&W.addEventListener("enter",t.onEventCueEnter))}}}u[T]={cues:L,dateRange:S,durationKnown:I}},y=0;y<l.length;y++)m()}}},a}(),jh=function(){function a(n){var r=this;this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=function(){var e=r.media,t=r.levelDetails;if(!(!e||!t)){r.currentTime=e.currentTime;var i=r.computeLatency();if(i!==null){r._latency=i;var s=r.config,l=s.lowLatencyMode,u=s.maxLiveSyncPlaybackRate;if(!(!l||u===1||!t.live)){var f=r.targetLatency;if(f!==null){var d=i-f,h=Math.min(r.maxLatency,f+t.targetduration),c=d<h;if(c&&d>.05&&r.forwardBufferLength>1){var v=Math.min(2,Math.max(1,u)),g=Math.round(2/(1+Math.exp(-.75*d-r.edgeStalled))*20)/20,m=Math.min(v,Math.max(1,g));r.changeMediaPlaybackRate(e,m)}else e.playbackRate!==1&&e.playbackRate!==0&&r.changeMediaPlaybackRate(e,1)}}}}},this.hls=n,this.config=n.config,this.registerListeners()}var o=a.prototype;return o.destroy=function(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null},o.registerListeners=function(){var r=this.hls;r&&(r.on(p.MEDIA_ATTACHED,this.onMediaAttached,this),r.on(p.MEDIA_DETACHING,this.onMediaDetaching,this),r.on(p.MANIFEST_LOADING,this.onManifestLoading,this),r.on(p.LEVEL_UPDATED,this.onLevelUpdated,this),r.on(p.ERROR,this.onError,this))},o.unregisterListeners=function(){var r=this.hls;r&&(r.off(p.MEDIA_ATTACHED,this.onMediaAttached,this),r.off(p.MEDIA_DETACHING,this.onMediaDetaching,this),r.off(p.MANIFEST_LOADING,this.onManifestLoading,this),r.off(p.LEVEL_UPDATED,this.onLevelUpdated,this),r.off(p.ERROR,this.onError,this))},o.onMediaAttached=function(r,e){this.media=e.media,this.media.addEventListener("timeupdate",this.onTimeupdate)},o.onMediaDetaching=function(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)},o.onManifestLoading=function(){this._latency=null,this.stallCount=0},o.onLevelUpdated=function(r,e){var t=e.details;t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)},o.onError=function(r,e){var t;e.details===_.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&(t=this.levelDetails)!=null&&t.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))},o.changeMediaPlaybackRate=function(r,e){var t,i;r.playbackRate!==e&&((t=this.hls)==null||t.logger.debug("[latency-controller]: latency="+this.latency.toFixed(3)+", targetLatency="+((i=this.targetLatency)==null?void 0:i.toFixed(3))+", forwardBufferLength="+this.forwardBufferLength.toFixed(3)+": adjusting playback rate from "+r.playbackRate+" to "+e),r.playbackRate=e)},o.estimateLiveEdge=function(){var r=this.levelDetails;return r===null?null:r.edge+r.age},o.computeLatency=function(){var r=this.estimateLiveEdge();return r===null?null:r-this.currentTime},z(a,[{key:"levelDetails",get:function(){var r;return((r=this.hls)==null?void 0:r.latestLevelDetails)||null}},{key:"latency",get:function(){return this._latency||0}},{key:"maxLatency",get:function(){var r=this.config;if(r.liveMaxLatencyDuration!==void 0)return r.liveMaxLatencyDuration;var e=this.levelDetails;return e?r.liveMaxLatencyDurationCount*e.targetduration:0}},{key:"targetLatency",get:function(){var r=this.levelDetails;if(r===null||this.hls===null)return null;var e=r.holdBack,t=r.partHoldBack,i=r.targetduration,s=this.config,l=s.liveSyncDuration,u=s.liveSyncDurationCount,f=s.lowLatencyMode,d=this.hls.userConfig,h=f&&t||e;(this._targetLatencyUpdated||d.liveSyncDuration||d.liveSyncDurationCount||h===0)&&(h=l!==void 0?l:u*i);var c=i;return h+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,c)},set:function(r){this.stallCount=0,this.config.liveSyncDuration=r,this._targetLatencyUpdated=!0}},{key:"liveSyncPosition",get:function(){var r=this.estimateLiveEdge(),e=this.targetLatency;if(r===null||e===null)return null;var t=this.levelDetails;if(t===null)return null;var i=t.edge,s=r-e-this.edgeStalled,l=i-t.totalduration,u=i-(this.config.lowLatencyMode&&t.partTarget||t.targetduration);return Math.min(Math.max(l,s),u)}},{key:"drift",get:function(){var r=this.levelDetails;return r===null?1:r.drift}},{key:"edgeStalled",get:function(){var r=this.levelDetails;if(r===null)return 0;var e=(this.config.lowLatencyMode&&r.partTarget||r.targetduration)*3;return Math.max(r.age-e,0)}},{key:"forwardBufferLength",get:function(){var r=this.media,e=this.levelDetails;if(!r||!e)return 0;var t=r.buffered.length;return(t?r.buffered.end(t-1):e.edge)-this.currentTime}}])}(),Xh=function(a){function o(r,e){var t;return t=a.call(this,r,"level-controller")||this,t._levels=[],t._firstLevel=-1,t._maxAutoLevel=-1,t._startLevel=void 0,t.currentLevel=null,t.currentLevelIndex=-1,t.manualLevelIndex=-1,t.steering=void 0,t.onParsedComplete=void 0,t.steering=e,t._registerListeners(),t}J(o,a);var n=o.prototype;return n._registerListeners=function(){var e=this.hls;e.on(p.MANIFEST_LOADING,this.onManifestLoading,this),e.on(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this),e.on(p.ERROR,this.onError,this)},n._unregisterListeners=function(){var e=this.hls;e.off(p.MANIFEST_LOADING,this.onManifestLoading,this),e.off(p.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this),e.off(p.ERROR,this.onError,this)},n.destroy=function(){this._unregisterListeners(),this.steering=null,this.resetLevels(),a.prototype.destroy.call(this)},n.stopLoad=function(){var e=this._levels;e.forEach(function(t){t.loadError=0,t.fragmentError=0}),a.prototype.stopLoad.call(this)},n.resetLevels=function(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1},n.onManifestLoading=function(e,t){this.resetLevels()},n.onManifestLoaded=function(e,t){var i=this,s=this.hls.config.preferManagedMediaSource,l=[],u={},f={},d=!1,h=!1,c=!1;t.levels.forEach(function(v){var g,m=v.attrs,y=v.audioCodec,E=v.videoCodec;y&&(v.audioCodec=y=Ei(y,s)||void 0),((g=E)==null?void 0:g.indexOf("avc1"))===0&&(E=v.videoCodec=Kl(E));var T=v.width,S=v.height,A=v.unknownCodecs,x=A?A.length:0;if(A)for(var L=x;L--;){var I=A[L];i.isAudioSupported(I)?(v.audioCodec=y=y?y+","+I:I,x--,Pr.audio[y.substring(0,4)]=2):i.isVideoSupported(I)&&(v.videoCodec=E=E?E+","+I:I,x--,Pr.video[E.substring(0,4)]=2)}if(d||(d=!!(T&&S)),h||(h=!!E),c||(c=!!y),x||y&&!i.isAudioSupported(y)||E&&!i.isVideoSupported(E)){i.log('Some or all CODECS not supported "'+m.CODECS+'"');return}var k=m.CODECS,R=m["FRAME-RATE"],b=m["HDCP-LEVEL"],D=m["PATHWAY-ID"],P=m.RESOLUTION,U=m["VIDEO-RANGE"],F=(D||".")+"-",M=""+F+v.bitrate+"-"+P+"-"+R+"-"+k+"-"+U+"-"+b;if(u[M])if(u[M].uri!==v.url&&!v.attrs["PATHWAY-ID"]){var q=f[M]+=1;v.attrs["PATHWAY-ID"]=new Array(q+1).join(".");var W=i.createLevel(v);u[M]=W,l.push(W)}else u[M].addGroupId("audio",m.AUDIO),u[M].addGroupId("text",m.SUBTITLES);else{var H=i.createLevel(v);u[M]=H,f[M]=1,l.push(H)}}),this.filterAndSortMediaOptions(l,t,d,h,c)},n.createLevel=function(e){var t=new $r(e),i=e.supplemental;if(i!=null&&i.videoCodec&&!this.isVideoSupported(i.videoCodec)){var s=new Error('SUPPLEMENTAL-CODECS not supported "'+i.videoCodec+'"');this.log(s.message),t.supportedResult=ja(s,[])}return t},n.isAudioSupported=function(e){return vn(e,"audio",this.hls.config.preferManagedMediaSource)},n.isVideoSupported=function(e){return vn(e,"video",this.hls.config.preferManagedMediaSource)},n.filterAndSortMediaOptions=function(e,t,i,s,l){var u=this,f=[],d=[],h=e;if((i||s)&&l&&(h=h.filter(function(k){var R=k.videoCodec,b=k.videoRange,D=k.width,P=k.height;return(!!R||!!(D&&P))&&ql(b)})),h.length===0){Promise.resolve().then(function(){if(u.hls){var k="no level with compatible codecs found in manifest",R=k;t.levels.length&&(R="one or more CODECS in variant not supported: "+He(t.levels.map(function(D){return D.attrs.CODECS}).filter(function(D,P,U){return U.indexOf(D)===P})),u.warn(R),k+=" ("+R+")");var b=new Error(k);u.hls.trigger(p.ERROR,{type:V.MEDIA_ERROR,details:_.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:b,reason:R})}});return}t.audioTracks&&(f=t.audioTracks.filter(function(k){return!k.audioCodec||u.isAudioSupported(k.audioCodec)}),al(f)),t.subtitles&&(d=t.subtitles,al(d));var c=h.slice(0);h.sort(function(k,R){if(k.attrs["HDCP-LEVEL"]!==R.attrs["HDCP-LEVEL"])return(k.attrs["HDCP-LEVEL"]||"")>(R.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&k.height!==R.height)return k.height-R.height;if(k.frameRate!==R.frameRate)return k.frameRate-R.frameRate;if(k.videoRange!==R.videoRange)return Si.indexOf(k.videoRange)-Si.indexOf(R.videoRange);if(k.videoCodec!==R.videoCodec){var b=Va(k.videoCodec),D=Va(R.videoCodec);if(b!==D)return D-b}if(k.uri===R.uri&&k.codecSet!==R.codecSet){var P=yi(k.codecSet),U=yi(R.codecSet);if(P!==U)return U-P}return k.averageBitrate!==R.averageBitrate?k.averageBitrate-R.averageBitrate:0});var v=c[0];if(this.steering&&(h=this.steering.filterParsedLevels(h),h.length!==c.length)){for(var g=0;g<c.length;g++)if(c[g].pathwayId===h[0].pathwayId){v=c[g];break}}this._levels=h;for(var m=0;m<h.length;m++)if(h[m]===v){var y;this._firstLevel=m;var E=v.bitrate,T=this.hls.bandwidthEstimate;if(this.log("manifest loaded, "+h.length+" level(s) found, first bitrate: "+E),((y=this.hls.userConfig)==null?void 0:y.abrEwmaDefaultEstimate)===void 0){var S=Math.min(E,this.hls.config.abrEwmaDefaultEstimateMax);S>T&&T===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=S)}break}var A=l&&!s,x=this.hls.config,L=!!(x.audioStreamController&&x.audioTrackController),I={levels:h,audioTracks:f,subtitleTracks:d,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:l,video:s,altAudio:L&&!A&&f.some(function(k){return!!k.url})};this.hls.trigger(p.MANIFEST_PARSED,I)},n.onError=function(e,t){t.fatal||!t.context||t.context.type===j.LEVEL&&t.context.level===this.level&&this.checkRetry(t)},n.onFragBuffered=function(e,t){var i=t.frag;if(i!==void 0&&i.type===K.MAIN){var s=i.elementaryStreams;if(!Object.keys(s).some(function(u){return!!s[u]}))return;var l=this._levels[i.level];l!=null&&l.loadError&&(this.log("Resetting level error count of "+l.loadError+" on frag buffered"),l.loadError=0)}},n.onLevelLoaded=function(e,t){var i,s=t.level,l=t.details,u=t.levelInfo;if(!u){var f;this.warn("Invalid level index "+s),(f=t.deliveryDirectives)!=null&&f.skip&&(l.deltaUpdateFailed=!0);return}if(u===this.currentLevel||t.withoutMultiVariant){u.fragmentError===0&&(u.loadError=0);var d=u.details;d===t.details&&d.advanced&&(d=void 0),this.playlistLoaded(s,t,d)}else(i=t.deliveryDirectives)!=null&&i.skip&&(l.deltaUpdateFailed=!0)},n.loadPlaylist=function(e){a.prototype.loadPlaylist.call(this),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)},n.loadingPlaylist=function(e,t){a.prototype.loadingPlaylist.call(this,e,t);var i=this.getUrlWithDirectives(e.uri,t),s=this.currentLevelIndex,l=e.attrs["PATHWAY-ID"],u=e.details,f=u==null?void 0:u.age;this.log("Loading level index "+s+((t==null?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:"")+(l?" Pathway "+l:"")+(f&&u.live?" age "+f.toFixed(1)+(u.type&&" "+u.type||""):"")+" "+i),this.hls.trigger(p.LEVEL_LOADING,{url:i,level:s,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})},n.removeLevel=function(e){var t=this,i;if(this._levels.length!==1){var s=this._levels.filter(function(u,f){return f!==e?!0:(t.steering&&t.steering.removeLevel(u),u===t.currentLevel&&(t.currentLevel=null,t.currentLevelIndex=-1,u.details&&u.details.fragments.forEach(function(d){return d.level=-1})),!1)});Fs(s),this._levels=s,this.currentLevelIndex>-1&&(i=this.currentLevel)!=null&&i.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);var l=s.length-1;this._firstLevel=Math.min(this._firstLevel,l),this._startLevel&&(this._startLevel=Math.min(this._startLevel,l)),this.hls.trigger(p.LEVELS_UPDATED,{levels:s})}},n.onLevelsUpdated=function(e,t){var i=t.levels;this._levels=i},n.checkMaxAutoUpdated=function(){var e=this.hls,t=e.autoLevelCapping,i=e.maxAutoLevel,s=e.maxHdcpLevel;this._maxAutoLevel!==i&&(this._maxAutoLevel=i,this.hls.trigger(p.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:i,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:s}))},z(o,[{key:"levels",get:function(){return this._levels.length===0?null:this._levels}},{key:"loadLevelObj",get:function(){return this.currentLevel}},{key:"level",get:function(){return this.currentLevelIndex},set:function(e){var t=this._levels;if(t.length!==0){if(e<0||e>=t.length){var i=new Error("invalid level idx"),s=e<0;if(this.hls.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.LEVEL_SWITCH_ERROR,level:e,fatal:s,error:i,reason:i.message}),s)return;e=Math.min(e,t.length-1)}var l=this.currentLevelIndex,u=this.currentLevel,f=u?u.attrs["PATHWAY-ID"]:void 0,d=t[e],h=d.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=d,!(l===e&&u&&f===h)){this.log("Switching to level "+e+" ("+(d.height?d.height+"p ":"")+(d.videoRange?d.videoRange+" ":"")+(d.codecSet?d.codecSet+" ":"")+"@"+d.bitrate+")"+(h?" with Pathway "+h:"")+" from level "+l+(f?" with Pathway "+f:""));var c={level:e,attrs:d.attrs,details:d.details,bitrate:d.bitrate,averageBitrate:d.averageBitrate,maxBitrate:d.maxBitrate,realBitrate:d.realBitrate,width:d.width,height:d.height,codecSet:d.codecSet,audioCodec:d.audioCodec,videoCodec:d.videoCodec,audioGroups:d.audioGroups,subtitleGroups:d.subtitleGroups,loaded:d.loaded,loadError:d.loadError,fragmentError:d.fragmentError,name:d.name,id:d.id,uri:d.uri,url:d.url,urlId:0,audioGroupIds:d.audioGroupIds,textGroupIds:d.textGroupIds};this.hls.trigger(p.LEVEL_SWITCHING,c);var v=d.details;if(!v||v.live){var g=this.switchParams(d.uri,u==null?void 0:u.details,v);this.loadPlaylist(g)}}}}},{key:"manualLevel",get:function(){return this.manualLevelIndex},set:function(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}},{key:"firstLevel",get:function(){return this._firstLevel},set:function(e){this._firstLevel=e}},{key:"startLevel",get:function(){if(this._startLevel===void 0){var e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel},set:function(e){this._startLevel=e}},{key:"pathways",get:function(){return this.steering?this.steering.pathways():[]}},{key:"pathwayPriority",get:function(){return this.steering?this.steering.pathwayPriority:null},set:function(e){if(this.steering){var t=this.steering.pathways(),i=e.filter(function(s){return t.indexOf(s)!==-1});if(e.length<1){this.warn("pathwayPriority "+e+" should contain at least one pathway from list: "+t);return}this.steering.pathwayPriority=i}}},{key:"nextLoadLevel",get:function(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel},set:function(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}}])}(zn);function al(a){var o={};a.forEach(function(n){var r=n.groupId||"";n.id=o[r]=o[r]||0,o[r]++})}function sl(){return self.SourceBuffer||self.WebKitSourceBuffer}function ol(){var a=re();if(!a)return!1;var o=sl();return!o||o.prototype&&typeof o.prototype.appendBuffer=="function"&&typeof o.prototype.remove=="function"}function zh(){if(!ol())return!1;var a=re();return typeof(a==null?void 0:a.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(function(o){return a.isTypeSupported(Qr(o,"video"))})||["mp4a.40.2","fLaC"].some(function(o){return a.isTypeSupported(Qr(o,"audio"))}))}function Qh(){var a,o=sl();return typeof(o==null||(a=o.prototype)==null?void 0:a.changeType)=="function"}var $h=100,Jh=function(a){function o(r,e,t){var i;return i=a.call(this,r,e,t,"stream-controller",K.MAIN)||this,i.audioCodecSwap=!1,i.level=-1,i._forceStartLoad=!1,i._hasEnoughToStart=!1,i.altAudio=0,i.audioOnly=!1,i.fragPlaying=null,i.fragLastKbps=0,i.couldBacktrack=!1,i.backtrackFragment=null,i.audioCodecSwitch=!1,i.videoBuffer=null,i.onMediaPlaying=function(){i.tick()},i.onMediaSeeked=function(){var s=i.media,l=s?s.currentTime:null;if(!(l===null||!N(l))&&(i.log("Media seeked to "+l.toFixed(3)),!!i.getBufferedFrag(l))){var u=i.getFwdBufferInfoAtPos(s,l,K.MAIN,0);if(u===null||u.len===0){i.warn("Main forward buffer length at "+l+' on "seeked" event '+(u?u.len:"empty")+")");return}i.tick()}},i.registerListeners(),i}J(o,a);var n=o.prototype;return n.registerListeners=function(){a.prototype.registerListeners.call(this);var e=this.hls;e.on(p.MANIFEST_PARSED,this.onManifestParsed,this),e.on(p.LEVEL_LOADING,this.onLevelLoading,this),e.on(p.LEVEL_LOADED,this.onLevelLoaded,this),e.on(p.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(p.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(p.BUFFER_CREATED,this.onBufferCreated,this),e.on(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(p.FRAG_BUFFERED,this.onFragBuffered,this)},n.unregisterListeners=function(){a.prototype.unregisterListeners.call(this);var e=this.hls;e.off(p.MANIFEST_PARSED,this.onManifestParsed,this),e.off(p.LEVEL_LOADED,this.onLevelLoaded,this),e.off(p.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(p.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(p.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(p.BUFFER_CREATED,this.onBufferCreated,this),e.off(p.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(p.FRAG_BUFFERED,this.onFragBuffered,this)},n.onHandlerDestroying=function(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),a.prototype.onHandlerDestroying.call(this)},n.startLoad=function(e,t){if(this.levels){var i=this.lastCurrentTime,s=this.hls;if(this.stopLoad(),this.setInterval($h),this.level=-1,!this.startFragRequested){var l=s.startLevel;l===-1&&(s.config.testBandwidth&&this.levels.length>1?(l=0,this.bitrateTest=!0):l=s.firstAutoLevel),s.nextLoadLevel=l,this.level=s.loadLevel,this._hasEnoughToStart=!!t}i>0&&e===-1&&!t&&(this.log("Override startPosition with lastCurrentTime @"+i.toFixed(3)),e=i),this.state=w.IDLE,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=w.STOPPED},n.stopLoad=function(){this._forceStartLoad=!1,a.prototype.stopLoad.call(this)},n.doTick=function(){switch(this.state){case w.WAITING_LEVEL:{var e=this.levels,t=this.level,i=e==null?void 0:e[t],s=i==null?void 0:i.details;if(s&&(!s.live||this.levelLastLoaded===i&&!this.waitForLive(i))){if(this.waitForCdnTuneIn(s))break;this.state=w.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=w.IDLE;break}break}case w.FRAG_LOADING_WAITING_RETRY:{var l,u=self.performance.now(),f=this.retryDate;if(!f||u>=f||(l=this.media)!=null&&l.seeking){var d=this.levels,h=this.level,c=d==null?void 0:d[h];this.resetStartWhenNotLoaded(c||null),this.state=w.IDLE}}break}this.state===w.IDLE&&this.doTickIdle(),this.onTickEnd()},n.onTickEnd=function(){var e;a.prototype.onTickEnd.call(this),(e=this.media)!=null&&e.readyState&&this.media.seeking===!1&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()},n.doTickIdle=function(){var e=this.hls,t=this.levelLastLoaded,i=this.levels,s=this.media;if(!(t===null||!s&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch))&&!(this.altAudio&&this.audioOnly)){var l=this.buffering?e.nextLoadLevel:e.loadLevel;if(i!=null&&i[l]){var u=i[l],f=this.getMainFwdBufferInfo();if(f!==null){var d=this.getLevelDetails();if(d&&this._streamEnded(f,d)){var h={};this.altAudio===2&&(h.type="video"),this.hls.trigger(p.BUFFER_EOS,h),this.state=w.ENDED;return}if(this.buffering){e.loadLevel!==l&&e.manualLevel===-1&&this.log("Adapting to level "+l+" from level "+this.level),this.level=e.nextLoadLevel=l;var c=u.details;if(!c||this.state===w.WAITING_LEVEL||this.waitForLive(u)){this.level=l,this.state=w.WAITING_LEVEL,this.startFragRequested=!1;return}var v=f.len,g=this.getMaxBufferLength(u.maxBitrate);if(!(v>=g)){this.backtrackFragment&&this.backtrackFragment.start>f.end&&(this.backtrackFragment=null);var m=this.backtrackFragment?this.backtrackFragment.start:f.end,y=this.getNextFragment(m,c);if(this.couldBacktrack&&!this.fragPrevious&&y&&Ie(y)&&this.fragmentTracker.getState(y)!==ut.OK){var E,T=((E=this.backtrackFragment)!=null?E:y).sn,S=T-c.startSN,A=c.fragments[S-1];A&&y.cc===A.cc&&(y=A,this.fragmentTracker.removeFragment(A))}else this.backtrackFragment&&f.len&&(this.backtrackFragment=null);if(y&&this.isLoopLoading(y,m)){var x=y.gap;if(!x){var L=this.audioOnly&&!this.altAudio?oe.AUDIO:oe.VIDEO,I=(L===oe.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;I&&this.afterBufferFlushed(I,L,K.MAIN)}y=this.getNextFragmentLoopLoading(y,c,f,K.MAIN,g)}y&&(y.initSegment&&!y.initSegment.data&&!this.bitrateTest&&(y=y.initSegment),this.loadFragment(y,u,m))}}}}}},n.loadFragment=function(e,t,i){var s=this.fragmentTracker.getState(e);s===ut.NOT_LOADED||s===ut.PARTIAL?Ie(e)?this.bitrateTest?(this.log("Fragment "+e.sn+" of level "+e.level+" is being downloaded to test bitrate and will not be buffered"),this._loadBitrateTestFrag(e,t)):a.prototype.loadFragment.call(this,e,t,i):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)},n.getBufferedFrag=function(e){return this.fragmentTracker.getBufferedFrag(e,K.MAIN)},n.followingBufferedFrag=function(e){return e?this.getBufferedFrag(e.end+.5):null},n.immediateLevelSwitch=function(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)},n.nextLevelSwitch=function(){var e=this.levels,t=this.media;if(t!=null&&t.readyState){var i,s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);var l=this.getLevelDetails();if(l!=null&&l.live){var u=this.getMainFwdBufferInfo();if(!u||u.len<l.targetduration*2)return}if(!t.paused&&e){var f=this.hls.nextLoadLevel,d=e[f],h=this.fragLastKbps;h&&this.fragCurrent?i=this.fragCurrent.duration*d.maxBitrate/(1e3*h)+1:i=0}else i=0;var c=this.getBufferedFrag(t.currentTime+i);if(c){var v=this.followingBufferedFrag(c);if(v){this.abortCurrentFrag();var g=v.maxStartPTS?v.maxStartPTS:v.start,m=v.duration,y=Math.max(c.end,g+Math.min(Math.max(m-this.config.maxFragLookUpTolerance,m*(this.couldBacktrack?.5:.125)),m*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(y,Number.POSITIVE_INFINITY)}}}},n.abortCurrentFrag=function(){var e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case w.KEY_LOADING:case w.FRAG_LOADING:case w.FRAG_LOADING_WAITING_RETRY:case w.PARSING:case w.PARSED:this.state=w.IDLE;break}this.nextLoadPosition=this.getLoadPosition()},n.flushMainBuffer=function(e,t){a.prototype.flushMainBuffer.call(this,e,t,this.altAudio===2?"video":null)},n.onMediaAttached=function(e,t){a.prototype.onMediaAttached.call(this,e,t);var i=t.media;ur(i,"playing",this.onMediaPlaying),ur(i,"seeked",this.onMediaSeeked)},n.onMediaDetaching=function(e,t){var i=this.media;i&&(tr(i,"playing",this.onMediaPlaying),tr(i,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,a.prototype.onMediaDetaching.call(this,e,t);var s=!!t.transferMedia;s||(this._hasEnoughToStart=!1)},n.onManifestLoading=function(){a.prototype.onManifestLoading.call(this),this.log("Trigger BUFFER_RESET"),this.hls.trigger(p.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1},n.onManifestParsed=function(e,t){var i=!1,s=!1;t.levels.forEach(function(l){var u=l.audioCodec;u&&(i=i||u.indexOf("mp4a.40.2")!==-1,s=s||u.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&s&&!Qh(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1},n.onLevelLoading=function(e,t){var i=this.levels;if(!(!i||this.state!==w.IDLE)){var s=t.levelInfo;(!s.details||s.details.live&&(this.levelLastLoaded!==s||s.details.expired)||this.waitForCdnTuneIn(s.details))&&(this.state=w.WAITING_LEVEL)}},n.onLevelLoaded=function(e,t){var i,s=this.levels,l=this.startFragRequested,u=t.level,f=t.details,d=f.totalduration;if(!s){this.warn("Levels were reset while loading level "+u);return}this.log("Level "+u+" loaded ["+f.startSN+","+f.endSN+"]"+(f.lastPartSn?"[part-"+f.lastPartSn+"-"+f.lastPartIndex+"]":"")+", cc ["+f.startCC+", "+f.endCC+"] duration:"+d);var h=t.levelInfo,c=this.fragCurrent;c&&(this.state===w.FRAG_LOADING||this.state===w.FRAG_LOADING_WAITING_RETRY)&&c.level!==t.level&&c.loader&&this.abortCurrentFrag();var v=0;if(f.live||(i=h.details)!=null&&i.live){var g;if(this.checkLiveUpdate(f),f.deltaUpdateFailed)return;v=this.alignPlaylists(f,h.details,(g=this.levelLastLoaded)==null?void 0:g.details)}if(h.details=f,this.levelLastLoaded=h,l||this.setStartPosition(f,v),this.hls.trigger(p.LEVEL_UPDATED,{details:f,level:u}),this.state===w.WAITING_LEVEL){if(this.waitForCdnTuneIn(f))return;this.state=w.IDLE}l&&f.live&&this.synchronizeToLiveEdge(f),this.tick()},n.synchronizeToLiveEdge=function(e){var t=this.config,i=this.media;if(i){var s=this.hls.liveSyncPosition,l=this.getLoadPosition(),u=e.fragmentStart,f=e.edge,d=l>=u-t.maxFragLookUpTolerance&&l<=f;if(s!==null&&i.duration>s&&(l<s||!d)){var h=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!d&&i.readyState<4||l<f-h)&&(this._hasEnoughToStart||(this.nextLoadPosition=s),i.readyState&&(this.warn("Playback: "+l.toFixed(3)+" is located too far from the end of live sliding playlist: "+f+", reset currentTime to : "+s.toFixed(3)),i.currentTime=s))}}},n._handleFragmentLoadProgress=function(e){var t,i=e.frag,s=e.part,l=e.payload,u=this.levels;if(!u){this.warn("Levels were reset while fragment load was in progress. Fragment "+i.sn+" of level "+i.level+" will not be buffered");return}var f=u[i.level];if(!f){this.warn("Level "+i.level+" not found on progress");return}var d=f.details;if(!d){this.warn("Dropping fragment "+i.sn+" of level "+i.level+" after level details were reset"),this.fragmentTracker.removeFragment(i);return}var h=f.videoCodec,c=d.PTSKnown||!d.live,v=(t=i.initSegment)==null?void 0:t.data,g=this._getAudioCodec(f),m=this.transmuxer=this.transmuxer||new mo(this.hls,K.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),y=s?s.index:-1,E=y!==-1,T=new Tn(i.level,i.sn,i.stats.chunkCount,l.byteLength,y,E),S=this.initPTS[i.cc];m.push(l,v,g,h,i,s,d.totalduration,c,T,S)},n.onAudioTrackSwitching=function(e,t){var i=this,s=this.hls,l=this.altAudio===2,u=xi(t.url,s);if(u)this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;var f=this.fragCurrent;f&&(this.log("Switching to main audio track, cancel main fragment load"),f.abortRequests(),this.fragmentTracker.removeFragment(f)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(l){this.fragmentTracker.removeAllFragments(),s.once(p.BUFFER_FLUSHED,function(){var d;(d=i.hls)==null||d.trigger(p.AUDIO_TRACK_SWITCHED,t)}),s.trigger(p.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});return}s.trigger(p.AUDIO_TRACK_SWITCHED,t)}},n.onAudioTrackSwitched=function(e,t){var i=xi(t.url,this.hls);if(i){var s=this.videoBuffer;s&&this.mediaBuffer!==s&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=s)}this.altAudio=i?2:0,this.tick()},n.onBufferCreated=function(e,t){var i=t.tracks,s,l,u=!1;for(var f in i){var d=i[f];if(d.id==="main"){if(l=f,s=d,f==="video"){var h=i[f];h&&(this.videoBuffer=h.buffer)}}else u=!0}u&&s?(this.log("Alternate track found, use "+l+".buffered to schedule main fragment loading"),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media},n.onFragBuffered=function(e,t){var i=t.frag,s=t.part,l=i.type===K.MAIN;if(l){if(this.fragContextChanged(i)){this.warn("Fragment "+i.sn+(s?" p: "+s.index:"")+" of level "+i.level+" finished buffering, but was aborted. state: "+this.state),this.state===w.PARSED&&(this.state=w.IDLE);return}var u=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*u.total/(u.buffering.end-u.loading.first)),Ie(i)&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}var f=this.media;f&&(!this._hasEnoughToStart&&Se.getBuffered(f).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),l&&this.tick())},n.onError=function(e,t){var i;if(t.fatal){this.state=w.ERROR;return}switch(t.details){case _.FRAG_GAP:case _.FRAG_PARSING_ERROR:case _.FRAG_DECRYPT_ERROR:case _.FRAG_LOAD_ERROR:case _.FRAG_LOAD_TIMEOUT:case _.KEY_LOAD_ERROR:case _.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(K.MAIN,t);break;case _.LEVEL_LOAD_ERROR:case _.LEVEL_LOAD_TIMEOUT:case _.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===w.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===j.LEVEL&&(this.state=w.IDLE);break;case _.BUFFER_ADD_CODEC_ERROR:case _.BUFFER_APPEND_ERROR:if(t.parent!=="main")return;this.resetLoadingState();break;case _.BUFFER_FULL_ERROR:if(t.parent!=="main")return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case _.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}},n.onFragLoadEmergencyAborted=function(){this.state=w.IDLE,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()},n.onBufferFlushed=function(e,t){var i=t.type;if(i!==oe.AUDIO||!this.altAudio){var s=(i===oe.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;s&&(this.afterBufferFlushed(s,i,K.MAIN),this.tick())}},n.onLevelsUpdated=function(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,this.level===-1&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels},n.swapAudioCodec=function(){this.audioCodecSwap=!this.audioCodecSwap},n.seekToStartPos=function(){var e=this.media;if(e){var t=e.currentTime,i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log("could not seek to "+i+", already seeking at "+t);return}var s=this.timelineOffset;s&&i&&(i+=s);var l=this.getLevelDetails(),u=Se.getBuffered(e),f=u.length?u.start(0):0,d=f-i,h=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);d>0&&(d<h||this.loadingParts&&d<2*((l==null?void 0:l.partTarget)||0))&&(this.log("adjusting start position by "+d+" to match buffer start"),i+=d,this.startPosition=i),t<i&&(this.log("seek to target start position "+i+" from current time "+t+" buffer start "+f),e.currentTime=i)}}},n._getAudioCodec=function(e){var t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t},n._loadBitrateTestFrag=function(e,t){var i=this;e.bitrateTest=!0,this._doFragLoad(e,t).then(function(s){var l=i.hls,u=s==null?void 0:s.frag;if(!(!u||i.fragContextChanged(u))){t.fragmentError=0,i.state=w.IDLE,i.startFragRequested=!1,i.bitrateTest=!1;var f=u.stats;f.parsing.start=f.parsing.end=f.buffering.start=f.buffering.end=self.performance.now(),l.trigger(p.FRAG_LOADED,s),u.bitrateTest=!1}})},n._handleTransmuxComplete=function(e){var t,i=this.playlistType,s=this.hls,l=e.remuxResult,u=e.chunkMeta,f=this.getCurrentContext(u);if(!f){this.resetWhenMissingContext(u);return}var d=f.frag,h=f.part,c=f.level,v=l.video,g=l.text,m=l.id3,y=l.initSegment,E=c.details,T=this.altAudio?void 0:l.audio;if(this.fragContextChanged(d)){this.fragmentTracker.removeFragment(d);return}if(this.state=w.PARSING,y){if(y!=null&&y.tracks){var S=d.initSegment||d;this._bufferInitSegment(c,y.tracks,S,u),s.trigger(p.FRAG_PARSING_INIT_SEGMENT,{frag:S,id:i,tracks:y.tracks})}var A=y.initPTS,x=y.timescale;N(A)&&(this.initPTS[d.cc]={baseTime:A,timescale:x},s.trigger(p.INIT_PTS_FOUND,{frag:d,id:i,initPTS:A,timescale:x}))}if(v&&E){T&&v.type==="audiovideo"&&this.logMuxedErr(d);var L=E.fragments[d.sn-1-E.startSN],I=d.sn===E.startSN,k=!L||d.cc>L.cc;if(l.independent!==!1){var R=v.startPTS,b=v.endPTS,D=v.startDTS,P=v.endDTS;if(h)h.elementaryStreams[v.type]={startPTS:R,endPTS:b,startDTS:D,endDTS:P};else if(v.firstKeyFrame&&v.independent&&u.id===1&&!k&&(this.couldBacktrack=!0),v.dropped&&v.independent){var U=this.getMainFwdBufferInfo(),F=(U?U.end:this.getLoadPosition())+this.config.maxBufferHole,M=v.firstKeyFramePTS?v.firstKeyFramePTS:R;if(!I&&F<M-this.config.maxBufferHole&&!k){this.backtrack(d);return}else k&&(d.gap=!0);d.setElementaryStreamInfo(v.type,d.start,b,d.start,P,!0)}else I&&R-(E.appliedTimelineOffset||0)>qi&&(d.gap=!0);d.setElementaryStreamInfo(v.type,R,b,D,P),this.backtrackFragment&&(this.backtrackFragment=d),this.bufferFragmentData(v,d,h,u,I||k)}else if(I||k)d.gap=!0;else{this.backtrack(d);return}}if(T){var H=T.startPTS,q=T.endPTS,W=T.startDTS,ee=T.endDTS;h&&(h.elementaryStreams[oe.AUDIO]={startPTS:H,endPTS:q,startDTS:W,endDTS:ee}),d.setElementaryStreamInfo(oe.AUDIO,H,q,W,ee),this.bufferFragmentData(T,d,h,u)}if(E&&m!=null&&(t=m.samples)!=null&&t.length){var ye={id:i,frag:d,details:E,samples:m.samples};s.trigger(p.FRAG_PARSING_METADATA,ye)}if(E&&g){var le={id:i,frag:d,details:E,samples:g.samples};s.trigger(p.FRAG_PARSING_USERDATA,le)}},n.logMuxedErr=function(e){this.warn((Ie(e)?"Media":"Init")+" segment with muxed audiovideo where only video expected: "+e.url)},n._bufferInitSegment=function(e,t,i,s){var l=this;if(this.state===w.PARSING){this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(i));var u=t.audio,f=t.video,d=t.audiovideo;if(u){var h=Ti(u.codec,e.audioCodec);h==="mp4a"&&(h="mp4a.40.5");var c=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){h&&(h.indexOf("mp4a.40.5")!==-1?h="mp4a.40.2":h="mp4a.40.5");var v=u.metadata;v&&"channelCount"in v&&(v.channelCount||1)!==1&&c.indexOf("firefox")===-1&&(h="mp4a.40.5")}h&&h.indexOf("mp4a.40.5")!==-1&&c.indexOf("android")!==-1&&u.container!=="audio/mpeg"&&(h="mp4a.40.2",this.log("Android: force audio codec to "+h)),e.audioCodec&&e.audioCodec!==h&&this.log('Swapping manifest audio codec "'+e.audioCodec+'" for "'+h+'"'),u.levelCodec=h,u.id=K.MAIN,this.log("Init audio buffer, container:"+u.container+", codecs[selected/level/parsed]=["+(h||"")+"/"+(e.audioCodec||"")+"/"+u.codec+"]"),delete t.audiovideo}if(f){f.levelCodec=e.videoCodec,f.id=K.MAIN;var g=f.codec;if((g==null?void 0:g.length)===4)switch(g){case"hvc1":case"hev1":f.codec="hvc1.1.6.L120.90";break;case"av01":f.codec="av01.0.04M.08";break;case"avc1":f.codec="avc1.42e01e";break}this.log("Init video buffer, container:"+f.container+", codecs[level/parsed]=["+(e.videoCodec||"")+"/"+g+"]"+(f.codec!==g?" parsed-corrected="+f.codec:"")+(f.supplemental?" supplemental="+f.supplemental:"")),delete t.audiovideo}d&&(this.log("Init audiovideo buffer, container:"+d.container+", codecs[level/parsed]=["+e.codecs+"/"+d.codec+"]"),delete t.video,delete t.audio);var m=Object.keys(t);if(m.length){if(this.hls.trigger(p.BUFFER_CODECS,t),!this.hls)return;m.forEach(function(y){var E=t[y],T=E.initSegment;T!=null&&T.byteLength&&l.hls.trigger(p.BUFFER_APPENDING,{type:y,data:T,frag:i,part:null,chunkMeta:s,parent:i.type})})}this.tickImmediate()}},n.getMainFwdBufferInfo=function(){var e=this.mediaBuffer&&this.altAudio===2?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,K.MAIN)},n.backtrack=function(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=w.IDLE},n.checkFragmentChanged=function(){var e=this.media,t=null;if(e&&e.readyState>1&&e.seeking===!1){var i=e.currentTime;if(Se.isBuffered(e,i)?t=this.getAppendedFrag(i):Se.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;var s=this.fragPlaying,l=t.level;(!s||t.sn!==s.sn||s.level!==l)&&(this.fragPlaying=t,this.hls.trigger(p.FRAG_CHANGED,{frag:t}),(!s||s.level!==l)&&this.hls.trigger(p.LEVEL_SWITCHED,{level:l}))}}},z(o,[{key:"hasEnoughToStart",get:function(){return this._hasEnoughToStart}},{key:"maxBufferLength",get:function(){var e=this.levels,t=this.level,i=e==null?void 0:e[t];return i?this.getMaxBufferLength(i.maxBitrate):this.config.maxBufferLength}},{key:"nextLevel",get:function(){var e=this.nextBufferedFrag;return e?e.level:-1}},{key:"currentFrag",get:function(){var e;if(this.fragPlaying)return this.fragPlaying;var t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;return N(t)?this.getAppendedFrag(t):null}},{key:"currentProgramDateTime",get:function(){var e,t=((e=this.media)==null?void 0:e.currentTime)||this.lastCurrentTime;if(N(t)){var i=this.getLevelDetails(),s=this.currentFrag||(i?br(null,i.fragments,t):null);if(s){var l=s.programDateTime;if(l!==null){var u=l+(t-s.start)*1e3;return new Date(u)}}}return null}},{key:"currentLevel",get:function(){var e=this.currentFrag;return e?e.level:-1}},{key:"nextBufferedFrag",get:function(){var e=this.currentFrag;return e?this.followingBufferedFrag(e):null}},{key:"forceStartLoad",get:function(){return this._forceStartLoad}}])}(wn),Zh=function(){function a(n){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=n}var o=a.prototype;return o.abort=function(r){for(var e in this.keyUriToKeyInfo){var t=this.keyUriToKeyInfo[e].loader;if(t){var i;if(r&&r!==((i=t.context)==null?void 0:i.frag.type))return;t.abort()}}},o.detach=function(){for(var r in this.keyUriToKeyInfo){var e=this.keyUriToKeyInfo[r];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[r]}},o.destroy=function(){this.detach();for(var r in this.keyUriToKeyInfo){var e=this.keyUriToKeyInfo[r].loader;e&&e.destroy()}this.keyUriToKeyInfo={}},o.createKeyLoadError=function(r,e,t,i,s){return e===void 0&&(e=_.KEY_LOAD_ERROR),new sr({type:V.NETWORK_ERROR,details:e,fatal:!1,frag:r,response:s,error:t,networkDetails:i})},o.loadClear=function(r,e){var t=this;if(this.emeController&&this.config.emeEnabled)for(var i=r.sn,s=r.cc,l=function(){var d=e[u];if(s<=d.cc&&(i==="initSegment"||d.sn==="initSegment"||i<d.sn))return t.emeController.selectKeySystemFormat(d).then(function(h){d.setKeyFormat(h)}),1},u=0;u<e.length&&!l();u++);},o.load=function(r){var e=this;return!r.decryptdata&&r.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(r).then(function(t){return e.loadInternal(r,t)}):this.loadInternal(r)},o.loadInternal=function(r,e){var t,i;e&&r.setKeyFormat(e);var s=r.decryptdata;if(!s){var l=new Error(e?"Expected frag.decryptdata to be defined after setting format "+e:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(r,_.KEY_LOAD_ERROR,l))}var u=s.uri;if(!u)return Promise.reject(this.createKeyLoadError(r,_.KEY_LOAD_ERROR,new Error('Invalid key URI: "'+u+'"')));var f=this.keyUriToKeyInfo[u];if((t=f)!=null&&t.decryptdata.key)return s.key=f.decryptdata.key,Promise.resolve({frag:r,keyInfo:f});if((i=f)!=null&&i.keyLoadPromise){var d;switch((d=f.mediaKeySessionContext)==null?void 0:d.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return f.keyLoadPromise.then(function(h){return s.key=h.keyInfo.decryptdata.key,{frag:r,keyInfo:f}})}}switch(f=this.keyUriToKeyInfo[u]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return s.keyFormat==="identity"?this.loadKeyHTTP(f,r):this.loadKeyEME(f,r);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(f,r);default:return Promise.reject(this.createKeyLoadError(r,_.KEY_LOAD_ERROR,new Error('Key supplied with unsupported METHOD: "'+s.method+'"')))}},o.loadKeyEME=function(r,e){var t={frag:e,keyInfo:r};if(this.emeController&&this.config.emeEnabled){var i=this.emeController.loadKey(t);if(i)return(r.keyLoadPromise=i.then(function(s){return r.mediaKeySessionContext=s,t})).catch(function(s){throw r.keyLoadPromise=null,s})}return Promise.resolve(t)},o.loadKeyHTTP=function(r,e){var t=this,i=this.config,s=i.loader,l=new s(i);return e.keyLoader=r.loader=l,r.keyLoadPromise=new Promise(function(u,f){var d={keyInfo:r,frag:e,responseType:"arraybuffer",url:r.decryptdata.uri},h=i.keyLoadPolicy.default,c={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},v={onSuccess:function(m,y,E,T){var S=E.frag,A=E.keyInfo,x=E.url;if(!S.decryptdata||A!==t.keyUriToKeyInfo[x])return f(t.createKeyLoadError(S,_.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),T));A.decryptdata.key=S.decryptdata.key=new Uint8Array(m.data),S.keyLoader=null,A.loader=null,u({frag:S,keyInfo:A})},onError:function(m,y,E,T){t.resetLoader(y),f(t.createKeyLoadError(e,_.KEY_LOAD_ERROR,new Error("HTTP Error "+m.code+" loading key "+m.text),E,Q({url:d.url,data:void 0},m)))},onTimeout:function(m,y,E){t.resetLoader(y),f(t.createKeyLoadError(e,_.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),E))},onAbort:function(m,y,E){t.resetLoader(y),f(t.createKeyLoadError(e,_.INTERNAL_ABORTED,new Error("key loading aborted"),E))}};l.load(d,c,v)})},o.resetLoader=function(r){var e=r.frag,t=r.keyInfo,i=r.url,s=t.loader;e.keyLoader===s&&(e.keyLoader=null,t.loader=null),delete this.keyUriToKeyInfo[i],s&&s.destroy()},a}();function ll(a){var o=a.type;switch(o){case j.AUDIO_TRACK:return K.AUDIO;case j.SUBTITLE_TRACK:return K.SUBTITLE;default:return K.MAIN}}function ma(a,o){var n=a.url;return(n===void 0||n.indexOf("data:")===0)&&(n=o.url),n}var ec=function(){function a(n){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=n,this.registerListeners()}var o=a.prototype;return o.startLoad=function(r){},o.stopLoad=function(){this.destroyInternalLoaders()},o.registerListeners=function(){var r=this.hls;r.on(p.MANIFEST_LOADING,this.onManifestLoading,this),r.on(p.LEVEL_LOADING,this.onLevelLoading,this),r.on(p.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),r.on(p.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),r.on(p.LEVELS_UPDATED,this.onLevelsUpdated,this)},o.unregisterListeners=function(){var r=this.hls;r.off(p.MANIFEST_LOADING,this.onManifestLoading,this),r.off(p.LEVEL_LOADING,this.onLevelLoading,this),r.off(p.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),r.off(p.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),r.off(p.LEVELS_UPDATED,this.onLevelsUpdated,this)},o.createInternalLoader=function(r){var e=this.hls.config,t=e.pLoader,i=e.loader,s=t||i,l=new s(e);return this.loaders[r.type]=l,l},o.getInternalLoader=function(r){return this.loaders[r.type]},o.resetInternalLoader=function(r){this.loaders[r]&&delete this.loaders[r]},o.destroyInternalLoaders=function(){for(var r in this.loaders){var e=this.loaders[r];e&&e.destroy(),this.resetInternalLoader(r)}},o.destroy=function(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()},o.onManifestLoading=function(r,e){var t=e.url;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:j.MANIFEST,url:t,deliveryDirectives:null,levelOrTrack:null})},o.onLevelLoading=function(r,e){var t=e.id,i=e.level,s=e.pathwayId,l=e.url,u=e.deliveryDirectives,f=e.levelInfo;this.load({id:t,level:i,pathwayId:s,responseType:"text",type:j.LEVEL,url:l,deliveryDirectives:u,levelOrTrack:f})},o.onAudioTrackLoading=function(r,e){var t=e.id,i=e.groupId,s=e.url,l=e.deliveryDirectives,u=e.track;this.load({id:t,groupId:i,level:null,responseType:"text",type:j.AUDIO_TRACK,url:s,deliveryDirectives:l,levelOrTrack:u})},o.onSubtitleTrackLoading=function(r,e){var t=e.id,i=e.groupId,s=e.url,l=e.deliveryDirectives,u=e.track;this.load({id:t,groupId:i,level:null,responseType:"text",type:j.SUBTITLE_TRACK,url:s,deliveryDirectives:l,levelOrTrack:u})},o.onLevelsUpdated=function(r,e){var t=this.loaders[j.LEVEL];if(t){var i=t.context;i&&!e.levels.some(function(s){return s===i.levelOrTrack})&&(t.abort(),delete this.loaders[j.LEVEL])}},o.load=function(r){var e,t=this,i=this.hls.config,s=this.getInternalLoader(r);if(s){var l=this.hls.logger,u=s.context;if(u&&u.levelOrTrack===r.levelOrTrack&&(u.url===r.url||u.deliveryDirectives&&!r.deliveryDirectives)){u.url===r.url?l.log("[playlist-loader]: ignore "+r.url+" ongoing request"):l.log("[playlist-loader]: ignore "+r.url+" in favor of "+u.url);return}l.log("[playlist-loader]: aborting previous loader for type: "+r.type),s.abort()}var f;if(r.type===j.MANIFEST?f=i.manifestLoadPolicy.default:f=ae({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(r),N((e=r.deliveryDirectives)==null?void 0:e.part)){var d;if(r.type===j.LEVEL&&r.level!==null?d=this.hls.levels[r.level].details:r.type===j.AUDIO_TRACK&&r.id!==null?d=this.hls.audioTracks[r.id].details:r.type===j.SUBTITLE_TRACK&&r.id!==null&&(d=this.hls.subtitleTracks[r.id].details),d){var h=d.partTarget,c=d.targetduration;if(h&&c){var v=Math.max(h*3,c*.8)*1e3;f=ae({},f,{maxTimeToFirstByteMs:Math.min(v,f.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(v,f.maxTimeToFirstByteMs)})}}}var g=f.errorRetry||f.timeoutRetry||{},m={loadPolicy:f,timeout:f.maxLoadTimeMs,maxRetry:g.maxNumRetry||0,retryDelay:g.retryDelayMs||0,maxRetryDelay:g.maxRetryDelayMs||0},y={onSuccess:function(T,S,A,x){var L=t.getInternalLoader(A);t.resetInternalLoader(A.type);var I=T.data;if(I.indexOf("#EXTM3U")!==0){t.handleManifestParsingError(T,A,new Error("no EXTM3U delimiter"),x||null,S);return}S.parsing.start=performance.now(),Zr.isMediaPlaylist(I)||A.type!==j.MANIFEST?t.handleTrackOrLevelPlaylist(T,S,A,x||null,L):t.handleMasterPlaylist(T,S,A,x)},onError:function(T,S,A,x){t.handleNetworkError(S,A,!1,T,x)},onTimeout:function(T,S,A){t.handleNetworkError(S,A,!0,void 0,T)}};s.load(r,m,y)},o.checkAutostartLoad=function(){if(this.hls){var r=this.hls,e=r.config,t=e.autoStartLoad,i=e.startPosition,s=r.forceStartLoad;(t||s)&&(this.hls.logger.log((t?"auto":"force")+" startLoad with configured startPosition "+i),this.hls.startLoad(i))}},o.handleMasterPlaylist=function(r,e,t,i){var s=this.hls,l=r.data,u=ma(r,t),f=Zr.parseMasterPlaylist(l,u);if(f.playlistParsingError){this.handleManifestParsingError(r,t,f.playlistParsingError,i,e);return}var d=f.contentSteering,h=f.levels,c=f.sessionData,v=f.sessionKeys,g=f.startTimeOffset,m=f.variableList;this.variableList=m;var y=Zr.parseMasterPlaylistMedia(l,u,f),E=y.AUDIO,T=E===void 0?[]:E,S=y.SUBTITLES,A=y["CLOSED-CAPTIONS"];if(T.length){var x=T.some(function(L){return!L.url});!x&&h[0].audioCodec&&!h[0].attrs.AUDIO&&(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),T.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new et({}),bitrate:0,url:""}))}s.trigger(p.MANIFEST_LOADED,{levels:h,audioTracks:T,subtitles:S,captions:A,contentSteering:d,url:u,stats:e,networkDetails:i,sessionData:c,sessionKeys:v,startTimeOffset:g,variableList:m})},o.handleTrackOrLevelPlaylist=function(r,e,t,i,s){var l=this.hls,u=t.id,f=t.level,d=t.type,h=ma(r,t),c=N(f)?f:N(u)?u:0,v=ll(t),g=Zr.parseLevelPlaylist(r.data,h,c,v,0,this.variableList);if(d===j.MANIFEST){var m={attrs:new et({}),bitrate:0,details:g,name:"",url:h};g.requestScheduled=e.loading.start+Ps(g,0),l.trigger(p.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:h,stats:e,networkDetails:i,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),t.levelDetails=g,this.handlePlaylistLoaded(g,r,e,t,i,s)},o.handleManifestParsingError=function(r,e,t,i,s){this.hls.trigger(p.ERROR,{type:V.NETWORK_ERROR,details:_.MANIFEST_PARSING_ERROR,fatal:e.type===j.MANIFEST,url:r.url,err:t,error:t,reason:t.message,response:r,context:e,networkDetails:i,stats:s})},o.handleNetworkError=function(r,e,t,i,s){t===void 0&&(t=!1);var l="A network "+(t?"timeout":"error"+(i?" (status "+i.code+")":""))+" occurred while loading "+r.type;r.type===j.LEVEL?l+=": "+r.level+" id: "+r.id:(r.type===j.AUDIO_TRACK||r.type===j.SUBTITLE_TRACK)&&(l+=" id: "+r.id+' group-id: "'+r.groupId+'"');var u=new Error(l);this.hls.logger.warn("[playlist-loader]: "+l);var f=_.UNKNOWN,d=!1,h=this.getInternalLoader(r);switch(r.type){case j.MANIFEST:f=t?_.MANIFEST_LOAD_TIMEOUT:_.MANIFEST_LOAD_ERROR,d=!0;break;case j.LEVEL:f=t?_.LEVEL_LOAD_TIMEOUT:_.LEVEL_LOAD_ERROR,d=!1;break;case j.AUDIO_TRACK:f=t?_.AUDIO_TRACK_LOAD_TIMEOUT:_.AUDIO_TRACK_LOAD_ERROR,d=!1;break;case j.SUBTITLE_TRACK:f=t?_.SUBTITLE_TRACK_LOAD_TIMEOUT:_.SUBTITLE_LOAD_ERROR,d=!1;break}h&&this.resetInternalLoader(r.type);var c={type:V.NETWORK_ERROR,details:f,fatal:d,url:r.url,loader:h,context:r,error:u,networkDetails:e,stats:s};if(i){var v=(e==null?void 0:e.url)||r.url;c.response=Q({url:v,data:void 0},i)}this.hls.trigger(p.ERROR,c)},o.handlePlaylistLoaded=function(r,e,t,i,s,l){var u=this.hls,f=i.type,d=i.level,h=i.id,c=i.groupId,v=i.deliveryDirectives,g=ma(e,i),m=ll(i),y=typeof i.level=="number"&&m===K.MAIN?d:void 0;if(!r.fragments.length){var E=r.playlistParsingError=new Error("No Segments found in Playlist");u.trigger(p.ERROR,{type:V.NETWORK_ERROR,details:_.LEVEL_EMPTY_ERROR,fatal:!1,url:g,error:E,reason:E.message,response:e,context:i,level:y,parent:m,networkDetails:s,stats:t});return}r.targetduration||(r.playlistParsingError=new Error("Missing Target Duration"));var T=r.playlistParsingError;if(T){if(this.hls.logger.warn(T),!u.config.ignorePlaylistParsingErrors){u.trigger(p.ERROR,{type:V.NETWORK_ERROR,details:_.LEVEL_PARSING_ERROR,fatal:!1,url:g,error:T,reason:T.message,response:e,context:i,level:y,parent:m,networkDetails:s,stats:t});return}r.playlistParsingError=null}switch(r.live&&l&&(l.getCacheAge&&(r.ageHeader=l.getCacheAge()||0),(!l.getCacheAge||isNaN(r.ageHeader))&&(r.ageHeader=0)),f){case j.MANIFEST:case j.LEVEL:u.trigger(p.LEVEL_LOADED,{details:r,levelInfo:i.levelOrTrack||u.levels[0],level:y||0,id:h||0,stats:t,networkDetails:s,deliveryDirectives:v,withoutMultiVariant:f===j.MANIFEST});break;case j.AUDIO_TRACK:u.trigger(p.AUDIO_TRACK_LOADED,{details:r,track:i.levelOrTrack,id:h||0,groupId:c||"",stats:t,networkDetails:s,deliveryDirectives:v});break;case j.SUBTITLE_TRACK:u.trigger(p.SUBTITLE_TRACK_LOADED,{details:r,track:i.levelOrTrack,id:h||0,groupId:c||"",stats:t,networkDetails:s,deliveryDirectives:v});break}},a}(),ul=function(){function a(n){n===void 0&&(n={}),this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new ce,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;var r=this.logger=_t(n.debug||!1,"Hls instance",n.assetPlayerId),e=this.config=Uh(a.DefaultConfig,n,r);this.userConfig=n,e.progressive&&Bh(e,r);var t=e.abrController,i=e.bufferController,s=e.capLevelController,l=e.errorController,u=e.fpsController,f=new l(this),d=this.abrController=new t(this),h=new lu(this),c=e.interstitialsController,v=c?this.interstitialsController=new c(this,a):null,g=this.bufferController=new i(this,h),m=this.capLevelController=new s(this),y=new u(this),E=new ec(this),T=e.contentSteeringController,S=T?new T(this):null,A=this.levelController=new Xh(this,S),x=new qh(this),L=new Zh(this.config),I=this.streamController=new Jh(this,h,L),k=this.gapController=new Vh(this,h);m.setStreamController(I),y.setStreamController(I);var R=[E,A,I];v&&R.splice(1,0,v),S&&R.splice(1,0,S),this.networkControllers=R;var b=[d,g,k,m,y,x,h];this.audioTrackController=this.createController(e.audioTrackController,R);var D=e.audioStreamController;D&&R.push(this.audioStreamController=new D(this,h,L)),this.subtitleTrackController=this.createController(e.subtitleTrackController,R);var P=e.subtitleStreamController;P&&R.push(this.subtititleStreamController=new P(this,h,L)),this.createController(e.timelineController,b),L.emeController=this.emeController=this.createController(e.emeController,b),this.cmcdController=this.createController(e.cmcdController,b),this.latencyController=this.createController(jh,b),this.coreComponents=b,R.push(f);var U=f.onErrorOut;typeof U=="function"&&this.on(p.ERROR,U,f),this.on(p.MANIFEST_LOADED,E.onManifestLoaded,E)}a.isMSESupported=function(){return ol()},a.isSupported=function(){return zh()},a.getMediaSource=function(){return re()};var o=a.prototype;return o.createController=function(r,e){if(r){var t=new r(this);return e&&e.push(t),t}return null},o.on=function(r,e,t){t===void 0&&(t=this),this._emitter.on(r,e,t)},o.once=function(r,e,t){t===void 0&&(t=this),this._emitter.once(r,e,t)},o.removeAllListeners=function(r){this._emitter.removeAllListeners(r)},o.off=function(r,e,t,i){t===void 0&&(t=this),this._emitter.off(r,e,t,i)},o.listeners=function(r){return this._emitter.listeners(r)},o.emit=function(r,e,t){return this._emitter.emit(r,e,t)},o.trigger=function(r,e){if(this.config.debug)return this.emit(r,r,e);try{return this.emit(r,r,e)}catch(i){if(this.logger.error("An internal error happened while handling event "+r+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;var t=r===p.ERROR;this.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.INTERNAL_EXCEPTION,fatal:t,event:r,error:i}),this.triggeringException=!1}}return!1},o.listenerCount=function(r){return this._emitter.listenerCount(r)},o.destroy=function(){this.logger.log("destroy"),this.trigger(p.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(function(e){return e.destroy()}),this.networkControllers.length=0,this.coreComponents.forEach(function(e){return e.destroy()}),this.coreComponents.length=0;var r=this.config;r.xhrSetup=r.fetchSetup=void 0,this.userConfig=null},o.attachMedia=function(r){if(!r||"media"in r&&!r.media){var e=new Error("attachMedia failed: invalid argument ("+r+")");this.trigger(p.ERROR,{type:V.OTHER_ERROR,details:_.ATTACH_MEDIA_ERROR,fatal:!0,error:e});return}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());var t="media"in r,i=t?r.media:r,s=t?r:{media:i};this._media=i,this.trigger(p.MEDIA_ATTACHING,s)},o.detachMedia=function(){this.logger.log("detachMedia"),this.trigger(p.MEDIA_DETACHING,{}),this._media=null},o.transferMedia=function(){this._media=null;var r=this.bufferController.transferMedia();return this.trigger(p.MEDIA_DETACHING,{transferMedia:r}),r},o.loadSource=function(r){this.stopLoad();var e=this.media,t=this._url,i=this._url=Ze.buildAbsoluteURL(self.location.href,r,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log("loadSource:"+i),e&&t&&(t!==i||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(p.MANIFEST_LOADING,{url:r})},o.startLoad=function(r,e){r===void 0&&(r=-1),this.logger.log("startLoad("+(r+(e?", <skip seek to start>":""))+")"),this.started=!0,this.resumeBuffering();for(var t=0;t<this.networkControllers.length&&(this.networkControllers[t].startLoad(r,e),!(!this.started||!this.networkControllers));t++);},o.stopLoad=function(){this.logger.log("stopLoad"),this.started=!1;for(var r=0;r<this.networkControllers.length&&(this.networkControllers[r].stopLoad(),!(this.started||!this.networkControllers));r++);},o.resumeBuffering=function(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(function(r){r.resumeBuffering&&r.resumeBuffering()}))},o.pauseBuffering=function(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(function(r){r.pauseBuffering&&r.pauseBuffering()}))},o.swapAudioCodec=function(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()},o.recoverMediaError=function(){this.logger.log("recoverMediaError");var r=this._media,e=r==null?void 0:r.currentTime;this.detachMedia(),r&&(this.attachMedia(r),e&&this.startLoad(e))},o.removeLevel=function(r){this.levelController.removeLevel(r)},o.setAudioOption=function(r){var e;return((e=this.audioTrackController)==null?void 0:e.setAudioOption(r))||null},o.setSubtitleOption=function(r){var e;return((e=this.subtitleTrackController)==null?void 0:e.setSubtitleOption(r))||null},o.getMediaDecodingInfo=function(r,e){e===void 0&&(e=this.allAudioTracks);var t=Za(e);return za(r,t,navigator.mediaCapabilities)},z(a,[{key:"url",get:function(){return this._url}},{key:"hasEnoughToStart",get:function(){return this.streamController.hasEnoughToStart}},{key:"startPosition",get:function(){return this.streamController.startPositionValue}},{key:"loadingEnabled",get:function(){return this.started}},{key:"bufferingEnabled",get:function(){return this.streamController.bufferingEnabled}},{key:"inFlightFragments",get:function(){var r,e=(r={},r[K.MAIN]=this.streamController.inFlightFrag,r);return this.audioStreamController&&(e[K.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[K.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}},{key:"sessionId",get:function(){var r=this._sessionId;return r||(r=this._sessionId=Wt()),r}},{key:"levels",get:function(){var r=this.levelController.levels;return r||[]}},{key:"latestLevelDetails",get:function(){return this.streamController.getLevelDetails()||null}},{key:"loadLevelObj",get:function(){return this.levelController.loadLevelObj}},{key:"currentLevel",get:function(){return this.streamController.currentLevel},set:function(r){this.logger.log("set currentLevel:"+r),this.levelController.manualLevel=r,this.streamController.immediateLevelSwitch()}},{key:"nextLevel",get:function(){return this.streamController.nextLevel},set:function(r){this.logger.log("set nextLevel:"+r),this.levelController.manualLevel=r,this.streamController.nextLevelSwitch()}},{key:"loadLevel",get:function(){return this.levelController.level},set:function(r){this.logger.log("set loadLevel:"+r),this.levelController.manualLevel=r}},{key:"nextLoadLevel",get:function(){return this.levelController.nextLoadLevel},set:function(r){this.levelController.nextLoadLevel=r}},{key:"firstLevel",get:function(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)},set:function(r){this.logger.log("set firstLevel:"+r),this.levelController.firstLevel=r}},{key:"startLevel",get:function(){var r=this.levelController.startLevel;return r===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:r},set:function(r){this.logger.log("set startLevel:"+r),r!==-1&&(r=Math.max(r,this.minAutoLevel)),this.levelController.startLevel=r}},{key:"capLevelToPlayerSize",get:function(){return this.config.capLevelToPlayerSize},set:function(r){var e=!!r;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}},{key:"autoLevelCapping",get:function(){return this._autoLevelCapping},set:function(r){this._autoLevelCapping!==r&&(this.logger.log("set autoLevelCapping:"+r),this._autoLevelCapping=r,this.levelController.checkMaxAutoUpdated())}},{key:"bandwidthEstimate",get:function(){var r=this.abrController.bwEstimator;return r?r.getEstimate():NaN},set:function(r){this.abrController.resetEstimator(r)}},{key:"abrEwmaDefaultEstimate",get:function(){var r=this.abrController.bwEstimator;return r?r.defaultEstimate:NaN}},{key:"ttfbEstimate",get:function(){var r=this.abrController.bwEstimator;return r?r.getEstimateTTFB():NaN}},{key:"maxHdcpLevel",get:function(){return this._maxHdcpLevel},set:function(r){Yl(r)&&this._maxHdcpLevel!==r&&(this._maxHdcpLevel=r,this.levelController.checkMaxAutoUpdated())}},{key:"autoLevelEnabled",get:function(){return this.levelController.manualLevel===-1}},{key:"manualLevel",get:function(){return this.levelController.manualLevel}},{key:"minAutoLevel",get:function(){var r=this.levels,e=this.config.minAutoBitrate;if(!r)return 0;for(var t=r.length,i=0;i<t;i++)if(r[i].maxBitrate>=e)return i;return 0}},{key:"maxAutoLevel",get:function(){var r=this.levels,e=this.autoLevelCapping,t=this.maxHdcpLevel,i;if(e===-1&&r!=null&&r.length?i=r.length-1:i=e,t)for(var s=i;s--;){var l=r[s].attrs["HDCP-LEVEL"];if(l&&l<=t)return s}return i}},{key:"firstAutoLevel",get:function(){return this.abrController.firstAutoLevel}},{key:"nextAutoLevel",get:function(){return this.abrController.nextAutoLevel},set:function(r){this.abrController.nextAutoLevel=r}},{key:"playingDate",get:function(){return this.streamController.currentProgramDateTime}},{key:"mainForwardBufferInfo",get:function(){return this.streamController.getMainFwdBufferInfo()}},{key:"maxBufferLength",get:function(){return this.streamController.maxBufferLength}},{key:"allAudioTracks",get:function(){var r=this.audioTrackController;return r?r.allAudioTracks:[]}},{key:"audioTracks",get:function(){var r=this.audioTrackController;return r?r.audioTracks:[]}},{key:"audioTrack",get:function(){var r=this.audioTrackController;return r?r.audioTrack:-1},set:function(r){var e=this.audioTrackController;e&&(e.audioTrack=r)}},{key:"allSubtitleTracks",get:function(){var r=this.subtitleTrackController;return r?r.allSubtitleTracks:[]}},{key:"subtitleTracks",get:function(){var r=this.subtitleTrackController;return r?r.subtitleTracks:[]}},{key:"subtitleTrack",get:function(){var r=this.subtitleTrackController;return r?r.subtitleTrack:-1},set:function(r){var e=this.subtitleTrackController;e&&(e.subtitleTrack=r)}},{key:"media",get:function(){return this._media}},{key:"subtitleDisplay",get:function(){var r=this.subtitleTrackController;return r?r.subtitleDisplay:!1},set:function(r){var e=this.subtitleTrackController;e&&(e.subtitleDisplay=r)}},{key:"lowLatencyMode",get:function(){return this.config.lowLatencyMode},set:function(r){this.config.lowLatencyMode=r}},{key:"liveSyncPosition",get:function(){return this.latencyController.liveSyncPosition}},{key:"latency",get:function(){return this.latencyController.latency}},{key:"maxLatency",get:function(){return this.latencyController.maxLatency}},{key:"targetLatency",get:function(){return this.latencyController.targetLatency},set:function(r){this.latencyController.targetLatency=r}},{key:"drift",get:function(){return this.latencyController.drift}},{key:"forceStartLoad",get:function(){return this.streamController.forceStartLoad}},{key:"pathways",get:function(){return this.levelController.pathways}},{key:"pathwayPriority",get:function(){return this.levelController.pathwayPriority},set:function(r){this.levelController.pathwayPriority=r}},{key:"bufferedToEnd",get:function(){var r;return!!((r=this.bufferController)!=null&&r.bufferedToEnd)}},{key:"interstitialsManager",get:function(){var r;return((r=this.interstitialsController)==null?void 0:r.interstitialsManager)||null}}],[{key:"version",get:function(){return ni}},{key:"Events",get:function(){return p}},{key:"MetadataSchema",get:function(){return Ft}},{key:"ErrorTypes",get:function(){return V}},{key:"ErrorDetails",get:function(){return _}},{key:"DefaultConfig",get:function(){return a.defaultConfig?a.defaultConfig:Fh},set:function(r){a.defaultConfig=r}}])}();return ul.defaultConfig=void 0,ul})})(!1)}(Ia)),Ia.exports}var Kc=Gc();const jr=Bc(Kc);var Hc=Qe('<div class="flex w-full items-center gap-4 py-2"><audio preload="none" class="hidden"></audio> <button> </button> <iconify-icon></iconify-icon> <input type="range" min="0" max="1" step="0.01" class="range range-xs w-full"></div>',2);function Vc(O,C){on(C,!0);let G,Y=null,fe=Tr(!1),ke=Tr(.7);wa(()=>{C.gameId&&he(C.gameId)});async function he(lt){if(!G)return;Y&&(Y.destroy(),Y=null);const dt=`http://localhost:8080/tts/${lt}/playlist.m3u8`;jr.isSupported()?(Y=new jr({enableWorker:!0,lowLatencyMode:!0,backBufferLength:90}),Y.loadSource(dt),Y.attachMedia(G),Y.on(jr.Events.MANIFEST_PARSED,()=>{console.log("Received HLS manifest"),z()}),Y.on(jr.Events.ERROR,(Wt,Je)=>{if(console.error("HLS error:",Je),Je.fatal)switch(Je.type){case jr.ErrorTypes.NETWORK_ERROR:console.log("Network error, trying to recover..."),Y==null||Y.startLoad();break;case jr.ErrorTypes.MEDIA_ERROR:console.log("Media error, trying to recover..."),Y==null||Y.recoverMediaError();break;default:console.log("Fatal error, destroying HLS instance"),Y==null||Y.destroy(),Y=null;break}})):G.canPlayType("application/vnd.apple.mpegurl")?(G.src=dt,z()):console.error("HLS is not supported in this browser")}function z(){G&&G.play().then(()=>{wt(fe,!0),console.log("Audio playback started")}).catch(lt=>{console.error("Failed to play audio:",lt),wt(fe,!1)})}function Ue(){G&&(G.pause(),wt(fe,!1),console.log("Audio playback paused"))}function Ve(){B(fe)?Ue():z()}function ae(lt){G&&(wt(ke,Math.max(0,Math.min(1,lt)),!0),G.volume=B(ke))}function $e(){wt(fe,!0)}function J(){wt(fe,!1)}function be(){wt(fe,!1)}fn(()=>{Y&&(Y.destroy(),Y=null)});var Re=Hc(),Oe=te(Re);hr(Oe,lt=>G=lt,()=>G);var Q=ne(Oe,2);Q.__click=Ve;var qe=te(Q,!0);Z(Q);var ot=ne(Q,2);Mt(ot,"inline",!0),Mt(ot,"icon","mdi:volume");var vt=ne(ot,2);return Nt(vt),Z(Re),nt(()=>{kr(Q,1,`btn btn-sm ${B(fe)?"btn-error":"btn-success"}`),Q.disabled=!C.gameId,st(qe,B(fe)?"停止":"再生")}),ba("play",Oe,$e),ba("pause",Oe,J),ba("ended",Oe,be),Ec(vt,()=>B(ke),lt=>wt(ke,lt)),Pe(O,Re),ln({toggleAudio:Ve,updateVolume:ae})}un(["click"]);function Wc(){zr.connect()}function Yc(){zr.disconnect()}var qc=Qe('<div class="status status-success animate-ping"></div> <div class="status status-success"></div>',1),jc=Qe('<div class="status status-warning animate-ping"></div> <div class="status status-warning"></div>',1),Xc=Qe('<div class="status status-error"></div>'),zc=(O,C)=>C("connection.url",O.currentTarget.value),Qc=(O,C)=>C("connection.token",O.currentTarget.value),$c=(O,C)=>C("display.canvas.name",O.currentTarget.checked),Jc=(O,C)=>C("display.canvas.team",O.currentTarget.checked),Zc=(O,C)=>C("display.canvas.role",O.currentTarget.checked),ev=(O,C)=>C("display.bubble.name",O.currentTarget.checked),tv=(O,C)=>C("display.bubble.team",O.currentTarget.checked),rv=(O,C)=>C("display.bubble.role",O.currentTarget.checked),iv=(O,C)=>C("display.text.name",O.currentTarget.checked),nv=(O,C)=>C("display.text.team",O.currentTarget.checked),av=(O,C)=>C("display.text.role",O.currentTarget.checked),sv=(O,C)=>C("display.largeScale",O.currentTarget.checked),ov=Qe('<div class="navbar bg-base-100 flex justify-start gap-4 overflow-x-auto"><a class="text-3xl font-bold text-nowrap ml-2" href="./">aiwolf-nlp-viewer</a> <div class="ml-auto"><div class="inline-grid *:[grid-area:1/1]"><!></div></div> <label class="input min-w-3xs w-3xs"><iconify-icon></iconify-icon> <input type="text" class="grow" placeholder="WebSocket URL"></label> <label class="input min-w-3xs w-3xs"><iconify-icon></iconify-icon> <input type="text" class="grow" placeholder="Authorization Key"> <span class="badge badge-neutral badge-xs">Optional</span></label> <button class="btn btn-info">接続</button> <button class="btn btn-error">切断</button> <button class="btn">設定</button> <dialog class="modal"><div class="modal-box"><div class="form-control my-2"><h3 class="text-lg font-bold">表示設定</h3> <h4 class="text-base font-bold mt-2">キャンバス上のエージェント情報</h4> <div class="flex gap-4 my-2"><label class="label cursor-pointer"><span class="label-text">名前</span> <input type="checkbox" class="checkbox"></label> <label class="label cursor-pointer"><span class="label-text">チーム名</span> <input type="checkbox" class="checkbox"></label> <label class="label cursor-pointer"><span class="label-text">役職</span> <input type="checkbox" class="checkbox"></label></div> <h4 class="text-base font-bold mt-2">メッセージボックス上のエージェント情報</h4> <div class="flex gap-4 my-2"><label class="label cursor-pointer"><span class="label-text">名前</span> <input type="checkbox" class="checkbox"></label> <label class="label cursor-pointer"><span class="label-text">チーム名</span> <input type="checkbox" class="checkbox"></label> <label class="label cursor-pointer"><span class="label-text">役職</span> <input type="checkbox" class="checkbox"></label></div> <h4 class="text-base font-bold mt-2">一覧のエージェント情報</h4> <div class="flex gap-4 my-2"><label class="label cursor-pointer"><span class="label-text">名前</span> <input type="checkbox" class="checkbox"></label> <label class="label cursor-pointer"><span class="label-text">チーム名</span> <input type="checkbox" class="checkbox"></label> <label class="label cursor-pointer"><span class="label-text">役職</span> <input type="checkbox" class="checkbox"></label></div> <h4 class="text-base font-bold mt-2">大画面向け</h4> <label class="label cursor-pointer my-2"><span class="label-text">有効</span> <input type="checkbox" class="checkbox"></label></div></div> <form method="dialog" class="modal-backdrop"><button>close</button></form></dialog> <label class="flex items-center cursor-pointer gap-2"><iconify-icon></iconify-icon> <input type="checkbox" value="dark" class="toggle theme-controller"> <iconify-icon></iconify-icon></label></div>',2);function lv(O,C){on(C,!0);let G=Tr(void 0),Y=Tr(void 0);const fe=Cr.subscribe(pe=>{wt(G,pe,!0)}),ke=zr.subscribe(pe=>{wt(Y,pe.status,!0)});fn(()=>{fe(),ke()});function he(pe,Rt){Cr.update(Ge=>{const Ne=pe.split("."),_e=Ne.pop();let oe=Ge;for(const mt of Ne)mt&&(oe=oe[mt]);return oe[_e]=Rt,{...Ge}})}let z;var Ue=ov(),Ve=ne(te(Ue),2),ae=te(Ve),$e=te(ae);{var J=pe=>{var Rt=qc();ci(2),Pe(pe,Rt)},be=(pe,Rt)=>{{var Ge=_e=>{var oe=jc();ci(2),Pe(_e,oe)},Ne=_e=>{var oe=Xc();Pe(_e,oe)};At(pe,_e=>{B(Y)==="connecting"?_e(Ge):_e(Ne,!1)},Rt)}};At($e,pe=>{B(Y)==="connected"?pe(J):pe(be,!1)})}Z(ae),Z(Ve);var Re=ne(Ve,2),Oe=te(Re);kr(Oe,1,"h-[1em] opacity-50"),Mt(Oe,"inline",!0),Mt(Oe,"icon","mdi:link");var Q=ne(Oe,2);Nt(Q),Q.__input=[zc,he],Z(Re);var qe=ne(Re,2),ot=te(qe);kr(ot,1,"h-[1em] opacity-50"),Mt(ot,"inline",!0),Mt(ot,"icon","mdi:key");var vt=ne(ot,2);Nt(vt),vt.__input=[Qc,he],ci(2),Z(qe);var lt=ne(qe,2);lt.__click=[Wc];var dt=ne(lt,2);dt.__click=[Yc];var Wt=ne(dt,2);Wt.__click=()=>z.showModal();var Je=ne(Wt,2),Ot=te(Je),Ut=te(Ot),Yt=ne(te(Ut),4),Bt=te(Yt),ce=ne(te(Bt),2);Nt(ce),ce.__change=[$c,he],Z(Bt);var me=ne(Bt,2),at=ne(te(me),2);Nt(at),at.__change=[Jc,he],Z(me);var we=ne(me,2),Ze=ne(te(we),2);Nt(Ze),Ze.__change=[Zc,he],Z(we),Z(Yt);var N=ne(Yt,4),Te=te(N),Be=ne(te(Te),2);Nt(Be),Be.__change=[ev,he],Z(Te);var V=ne(Te,2),_=ne(te(V),2);Nt(_),_.__change=[tv,he],Z(V);var p=ne(V,2),j=ne(te(p),2);Nt(j),j.__change=[rv,he],Z(p),Z(N);var K=ne(N,4),ve=te(K),$=ne(te(ve),2);Nt($),$.__change=[iv,he],Z(ve);var ie=ne(ve,2),Ee=ne(te(ie),2);Nt(Ee),Ee.__change=[nv,he],Z(ie);var qt=ne(ie,2),Fe=ne(te(qt),2);Nt(Fe),Fe.__change=[av,he],Z(qt),Z(K);var Ce=ne(K,4),xt=ne(te(Ce),2);Nt(xt),xt.__change=[sv,he],Z(Ce),Z(Ut),Z(Ot),ci(2),Z(Je),hr(Je,pe=>z=pe,()=>z);var gt=ne(Je,2),_t=te(gt);Mt(_t,"inline",!0),Mt(_t,"icon","mdi:white-balance-sunny");var X=ne(_t,2),re=ne(X,2);Mt(re,"inline",!0),Mt(re,"icon","mdi:moon-and-stars"),Z(gt),Z(Ue),nt(()=>{var pe,Rt,Ge,Ne,_e,oe,mt,Ie,Dt,It,nr,kt;yl(Q,(pe=B(G))==null?void 0:pe.connection.url),yl(vt,(Rt=B(G))==null?void 0:Rt.connection.token),lt.disabled=B(Y)!=="disconnected",dt.disabled=B(Y)==="disconnected",ir(ce,(Ge=B(G))==null?void 0:Ge.display.canvas.name),ir(at,(Ne=B(G))==null?void 0:Ne.display.canvas.team),ir(Ze,(_e=B(G))==null?void 0:_e.display.canvas.role),ir(Be,(oe=B(G))==null?void 0:oe.display.bubble.name),ir(_,(mt=B(G))==null?void 0:mt.display.bubble.team),ir(j,(Ie=B(G))==null?void 0:Ie.display.bubble.role),ir($,(Dt=B(G))==null?void 0:Dt.display.text.name),ir(Ee,(It=B(G))==null?void 0:It.display.text.team),ir(Fe,(nr=B(G))==null?void 0:nr.display.text.role),ir(xt,(kt=B(G))==null?void 0:kt.display.largeScale)}),Pe(O,Ue),ln()}un(["input","click","change"]);var uv=Qe("<option> </option>"),fv=Qe('<div class="divider"> </div>'),dv=Qe('<p class="overflow-hidden text-ellipsis whitespace-nowrap"> </p>'),hv=Qe('<p class="overflow-hidden text-ellipsis whitespace-nowrap"> </p> <iconify-icon></iconify-icon>',3),cv=Qe('<p class="overflow-hidden text-ellipsis whitespace-nowrap"> </p> <iconify-icon></iconify-icon>',3),vv=Qe('<p class="overflow-hidden text-ellipsis whitespace-nowrap"> </p>'),gv=Qe('<p class="overflow-hidden text-ellipsis whitespace-nowrap"><!> </p>'),mv=Qe("<!> <button><!></button>",1),pv=Qe('<main class="h-screen flex flex-col bg-base-300"><!> <div class="flex flex-1 overflow-hidden w-full flex-row h-full"><div class="overflow-y-auto pr-2 h-full"><!></div> <button class="cursor-ew-resize w-2 rounded bg-gray-300 hover:bg-gray-400 active:bg-gray-500 transition-colors border-0 my-2" aria-label="Resize"></button> <div class="flex-1 overflow-y-auto h-full pr-2"><div class="flex flex-col p-2"><!> <select class="w-full select"></select> <div class="list overflow-y-auto flex-1 my-2"><!></div></div></div></div></main>');function Uv(O,C){on(C,!0);const[G,Y]=dc(),fe=()=>di(Ve,"$selectedId",G),ke=()=>di(Re,"$entries",G),he=()=>di(Oe,"$status",G),z=()=>di(ae,"$selectedIdx",G),Ue=()=>di(be,"$currentPacket",G),Ve=_r(null),ae=_r(null);let $e=Tr(void 0);const J={id:"",idx:-1,day:0,is_day:!0,agents:Rc(13),event:"未接続",message:void 0,from_idx:void 0,to_idx:void 0,bubble_idx:void 0},be=_r(J),Re=_r({}),Oe=_r("");let Q=Tr(void 0),qe=Tr(80),ot=!1,vt=null;function lt(){{const p=cc.url.searchParams,j=p.get("url"),K=p.get("token");j&&(Cr.update(ve=>({...ve,connection:{url:j??"",token:K??""}})),zr.connect())}}function dt(p){if(!ot||!vt)return;const j=vt.getBoundingClientRect(),K=p-j.left,ve=j.width;wt(qe,Math.min(90,Math.max(10,K/ve*100)),!0)}function Wt(){ot=!0,document.body.style.cursor="ew-resize",document.body.style.userSelect="none";const p=K=>{const ve=K instanceof MouseEvent?K.clientX:K.touches[0].clientX;dt(ve)},j=()=>{ot=!1,document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("mousemove",p),window.removeEventListener("touchmove",p),window.removeEventListener("mouseup",j),window.removeEventListener("touchend",j)};window.addEventListener("mousemove",p),window.addEventListener("touchmove",p),window.addEventListener("mouseup",j),window.addEventListener("touchend",j)}Al(()=>{lt();const p=zr.entries.subscribe(ie=>{Re.set(ie),Ve.update(Ee=>Ee||Object.keys(ie)[0]),ae.update(()=>fe()?ie[fe()].length-1:null)}),j=zr.subscribe(ie=>{Oe.set(ie.status)}),K=Ve.subscribe(ie=>{var Ee;ie&&((Ee=ke()[ie])==null?void 0:Ee.length)>0?ae.set(ke()[ie].length-1):ae.set(null)}),ve=Cr.subscribe(ie=>{wt(Q,ie,!0)}),$=vc([Ve,ae,Re],([ie,Ee,qt])=>{if(!ie||Ee===null)return J;const Fe=qt[ie];return!Fe||Ee<0||Ee>=Fe.length?J:Fe[Ee]}).subscribe(ie=>{be.set(ie)});fn(()=>{p(),j(),ve(),K(),$()}),window.addEventListener("beforeunload",ie=>{he()==="connected"&&ie.preventDefault()}),window.addEventListener("popstate",ie=>{he()==="connected"&&ie.preventDefault()})});let Je=null;wa(()=>{if(Je&&z()!==null){const p=Je.querySelectorAll("button");z()>=0&&z()<p.length&&p[z()].scrollIntoView({behavior:"smooth",block:"center"})}});var Ot=pv();lc(p=>{oc.title="aiwolf-nlp-viewer"});var Ut=te(Ot);lv(Ut,{});var Yt=ne(Ut,2),Bt=te(Yt),ce=te(Bt);Uc(ce,{get packet(){return Ue()},get focusIdx(){return B($e)},set focusIdx(p){wt($e,p,!0)}}),Z(Bt);var me=ne(Bt,2);me.__mousedown=Wt,me.__touchstart=Wt;var at=ne(me,2),we=te(at),Ze=te(we);{var N=p=>{Vc(p,{get gameId(){return fe()}})};At(Ze,p=>{p(N)})}var Te=ne(Ze,2);_a(Te,5,()=>Object.keys(ke()),Da,(p,j)=>{var K=uv(),ve={},$=te(K,!0);Z(K),nt(()=>{ve!==(ve=B(j))&&(K.value=(K.__value=B(j))??""),st($,B(j))}),Pe(p,K)}),Z(Te);var Be=ne(Te,2),V=te(Be);{var _=p=>{var j=vi(),K=Er(j);_a(K,1,()=>ke()[fe()]||[],Da,(ve,$,ie)=>{var Ee=mv(),qt=Er(Ee);{var Fe=X=>{var re=fv(),pe=te(re);Z(re),nt(()=>st(pe,`${B($).day??""}日目 ${B($).is_day?"昼":"夜"}`)),Pe(X,re)};At(qt,X=>{(ie>0&&(B($).day!==ke()[fe()][ie-1].day||B($).is_day!==ke()[fe()][ie-1].is_day)||ie===0)&&X(Fe)})}var Ce=ne(qt,2);Ce.__click=()=>ae.set(ie);var xt=te(Ce);{var gt=X=>{var re=vi(),pe=Er(re);{var Rt=Ne=>{var _e=dv(),oe=te(_e,!0);Z(_e),nt(()=>st(oe,B($).event)),Pe(Ne,_e)},Ge=(Ne,_e)=>{{var oe=Ie=>{var Dt=hv(),It=Er(Dt),nr=te(It,!0);Z(It);var kt=ne(It,2);Mt(kt,"inline",!0),Mt(kt,"icon","mdi:skip-forward"),nt(Lt=>st(nr,Lt),[()=>{var Lt;return St((Lt=B(Q))==null?void 0:Lt.display.text,B($),B($).bubble_idx)}]),Pe(Ie,Dt)},mt=(Ie,Dt)=>{{var It=kt=>{var Lt=cv(),Sr=Er(Lt),ar=te(Sr,!0);Z(Sr);var je=ne(Sr,2);Mt(je,"inline",!0),Mt(je,"icon","mdi:arrow-u-down-right-bold"),nt(Ar=>st(ar,Ar),[()=>{var Ar;return St((Ar=B(Q))==null?void 0:Ar.display.text,B($),B($).bubble_idx)}]),Pe(kt,Lt)},nr=kt=>{var Lt=vv(),Sr=te(Lt,!0);Z(Lt),nt(ar=>st(Sr,ar),[()=>{var ar;return St((ar=B(Q))==null?void 0:ar.display.text,B($),B($).bubble_idx)+"<"+B($).message}]),Pe(kt,Lt)};At(Ie,kt=>{B($).message==="Skip"?kt(It):kt(nr,!1)},Dt)}};At(Ne,Ie=>{B($).message==="Over"?Ie(oe):Ie(mt,!1)},_e)}};At(pe,Ne=>{var _e;B($).event==="囁き"&&B($e)!==void 0&&((_e=B($).agents.find(oe=>oe.idx===B($e)))==null?void 0:_e.role)!=="WEREWOLF"?Ne(Rt):Ne(Ge,!1)})}Pe(X,re)},_t=X=>{var re=gv(),pe=te(re);{var Rt=_e=>{var oe=pl();nt(mt=>st(oe,mt),[()=>{var mt;return St((mt=B(Q))==null?void 0:mt.display.text,B($),B($).from_idx)}]),Pe(_e,oe)},Ge=(_e,oe)=>{{var mt=Ie=>{var Dt=pl();nt(It=>st(Dt,It),[()=>{var It;return St((It=B(Q))==null?void 0:It.display.text,B($),B($).to_idx)}]),Pe(Ie,Dt)};At(_e,Ie=>{(B($).event==="追放"||B($).event==="襲撃")&&Ie(mt)},oe)}};At(pe,_e=>{B($).event==="投票"||B($).event==="占い"?_e(Rt):_e(Ge,!1)})}var Ne=ne(pe);Z(re),nt(()=>st(Ne,` ${B($).event??""}`)),Pe(X,re)};At(xt,X=>{B($).event==="トーク"||B($).event==="囁き"?X(gt):X(_t,!1)})}Z(Ce),nt(()=>kr(Ce,1,`btn ${ie===z()?"btn-primary":""}`)),Pe(ve,Ee)}),Pe(p,j)};At(V,p=>{fe()&&p(_)})}Z(Be),hr(Be,p=>Je=p,()=>Je),Z(we),Z(at),Z(Yt),hr(Yt,p=>vt=p,()=>vt),Z(Ot),nt(()=>ka(Bt,`width: ${B(qe)??""}%`)),uc(Te,fe,p=>hc(Ve,p)),Pe(O,Ot),ln(),Y()}un(["mousedown","touchstart","click"]);export{Uv as component};
